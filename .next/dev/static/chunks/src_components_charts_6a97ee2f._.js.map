{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Michael/IdeaProjects/MSMTB/src/trading-cockpit/src/components/charts/widgets/ShapeManager.ts"],"sourcesContent":["import { EntityId, IChartShape } from './api';\r\n\r\nexport class ShapeManager {\r\n    private _shapes: Map<EntityId, IChartShape> = new Map();\r\n    private _listeners: Map<string, Set<(params: any) => void>> = new Map();\r\n\r\n    public register(shape: IChartShape) {\r\n        this._shapes.set(shape.id, shape);\r\n        this.emit('drawing', { type: 'create', id: shape.id, shape });\r\n    }\r\n\r\n    public unregister(id: EntityId) {\r\n        const shape = this._shapes.get(id);\r\n        if (shape) {\r\n            this._shapes.delete(id);\r\n            this.emit('drawing', { type: 'remove', id });\r\n        }\r\n    }\r\n\r\n    public get(id: EntityId): IChartShape | null {\r\n        return this._shapes.get(id) || null;\r\n    }\r\n\r\n    public getAll(): IChartShape[] {\r\n        return Array.from(this._shapes.values());\r\n    }\r\n\r\n    // --- Events ---\r\n    public subscribe(event: string, callback: (params: any) => void) {\r\n        if (!this._listeners.has(event)) {\r\n            this._listeners.set(event, new Set());\r\n        }\r\n        this._listeners.get(event)?.add(callback);\r\n    }\r\n\r\n    public unsubscribe(event: string, callback: (params: any) => void) {\r\n        this._listeners.get(event)?.delete(callback);\r\n    }\r\n\r\n    public emit(event: string, params: any) {\r\n        this._listeners.get(event)?.forEach(cb => cb(params));\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;AAEO,MAAM;IACD,UAAsC,IAAI,MAAM;IAChD,aAAsD,IAAI,MAAM;IAEjE,SAAS,KAAkB,EAAE;QAChC,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,MAAM,EAAE,EAAE;QAC3B,IAAI,CAAC,IAAI,CAAC,WAAW;YAAE,MAAM;YAAU,IAAI,MAAM,EAAE;YAAE;QAAM;IAC/D;IAEO,WAAW,EAAY,EAAE;QAC5B,MAAM,QAAQ,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC;QAC/B,IAAI,OAAO;YACP,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC;YACpB,IAAI,CAAC,IAAI,CAAC,WAAW;gBAAE,MAAM;gBAAU;YAAG;QAC9C;IACJ;IAEO,IAAI,EAAY,EAAsB;QACzC,OAAO,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,OAAO;IACnC;IAEO,SAAwB;QAC3B,OAAO,MAAM,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,MAAM;IACzC;IAEA,iBAAiB;IACV,UAAU,KAAa,EAAE,QAA+B,EAAE;QAC7D,IAAI,CAAC,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,QAAQ;YAC7B,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,OAAO,IAAI;QACnC;QACA,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,QAAQ,IAAI;IACpC;IAEO,YAAY,KAAa,EAAE,QAA+B,EAAE;QAC/D,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,QAAQ,OAAO;IACvC;IAEO,KAAK,KAAa,EAAE,MAAW,EAAE;QACpC,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,QAAQ,QAAQ,CAAA,KAAM,GAAG;IACjD;AACJ"}},
    {"offset": {"line": 56, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Michael/IdeaProjects/MSMTB/src/trading-cockpit/src/components/charts/widgets/adapters/LongShortPositionAdapter.ts"],"sourcesContent":["import { IChartShape, TimePoint, EntityId } from '../api';\r\nimport { LongShortPosition } from '../../LongShortPosition';\r\nimport { v4 as uuidv4 } from 'uuid';\r\n\r\nexport class LongShortPositionAdapter implements IChartShape {\r\n    public id: EntityId;\r\n    public name: string;\r\n\r\n    private _tool: LongShortPosition;\r\n    private _selectionEnabled: boolean = true;\r\n    public onExecute?: (trade: any) => void;\r\n\r\n    constructor(tool: LongShortPosition, type: 'Riskrewardlong' | 'Riskrewardshort') {\r\n        this.id = uuidv4();\r\n        this.name = type;\r\n        this._tool = tool;\r\n\r\n        this._tool.onExecute = (trade) => {\r\n            this.onExecute?.(trade);\r\n        };\r\n    }\r\n\r\n    public getPoints(): TimePoint[] {\r\n        const state = this._tool.getData();\r\n        return [{\r\n            time: state.timeIndex, // Assuming timeIndex is the UNIX TS as number\r\n            price: state.entryPrice\r\n        }];\r\n    }\r\n\r\n    public setPoints(points: TimePoint[]): void {\r\n        if (points.length === 0) return;\r\n        const p = points[0];\r\n\r\n        // Use custom update logic if needed, or simply update entry\r\n        this._tool.updatePoint('body', { time: p.time as number, price: p.price });\r\n\r\n        // Trigger update via tool\r\n        this._tool.setSelected(this._tool.isSelected());\r\n    }\r\n\r\n    public getProperties(): Record<string, any> {\r\n        const state = this._tool.getData();\r\n        const prefix = this.name === 'Riskrewardlong' ? 'linetoolriskrewardlong' : 'linetoolriskrewardshort';\r\n\r\n        return {\r\n            [`${prefix}.stopLevel`]: state.stopLossPrice,\r\n            [`${prefix}.profitLevel`]: state.takeProfitPrice,\r\n            [`${prefix}.entryPrice`]: state.entryPrice,\r\n            [`${prefix}.riskReward`]: state.riskReward,\r\n            [`${prefix}.fixedLeg`]: state.fixedLeg,\r\n            [`${prefix}.fixedStates`]: state.fixedStates,\r\n            [`${prefix}.orderType`]: state.orderType,\r\n            [`${prefix}.lineColor`]: state.lineColor,\r\n            [`${prefix}.stopColor`]: state.stopColor,\r\n            [`${prefix}.profitColor`]: state.profitColor,\r\n            [`${prefix}.fillLabelBackground`]: state.fillLabelBackground,\r\n            [`${prefix}.accountSize`]: state.accountSize,\r\n            [`${prefix}.riskSize`]: state.riskSize,\r\n            [`${prefix}.riskDisplayMode`]: state.riskDisplayMode,\r\n            [`${prefix}.alwaysShowStats`]: state.alwaysShowStats,\r\n            [`${prefix}.compact`]: state.compact,\r\n            [`${prefix}.entryAnchor`]: state.entryAnchor,\r\n            [`${prefix}.slAnchor`]: state.slAnchor,\r\n            [`${prefix}.tpAnchor`]: state.tpAnchor,\r\n        };\r\n    }\r\n\r\n    public setProperties(props: Record<string, any>): void {\r\n        const state = this._tool.getData();\r\n        const prefix = this.name === 'Riskrewardlong' ? 'linetoolriskrewardlong' : 'linetoolriskrewardshort';\r\n\r\n        if (typeof props[`${prefix}.stopLevel`] === 'number') state.stopLossPrice = props[`${prefix}.stopLevel`];\r\n        if (typeof props[`${prefix}.profitLevel`] === 'number') state.takeProfitPrice = props[`${prefix}.profitLevel`];\r\n        if (typeof props[`${prefix}.entryPrice`] === 'number') state.entryPrice = props[`${prefix}.entryPrice`];\r\n        if (typeof props[`${prefix}.riskReward`] === 'number') state.riskReward = props[`${prefix}.riskReward`];\r\n        if (typeof props[`${prefix}.fixedLeg`] === 'string') state.fixedLeg = props[`${prefix}.fixedLeg`] as any;\r\n        if (props[`${prefix}.fixedStates`]) state.fixedStates = props[`${prefix}.fixedStates`];\r\n        if (typeof props[`${prefix}.orderType`] === 'string') state.orderType = props[`${prefix}.orderType`] as any;\r\n        if (typeof props[`${prefix}.lineColor`] === 'string') state.lineColor = props[`${prefix}.lineColor`];\r\n        if (typeof props[`${prefix}.stopColor`] === 'string') state.stopColor = props[`${prefix}.stopColor`];\r\n        if (typeof props[`${prefix}.profitColor`] === 'string') state.profitColor = props[`${prefix}.profitColor`];\r\n        if (typeof props[`${prefix}.fillLabelBackground`] === 'boolean') state.fillLabelBackground = props[`${prefix}.fillLabelBackground`];\r\n        if (typeof props[`${prefix}.accountSize`] === 'number') state.accountSize = props[`${prefix}.accountSize`];\r\n        if (typeof props[`${prefix}.riskSize`] === 'number') state.riskSize = props[`${prefix}.riskSize`];\r\n        if (typeof props[`${prefix}.riskDisplayMode`] === 'string') state.riskDisplayMode = props[`${prefix}.riskDisplayMode`] as any;\r\n        if (typeof props[`${prefix}.alwaysShowStats`] === 'boolean') state.alwaysShowStats = props[`${prefix}.alwaysShowStats`];\r\n        if (typeof props[`${prefix}.compact`] === 'boolean') state.compact = props[`${prefix}.compact`];\r\n        if (props[`${prefix}.entryAnchor`] !== undefined) state.entryAnchor = props[`${prefix}.entryAnchor`];\r\n        if (props[`${prefix}.slAnchor`] !== undefined) state.slAnchor = props[`${prefix}.slAnchor`];\r\n        if (props[`${prefix}.tpAnchor`] !== undefined) state.tpAnchor = props[`${prefix}.tpAnchor`];\r\n\r\n        this._tool.setSelected(this._tool.isSelected());\r\n    }\r\n\r\n    public isSelectionEnabled(): boolean {\r\n        return this._selectionEnabled;\r\n    }\r\n\r\n    public setSelection(selected: boolean): void {\r\n        this._tool.setSelected(selected);\r\n    }\r\n\r\n    // Helper to get the raw tool\r\n    public getTool(): LongShortPosition {\r\n        return this._tool;\r\n    }\r\n\r\n    public getPrimitive(): any {\r\n        return this._tool;\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;AAEA;;AAEO,MAAM;IACF,GAAa;IACb,KAAa;IAEZ,MAAyB;IACzB,oBAA6B,KAAK;IACnC,UAAiC;IAExC,YAAY,IAAuB,EAAE,IAA0C,CAAE;QAC7E,IAAI,CAAC,EAAE,GAAG,IAAA,4KAAM;QAChB,IAAI,CAAC,IAAI,GAAG;QACZ,IAAI,CAAC,KAAK,GAAG;QAEb,IAAI,CAAC,KAAK,CAAC,SAAS,GAAG,CAAC;YACpB,IAAI,CAAC,SAAS,GAAG;QACrB;IACJ;IAEO,YAAyB;QAC5B,MAAM,QAAQ,IAAI,CAAC,KAAK,CAAC,OAAO;QAChC,OAAO;YAAC;gBACJ,MAAM,MAAM,SAAS;gBACrB,OAAO,MAAM,UAAU;YAC3B;SAAE;IACN;IAEO,UAAU,MAAmB,EAAQ;QACxC,IAAI,OAAO,MAAM,KAAK,GAAG;QACzB,MAAM,IAAI,MAAM,CAAC,EAAE;QAEnB,4DAA4D;QAC5D,IAAI,CAAC,KAAK,CAAC,WAAW,CAAC,QAAQ;YAAE,MAAM,EAAE,IAAI;YAAY,OAAO,EAAE,KAAK;QAAC;QAExE,0BAA0B;QAC1B,IAAI,CAAC,KAAK,CAAC,WAAW,CAAC,IAAI,CAAC,KAAK,CAAC,UAAU;IAChD;IAEO,gBAAqC;QACxC,MAAM,QAAQ,IAAI,CAAC,KAAK,CAAC,OAAO;QAChC,MAAM,SAAS,IAAI,CAAC,IAAI,KAAK,mBAAmB,2BAA2B;QAE3E,OAAO;YACH,CAAC,GAAG,OAAO,UAAU,CAAC,CAAC,EAAE,MAAM,aAAa;YAC5C,CAAC,GAAG,OAAO,YAAY,CAAC,CAAC,EAAE,MAAM,eAAe;YAChD,CAAC,GAAG,OAAO,WAAW,CAAC,CAAC,EAAE,MAAM,UAAU;YAC1C,CAAC,GAAG,OAAO,WAAW,CAAC,CAAC,EAAE,MAAM,UAAU;YAC1C,CAAC,GAAG,OAAO,SAAS,CAAC,CAAC,EAAE,MAAM,QAAQ;YACtC,CAAC,GAAG,OAAO,YAAY,CAAC,CAAC,EAAE,MAAM,WAAW;YAC5C,CAAC,GAAG,OAAO,UAAU,CAAC,CAAC,EAAE,MAAM,SAAS;YACxC,CAAC,GAAG,OAAO,UAAU,CAAC,CAAC,EAAE,MAAM,SAAS;YACxC,CAAC,GAAG,OAAO,UAAU,CAAC,CAAC,EAAE,MAAM,SAAS;YACxC,CAAC,GAAG,OAAO,YAAY,CAAC,CAAC,EAAE,MAAM,WAAW;YAC5C,CAAC,GAAG,OAAO,oBAAoB,CAAC,CAAC,EAAE,MAAM,mBAAmB;YAC5D,CAAC,GAAG,OAAO,YAAY,CAAC,CAAC,EAAE,MAAM,WAAW;YAC5C,CAAC,GAAG,OAAO,SAAS,CAAC,CAAC,EAAE,MAAM,QAAQ;YACtC,CAAC,GAAG,OAAO,gBAAgB,CAAC,CAAC,EAAE,MAAM,eAAe;YACpD,CAAC,GAAG,OAAO,gBAAgB,CAAC,CAAC,EAAE,MAAM,eAAe;YACpD,CAAC,GAAG,OAAO,QAAQ,CAAC,CAAC,EAAE,MAAM,OAAO;YACpC,CAAC,GAAG,OAAO,YAAY,CAAC,CAAC,EAAE,MAAM,WAAW;YAC5C,CAAC,GAAG,OAAO,SAAS,CAAC,CAAC,EAAE,MAAM,QAAQ;YACtC,CAAC,GAAG,OAAO,SAAS,CAAC,CAAC,EAAE,MAAM,QAAQ;QAC1C;IACJ;IAEO,cAAc,KAA0B,EAAQ;QACnD,MAAM,QAAQ,IAAI,CAAC,KAAK,CAAC,OAAO;QAChC,MAAM,SAAS,IAAI,CAAC,IAAI,KAAK,mBAAmB,2BAA2B;QAE3E,IAAI,OAAO,KAAK,CAAC,GAAG,OAAO,UAAU,CAAC,CAAC,KAAK,UAAU,MAAM,aAAa,GAAG,KAAK,CAAC,GAAG,OAAO,UAAU,CAAC,CAAC;QACxG,IAAI,OAAO,KAAK,CAAC,GAAG,OAAO,YAAY,CAAC,CAAC,KAAK,UAAU,MAAM,eAAe,GAAG,KAAK,CAAC,GAAG,OAAO,YAAY,CAAC,CAAC;QAC9G,IAAI,OAAO,KAAK,CAAC,GAAG,OAAO,WAAW,CAAC,CAAC,KAAK,UAAU,MAAM,UAAU,GAAG,KAAK,CAAC,GAAG,OAAO,WAAW,CAAC,CAAC;QACvG,IAAI,OAAO,KAAK,CAAC,GAAG,OAAO,WAAW,CAAC,CAAC,KAAK,UAAU,MAAM,UAAU,GAAG,KAAK,CAAC,GAAG,OAAO,WAAW,CAAC,CAAC;QACvG,IAAI,OAAO,KAAK,CAAC,GAAG,OAAO,SAAS,CAAC,CAAC,KAAK,UAAU,MAAM,QAAQ,GAAG,KAAK,CAAC,GAAG,OAAO,SAAS,CAAC,CAAC;QACjG,IAAI,KAAK,CAAC,GAAG,OAAO,YAAY,CAAC,CAAC,EAAE,MAAM,WAAW,GAAG,KAAK,CAAC,GAAG,OAAO,YAAY,CAAC,CAAC;QACtF,IAAI,OAAO,KAAK,CAAC,GAAG,OAAO,UAAU,CAAC,CAAC,KAAK,UAAU,MAAM,SAAS,GAAG,KAAK,CAAC,GAAG,OAAO,UAAU,CAAC,CAAC;QACpG,IAAI,OAAO,KAAK,CAAC,GAAG,OAAO,UAAU,CAAC,CAAC,KAAK,UAAU,MAAM,SAAS,GAAG,KAAK,CAAC,GAAG,OAAO,UAAU,CAAC,CAAC;QACpG,IAAI,OAAO,KAAK,CAAC,GAAG,OAAO,UAAU,CAAC,CAAC,KAAK,UAAU,MAAM,SAAS,GAAG,KAAK,CAAC,GAAG,OAAO,UAAU,CAAC,CAAC;QACpG,IAAI,OAAO,KAAK,CAAC,GAAG,OAAO,YAAY,CAAC,CAAC,KAAK,UAAU,MAAM,WAAW,GAAG,KAAK,CAAC,GAAG,OAAO,YAAY,CAAC,CAAC;QAC1G,IAAI,OAAO,KAAK,CAAC,GAAG,OAAO,oBAAoB,CAAC,CAAC,KAAK,WAAW,MAAM,mBAAmB,GAAG,KAAK,CAAC,GAAG,OAAO,oBAAoB,CAAC,CAAC;QACnI,IAAI,OAAO,KAAK,CAAC,GAAG,OAAO,YAAY,CAAC,CAAC,KAAK,UAAU,MAAM,WAAW,GAAG,KAAK,CAAC,GAAG,OAAO,YAAY,CAAC,CAAC;QAC1G,IAAI,OAAO,KAAK,CAAC,GAAG,OAAO,SAAS,CAAC,CAAC,KAAK,UAAU,MAAM,QAAQ,GAAG,KAAK,CAAC,GAAG,OAAO,SAAS,CAAC,CAAC;QACjG,IAAI,OAAO,KAAK,CAAC,GAAG,OAAO,gBAAgB,CAAC,CAAC,KAAK,UAAU,MAAM,eAAe,GAAG,KAAK,CAAC,GAAG,OAAO,gBAAgB,CAAC,CAAC;QACtH,IAAI,OAAO,KAAK,CAAC,GAAG,OAAO,gBAAgB,CAAC,CAAC,KAAK,WAAW,MAAM,eAAe,GAAG,KAAK,CAAC,GAAG,OAAO,gBAAgB,CAAC,CAAC;QACvH,IAAI,OAAO,KAAK,CAAC,GAAG,OAAO,QAAQ,CAAC,CAAC,KAAK,WAAW,MAAM,OAAO,GAAG,KAAK,CAAC,GAAG,OAAO,QAAQ,CAAC,CAAC;QAC/F,IAAI,KAAK,CAAC,GAAG,OAAO,YAAY,CAAC,CAAC,KAAK,WAAW,MAAM,WAAW,GAAG,KAAK,CAAC,GAAG,OAAO,YAAY,CAAC,CAAC;QACpG,IAAI,KAAK,CAAC,GAAG,OAAO,SAAS,CAAC,CAAC,KAAK,WAAW,MAAM,QAAQ,GAAG,KAAK,CAAC,GAAG,OAAO,SAAS,CAAC,CAAC;QAC3F,IAAI,KAAK,CAAC,GAAG,OAAO,SAAS,CAAC,CAAC,KAAK,WAAW,MAAM,QAAQ,GAAG,KAAK,CAAC,GAAG,OAAO,SAAS,CAAC,CAAC;QAE3F,IAAI,CAAC,KAAK,CAAC,WAAW,CAAC,IAAI,CAAC,KAAK,CAAC,UAAU;IAChD;IAEO,qBAA8B;QACjC,OAAO,IAAI,CAAC,iBAAiB;IACjC;IAEO,aAAa,QAAiB,EAAQ;QACzC,IAAI,CAAC,KAAK,CAAC,WAAW,CAAC;IAC3B;IAEA,6BAA6B;IACtB,UAA6B;QAChC,OAAO,IAAI,CAAC,KAAK;IACrB;IAEO,eAAoB;QACvB,OAAO,IAAI,CAAC,KAAK;IACrB;AACJ"}},
    {"offset": {"line": 166, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Michael/IdeaProjects/MSMTB/src/trading-cockpit/src/components/charts/widgets/BaseWidget.ts"],"sourcesContent":["import {\r\n    ISeriesPrimitive,\r\n    SeriesAttachedParameter,\r\n    IChartApi,\r\n    ISeriesApi,\r\n    SeriesType,\r\n    Time,\r\n    Coordinate,\r\n    IPrimitivePaneRenderer,\r\n    IPrimitivePaneView,\r\n    PrimitiveHoveredItem\r\n} from 'lightweight-charts';\r\nimport { Anchor, Point, WidgetHitResult } from './types';\r\n\r\nexport enum WidgetState {\r\n    Idle = 'Idle',\r\n    Hover = 'Hover',\r\n    Selected = 'Selected'\r\n}\r\n\r\nexport abstract class BaseWidget<TData> implements ISeriesPrimitive {\r\n    protected _chart: IChartApi | null = null;\r\n    protected _series: ISeriesApi<SeriesType> | null = null;\r\n    protected _requestUpdate: (() => void) | null = null;\r\n\r\n    protected _data: TData;\r\n    protected _state: WidgetState = WidgetState.Idle;\r\n    protected _cursor: string = 'default';\r\n\r\n    // Geometry Cache\r\n    protected _anchors: Anchor[] = [];\r\n\r\n    // View/Renderer\r\n    protected _paneViews: BaseWidgetPaneView[];\r\n    protected _visible: boolean = true;\r\n\r\n    constructor(initialData: TData) {\r\n        this._data = initialData;\r\n        this._paneViews = [new BaseWidgetPaneView(this)];\r\n    }\r\n\r\n    public setVisible(visible: boolean) {\r\n        this._visible = visible;\r\n        this._requestUpdate?.();\r\n    }\r\n\r\n    public isVisible(): boolean {\r\n        return this._visible;\r\n    }\r\n\r\n    // --- ISeriesPrimitive Implementation ---\r\n\r\n    public attached(param: SeriesAttachedParameter<Time>): void {\r\n        this._chart = param.chart;\r\n        this._series = param.series;\r\n        this._requestUpdate = param.requestUpdate;\r\n\r\n        const container = this._chart.chartElement();\r\n        this.subscribeToEvents(container);\r\n        this.onAttached();\r\n    }\r\n\r\n    public detached(): void {\r\n        if (this._chart) {\r\n            const container = this._chart.chartElement();\r\n            this.unsubscribeFromEvents(container);\r\n        }\r\n        this._chart = null;\r\n        this._series = null;\r\n        this._requestUpdate = null;\r\n        this.onDetached();\r\n    }\r\n\r\n    public paneViews() {\r\n        return this._paneViews;\r\n    }\r\n\r\n    // --- Abstract Methods (Geometry) ---\r\n\r\n    /**\r\n     * Called when the widget needs to recalculate its screen coordinates (anchors, paths).\r\n     * Usually called inside the Renderer's draw loop or before hit-testing.\r\n     */\r\n    public abstract updateGeometry(timeScale: any, series: any): void;\r\n\r\n    /**\r\n     * Called to draw the main body of the widget (lines, fills).\r\n     * Anchors are drawn automatically by the BaseWidget.\r\n     */\r\n    public abstract drawBody(ctx: CanvasRenderingContext2D): void;\r\n\r\n    /**\r\n     * Return true if the point is inside the widget body/shape.\r\n     */\r\n    protected abstract hitTestBody(point: Point): boolean;\r\n\r\n    /**\r\n     * Apply a drag delta to the data model.\r\n     * @param target The drag target ('body' or anchor ID)\r\n     * @param newPoint The new mouse position (sanitized/snapped)\r\n     * @param originalPoint The mouse position when drag started\r\n     */\r\n    protected abstract applyDrag(target: string, newPoint: Point): void;\r\n\r\n\r\n    // --- Core Behavior (Pillars 1 & 2) ---\r\n\r\n    // 1. Visual State Machine\r\n    public setSelected(selected: boolean) {\r\n        if (selected) {\r\n            this._state = WidgetState.Selected;\r\n        } else {\r\n            this._state = WidgetState.Idle;\r\n        }\r\n        this.requestUpdate();\r\n    }\r\n\r\n    public getState(): WidgetState {\r\n        return this._state;\r\n    }\r\n\r\n    // 2. Interaction Logic & Hit Testing\r\n    public hitTest(x: number, y: number): PrimitiveHoveredItem | null {\r\n        const point = { x, y };\r\n        const result = this.hitTestInternal(point);\r\n\r\n        if (result) {\r\n            return {\r\n                externalId: result.target,\r\n                zOrder: 'top'\r\n            };\r\n        }\r\n        return null;\r\n    }\r\n\r\n    protected hitTestInternal(point: Point): WidgetHitResult | null {\r\n        // Priority A: Anchors\r\n        // Only valid if Selected or Hovered (depending on design, usually Hover/Selected shows anchors)\r\n        if (this._state !== WidgetState.Idle) {\r\n            for (const anchor of this._anchors) {\r\n                const dist = Math.sqrt(Math.pow(point.x - anchor.x, 2) + Math.pow(point.y - anchor.y, 2));\r\n                if (dist <= (anchor.radius || 6) + 2) {\r\n                    return { target: anchor.id, cursor: anchor.cursor || 'pointer' };\r\n                }\r\n            }\r\n        }\r\n\r\n        // Priority B: Body\r\n        if (this.hitTestBody(point)) {\r\n            return { target: 'body', cursor: 'move' };\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    // --- Event Handling ---\r\n\r\n    protected _dragTarget: string | null = null;\r\n    protected _dragStartPoint: Point | null = null;\r\n    protected _isDragging: boolean = false;\r\n\r\n    protected onMouseDown = (e: MouseEvent) => {\r\n        if (!this._chart) return;\r\n        const point = this.getPoint(e);\r\n        const hit = this.hitTestInternal(point);\r\n\r\n        if (hit) {\r\n            this._isDragging = true;\r\n            this._dragTarget = hit.target;\r\n            this._dragStartPoint = point;\r\n            this.setSelected(true);\r\n\r\n            // Lock chart scroll\r\n            this._chart.applyOptions({ handleScroll: false, handleScale: false });\r\n        } else {\r\n            // Clicked outside -> Deselect? \r\n            // Usually managed by a global ToolManager, but self-management:\r\n            if (this._state === WidgetState.Selected) {\r\n                this.setSelected(false);\r\n            }\r\n        }\r\n    }\r\n\r\n    protected onMouseMove = (e: MouseEvent) => {\r\n        if (!this._chart) return;\r\n        const rawPoint = this.getPoint(e);\r\n\r\n        if (this._isDragging && this._dragTarget && this._dragStartPoint) {\r\n            // DRAGGING\r\n            let targetPoint = { ...rawPoint };\r\n\r\n            // Apply Axis Locks\r\n            const anchor = this._anchors.find(a => a.id === this._dragTarget);\r\n            if (anchor && anchor.axisLock) {\r\n                if (anchor.axisLock === 'vertical_only') {\r\n                    targetPoint.x = this._dragStartPoint.x;\r\n                } else if (anchor.axisLock === 'horizontal_only') {\r\n                    targetPoint.y = this._dragStartPoint.y;\r\n                }\r\n            }\r\n\r\n            // TODO: Magnet Integration here (Pillar 3)\r\n            // const snapped = MagnetService.snap(targetPoint, ...)\r\n\r\n            this.applyDrag(this._dragTarget, targetPoint);\r\n            this.requestUpdate();\r\n            return;\r\n        }\r\n\r\n        // HOVERING\r\n        const hit = this.hitTestInternal(rawPoint);\r\n\r\n        if (hit) {\r\n            document.body.style.cursor = hit.cursor;\r\n            if (this._state === WidgetState.Idle) {\r\n                this._state = WidgetState.Hover;\r\n                this.requestUpdate();\r\n            }\r\n        } else {\r\n            document.body.style.cursor = 'default';\r\n            if (this._state === WidgetState.Hover) {\r\n                this._state = WidgetState.Idle;\r\n                this.requestUpdate();\r\n            }\r\n        }\r\n    }\r\n\r\n    protected onMouseUp = () => {\r\n        if (this._isDragging) {\r\n            this._isDragging = false;\r\n            this._dragTarget = null;\r\n            this._chart?.applyOptions({ handleScroll: true, handleScale: true });\r\n        }\r\n    }\r\n\r\n    // --- Helpers ---\r\n\r\n    private getPoint(e: MouseEvent): Point {\r\n        const rect = (e.target as HTMLElement).getBoundingClientRect();\r\n        return {\r\n            x: e.clientX - rect.left,\r\n            y: e.clientY - rect.top\r\n        };\r\n    }\r\n\r\n    protected subscribeToEvents(el: HTMLElement) {\r\n        el.addEventListener('mousedown', this.onMouseDown);\r\n        el.addEventListener('mousemove', this.onMouseMove);\r\n        el.addEventListener('mouseup', this.onMouseUp);\r\n        el.addEventListener('mouseleave', this.onMouseUp);\r\n        // Global keydown (attached to document/window, but scope managed via Selection)\r\n        // Note: ChartElement doesn't focus easily. We attach to document but check chart focus/hover?\r\n        // Simpler: attach to document and check if this tool is Selected.\r\n        document.addEventListener('keydown', this.onKeyDown);\r\n    }\r\n\r\n    protected unsubscribeFromEvents(el: HTMLElement) {\r\n        el.removeEventListener('mousedown', this.onMouseDown);\r\n        el.removeEventListener('mousemove', this.onMouseMove);\r\n        el.removeEventListener('mouseup', this.onMouseUp);\r\n        el.removeEventListener('mouseleave', this.onMouseUp);\r\n        document.removeEventListener('keydown', this.onKeyDown);\r\n    }\r\n\r\n    protected onKeyDown = (e: KeyboardEvent) => {\r\n        if (this._state === WidgetState.Selected) {\r\n            if (e.key === 'Delete' || e.key === 'Backspace') {\r\n                e.preventDefault();\r\n                e.stopPropagation();\r\n                // Self-Destruct\r\n                this._series?.detachPrimitive(this);\r\n            }\r\n        }\r\n    }\r\n\r\n    protected requestUpdate() {\r\n        this._requestUpdate?.();\r\n    }\r\n\r\n    // Hooks\r\n    protected onAttached() { }\r\n    protected onDetached() { }\r\n\r\n    // --- Accessors for Renderer ---\r\n    public getChart() { return this._chart; }\r\n    public getSeries() { return this._series; }\r\n    public getAnchors() { return this._anchors; }\r\n    public setAnchors(anchors: Anchor[]) { this._anchors = anchors; }\r\n}\r\n\r\n\r\n// --- Internal Renderer Classes ---\r\n\r\nclass BaseWidgetRenderer implements IPrimitivePaneRenderer {\r\n    constructor(private _widget: BaseWidget<any>) { }\r\n\r\n    draw(target: any) {\r\n        if (!this._widget.isVisible()) return;\r\n\r\n        const chart = this._widget.getChart();\r\n        const series = this._widget.getSeries();\r\n        if (!chart || !series) return;\r\n\r\n        const ctx: CanvasRenderingContext2D = target.useMediaCoordinateSpace\r\n            ? target.context // Newer API might differ slightly, conceptual\r\n            : (target.context || target);\r\n\r\n        if (target.useMediaCoordinateSpace) {\r\n            target.useMediaCoordinateSpace((scope: any) => this._drawImpl(scope.context, chart, series));\r\n        } else {\r\n            this._drawImpl(ctx, chart, series);\r\n        }\r\n    }\r\n\r\n    private _drawImpl(ctx: CanvasRenderingContext2D, chart: IChartApi, series: ISeriesApi<SeriesType>) {\r\n        // 1. Update Geometry (Recalculate screen coords based on current Time/Price)\r\n        // Note: Ideally geometry update happens before draw, but for LWC primitives it's often done here\r\n        // or cached in the View. BaseWidget handles logic.\r\n        this._widget.updateGeometry(chart.timeScale(), series);\r\n\r\n        // 2. Draw Body\r\n        ctx.save();\r\n        this._widget.drawBody(ctx);\r\n        ctx.restore();\r\n\r\n        // 3. Draw Anchors (if not Idle)\r\n        const state = this._widget.getState();\r\n        if (state !== WidgetState.Idle) {\r\n            const anchors = this._widget.getAnchors();\r\n            for (const anchor of anchors) {\r\n                this.drawAnchor(ctx, anchor, state === WidgetState.Selected);\r\n            }\r\n        }\r\n    }\r\n\r\n    private drawAnchor(ctx: CanvasRenderingContext2D, anchor: Anchor, isSelected: boolean) {\r\n        ctx.beginPath();\r\n        ctx.arc(anchor.x, anchor.y, anchor.radius || 5, 0, 2 * Math.PI);\r\n\r\n        // Style based on Selection\r\n        ctx.fillStyle = isSelected ? (anchor.color || '#FFFFFF') : 'rgba(255, 255, 255, 0.5)';\r\n        ctx.fill();\r\n\r\n        ctx.strokeStyle = '#000000';\r\n        ctx.lineWidth = 1;\r\n        ctx.stroke();\r\n    }\r\n}\r\n\r\nclass BaseWidgetPaneView implements IPrimitivePaneView {\r\n    private _renderer: BaseWidgetRenderer;\r\n    constructor(source: BaseWidget<any>) {\r\n        this._renderer = new BaseWidgetRenderer(source);\r\n    }\r\n    renderer() {\r\n        return this._renderer;\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 470, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Michael/IdeaProjects/MSMTB/src/trading-cockpit/src/components/charts/widgets/adapters/TrendLineAdapter.ts"],"sourcesContent":["import { IChartShape, TimePoint, EntityId } from '../api';\r\nimport { TrendLineTool } from '../../TrendLineTool';\r\nimport { WidgetState } from '../BaseWidget';\r\nimport { v4 as uuidv4 } from 'uuid';\r\n\r\nexport class TrendLineAdapter implements IChartShape {\r\n    public id: EntityId;\r\n    public name: string;\r\n\r\n    private _tool: TrendLineTool;\r\n    private _selectionEnabled: boolean = true;\r\n\r\n    constructor(tool: TrendLineTool) {\r\n        this.id = uuidv4();\r\n        this.name = 'trend_line';\r\n        this._tool = tool;\r\n    }\r\n\r\n    public getPoints(): TimePoint[] {\r\n        const data = this._tool.getData();\r\n        return [\r\n            { time: data.p1.time, price: data.p1.price },\r\n            { time: data.p2.time, price: data.p2.price }\r\n        ];\r\n    }\r\n\r\n    public setPoints(points: TimePoint[]): void {\r\n        if (points.length < 2) return;\r\n        const data = this._tool.getData();\r\n\r\n        data.p1.time = points[0].time;\r\n        data.p1.price = points[0].price;\r\n        data.p2.time = points[1].time;\r\n        data.p2.price = points[1].price;\r\n\r\n        // Redraw usually triggered by logic or selection\r\n        this._tool.setSelected(this._tool.getState() === WidgetState.Selected);\r\n    }\r\n\r\n    public getProperties(): Record<string, any> {\r\n        const data = this._tool.getData();\r\n        return {\r\n            \"linetooltrendline.linecolor\": data.color || '#2962FF',\r\n            \"linetooltrendline.linewidth\": data.width || 2\r\n        };\r\n    }\r\n\r\n    public setProperties(props: Record<string, any>): void {\r\n        const data = this._tool.getData();\r\n        if (props[\"linetooltrendline.linecolor\"]) data.color = props[\"linetooltrendline.linecolor\"];\r\n        if (props[\"linetooltrendline.linewidth\"]) data.width = props[\"linetooltrendline.linewidth\"];\r\n\r\n        this._tool.setSelected(this._tool.getState() === WidgetState.Selected);\r\n    }\r\n\r\n    public setSelection(selected: boolean): void {\r\n        this._tool.setSelected(selected);\r\n    }\r\n\r\n    public isSelectionEnabled(): boolean {\r\n        return this._selectionEnabled;\r\n    }\r\n\r\n    public getPrimitive(): any {\r\n        return this._tool;\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;AAEA;AACA;;;AAEO,MAAM;IACF,GAAa;IACb,KAAa;IAEZ,MAAqB;IACrB,oBAA6B,KAAK;IAE1C,YAAY,IAAmB,CAAE;QAC7B,IAAI,CAAC,EAAE,GAAG,IAAA,4KAAM;QAChB,IAAI,CAAC,IAAI,GAAG;QACZ,IAAI,CAAC,KAAK,GAAG;IACjB;IAEO,YAAyB;QAC5B,MAAM,OAAO,IAAI,CAAC,KAAK,CAAC,OAAO;QAC/B,OAAO;YACH;gBAAE,MAAM,KAAK,EAAE,CAAC,IAAI;gBAAE,OAAO,KAAK,EAAE,CAAC,KAAK;YAAC;YAC3C;gBAAE,MAAM,KAAK,EAAE,CAAC,IAAI;gBAAE,OAAO,KAAK,EAAE,CAAC,KAAK;YAAC;SAC9C;IACL;IAEO,UAAU,MAAmB,EAAQ;QACxC,IAAI,OAAO,MAAM,GAAG,GAAG;QACvB,MAAM,OAAO,IAAI,CAAC,KAAK,CAAC,OAAO;QAE/B,KAAK,EAAE,CAAC,IAAI,GAAG,MAAM,CAAC,EAAE,CAAC,IAAI;QAC7B,KAAK,EAAE,CAAC,KAAK,GAAG,MAAM,CAAC,EAAE,CAAC,KAAK;QAC/B,KAAK,EAAE,CAAC,IAAI,GAAG,MAAM,CAAC,EAAE,CAAC,IAAI;QAC7B,KAAK,EAAE,CAAC,KAAK,GAAG,MAAM,CAAC,EAAE,CAAC,KAAK;QAE/B,iDAAiD;QACjD,IAAI,CAAC,KAAK,CAAC,WAAW,CAAC,IAAI,CAAC,KAAK,CAAC,QAAQ,OAAO,sKAAW,CAAC,QAAQ;IACzE;IAEO,gBAAqC;QACxC,MAAM,OAAO,IAAI,CAAC,KAAK,CAAC,OAAO;QAC/B,OAAO;YACH,+BAA+B,KAAK,KAAK,IAAI;YAC7C,+BAA+B,KAAK,KAAK,IAAI;QACjD;IACJ;IAEO,cAAc,KAA0B,EAAQ;QACnD,MAAM,OAAO,IAAI,CAAC,KAAK,CAAC,OAAO;QAC/B,IAAI,KAAK,CAAC,8BAA8B,EAAE,KAAK,KAAK,GAAG,KAAK,CAAC,8BAA8B;QAC3F,IAAI,KAAK,CAAC,8BAA8B,EAAE,KAAK,KAAK,GAAG,KAAK,CAAC,8BAA8B;QAE3F,IAAI,CAAC,KAAK,CAAC,WAAW,CAAC,IAAI,CAAC,KAAK,CAAC,QAAQ,OAAO,sKAAW,CAAC,QAAQ;IACzE;IAEO,aAAa,QAAiB,EAAQ;QACzC,IAAI,CAAC,KAAK,CAAC,WAAW,CAAC;IAC3B;IAEO,qBAA8B;QACjC,OAAO,IAAI,CAAC,iBAAiB;IACjC;IAEO,eAAoB;QACvB,OAAO,IAAI,CAAC,KAAK;IACrB;AACJ"}},
    {"offset": {"line": 541, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Michael/IdeaProjects/MSMTB/src/trading-cockpit/src/components/charts/widgets/adapters/HorizontalLineAdapter.ts"],"sourcesContent":["import { IChartShape, TimePoint, EntityId } from '../api';\r\nimport { HorizontalLineWidget } from '../HorizontalLineWidget';\r\nimport { v4 as uuidv4 } from 'uuid';\r\n\r\nexport class HorizontalLineAdapter implements IChartShape {\r\n    public id: EntityId;\r\n    public name: string;\r\n\r\n    private _tool: HorizontalLineWidget;\r\n    private _selectionEnabled: boolean = true;\r\n\r\n    constructor(tool: HorizontalLineWidget) {\r\n        this.id = uuidv4();\r\n        this.name = 'horizontal_line';\r\n        this._tool = tool;\r\n    }\r\n\r\n    public getPoints(): TimePoint[] {\r\n        const data = this._tool.getData();\r\n        // Return a dummy time for point representation, as line is infinite\r\n        return [\r\n            { time: 0, price: data.price }\r\n        ];\r\n    }\r\n\r\n    public setPoints(points: TimePoint[]): void {\r\n        if (points.length < 1) return;\r\n        this._tool.updatePoint('body', { time: points[0].time as number, price: points[0].price });\r\n        this._tool.setSelected(this._tool.getState() === 'selected');\r\n    }\r\n\r\n    public getProperties(): Record<string, any> {\r\n        const data = this._tool.getData();\r\n        return {\r\n            \"linetoolhorizontalline.linecolor\": data.color,\r\n            \"linetoolhorizontalline.linewidth\": data.width,\r\n            \"linetoolhorizontalline.linestyle\": data.lineStyle,\r\n            \"linetoolhorizontalline.showLabel\": data.showLabel\r\n        };\r\n    }\r\n\r\n    public setProperties(props: Record<string, any>): void {\r\n        const data = this._tool.getData();\r\n        if (props[\"linetoolhorizontalline.linecolor\"]) data.color = props[\"linetoolhorizontalline.linecolor\"];\r\n        if (props[\"linetoolhorizontalline.linewidth\"]) data.width = props[\"linetoolhorizontalline.linewidth\"];\r\n        if (typeof props[\"linetoolhorizontalline.linestyle\"] !== 'undefined') data.lineStyle = props[\"linetoolhorizontalline.linestyle\"];\r\n        if (typeof props[\"linetoolhorizontalline.showLabel\"] !== 'undefined') data.showLabel = props[\"linetoolhorizontalline.showLabel\"];\r\n\r\n        this._tool.setSelected(this._tool.getState() === 'selected');\r\n    }\r\n\r\n    public setSelection(selected: boolean): void {\r\n        this._tool.setSelected(selected);\r\n    }\r\n\r\n    public isSelectionEnabled(): boolean {\r\n        return this._selectionEnabled;\r\n    }\r\n\r\n    public getPrimitive(): any {\r\n        return this._tool;\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;AAEA;;AAEO,MAAM;IACF,GAAa;IACb,KAAa;IAEZ,MAA4B;IAC5B,oBAA6B,KAAK;IAE1C,YAAY,IAA0B,CAAE;QACpC,IAAI,CAAC,EAAE,GAAG,IAAA,4KAAM;QAChB,IAAI,CAAC,IAAI,GAAG;QACZ,IAAI,CAAC,KAAK,GAAG;IACjB;IAEO,YAAyB;QAC5B,MAAM,OAAO,IAAI,CAAC,KAAK,CAAC,OAAO;QAC/B,oEAAoE;QACpE,OAAO;YACH;gBAAE,MAAM;gBAAG,OAAO,KAAK,KAAK;YAAC;SAChC;IACL;IAEO,UAAU,MAAmB,EAAQ;QACxC,IAAI,OAAO,MAAM,GAAG,GAAG;QACvB,IAAI,CAAC,KAAK,CAAC,WAAW,CAAC,QAAQ;YAAE,MAAM,MAAM,CAAC,EAAE,CAAC,IAAI;YAAY,OAAO,MAAM,CAAC,EAAE,CAAC,KAAK;QAAC;QACxF,IAAI,CAAC,KAAK,CAAC,WAAW,CAAC,IAAI,CAAC,KAAK,CAAC,QAAQ,OAAO;IACrD;IAEO,gBAAqC;QACxC,MAAM,OAAO,IAAI,CAAC,KAAK,CAAC,OAAO;QAC/B,OAAO;YACH,oCAAoC,KAAK,KAAK;YAC9C,oCAAoC,KAAK,KAAK;YAC9C,oCAAoC,KAAK,SAAS;YAClD,oCAAoC,KAAK,SAAS;QACtD;IACJ;IAEO,cAAc,KAA0B,EAAQ;QACnD,MAAM,OAAO,IAAI,CAAC,KAAK,CAAC,OAAO;QAC/B,IAAI,KAAK,CAAC,mCAAmC,EAAE,KAAK,KAAK,GAAG,KAAK,CAAC,mCAAmC;QACrG,IAAI,KAAK,CAAC,mCAAmC,EAAE,KAAK,KAAK,GAAG,KAAK,CAAC,mCAAmC;QACrG,IAAI,OAAO,KAAK,CAAC,mCAAmC,KAAK,aAAa,KAAK,SAAS,GAAG,KAAK,CAAC,mCAAmC;QAChI,IAAI,OAAO,KAAK,CAAC,mCAAmC,KAAK,aAAa,KAAK,SAAS,GAAG,KAAK,CAAC,mCAAmC;QAEhI,IAAI,CAAC,KAAK,CAAC,WAAW,CAAC,IAAI,CAAC,KAAK,CAAC,QAAQ,OAAO;IACrD;IAEO,aAAa,QAAiB,EAAQ;QACzC,IAAI,CAAC,KAAK,CAAC,WAAW,CAAC;IAC3B;IAEO,qBAA8B;QACjC,OAAO,IAAI,CAAC,iBAAiB;IACjC;IAEO,eAAoB;QACvB,OAAO,IAAI,CAAC,KAAK;IACrB;AACJ"}},
    {"offset": {"line": 609, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Michael/IdeaProjects/MSMTB/src/trading-cockpit/src/components/charts/widgets/adapters/HorizontalRayAdapter.ts"],"sourcesContent":["import { IChartShape, TimePoint, EntityId } from '../api';\r\nimport { HorizontalRayWidget } from '../HorizontalRayWidget';\r\nimport { v4 as uuidv4 } from 'uuid';\r\n\r\nexport class HorizontalRayAdapter implements IChartShape {\r\n    public id: EntityId;\r\n    public name: string;\r\n\r\n    private _tool: HorizontalRayWidget;\r\n    private _selectionEnabled: boolean = true;\r\n\r\n    constructor(tool: HorizontalRayWidget) {\r\n        this.id = uuidv4();\r\n        this.name = 'horizontal_ray';\r\n        this._tool = tool;\r\n    }\r\n\r\n    public getPoints(): TimePoint[] {\r\n        const data = this._tool.getData();\r\n        return [\r\n            { time: data.time, price: data.price }\r\n        ];\r\n    }\r\n\r\n    public setPoints(points: TimePoint[]): void {\r\n        if (points.length < 1) return;\r\n        this._tool.updatePoint('anchor', { time: points[0].time as number, price: points[0].price });\r\n        this._tool.setSelected(this._tool.getState() === 'selected');\r\n    }\r\n\r\n    public getProperties(): Record<string, any> {\r\n        const data = this._tool.getData();\r\n        return {\r\n            \"linetoolhorizontalray.linecolor\": data.color,\r\n            \"linetoolhorizontalray.linewidth\": data.width\r\n        };\r\n    }\r\n\r\n    public setProperties(props: Record<string, any>): void {\r\n        const data = this._tool.getData();\r\n        if (props[\"linetoolhorizontalray.linecolor\"]) data.color = props[\"linetoolhorizontalray.linecolor\"];\r\n        if (props[\"linetoolhorizontalray.linewidth\"]) data.width = props[\"linetoolhorizontalray.linewidth\"];\r\n\r\n        this._tool.setSelected(this._tool.getState() === 'selected');\r\n    }\r\n\r\n    public setSelection(selected: boolean): void {\r\n        this._tool.setSelected(selected);\r\n    }\r\n\r\n    public isSelectionEnabled(): boolean {\r\n        return this._selectionEnabled;\r\n    }\r\n\r\n    public getPrimitive(): any {\r\n        return this._tool;\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;AAEA;;AAEO,MAAM;IACF,GAAa;IACb,KAAa;IAEZ,MAA2B;IAC3B,oBAA6B,KAAK;IAE1C,YAAY,IAAyB,CAAE;QACnC,IAAI,CAAC,EAAE,GAAG,IAAA,4KAAM;QAChB,IAAI,CAAC,IAAI,GAAG;QACZ,IAAI,CAAC,KAAK,GAAG;IACjB;IAEO,YAAyB;QAC5B,MAAM,OAAO,IAAI,CAAC,KAAK,CAAC,OAAO;QAC/B,OAAO;YACH;gBAAE,MAAM,KAAK,IAAI;gBAAE,OAAO,KAAK,KAAK;YAAC;SACxC;IACL;IAEO,UAAU,MAAmB,EAAQ;QACxC,IAAI,OAAO,MAAM,GAAG,GAAG;QACvB,IAAI,CAAC,KAAK,CAAC,WAAW,CAAC,UAAU;YAAE,MAAM,MAAM,CAAC,EAAE,CAAC,IAAI;YAAY,OAAO,MAAM,CAAC,EAAE,CAAC,KAAK;QAAC;QAC1F,IAAI,CAAC,KAAK,CAAC,WAAW,CAAC,IAAI,CAAC,KAAK,CAAC,QAAQ,OAAO;IACrD;IAEO,gBAAqC;QACxC,MAAM,OAAO,IAAI,CAAC,KAAK,CAAC,OAAO;QAC/B,OAAO;YACH,mCAAmC,KAAK,KAAK;YAC7C,mCAAmC,KAAK,KAAK;QACjD;IACJ;IAEO,cAAc,KAA0B,EAAQ;QACnD,MAAM,OAAO,IAAI,CAAC,KAAK,CAAC,OAAO;QAC/B,IAAI,KAAK,CAAC,kCAAkC,EAAE,KAAK,KAAK,GAAG,KAAK,CAAC,kCAAkC;QACnG,IAAI,KAAK,CAAC,kCAAkC,EAAE,KAAK,KAAK,GAAG,KAAK,CAAC,kCAAkC;QAEnG,IAAI,CAAC,KAAK,CAAC,WAAW,CAAC,IAAI,CAAC,KAAK,CAAC,QAAQ,OAAO;IACrD;IAEO,aAAa,QAAiB,EAAQ;QACzC,IAAI,CAAC,KAAK,CAAC,WAAW,CAAC;IAC3B;IAEO,qBAA8B;QACjC,OAAO,IAAI,CAAC,iBAAiB;IACjC;IAEO,eAAoB;QACvB,OAAO,IAAI,CAAC,KAAK;IACrB;AACJ"}},
    {"offset": {"line": 672, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Michael/IdeaProjects/MSMTB/src/trading-cockpit/src/components/charts/widgets/MagnetService.ts"],"sourcesContent":["import { ISeriesApi, ITimeScaleApi, SeriesType, Time } from 'lightweight-charts';\r\nimport { Point } from './types';\r\n\r\nexport type MagnetMode = 'OFF' | 'WEAK' | 'STRONG';\r\n\r\nexport interface AnchorInfo {\r\n    time: number;\r\n    price: number;\r\n    type: 'open' | 'high' | 'low' | 'close';\r\n    timeframe: string;\r\n    timeString?: string;\r\n    label?: string; // H, L, BH, BL\r\n}\r\n\r\nexport interface SnapResult extends Point {\r\n    snapped: boolean;\r\n    anchor?: AnchorInfo;\r\n}\r\n\r\n/**\r\n * MagnetService handles snapping logic to OHLC values.\r\n */\r\nexport class MagnetService {\r\n    private static mode: MagnetMode = 'WEAK';\r\n    private static snapRadius: number = 20; // pixels\r\n    private static listeners: ((mode: MagnetMode) => void)[] = [];\r\n\r\n    /**\r\n     * Set the magnet mode.\r\n     */\r\n    public static setMode(mode: MagnetMode): void {\r\n        this.mode = mode;\r\n        this.listeners.forEach(l => l(mode));\r\n    }\r\n\r\n    public static getMode(): MagnetMode {\r\n        return this.mode;\r\n    }\r\n\r\n    public static subscribe(listener: (mode: MagnetMode) => void): () => void {\r\n        this.listeners.push(listener);\r\n        return () => {\r\n            this.listeners = this.listeners.filter(l => l !== listener);\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Set the snapping radius in pixels.\r\n     */\r\n    public static setSnapRadius(radius: number): void {\r\n        this.snapRadius = radius;\r\n    }\r\n\r\n    /**\r\n     * Snap a pixel coordinate to the nearest OHLC value of the candle under the mouse.\r\n     */\r\n    public static snap(\r\n        mouseX: number,\r\n        mouseY: number,\r\n        series: ISeriesApi<SeriesType>,\r\n        data: any[], // CandlestickData[]\r\n        timeScale: ITimeScaleApi<Time>,\r\n        timeframe: string\r\n    ): SnapResult {\r\n        if (this.mode === 'OFF' || !data || data.length === 0) {\r\n            return { x: mouseX, y: mouseY, snapped: false };\r\n        }\r\n\r\n        // 1. Coordinate Conversion: Find candle index\r\n        const logical = timeScale.coordinateToLogical(mouseX as any);\r\n        if (logical === null) return { x: mouseX, y: mouseY, snapped: false };\r\n\r\n        const index = Math.round(logical);\r\n        const candle = data[index]; // Note: data index might not match logical if there are holes, \r\n        // but for most implementations it's safe or needs offset adjustment.\r\n        // In Lightweight Charts, logical index usually maps to data index for the main series.\r\n\r\n        if (!candle) return { x: mouseX, y: mouseY, snapped: false };\r\n\r\n        // 2. Data Retrieval: O,H,L,C\r\n        const prices = [candle.open, candle.high, candle.low, candle.close];\r\n\r\n        let bestY = mouseY;\r\n        let minDistance = Infinity;\r\n        let foundSnap = false;\r\n        let bestType: 'open' | 'high' | 'low' | 'close' = 'close';\r\n\r\n        // 3. Screen Mapping: Convert prices to Y-coordinates\r\n        // We iterate specifically to track the type\r\n        const priceMap: { type: 'open' | 'high' | 'low' | 'close', val: number }[] = [\r\n            { type: 'open', val: candle.open },\r\n            { type: 'high', val: candle.high },\r\n            { type: 'low', val: candle.low },\r\n            { type: 'close', val: candle.close }\r\n        ];\r\n\r\n        for (const p of priceMap) {\r\n            const py = series.priceToCoordinate(p.val);\r\n            if (py === null) continue;\r\n\r\n            const dist = Math.abs(mouseY - py);\r\n            if (dist < minDistance) {\r\n                minDistance = dist;\r\n                bestY = py;\r\n                foundSnap = true;\r\n                bestType = p.type;\r\n            }\r\n        }\r\n\r\n        // 4. Mode Logic\r\n        if (this.mode === 'WEAK' && minDistance > this.snapRadius) {\r\n            return { x: mouseX, y: mouseY, snapped: false };\r\n        }\r\n\r\n        // Snap X to the center of the candle\r\n        const snappedX = timeScale.logicalToCoordinate(index as any) ?? mouseX;\r\n\r\n        // Determine Label (H, L, BH, BL)\r\n        let label = '';\r\n        if (bestType === 'high') label = 'H';\r\n        else if (bestType === 'low') label = 'L';\r\n        else {\r\n            // Body Logic - Independent of Color\r\n            // Body High = Max(Open, Close)\r\n            // Body Low = Min(Open, Close)\r\n\r\n            const snappedPrice = series.coordinateToPrice(bestY) ?? candle.close;\r\n            const bodyTop = Math.max(candle.open, candle.close);\r\n            const bodyBottom = Math.min(candle.open, candle.close);\r\n\r\n            // Allow small epsilon for floating point comparison if needed, \r\n            // but strict comparison usually works with snap\r\n            const distTop = Math.abs(snappedPrice - bodyTop);\r\n            const distBottom = Math.abs(snappedPrice - bodyBottom);\r\n\r\n            if (distTop < distBottom) {\r\n                label = 'BH';\r\n            } else {\r\n                label = 'BL';\r\n            }\r\n        }\r\n\r\n        return {\r\n            x: snappedX,\r\n            y: bestY,\r\n            snapped: foundSnap,\r\n            anchor: foundSnap ? {\r\n                time: candle.time as number,\r\n                price: series.coordinateToPrice(bestY) ?? candle.close,\r\n                type: bestType,\r\n                timeframe: timeframe,\r\n                label: label, // NEW: Pre-calculated label\r\n                timeString: new Date((candle.time as number) * 1000).toISOString().substr(11, 8) // HH:mm:ss for testing\r\n            } : undefined\r\n        };\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 821, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Michael/IdeaProjects/MSMTB/src/trading-cockpit/src/components/charts/widgets/InteractiveChartObject.ts"],"sourcesContent":["import {\r\n    ISeriesPrimitive,\r\n    SeriesAttachedParameter,\r\n    IChartApi,\r\n    ISeriesApi,\r\n    SeriesType,\r\n    Time,\r\n    Coordinate,\r\n    IPrimitivePaneRenderer,\r\n    IPrimitivePaneView,\r\n    PrimitiveHoveredItem\r\n} from 'lightweight-charts';\r\nimport { Point } from './types';\r\nimport { MagnetService, AnchorInfo } from './MagnetService';\r\n\r\nexport interface Handle {\r\n    id: string;\r\n    time: number;\r\n    price: number;\r\n    axisLock?: 'free' | 'horizontal_only' | 'vertical_only';\r\n    cursor?: string;\r\n}\r\n\r\nexport interface SettingField {\r\n    id: string;\r\n    label: string;\r\n    type: 'color' | 'number' | 'boolean' | 'select' | 'text';\r\n    value: any;\r\n    options?: string[]; // For select inputs\r\n}\r\n\r\n/**\r\n * Abstract base class for professional interactive chart tools.\r\n * Handles selection, handle rendering, and magnet logic automatically.\r\n */\r\nexport abstract class InteractiveChartObject implements ISeriesPrimitive {\r\n    protected _chart: IChartApi | null = null;\r\n    protected _series: ISeriesApi<SeriesType> | null = null;\r\n    protected _requestUpdate: (() => void) | null = null;\r\n\r\n    protected _isSelected: boolean = false;\r\n    protected _isHovered: boolean = false;\r\n    protected _isDragging: boolean = false;\r\n    protected _dragTarget: string | null = null;\r\n    protected _dragStartPoint: Point | null = null;\r\n    protected _seriesData: any[] = [];\r\n\r\n    private _lastClickTime: number = 0;\r\n    private _lastClickTarget: string | null = null;\r\n\r\n    private _lastProcessedX: number = -1;\r\n    private _lastProcessedY: number = -1;\r\n\r\n    protected _paneViews: InteractiveObjectPaneView[];\r\n    protected _timeframe: string = 'D1'; // Default, should be updated by ChartWidget\r\n\r\n    constructor() {\r\n        this._paneViews = [new InteractiveObjectPaneView(this)];\r\n    }\r\n\r\n    public setTimeframe(tf: string) {\r\n        this._timeframe = tf;\r\n    }\r\n\r\n    // --- Abstract API for Subclasses ---\r\n\r\n    /**\r\n     * Define the tool's interactive points.\r\n     */\r\n    public abstract getHandles(): Handle[];\r\n\r\n    /**\r\n     * Called when a point is moved (dragged).\r\n     * @param handleId - The ID of the handle being moved.\r\n     * @param newPoint - The snapped/constrained time and price.\r\n     */\r\n    public abstract updatePoint(handleId: string, newPoint: { time: number, price: number, anchor?: AnchorInfo }): void;\r\n\r\n    /**\r\n     * Called when an object part is double-clicked.\r\n     */\r\n    public onDoubleClick(handleId: string): void {\r\n        // Default implementation does nothing\r\n    }\r\n\r\n    /**\r\n     * Called when an object part is single-clicked.\r\n     */\r\n    public onClick(handleId: string): void {\r\n        // Default implementation does nothing\r\n    }\r\n\r\n    /**\r\n     * Implement the visual appearance of the tool.\r\n     * Super class handles selection highlights and anchor circles.\r\n     */\r\n    public abstract drawShape(ctx: CanvasRenderingContext2D): void;\r\n\r\n    /**\r\n     * Returns the schema for the settings dialog.\r\n     */\r\n    public getSettingsSchema(): SettingField[] {\r\n        return [];\r\n    }\r\n\r\n    /**\r\n     * Applies new settings to the tool.\r\n     */\r\n    public applySettings(settings: any): void {\r\n        // Default implementation does nothing\r\n    }\r\n\r\n    // --- ISeriesPrimitive Implementation ---\r\n\r\n    public attached(param: SeriesAttachedParameter<Time>): void {\r\n        this._chart = param.chart;\r\n        this._series = param.series;\r\n        this._requestUpdate = param.requestUpdate;\r\n\r\n        const container = this._chart.chartElement();\r\n        container.addEventListener('mousedown', this._onMouseDown);\r\n        container.addEventListener('mousemove', this._onMouseMove);\r\n        container.addEventListener('mouseup', this._onMouseUp);\r\n        container.addEventListener('mouseleave', this._onMouseUp);\r\n        document.addEventListener('keydown', this._onKeyDown);\r\n    }\r\n\r\n    public detached(): void {\r\n        try {\r\n            if (this._chart) {\r\n                const container = this._chart.chartElement();\r\n                container.removeEventListener('mousedown', this._onMouseDown);\r\n                container.removeEventListener('mousemove', this._onMouseMove);\r\n                container.removeEventListener('mouseup', this._onMouseUp);\r\n                container.removeEventListener('mouseleave', this._onMouseUp);\r\n            }\r\n        } catch (e) {\r\n            // Chart likely disposed already\r\n            console.warn('[InteractiveChartObject] Failed to cleanup listeners (chart disposed):', e);\r\n        }\r\n        document.removeEventListener('keydown', this._onKeyDown);\r\n        this._chart = null;\r\n        this._series = null;\r\n        this._requestUpdate = null;\r\n    }\r\n\r\n    public paneViews() {\r\n        return this._paneViews;\r\n    }\r\n\r\n    // --- Selection API ---\r\n\r\n    public setSelected(selected: boolean) {\r\n        this._isSelected = selected;\r\n        this._requestUpdate?.();\r\n    }\r\n\r\n    public isSelected(): boolean {\r\n        return this._isSelected;\r\n    }\r\n\r\n    public getState(): 'idle' | 'hover' | 'selected' | 'drag' {\r\n        if (this._isDragging) return 'drag';\r\n        if (this._isSelected) return 'selected';\r\n        if (this._isHovered) return 'hover';\r\n        return 'idle';\r\n    }\r\n\r\n    public setSeriesData(data: any[]) {\r\n        this._seriesData = data;\r\n    }\r\n\r\n    // --- Hit Testing ---\r\n\r\n    public hitTest(x: number, y: number): PrimitiveHoveredItem | null {\r\n        if (!this._chart || !this._series) return null;\r\n        const point = { x, y };\r\n\r\n        // 1. Check Handles (Highest Priority)\r\n        // We check handles even if not selected to allow immediate handle interaction/selection\r\n        const handles = this.getHandles();\r\n        for (const h of handles) {\r\n            const hx = this._chart.timeScale().timeToCoordinate(h.time as Time);\r\n            const hy = this._series.priceToCoordinate(h.price);\r\n            if (hx !== null && hy !== null) {\r\n                const dist = Math.sqrt(Math.pow(point.x - hx, 2) + Math.pow(point.y - hy, 2));\r\n                if (dist <= 10) return { externalId: h.id, zOrder: 'top' }; // Increased radius slightly to 10\r\n            }\r\n        }\r\n\r\n        // 2. Check Body (Subclasses provide custom hit test implementation or we could default to drawShape pixel check?)\r\n        // For simplicity and to match the prompt, we'll assume hitTest is managed by the Tool for now, \r\n        // but the prompt said \"Do NOT implement hit-testing... manually\". \r\n        // This might imply the base class should handle it based on the shape.\r\n        // However, without a path logic, we'll keep it simple: if it's not a handle, we'll rely on the Tool's own check if provided.\r\n        if (this.hitTestBody(point)) {\r\n            return { externalId: 'body', zOrder: 'top' };\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    /**\r\n     * Subclasses can override for custom body hit detection.\r\n     */\r\n    protected hitTestBody(point: Point): boolean {\r\n        return false;\r\n    }\r\n\r\n    // --- Internal Logic ---\r\n\r\n    private _onMouseDown = (e: MouseEvent) => {\r\n        const point = this._getPoint(e);\r\n        const hit = this.hitTest(point.x, point.y);\r\n\r\n        const now = Date.now();\r\n        const doubleClickDelay = 400; // Increased to 400ms\r\n\r\n        if (hit) {\r\n            // Manual Double Click Detection\r\n            if (hit.externalId === this._lastClickTarget && (now - this._lastClickTime) < doubleClickDelay) {\r\n                console.log(`[InteractiveChartObject] Manual Double Click Detected on: ${hit.externalId}`);\r\n                this.onDoubleClick(hit.externalId);\r\n                this._lastClickTime = 0; // Reset\r\n                this._lastClickTarget = null;\r\n                return; // Don't start drag on double click fix toggle\r\n            }\r\n\r\n            this._lastClickTime = now;\r\n            this._lastClickTarget = hit.externalId;\r\n\r\n            // Also notify of single click (can be used for selection or actions)\r\n            this.onClick(hit.externalId);\r\n\r\n            this._isDragging = true;\r\n            this._dragTarget = hit.externalId;\r\n            this._dragStartPoint = point;\r\n            this.setSelected(true);\r\n            this._chart?.applyOptions({ handleScroll: false, handleScale: false });\r\n        } else {\r\n            if (this._isSelected) this.setSelected(false);\r\n            this._lastClickTime = 0;\r\n            this._lastClickTarget = null;\r\n        }\r\n    }\r\n\r\n\r\n    private _onMouseMove = (e: MouseEvent) => {\r\n        if (!this._chart || !this._series) return;\r\n        const point = this._getPoint(e);\r\n\r\n        // 1. Performance Guard: Only process if mouse actually moved significant distance (e.g. 1px)\r\n        const dx = Math.abs(point.x - this._lastProcessedX);\r\n        const dy = Math.abs(point.y - this._lastProcessedY);\r\n        if (dx < 0.5 && dy < 0.5) return;\r\n\r\n        this._lastProcessedX = point.x;\r\n        this._lastProcessedY = point.y;\r\n\r\n        if (this._isDragging && this._dragTarget && this._dragStartPoint) {\r\n            const timeScale = this._chart.timeScale();\r\n            const series = this._series;\r\n\r\n            // 2. Magnet Snapping (Use RAW point for remote snapping)\r\n            const snapped = MagnetService.snap(\r\n                point.x,\r\n                point.y,\r\n                series,\r\n                this._seriesData,\r\n                timeScale,\r\n                this._timeframe\r\n            );\r\n\r\n            // 3. Constrain by Axis Lock AFTER snapping\r\n            let finalX = snapped.x;\r\n            let finalY = snapped.y;\r\n\r\n            if (this._dragTarget !== 'body' && this._dragTarget !== null) {\r\n                const handle = this.getHandles().find(h => h.id === this._dragTarget);\r\n                if (handle) {\r\n                    if (handle.axisLock === 'vertical_only') {\r\n                        // Keep time constant: Use the coordinate of the handle's logical time\r\n                        const handleX = timeScale.timeToCoordinate(handle.time as Time);\r\n                        if (handleX !== null) finalX = handleX;\r\n                    }\r\n                    if (handle.axisLock === 'horizontal_only') {\r\n                        // Keep price constant\r\n                        const handleY = series.priceToCoordinate(handle.price);\r\n                        if (handleY !== null) finalY = handleY;\r\n                    }\r\n                }\r\n            }\r\n\r\n            const time = timeScale.coordinateToTime(finalX);\r\n            const price = series.coordinateToPrice(finalY);\r\n\r\n            if (time && price !== null) {\r\n                this.updatePoint(this._dragTarget, { time: time as number, price, anchor: snapped.anchor });\r\n                this._requestUpdate?.();\r\n            }\r\n            return;\r\n        }\r\n\r\n        const hoverHit = this.hitTest(point.x, point.y);\r\n        this._isHovered = !!hoverHit;\r\n\r\n        if (hoverHit) {\r\n            let cursor = 'default';\r\n            if (hoverHit.externalId === 'body') {\r\n                cursor = 'move';\r\n            } else {\r\n                const handle = this.getHandles().find(h => h.id === hoverHit.externalId);\r\n                cursor = handle?.cursor || 'pointer';\r\n            }\r\n            this._chart.chartElement().style.cursor = cursor;\r\n        } else {\r\n            // Reset cursor when not hovering this object\r\n            const container = this._chart.chartElement();\r\n            if (container.style.cursor !== '' && container.style.cursor !== 'auto') {\r\n                container.style.cursor = '';\r\n            }\r\n        }\r\n    }\r\n\r\n    private _onMouseUp = () => {\r\n        if (this._isDragging) {\r\n            this._isDragging = false;\r\n            this._dragTarget = null;\r\n            this._chart?.applyOptions({ handleScroll: true, handleScale: true });\r\n        }\r\n    }\r\n\r\n    public onRemove?: () => void;\r\n\r\n    private _onKeyDown = (e: KeyboardEvent) => {\r\n        if (this._isSelected && (e.key === 'Delete' || e.key === 'Backspace')) {\r\n            if (this.onRemove) {\r\n                this.onRemove();\r\n            } else {\r\n                this._series?.detachPrimitive(this);\r\n            }\r\n        }\r\n    }\r\n\r\n    private _getPoint(e: MouseEvent): Point {\r\n        const rect = (e.currentTarget as HTMLElement).getBoundingClientRect();\r\n        return { x: e.clientX - rect.left, y: e.clientY - rect.top };\r\n    }\r\n\r\n    // --- Renderer Helpers ---\r\n    public getSelectionState() { return { selected: this._isSelected, hovered: this._isHovered }; }\r\n    public getDragState() { return { isDragging: this._isDragging, dragTarget: this._dragTarget }; }\r\n\r\n    public getHandlesList(): Handle[] {\r\n        return this.getHandles();\r\n    }\r\n\r\n    /**\r\n     * Safely retrieves a coordinate for a time, even if the exact time point doesn't exist in the current timeframe data.\r\n     * Strategies:\r\n     * 1. Direct Lookup (Fastest)\r\n     * 2. Snap to previous available bar (for zoom-outs)\r\n     * 3. Handle off-screen to the left (returns -Coordinate)\r\n     */\r\n    protected getSafeTimeCoordinate(targetTime: number): number | null {\r\n        if (!this._chart) return null;\r\n        const timeScale = this._chart.timeScale();\r\n\r\n        // 1. Try direct lookup\r\n        const x = timeScale.timeToCoordinate(targetTime as Time);\r\n        if (x !== null) return x;\r\n\r\n        // 2. Fallback: Find closest valid time in series data\r\n        if (!this._seriesData || this._seriesData.length === 0) return null;\r\n\r\n        // Binary search for closest time <= targetTime\r\n        let low = 0;\r\n        let high = this._seriesData.length - 1;\r\n        let closestIndex = -1;\r\n\r\n        while (low <= high) {\r\n            const mid = Math.floor((low + high) / 2);\r\n            const item = this._seriesData[mid];\r\n            const midTime = typeof item.time === 'number' ? item.time : (item.time as any).value || item.time; // Handle diverse time formats\r\n\r\n            if (midTime === targetTime) {\r\n                closestIndex = mid;\r\n                break;\r\n            } else if (midTime < targetTime) {\r\n                closestIndex = mid; // Candidate\r\n                low = mid + 1;\r\n            } else {\r\n                high = mid - 1;\r\n            }\r\n        }\r\n\r\n        if (closestIndex !== -1) {\r\n            const closestItem = this._seriesData[closestIndex];\r\n            const closestTime = typeof closestItem.time === 'number' ? closestItem.time : closestItem.time;\r\n            return timeScale.timeToCoordinate(closestTime as Time);\r\n        }\r\n\r\n        // 3. Fallback for off-screen left (older than all data)\r\n        // If targetTime is smaller than the first data point, return a negative coordinate\r\n        // We can estimate based on index or just return a safe off-screen number\r\n        const firstItem = this._seriesData[0];\r\n        const firstTime = typeof firstItem.time === 'number' ? firstItem.time : firstItem.time;\r\n        if (targetTime < firstTime) {\r\n            // Return a safe off-screen coordinate. \r\n            // In LWC, negative coordinates are to the left.\r\n            // We can ask LWC for the coordinate of the first item and subtract.\r\n            const firstX = timeScale.timeToCoordinate(firstTime as Time);\r\n            if (firstX !== null) {\r\n                return firstX - 1000; // Arbitrary safe distance\r\n            }\r\n        }\r\n\r\n        return null;\r\n    }\r\n}\r\n\r\nclass InteractiveObjectRenderer implements IPrimitivePaneRenderer {\r\n    constructor(private _source: InteractiveChartObject) { }\r\n\r\n    draw(target: any) {\r\n        target.useMediaCoordinateSpace((scope: any) => {\r\n            const ctx = scope.context;\r\n            this._source.drawShape(ctx);\r\n\r\n            const chart = (this._source as any)._chart;\r\n            const series = (this._source as any)._series;\r\n            if (!chart || !series) return;\r\n\r\n            const { selected } = this._source.getSelectionState();\r\n            const { isDragging, dragTarget } = this._source.getDragState();\r\n\r\n            // 1. Draw Drag Guidelines (Full-width dotted line)\r\n            if (isDragging && dragTarget && dragTarget !== 'body') {\r\n                const handles = this._source.getHandles();\r\n                const activeHandle = handles.find(h => h.id === dragTarget);\r\n\r\n                // Only show guidelines for horizontal levels (axisLock is vertical_only)\r\n                if (activeHandle && activeHandle.axisLock === 'vertical_only') {\r\n                    const y = series.priceToCoordinate(activeHandle.price);\r\n                    if (y !== null) {\r\n                        ctx.save();\r\n                        ctx.setLineDash([4, 4]);\r\n                        ctx.strokeStyle = 'rgba(51, 65, 85, 0.9)'; // Darker Slate (Slate-700 approx)\r\n                        ctx.lineWidth = 1;\r\n                        ctx.beginPath();\r\n                        ctx.moveTo(0, y);\r\n                        ctx.lineTo(scope.mediaSize.width, y);\r\n                        ctx.stroke();\r\n                        ctx.restore();\r\n                    }\r\n                }\r\n            }\r\n\r\n            // 2. Draw Handles if selected or hovered\r\n            if (selected || (this._source as any)._isHovered) {\r\n                const handles = this._source.getHandles();\r\n                for (const h of handles) {\r\n                    const x = chart.timeScale().timeToCoordinate(h.time as Time);\r\n                    const y = series.priceToCoordinate(h.price);\r\n                    if (x !== null && y !== null) {\r\n                        this._drawAnchor(ctx, x, y);\r\n                    }\r\n                }\r\n            }\r\n        });\r\n    }\r\n\r\n    private _drawAnchor(ctx: CanvasRenderingContext2D, x: number, y: number) {\r\n        ctx.beginPath();\r\n        ctx.arc(x, y, 5, 0, Math.PI * 2);\r\n        ctx.fillStyle = '#FFFFFF';\r\n        ctx.fill();\r\n        ctx.strokeStyle = '#000000';\r\n        ctx.lineWidth = 1;\r\n        ctx.stroke();\r\n    }\r\n}\r\n\r\nclass InteractiveObjectPaneView implements IPrimitivePaneView {\r\n    private _renderer: InteractiveObjectRenderer;\r\n    constructor(source: InteractiveChartObject) {\r\n        this._renderer = new InteractiveObjectRenderer(source);\r\n    }\r\n    renderer() { return this._renderer; }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1229, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Michael/IdeaProjects/MSMTB/src/trading-cockpit/src/components/charts/widgets/LongShortCalculator.ts"],"sourcesContent":["export type FixedLeg = 'tp' | 'sl' | 'rr';\r\n\r\nexport interface LongShortParams {\r\n    entryPrice: number;\r\n    stopLossPrice: number;\r\n    takeProfitPrice: number;\r\n    riskReward: number;\r\n    fixedStates: {\r\n        tp: boolean;\r\n        sl: boolean;\r\n        entry: boolean;\r\n        rr: boolean;\r\n    };\r\n}\r\n\r\nexport class LongShortCalculator {\r\n    /**\r\n     * Calculates the missing value based on which leg is fixed.\r\n     */\r\n    public static recalculate(\r\n        params: LongShortParams,\r\n        changedId: 'tp' | 'sl' | 'entry' | 'rr',\r\n        isLong: boolean\r\n    ): LongShortParams {\r\n        const result = { ...params };\r\n        const { tp: tpFixed, sl: slFixed, rr: rrFixed } = params.fixedStates;\r\n\r\n        if (changedId === 'entry') {\r\n            if (rrFixed) {\r\n                // If SL is fixed, update TP. If TP is fixed, update SL. \r\n                // If neither/both, prioritize updating TP from fixed SL distance.\r\n                if (slFixed && tpFixed) {\r\n                    // Special Case: All fixed. Move Entry implies re-calculating RR if we keep SL/TP fixed?\r\n                    // No, if Entry moves and SL/TP are fixed, RR changes.\r\n                    result.riskReward = this.calculateRR(result.entryPrice, result.stopLossPrice, result.takeProfitPrice, isLong);\r\n                }\r\n                else if (slFixed) result.takeProfitPrice = this.calculateTP(result.entryPrice, result.stopLossPrice, result.riskReward, isLong);\r\n                else if (tpFixed) result.stopLossPrice = this.calculateSL(result.entryPrice, result.takeProfitPrice, result.riskReward, isLong);\r\n                else result.takeProfitPrice = this.calculateTP(result.entryPrice, result.stopLossPrice, result.riskReward, isLong);\r\n            } else {\r\n                // RR is not fixed. Just update the ratio.\r\n                result.riskReward = this.calculateRR(result.entryPrice, result.stopLossPrice, result.takeProfitPrice, isLong);\r\n            }\r\n        } else if (changedId === 'tp') {\r\n            // EXCEPTION: If SL and TP and RR are ALL fixed, and we are moving TP,\r\n            // we must NOT move SL (violation of fixed SL). We must update RR (violation of fixed RR).\r\n            // User rule: \"fixed level must not change\" -> implied priority over RR.\r\n            if (rrFixed && slFixed && tpFixed) {\r\n                result.riskReward = this.calculateRR(result.entryPrice, result.stopLossPrice, result.takeProfitPrice, isLong);\r\n            } else if (rrFixed) {\r\n                // RR is fixed, SL must move to maintain R\r\n                result.stopLossPrice = this.calculateSL(result.entryPrice, result.takeProfitPrice, result.riskReward, isLong);\r\n            } else {\r\n                // SL or Entry is fixed (implied by dragging only TP), update RR\r\n                result.riskReward = this.calculateRR(result.entryPrice, result.stopLossPrice, result.takeProfitPrice, isLong);\r\n            }\r\n        } else if (changedId === 'sl') {\r\n            // EXCEPTION: Same as above.\r\n            if (rrFixed && slFixed && tpFixed) {\r\n                result.riskReward = this.calculateRR(result.entryPrice, result.stopLossPrice, result.takeProfitPrice, isLong);\r\n            } else if (rrFixed) {\r\n                // RR is fixed, TP must move to maintain R\r\n                result.takeProfitPrice = this.calculateTP(result.entryPrice, result.stopLossPrice, result.riskReward, isLong);\r\n            } else {\r\n                // TP or Entry is fixed, update RR\r\n                result.riskReward = this.calculateRR(result.entryPrice, result.stopLossPrice, result.takeProfitPrice, isLong);\r\n            }\r\n        } else if (changedId === 'rr') {\r\n            // Manual RR change (from settings or else)\r\n            // If SL is fixed, move TP. If TP is fixed, move SL.\r\n            if (slFixed || !tpFixed) {\r\n                result.takeProfitPrice = this.calculateTP(result.entryPrice, result.stopLossPrice, result.riskReward, isLong);\r\n            } else {\r\n                result.stopLossPrice = this.calculateSL(result.entryPrice, result.takeProfitPrice, result.riskReward, isLong);\r\n            }\r\n        }\r\n\r\n        return result;\r\n    }\r\n\r\n    public static calculateRR(entry: number, sl: number, tp: number, isLong: boolean): number {\r\n        const risk = Math.abs(entry - sl);\r\n        const reward = Math.abs(tp - entry);\r\n        if (risk === 0) return 0;\r\n\r\n        // Directional validation\r\n        const isValid = isLong ? (tp > entry && sl < entry) : (tp < entry && sl > entry);\r\n        if (!isValid) return 0;\r\n\r\n        return parseFloat((reward / risk).toFixed(2));\r\n    }\r\n\r\n    public static calculateTP(entry: number, sl: number, rr: number, isLong: boolean): number {\r\n        const risk = Math.abs(entry - sl);\r\n        const reward = risk * rr;\r\n        return isLong ? entry + reward : entry - reward;\r\n    }\r\n\r\n    public static calculateSL(entry: number, tp: number, rr: number, isLong: boolean): number {\r\n        const reward = Math.abs(entry - tp);\r\n        if (rr === 0) return entry;\r\n        const risk = reward / rr;\r\n        return isLong ? entry - risk : entry + risk;\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1319, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Michael/IdeaProjects/MSMTB/src/trading-cockpit/src/components/charts/LongShortPosition.ts"],"sourcesContent":["import { Time, PrimitiveHoveredItem } from 'lightweight-charts';\r\nimport { InteractiveChartObject, Handle } from './widgets/InteractiveChartObject';\r\nimport { Point } from './widgets/types';\r\nimport { LongShortCalculator, FixedLeg } from './widgets/LongShortCalculator';\r\nimport { AnchorInfo } from './widgets/MagnetService';\r\n\r\nimport { useWorkspaceStore } from '../../stores/useWorkspaceStore';\r\nimport { TradeLogService } from '../../services/TradeLogService';\r\n\r\nexport interface LongShortState {\r\n    entryPrice: number;\r\n    stopLossPrice: number;\r\n    takeProfitPrice: number;\r\n    timeIndex: number;\r\n    riskReward: number;\r\n    fixedLeg: FixedLeg; // Legacy - will be used as a primary fixed leg if needed, but we now support individual fixes\r\n    fixedStates: {\r\n        tp: boolean;\r\n        sl: boolean;\r\n        entry: boolean;\r\n        rr: boolean;\r\n    };\r\n    slAnchor?: AnchorInfo | null;\r\n    tpAnchor?: AnchorInfo | null;\r\n    entryAnchor?: AnchorInfo | null;\r\n    orderType: 'MARKET' | 'LIMIT';\r\n\r\n    symbol?: string;\r\n\r\n    // Parity properties\r\n    lineColor?: string;\r\n    stopColor?: string;\r\n    profitColor?: string;\r\n    fillLabelBackground?: boolean;\r\n    accountSize?: number;\r\n    riskSize?: number;\r\n    riskDisplayMode?: 'money' | 'percent';\r\n    alwaysShowStats?: boolean;\r\n    compact?: boolean;\r\n}\r\n\r\n/**\r\n * Professional Long/Short Position (Risk/Reward)\r\n */\r\nexport class LongShortPosition extends InteractiveChartObject {\r\n    private _data: LongShortState;\r\n    private _width: number = 200;\r\n    private _lastMarketPrice: number | null = null;\r\n    public onExecute?: (trade: any) => void;\r\n\r\n    constructor(initialData: LongShortState) {\r\n        super();\r\n        this._data = initialData;\r\n    }\r\n\r\n    /**\r\n     * Define the points for TP, SL, and Entry (Move).\r\n     */\r\n    public getHandles(): Handle[] {\r\n        return [\r\n            { id: 'tp', time: this._data.timeIndex, price: this._data.takeProfitPrice, axisLock: 'vertical_only', cursor: 'ns-resize' },\r\n            { id: 'sl', time: this._data.timeIndex, price: this._data.stopLossPrice, axisLock: 'vertical_only', cursor: 'ns-resize' },\r\n            { id: 'entry', time: this._data.timeIndex, price: this._data.entryPrice, axisLock: 'vertical_only', cursor: 'ns-resize' }\r\n        ];\r\n    }\r\n\r\n    public getSettingsSchema(): import('./widgets/InteractiveChartObject').SettingField[] {\r\n        return [\r\n            { id: 'riskReward', label: 'Risk Reward', type: 'number', value: this._data.riskReward },\r\n            { id: 'fixedLeg', label: 'Fixed Leg', type: 'select', value: this._data.fixedLeg, options: ['tp', 'sl', 'rr'] },\r\n            { id: 'profitColor', label: 'Profit Color', type: 'color', value: this._data.profitColor || 'rgba(20, 184, 166, 0.25)' },\r\n            { id: 'stopColor', label: 'Stop Color', type: 'color', value: this._data.stopColor || 'rgba(244, 63, 94, 0.25)' },\r\n            { id: 'lineColor', label: 'Line Color', type: 'color', value: this._data.lineColor || '#94a3b8' },\r\n            { id: 'riskSize', label: 'Risk Amount', type: 'number', value: this._data.riskSize || 0 }\r\n        ];\r\n    }\r\n\r\n\r\n    /**\r\n     * Handles dragging of any part of the tool.\r\n     */\r\n    public onDoubleClick(hitId: string): void {\r\n        console.log(`[LongShortPosition] Double click on: ${hitId}`);\r\n\r\n        // --- 1. Identify what is being toggled ---\r\n        const isRRToggle = (hitId === 'rr_panel');\r\n        const isSLToggle = (hitId === 'sl');\r\n        const isTPToggle = (hitId === 'tp');\r\n        const isEntryToggle = (hitId === 'entry');\r\n\r\n        // Capture current state BEFORE toggle\r\n        const { sl: slFixed, tp: tpFixed, rr: rrFixed, entry: entryFixed } = this._data.fixedStates;\r\n\r\n        // --- 2. Apply Toggle & Enforce Rules ---\r\n\r\n        if (isRRToggle) {\r\n            // User wants to toggle RR\r\n            const newRRState = !rrFixed;\r\n            this._data.fixedStates.rr = newRRState;\r\n\r\n            if (newRRState) {\r\n                // If turning RR ON, check conflicts\r\n                // Rule: If SL and TP are both fixed, unfix TP (per user request: \"takeprofit must resolve its fixation\")\r\n                if (slFixed && tpFixed) {\r\n                    this._data.fixedStates.tp = false;\r\n                }\r\n                // Case: Limit Mode (Entry Fixed) - If Entry, SL, RR fixed -> TP Dynamic (Automatic)\r\n            }\r\n        }\r\n        else if (isSLToggle) {\r\n            // User wants to toggle SL\r\n            const newSLState = !slFixed;\r\n            this._data.fixedStates.sl = newSLState;\r\n\r\n            if (newSLState) {\r\n                // If turning SL ON\r\n                // Rule: If TP and RR are fixed, unfix RR (per user request: \"rr must be cancelled\")\r\n                if (tpFixed && rrFixed) {\r\n                    this._data.fixedStates.rr = false;\r\n                }\r\n                // Limit Mode: Entry, RR, SL fixed -> TP Dynamic (Automatic)\r\n                // Limit Mode: Entry, TP, SL fixed -> RR Dynamic (Automatic)\r\n                // Note: If Entry+RR are fixed, and we fix SL -> We have Entry+RR+SL. TP becomes dynamic.\r\n                // But wait, user said \"is entry, tp and rr fixed and we fix sl, then rr is cancelled.\"\r\n                // My logic above handles \"TP and RR fixed\", which covers both Market and Limit (since Entry doesn't matter for this collision).\r\n            }\r\n        }\r\n        else if (isTPToggle) {\r\n            // User wants to toggle TP\r\n            const newTPState = !tpFixed;\r\n            this._data.fixedStates.tp = newTPState;\r\n\r\n            if (newTPState) {\r\n                // If turning TP ON\r\n                // Rule: If SL and RR are fixed, unfix RR (Symmetric assumption based on other rules)\r\n                // Also covers user rule for Limit: \"is entry, sl and rr fixed and we fix tp, then we cancel rr.\"\r\n                if (slFixed && rrFixed) {\r\n                    this._data.fixedStates.rr = false;\r\n                }\r\n            }\r\n        }\r\n        else if (isEntryToggle) {\r\n            // Entry Fixed State mainly meaningful for Limit Orders or \"Anchored Market\"\r\n            const newEntryState = !entryFixed;\r\n            this._data.fixedStates.entry = newEntryState;\r\n\r\n            // If user fixes the entry, it implies a specific price is desired -> Switch to LIMIT\r\n            if (newEntryState) {\r\n                this._data.orderType = 'LIMIT';\r\n            } else {\r\n                // If user unfixes the entry, revert to MARKET\r\n                this._data.orderType = 'MARKET';\r\n                // Snap to current market price immediately if available\r\n                if (this._lastMarketPrice !== null) {\r\n                    this.updateMarketPrice(this._lastMarketPrice, this._data.timeIndex);\r\n                }\r\n            }\r\n        }\r\n\r\n        // --- 3. Update Legacy & Request Render ---\r\n        this._updateFixedLegLegacy();\r\n        this._requestUpdate?.();\r\n    }\r\n\r\n    public updateMarketPrice(price: number, time: number): void {\r\n        this._lastMarketPrice = price;\r\n        // Don't auto-update if we are currently dragging this specific tool\r\n        if (this._isDragging) return;\r\n\r\n        if (this._data.orderType === 'MARKET') {\r\n            const priceDelta = price - this._data.entryPrice;\r\n            const { sl: slFixed, tp: tpFixed, rr: rrFixed } = this._data.fixedStates;\r\n\r\n            // Critical Rule: If Entry, SL, TP, and RR are ALL effectively fixed, we CANNOT move anything.\r\n            // If TP and SL and RR are fixed -> Entry is mathematically locked.\r\n            if (tpFixed && slFixed && rrFixed) {\r\n                return;\r\n            }\r\n\r\n            // Update timeIndex to track with the current candle\r\n            this._data.timeIndex = time;\r\n\r\n            // Case 1: Nothing fixed (except maybe RR) -> Shift everything (body move)\r\n            // This is \"floating\" mode where the whole structure follows the price\r\n            if (!slFixed && !tpFixed) {\r\n                this._data.entryPrice = price;\r\n                this._data.takeProfitPrice += priceDelta;\r\n                this._data.stopLossPrice += priceDelta;\r\n\r\n                // Clear anchors when floating because we are drifting away from original snap\r\n                this._data.slAnchor = null;\r\n                this._data.tpAnchor = null;\r\n                this._data.entryAnchor = null;\r\n\r\n                // Note: We don't need to call ApplyCalculations here because RR remains identical by definition of a linear shift\r\n            }\r\n            // Case 2: Something is fixed -> Use Calculator logic to squeeze/expand\r\n            else {\r\n                this.updatePoint('entry', { time: time, price: price });\r\n            }\r\n\r\n            this._requestUpdate?.();\r\n        }\r\n    }\r\n\r\n\r\n    public onClick(hitId: string): void {\r\n        // Renamed hitId logic but catching old ID just in case or using the new semantic\r\n        if (hitId === 'order_type_toggle' || hitId === 'execute_btn') {\r\n            // This button now acts as the Execute Trigger\r\n            const validation = this._validateState();\r\n            if (!validation.isValid) {\r\n                console.warn(`[LongShortPosition] Cannot execute: ${validation.reason}`);\r\n                // Optional: Provide UI feedback (flash red?) - For now console warn and no-op is safer\r\n                return;\r\n            }\r\n\r\n            const trade = this.getTradeObject();\r\n\r\n            // --- TRADE TRACKING INTEGRATION ---\r\n            // 1. Generate ID\r\n            const tradeId = TradeLogService.getNextId();\r\n\r\n            // 2. Inject ID\r\n            (trade as any).id = tradeId;\r\n\r\n            // 3. Log to DB\r\n            TradeLogService.logTrade(trade);\r\n            // ----------------------------------\r\n\r\n            console.log(`[LongShortPosition] Execute clicked! ID: ${tradeId}`, trade);\r\n            this.onExecute?.(trade);\r\n        }\r\n    }\r\n\r\n    private _updateFixedLegLegacy() {\r\n        if (this._data.fixedStates.rr) this._data.fixedLeg = 'rr';\r\n        else if (this._data.fixedStates.tp) this._data.fixedLeg = 'tp';\r\n        else if (this._data.fixedStates.sl) this._data.fixedLeg = 'sl';\r\n    }\r\n\r\n    public updatePoint(handleId: string, newPoint: { time: number; price: number; anchor?: AnchorInfo }): void {\r\n        const isLong = this._data.takeProfitPrice > this._data.entryPrice;\r\n\r\n        if (handleId === 'tp') {\r\n            this._data.takeProfitPrice = newPoint.price;\r\n            this._data.tpAnchor = newPoint.anchor || null; // Store anchor if provided, else clear\r\n            this._applyCalculations('tp', isLong);\r\n        } else if (handleId === 'sl') {\r\n            this._data.stopLossPrice = newPoint.price;\r\n            this._data.slAnchor = newPoint.anchor || null; // Store anchor if provided, else clear\r\n            this._applyCalculations('sl', isLong);\r\n        } else if (handleId === 'entry') {\r\n            this._data.entryPrice = newPoint.price;\r\n            this._data.entryAnchor = newPoint.anchor || null;\r\n            this._applyCalculations('entry', isLong);\r\n        } else if (handleId === 'body') {\r\n            const priceDelta = newPoint.price - this._data.entryPrice;\r\n            this._data.entryPrice = newPoint.price;\r\n            this._data.takeProfitPrice += priceDelta;\r\n            this._data.stopLossPrice += priceDelta;\r\n\r\n            // Clear anchors on body move\r\n            this._data.slAnchor = null;\r\n            this._data.tpAnchor = null;\r\n            this._data.entryAnchor = null;\r\n\r\n            // Safety check for time\r\n            if (newPoint.time && !isNaN(newPoint.time)) {\r\n                this._data.timeIndex = newPoint.time;\r\n            }\r\n        }\r\n    }\r\n\r\n    public applySettings(settings: any): void {\r\n        const oldRR = this._data.riskReward;\r\n        this._data = { ...this._data, ...settings };\r\n\r\n        // If RR manually changed in settings, trigger recalculation\r\n        if (this._data.riskReward !== oldRR) {\r\n            const isLong = this._data.takeProfitPrice > this._data.entryPrice;\r\n            this._applyCalculations('rr', isLong);\r\n        }\r\n\r\n        this._requestUpdate?.();\r\n    }\r\n\r\n    private _applyCalculations(changedId: 'tp' | 'sl' | 'entry' | 'rr', isLong: boolean): void {\r\n        const updated = LongShortCalculator.recalculate(\r\n            this._data,\r\n            changedId,\r\n            isLong\r\n        );\r\n\r\n        this._data.entryPrice = updated.entryPrice;\r\n        this._data.stopLossPrice = updated.stopLossPrice;\r\n        this._data.takeProfitPrice = updated.takeProfitPrice;\r\n        this._data.riskReward = updated.riskReward;\r\n    }\r\n\r\n    private _validateState(): { isValid: boolean; reason?: string } {\r\n        const { sl: slFixed, tp: tpFixed, rr: rrFixed, entry: entryFixed } = this._data.fixedStates;\r\n        const { slAnchor, tpAnchor, orderType } = this._data;\r\n\r\n        if (orderType === 'MARKET') {\r\n            // Market Rules:\r\n            // 1. Exactly 2 fixed elements out of SL, TP, RR\r\n            const fixedCount = (slFixed ? 1 : 0) + (tpFixed ? 1 : 0) + (rrFixed ? 1 : 0);\r\n            if (fixedCount !== 2) {\r\n                return { isValid: false, reason: 'Market req 2 fixed legs' };\r\n            }\r\n\r\n            // 2. If SL/TP Fixed -> Must have Anchor\r\n            if (slFixed && !slAnchor) return { isValid: false, reason: 'SL fixed needs Anchor' };\r\n            if (tpFixed && !tpAnchor) return { isValid: false, reason: 'TP fixed needs Anchor' };\r\n\r\n        } else {\r\n            // Limit/Stop Rules:\r\n            // Must have Entry fixed (defines limit nature)\r\n            if (!entryFixed) {\r\n                return { isValid: false, reason: 'Limit req Entry fixed' };\r\n            }\r\n\r\n            // Must have 2 others fixed (SL, TP, RR)\r\n            const remainingFixed = (slFixed ? 1 : 0) + (tpFixed ? 1 : 0) + (rrFixed ? 1 : 0);\r\n            if (remainingFixed < 2) {\r\n                // Technically we need enough info to derive the 3rd.\r\n                // Entry + SL + RR -> TP derived\r\n                // Entry + TP + RR -> SL derived\r\n                // Entry + SL + TP -> RR derived\r\n                return { isValid: false, reason: 'Limit req 2 of SL/TP/RR fixed' };\r\n            }\r\n\r\n            // Check Anchors only if the leg is actively fixed\r\n            // REMOVED STRICT CHECK: User expects 'Fixed' (Locked Price) to be valid even without 'Anchor' (Magnet Snap)\r\n            // if (slFixed && !slAnchor) return { isValid: false, reason: 'SL needs Anchor' };\r\n            // if (tpFixed && !tpAnchor) return { isValid: false, reason: 'TP needs Anchor' };\r\n\r\n            // Entry anchor check skipped as we don't store it yet, fixed state implies user intent\r\n        }\r\n\r\n        return { isValid: true };\r\n    }\r\n\r\n    public drawShape(ctx: CanvasRenderingContext2D): void {\r\n        if (!this._chart || !this._series) return;\r\n\r\n        const timeScale = this._chart.timeScale();\r\n        const series = this._series;\r\n\r\n        const x = timeScale.timeToCoordinate(this._data.timeIndex as any as Time);\r\n        const yEntry = series.priceToCoordinate(this._data.entryPrice);\r\n        const yTP = series.priceToCoordinate(this._data.takeProfitPrice);\r\n        const ySL = series.priceToCoordinate(this._data.stopLossPrice);\r\n\r\n        if (x === null || yEntry === null || yTP === null || ySL === null) return;\r\n\r\n        const width = this._width;\r\n\r\n        // Colors\r\n        const profitColor = this._data.profitColor || 'rgba(20, 184, 166, 0.25)'; // Higher vibrancy\r\n        const stopColor = this._data.stopColor || 'rgba(244, 63, 94, 0.25)';\r\n        const lineColor = this._data.lineColor || '#94a3b8';\r\n\r\n        // 1. Draw Profit Zone\r\n        ctx.fillStyle = profitColor;\r\n        const tpTop = Math.min(yEntry, yTP);\r\n        const tpHeight = Math.abs(yEntry - yTP);\r\n        ctx.fillRect(x, tpTop, width, tpHeight);\r\n\r\n        // 2. Draw Loss Zone\r\n        ctx.fillStyle = stopColor;\r\n        const slTop = Math.min(yEntry, ySL);\r\n        const slHeight = Math.abs(yEntry - ySL);\r\n        ctx.fillRect(x, slTop, width, slHeight);\r\n\r\n        // --- Draw Levels with visual fix feedback ---\r\n        ctx.save();\r\n\r\n        const drawLevel = (y: number, isFixed: boolean, color: string, label: string) => {\r\n            if (y === null || isNaN(y)) return;\r\n\r\n            ctx.beginPath();\r\n\r\n            if (isFixed) {\r\n                ctx.strokeStyle = '#000000'; // Black for fixed\r\n                ctx.lineWidth = 1;\r\n                ctx.setLineDash([]); // Ensure solid\r\n            } else {\r\n                ctx.strokeStyle = color;\r\n                ctx.lineWidth = 1;\r\n            }\r\n\r\n            ctx.moveTo(x, y);\r\n            ctx.lineTo(x + width, y);\r\n            ctx.stroke();\r\n        };\r\n\r\n        drawLevel(yTP, this._data.fixedStates.tp, 'rgba(20, 184, 166, 0.8)', 'TP');\r\n        drawLevel(ySL, this._data.fixedStates.sl, 'rgba(244, 63, 94, 0.8)', 'SL');\r\n        drawLevel(yEntry, this._data.fixedStates.entry, '#FFFFFF', 'ENTRY');\r\n\r\n        ctx.restore();\r\n\r\n        // --- Draw Stats Box (Professional Panel) ---\r\n        const ratio = this._data.riskReward.toFixed(2);\r\n        const isLong = this._data.takeProfitPrice > this._data.entryPrice;\r\n\r\n        const boxWidth = 65; // Reduced from 85\r\n        const boxHeight = 18; // Reduced from 26\r\n        const boxX = x + (width - boxWidth) / 2;\r\n        const boxY = yEntry - (boxHeight / 2);\r\n\r\n        ctx.save();\r\n        // Box Background\r\n        ctx.fillStyle = lineColor;\r\n        ctx.globalAlpha = 0.95;\r\n        this._roundRect(ctx, boxX, boxY, boxWidth, boxHeight, 4);\r\n        ctx.fill();\r\n\r\n        // Shadow/Border (Fixed RR feedback)\r\n        if (this._data.fixedStates.rr) {\r\n            ctx.strokeStyle = '#000000'; // Dark border for fixed RR\r\n            ctx.lineWidth = 1; // Thinner border (User request)\r\n            ctx.stroke();\r\n        } else {\r\n            ctx.strokeStyle = '#FFFFFF';\r\n            ctx.lineWidth = 1;\r\n            ctx.globalAlpha = 0.2;\r\n            ctx.stroke();\r\n        }\r\n        ctx.restore();\r\n\r\n        // Text\r\n        ctx.font = 'bold 10px Inter, sans-serif'; // Reduced from 12px\r\n        ctx.fillStyle = '#FFFFFF';\r\n        ctx.textAlign = 'center';\r\n        ctx.fillText(`${ratio} R`, boxX + boxWidth / 2, boxY + 13); // Adjusted y-offset for smaller box\r\n\r\n        // --- BUTTON LAYOUT LOGIC ---\r\n        // Top Slot: yEntry - (boxHeight/2) - gap - buttonHeight\r\n        // Bottom Slot: yEntry + (boxHeight/2) + gap\r\n        const btnHeight = 16; // Reduced from 20\r\n        const btnWidth = 140; // Increased to 140 for longer labels\r\n        const gap = 8; // Increased from 2 (User request)\r\n\r\n        const topY = yEntry - (boxHeight / 2) - btnHeight - gap;\r\n        const bottomY = yEntry + (boxHeight / 2) + gap;\r\n        const btnX = x + (width - btnWidth) / 2;\r\n\r\n        // Single Button Position: Keep \"Market\" position (Top for Short, Bottom for Long)\r\n        const buttonY = isLong ? bottomY : topY;\r\n\r\n        // Validation Check for Border Color\r\n        const validation = this._validateState();\r\n        const isValid = validation.isValid;\r\n\r\n        // 1. Trade Type & Execution Button\r\n        ctx.save();\r\n\r\n        // Background Color based on Validity\r\n        // Valid -> Green, Invalid -> Red\r\n        const btnColor = isValid ? 'rgba(16, 185, 129, 1)' : 'rgba(239, 68, 68, 1)';\r\n        const shadowColor = 'rgba(0, 0, 0, 0.4)';\r\n\r\n        // \"Step\" Effect (Shadow)\r\n        // Draw a shadow rect slightly offset (y+2)\r\n        ctx.fillStyle = shadowColor;\r\n        this._roundRect(ctx, btnX, buttonY + 2, btnWidth, btnHeight, 4);\r\n        ctx.fill();\r\n\r\n        // Main Button Body\r\n        ctx.fillStyle = btnColor;\r\n        this._roundRect(ctx, btnX, buttonY, btnWidth, btnHeight, 4);\r\n        ctx.fill();\r\n\r\n        // Border: Thin Black (User request: \"schwarze dnne (1px) umrandung\")\r\n        ctx.lineWidth = 1;\r\n        ctx.strokeStyle = '#000000';\r\n        ctx.stroke();\r\n\r\n        // Label\r\n        ctx.font = 'bold 8px Inter, sans-serif'; // Reduced from 9px\r\n        // White text (User preference reverted)\r\n        ctx.fillStyle = '#FFFFFF';\r\n        ctx.textAlign = 'center';\r\n        let label = '';\r\n        if (this._data.orderType === 'MARKET') {\r\n            label = 'EXECUTE MARKET ORDER';\r\n        } else {\r\n            // Default to LIMIT\r\n            label = 'PLACE LIMIT ORDER';\r\n\r\n            if (this._lastMarketPrice !== null) {\r\n                const entry = this._data.entryPrice;\r\n                const market = this._lastMarketPrice;\r\n                if (isLong) {\r\n                    // Buying: Below market = Limit, Above market = Stop\r\n                    label = entry < market ? 'PLACE LIMIT ORDER' : 'PLACE STOP ORDER';\r\n                } else {\r\n                    // Selling: Above market = Limit, Below market = Stop\r\n                    label = entry > market ? 'PLACE LIMIT ORDER' : 'PLACE STOP ORDER';\r\n                }\r\n            }\r\n        }\r\n\r\n        ctx.fillText(label, btnX + btnWidth / 2, buttonY + 11); // Adjusted offset for 16px height\r\n        ctx.restore();\r\n\r\n        ctx.textAlign = 'start';\r\n    }\r\n\r\n    public getTradeObject() {\r\n        // Validation Check before object creation? \r\n        // The execute click handler checks validation, so here we assume valid or return what we have.\r\n        // We ensure data integrity (0 values).\r\n\r\n        const isLong = this._data.takeProfitPrice > this._data.entryPrice;\r\n\r\n        // Helper to formatting anchor\r\n        const formatAnchor = (anchor: AnchorInfo | undefined | null) => {\r\n            if (!anchor) return null;\r\n            return {\r\n                time: anchor.time,\r\n                price: anchor.price,\r\n                type: anchor.type.toUpperCase(), // OPEN, HIGH, LOW, CLOSE\r\n                timeframe: anchor.timeframe\r\n            };\r\n        };\r\n\r\n        // Logic to determine specific Limit vs Stop\r\n        let finalOrderType: 'MARKET' | 'LIMIT' | 'STOP' = this._data.orderType; // 'MARKET' or 'LIMIT'\r\n\r\n        if (this._data.orderType === 'LIMIT' && this._lastMarketPrice !== null) {\r\n            const entry = this._data.entryPrice;\r\n            const market = this._lastMarketPrice;\r\n            if (isLong) {\r\n                // Buying: Below market = LIMIT, Above market = STOP\r\n                finalOrderType = entry < market ? 'LIMIT' : 'STOP';\r\n            } else {\r\n                // Selling: Above market = LIMIT, Below market = STOP\r\n                finalOrderType = entry > market ? 'LIMIT' : 'STOP';\r\n            }\r\n        }\r\n\r\n        return {\r\n            symbol: this._data.symbol || (this._series as any)?._symbol || 'UNKNOWN',\r\n            orderType: finalOrderType, // Explicit MARKET, LIMIT, or STOP\r\n            direction: isLong ? 'LONG' : 'SHORT',\r\n\r\n\r\n            // Entry Configuration\r\n            entry: this._data.orderType === 'MARKET'\r\n                ? { type: 'MARKET', fixed: this._data.fixedStates.entry, price: this._data.fixedStates.entry ? this._data.entryPrice : 0, anchor: formatAnchor(this._data.entryAnchor) }\r\n                : {\r\n                    type: 'LIMIT',\r\n                    fixed: this._data.fixedStates.entry,\r\n                    price: this._data.fixedStates.entry ? this._data.entryPrice : 0,\r\n                    anchor: formatAnchor(this._data.entryAnchor)\r\n                },\r\n\r\n            // Stop Loss Configuration\r\n            sl: {\r\n                type: 'PROTECTION',\r\n                fixed: this._data.fixedStates.sl,\r\n                price: this._data.fixedStates.sl ? this._data.stopLossPrice : 0,\r\n                anchor: formatAnchor(this._data.slAnchor)\r\n            },\r\n\r\n            // Take Profit Configuration\r\n            tp: {\r\n                type: 'TARGET',\r\n                fixed: this._data.fixedStates.tp,\r\n                price: this._data.fixedStates.tp ? this._data.takeProfitPrice : 0,\r\n                anchor: formatAnchor(this._data.tpAnchor)\r\n            },\r\n\r\n            // Risk Reward - \"wenn nicht fixiert, dann 0 bergeben\"\r\n            riskReward: {\r\n                value: this._data.fixedStates.rr ? this._data.riskReward : 0,\r\n                fixed: this._data.fixedStates.rr\r\n            },\r\n\r\n            // Metadata for Visualization (Concrete Calculated Values)\r\n            meta: {\r\n                initialEntry: this._data.entryPrice,\r\n                initialSL: this._data.stopLossPrice,\r\n                initialTP: this._data.takeProfitPrice\r\n            }\r\n        };\r\n    }\r\n\r\n    private _roundRect(ctx: CanvasRenderingContext2D, x: number, y: number, width: number, height: number, radius: number) {\r\n        ctx.beginPath();\r\n        ctx.moveTo(x + radius, y);\r\n        ctx.lineTo(x + width - radius, y);\r\n        ctx.quadraticCurveTo(x + width, y, x + width, y + radius);\r\n        ctx.lineTo(x + width, y + height - radius);\r\n        ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);\r\n        ctx.lineTo(x + radius, y + height);\r\n        ctx.quadraticCurveTo(x, y + height, x, y + height - radius);\r\n        ctx.lineTo(x, y + radius);\r\n        ctx.quadraticCurveTo(x, y, x + radius, y);\r\n        ctx.closePath();\r\n    }\r\n\r\n    /**\r\n     * Detect hits on the tool body or buttons.\r\n     */\r\n    public hitTest(x: number, y: number): PrimitiveHoveredItem | null {\r\n        if (!this._chart || !this._series) return null;\r\n\r\n        const timeScale = this._chart.timeScale();\r\n        const xPos = timeScale.timeToCoordinate(this._data.timeIndex as any as import('lightweight-charts').Time);\r\n        const yEntry = this._series.priceToCoordinate(this._data.entryPrice);\r\n\r\n        if (xPos !== null && yEntry !== null) {\r\n            const boxWidth = 65; // Sync with draw\r\n            const boxHeight = 18; // Sync with draw\r\n            const boxX = xPos + (this._width - boxWidth) / 2;\r\n            const boxY = yEntry - (boxHeight / 2);\r\n\r\n            // 1. Hit test for the stats box (RR Fix Toggle)\r\n            // We check this BEFORE handles/body to prioritize the stats panel\r\n            if (x >= boxX && x <= boxX + boxWidth && y >= boxY && y <= boxY + boxHeight) {\r\n                return { externalId: 'rr_panel', zOrder: 'top' };\r\n            }\r\n\r\n            // Button Layout Logic\r\n            const isLong = this._data.takeProfitPrice > this._data.entryPrice;\r\n            const btnHeight = 16; // Sync\r\n            const btnWidth = 140; // Sync\r\n            const gap = 8; // Sync\r\n\r\n            const topY = yEntry - (18 / 2) - btnHeight - gap; // 18 is boxHeight\r\n            const bottomY = yEntry + (18 / 2) + gap;\r\n\r\n            const btnX = xPos + (this._width - btnWidth) / 2;\r\n            const buttonY = isLong ? bottomY : topY;\r\n\r\n            // 2. Hit test for Order Type/Execute Button\r\n            if (x >= btnX && x <= btnX + btnWidth && y >= buttonY && y <= buttonY + btnHeight) {\r\n                return { externalId: 'order_type_toggle', zOrder: 'top' };\r\n            }\r\n        }\r\n\r\n        // 3. Check handles and body (base class logic)\r\n        return super.hitTest(x, y);\r\n    }\r\n\r\n    protected hitTestBody(point: Point): boolean {\r\n        if (!this._chart || !this._series) return false;\r\n        const x = this._chart.timeScale().timeToCoordinate(this._data.timeIndex as any as import('lightweight-charts').Time);\r\n        const yTP = this._series.priceToCoordinate(this._data.takeProfitPrice);\r\n        const ySL = this._series.priceToCoordinate(this._data.stopLossPrice);\r\n\r\n        if (x === null || yTP === null || ySL === null) return false;\r\n\r\n        const yTop = Math.min(yTP, ySL);\r\n        const yBottom = Math.max(yTP, ySL);\r\n\r\n        return point.x >= x && point.x <= x + this._width &&\r\n            point.y >= yTop && point.y <= yBottom;\r\n    }\r\n\r\n    // Accessor for adapters\r\n    public getData() { return this._data; }\r\n    public getStorageState() { return this._data; }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1930, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Michael/IdeaProjects/MSMTB/src/trading-cockpit/src/components/charts/TrendLineTool.ts"],"sourcesContent":["import {\r\n    Coordinate,\r\n    SeriesType,\r\n    ISeriesApi,\r\n    Time\r\n} from 'lightweight-charts';\r\nimport { BaseWidget, WidgetState } from './widgets/BaseWidget';\r\nimport { AnchorInfo } from './widgets/MagnetService';\r\nimport { Point, Anchor } from './widgets/types';\r\n\r\nexport interface TrendLineState {\r\n    p1: { time: number; price: number };\r\n    p2: { time: number; price: number };\r\n    color?: string;\r\n    width?: number;\r\n}\r\n\r\nexport class TrendLineTool extends BaseWidget<TrendLineState> {\r\n    private _p1Coords: Point | null = null;\r\n    private _p2Coords: Point | null = null;\r\n\r\n    constructor(initialState: TrendLineState) {\r\n        super(initialState);\r\n    }\r\n\r\n    public getData(): TrendLineState {\r\n        return this._data;\r\n    }\r\n\r\n    public updateGeometry(timeScale: any, series: ISeriesApi<SeriesType>): void {\r\n        const { p1, p2 } = this._data;\r\n\r\n        const x1 = timeScale.timeToCoordinate(p1.time as Time);\r\n        const y1 = series.priceToCoordinate(p1.price);\r\n        const x2 = timeScale.timeToCoordinate(p2.time as Time);\r\n        const y2 = series.priceToCoordinate(p2.price);\r\n\r\n        if (x1 !== null && y1 !== null && x2 !== null && y2 !== null) {\r\n            this._p1Coords = { x: x1, y: y1 };\r\n            this._p2Coords = { x: x2, y: y2 };\r\n\r\n            this.setAnchors([\r\n                { id: 'p1', x: x1, y: y1, color: this._data.color || '#2962FF', cursor: 'move', axisLock: 'free' },\r\n                { id: 'p2', x: x2, y: y2, color: this._data.color || '#2962FF', cursor: 'move', axisLock: 'free' }\r\n            ]);\r\n        } else {\r\n            this._p1Coords = null;\r\n            this._p2Coords = null;\r\n            this.setAnchors([]);\r\n        }\r\n    }\r\n\r\n    public drawBody(ctx: CanvasRenderingContext2D): void {\r\n        if (!this._p1Coords || !this._p2Coords) return;\r\n\r\n        ctx.beginPath();\r\n        ctx.moveTo(this._p1Coords.x, this._p1Coords.y);\r\n        ctx.lineTo(this._p2Coords.x, this._p2Coords.y);\r\n\r\n        ctx.strokeStyle = this._data.color || '#2962FF';\r\n        ctx.lineWidth = this._data.width || 2;\r\n\r\n        if (this._state === WidgetState.Hover || this._state === WidgetState.Selected) {\r\n            ctx.shadowBlur = 4;\r\n            ctx.shadowColor = ctx.strokeStyle;\r\n        } else {\r\n            ctx.shadowBlur = 0;\r\n        }\r\n\r\n        ctx.stroke();\r\n        ctx.shadowBlur = 0;\r\n    }\r\n\r\n    protected hitTestBody(point: Point): boolean {\r\n        if (!this._p1Coords || !this._p2Coords) return false;\r\n\r\n        // Distance from point to line segment\r\n        const dist = this._distToSegment(point, this._p1Coords, this._p2Coords);\r\n        return dist < 6; // 6px tolerance\r\n    }\r\n\r\n    protected applyDrag(target: string, newPoint: Point): void {\r\n        const series = this.getSeries();\r\n        const timeScale = this.getChart()?.timeScale();\r\n        if (!series || !timeScale) return;\r\n\r\n        const newPrice = series.coordinateToPrice(newPoint.y);\r\n        const newTime = timeScale.coordinateToTime(newPoint.x);\r\n\r\n        if (newPrice === null || newTime === null) return;\r\n\r\n        if (target === 'p1') {\r\n            this._data.p1.price = newPrice;\r\n            this._data.p1.time = newTime as number;\r\n        } else if (target === 'p2') {\r\n            this._data.p2.price = newPrice;\r\n            this._data.p2.time = newTime as number;\r\n        } else if (target === 'body') {\r\n            // Move both points by delta\r\n            if (!this._p1Coords || !this._p2Coords) return;\r\n\r\n            // We need the drag start delta in world coordinates or logic here\r\n            // But applyDrag receives the current mouse point.\r\n            // Simplified: calculate delta from previous p1/p2 (which is what BaseWidget does via this._dragStartPoint)\r\n            // Wait, BaseWidget's onMouseMove calculates the newPoint.\r\n            // Let's use the delta from the start of the drag.\r\n\r\n            // I'll need to store the initial state at drag start if I want perfect delta movement.\r\n            // BaseWidget doesn't pass Delta.\r\n            // I'll calculate it against the current data.\r\n            // NOTE: This might accumulate error if done per frame with logical time.\r\n            // Standard approach: calculate delta in pixels, then back to price/time.\r\n\r\n            // Since this is called every frame, moving by \"delta from entryPrice\" (newPrice - oldEntry) is correct.\r\n            const deltaPrice = newPrice - (target === 'body' ? series.coordinateToPrice(this._dragStartPoint!.y)! : 0); // Simplified for now\r\n            // Actually, let's just use the current point difference.\r\n\r\n            // To do this correctly, I need the \"last\" point.\r\n            // I'll just shift p1 and p2 by the same logical delta.\r\n            const priceP1 = series.coordinateToPrice(newPoint.y);\r\n            const timeP1 = timeScale.coordinateToTime(newPoint.x);\r\n\r\n            // BETTER: BaseWidget should probably support \"dragBody\" better.\r\n            // For now, I'll calculate the delta between newPoint and the point that was clicked (body hit).\r\n            // But wait, applyDrag is generic.\r\n\r\n            // Let's use a simpler approach: \r\n            // If dragging body, calculate how much price/time changed since start of drag.\r\n            const startPrice = series.coordinateToPrice(this._dragStartPoint!.y);\r\n            const startTime = timeScale.coordinateToTime(this._dragStartPoint!.x);\r\n\r\n            if (startPrice !== null && startTime !== null) {\r\n                const dPrice = newPrice - startPrice;\r\n                const dTime = (newTime as number) - (startTime as number);\r\n\r\n                // We use a backup of the points at drag start to avoid accumulation\r\n                // For now, I'll just apply it once? No, this is called every frame.\r\n                // I'll add a temporary \"dragStartData\" if I can, or just accept the logic.\r\n\r\n                // Let's assume the user wants simple \"move all\" logic.\r\n                // For TrendLine, \"move all\" means shifting both points.\r\n                // I'll store the 'originalP1' and 'originalP2' in a temporary field if possible.\r\n                // Or I use the delta since last call.\r\n\r\n                // Direct implementation:\r\n                this._data.p1.price += dPrice;\r\n                this._data.p1.time += dTime;\r\n                this._data.p2.price += dPrice;\r\n                this._data.p2.time += dTime;\r\n\r\n                // IMPORTANT: Reset dragStartPoint to current so next frame delta is relative to this one.\r\n                // This prevents exponential growth if we don't have \"original\" backup.\r\n                this._dragStartPoint = { ...newPoint };\r\n            }\r\n        }\r\n    }\r\n\r\n    private _distToSegment(p: Point, v: Point, w: Point): number {\r\n        const l2 = Math.pow(v.x - w.x, 2) + Math.pow(v.y - w.y, 2);\r\n        if (l2 === 0) return Math.sqrt(Math.pow(p.x - v.x, 2) + Math.pow(p.y - v.y, 2));\r\n        let t = ((p.x - v.x) * (w.x - v.x) + (p.y - v.y) * (w.y - v.y)) / l2;\r\n        t = Math.max(0, Math.min(1, t));\r\n        return Math.sqrt(Math.pow(p.x - (v.x + t * (w.x - v.x)), 2) + Math.pow(p.y - (v.y + t * (w.y - v.y)), 2));\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2084, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Michael/IdeaProjects/MSMTB/src/trading-cockpit/src/components/charts/widgets/HorizontalLineWidget.ts"],"sourcesContent":["import { InteractiveChartObject, Handle } from './InteractiveChartObject';\r\nimport { Point } from './types';\r\nimport { AnchorInfo } from './MagnetService';\r\nimport { Time } from 'lightweight-charts';\r\n\r\nexport interface HorizontalLineState {\r\n    price: number;\r\n    time: number; // For handle positioning\r\n    color: string;\r\n    width: number;\r\n    lineStyle: number; // 0=Solid, 1=Dotted, 2=Dashed, etc.\r\n    showLabel: boolean;\r\n    fixed: boolean;\r\n    anchor?: AnchorInfo | null;\r\n}\r\n\r\nexport class HorizontalLineWidget extends InteractiveChartObject {\r\n    private _data: HorizontalLineState;\r\n\r\n    constructor(initialData: HorizontalLineState) {\r\n        super();\r\n        this._data = initialData;\r\n        this._timeframe = initialData.anchor?.timeframe || 'D1';\r\n    }\r\n\r\n    public getHandles(): Handle[] {\r\n        return [\r\n            {\r\n                id: 'drag',\r\n                time: this._data.time,\r\n                price: this._data.price,\r\n                axisLock: 'free', // Allow unrestricted movement of the handle itself?\r\n                // Actually, if we want the line to only move vertically, we should lock vertical_only?\r\n                // But user might want to slide the handle left/right to move it out of the way.\r\n                // Let's use 'free' so the handle follows mouse, and we update price/time.\r\n                cursor: 'move'\r\n            }\r\n        ];\r\n    }\r\n\r\n    public updatePoint(handleId: string, newPoint: { time: number; price: number; anchor?: AnchorInfo }): void {\r\n        if (handleId === 'body' || handleId === 'drag') {\r\n            this._data.price = newPoint.price;\r\n            this._data.time = newPoint.time; // Update handle position\r\n            this._data.anchor = newPoint.anchor || null;\r\n            this._requestUpdate?.();\r\n        }\r\n    }\r\n\r\n    public drawShape(ctx: CanvasRenderingContext2D): void {\r\n        if (!this._chart || !this._series) return;\r\n\r\n        const series = this._series;\r\n        const y = series.priceToCoordinate(this._data.price);\r\n\r\n        if (y === null) return;\r\n\r\n        const width = ctx.canvas.width; // Approx screen width\r\n\r\n        ctx.save();\r\n        ctx.beginPath();\r\n\r\n        // Set Styles\r\n        ctx.strokeStyle = this._data.color;\r\n        ctx.lineWidth = this._data.width;\r\n\r\n        // Line Pattern\r\n        // LWC LineStyle: 0=Solid, 1=Dotted, 2=Dashed, 3=LargeDashed, 4=SparseDotted\r\n        if (this._data.lineStyle === 1) ctx.setLineDash([2, 2]);\r\n        else if (this._data.lineStyle === 2) ctx.setLineDash([6, 6]);\r\n        else ctx.setLineDash([]);\r\n\r\n        ctx.moveTo(0, y);\r\n        ctx.lineTo(width, y);\r\n        ctx.stroke();\r\n\r\n        // Label on Right Axis (Simulated)\r\n        if (this._data.showLabel) {\r\n            const text = series.priceFormatter().format(this._data.price);\r\n            ctx.font = '11px sans-serif';\r\n            ctx.fillStyle = this._data.color;\r\n            ctx.fillText(text, width - 60, y - 4);\r\n        }\r\n\r\n        ctx.restore();\r\n    }\r\n\r\n    protected hitTestBody(point: Point): boolean {\r\n        if (!this._series) return false;\r\n        const y = this._series.priceToCoordinate(this._data.price);\r\n        if (y === null) return false;\r\n\r\n        const tolerance = 6 + (this._data.width / 2);\r\n        return Math.abs(point.y - y) <= tolerance;\r\n    }\r\n\r\n    public getSettingsSchema(): import('./InteractiveChartObject').SettingField[] {\r\n        return [\r\n            { id: 'color', label: 'Color', type: 'color', value: this._data.color },\r\n            { id: 'width', label: 'Width', type: 'number', value: this._data.width },\r\n            { id: 'showLabel', label: 'Show Price Label', type: 'boolean', value: this._data.showLabel },\r\n        ];\r\n    }\r\n\r\n    public applySettings(settings: any): void {\r\n        this._data = { ...this._data, ...settings };\r\n        this._requestUpdate?.();\r\n    }\r\n\r\n    public getData() { return this._data; }\r\n\r\n    // Override manual double click to perhaps lock/unlock? \r\n    // Default behavior is acceptable for now.\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2200, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Michael/IdeaProjects/MSMTB/src/trading-cockpit/src/components/charts/widgets/HorizontalRayWidget.ts"],"sourcesContent":["import { InteractiveChartObject, Handle } from './InteractiveChartObject';\r\nimport { Point } from './types';\r\nimport { AnchorInfo } from './MagnetService';\r\nimport { Time } from 'lightweight-charts';\r\n\r\nexport interface HorizontalRayState {\r\n    time: number;\r\n    price: number;\r\n    color: string;\r\n    width: number;\r\n    anchor?: AnchorInfo | null;\r\n}\r\n\r\nexport class HorizontalRayWidget extends InteractiveChartObject {\r\n    private _data: HorizontalRayState;\r\n\r\n    constructor(initialData: HorizontalRayState) {\r\n        super();\r\n        this._data = initialData;\r\n        this._timeframe = initialData.anchor?.timeframe || 'D1';\r\n    }\r\n\r\n    public getHandles(): Handle[] {\r\n        return [\r\n            {\r\n                id: 'anchor',\r\n                time: this._data.time,\r\n                price: this._data.price,\r\n                axisLock: 'free',\r\n                cursor: 'move'\r\n            }\r\n        ];\r\n    }\r\n\r\n    public updatePoint(handleId: string, newPoint: { time: number; price: number; anchor?: AnchorInfo }): void {\r\n        if (handleId === 'anchor' || handleId === 'body') {\r\n            this._data.time = newPoint.time;\r\n            this._data.price = newPoint.price;\r\n            this._data.anchor = newPoint.anchor || null;\r\n            this._requestUpdate?.();\r\n        }\r\n    }\r\n\r\n    public drawShape(ctx: CanvasRenderingContext2D): void {\r\n        if (!this._chart || !this._series) return;\r\n\r\n        const timeScale = this._chart.timeScale();\r\n        const series = this._series;\r\n\r\n        const x = this.getSafeTimeCoordinate(this._data.time);\r\n        const y = series.priceToCoordinate(this._data.price);\r\n\r\n        if (x === null || y === null) return;\r\n\r\n        const width = ctx.canvas.width; // Draw to end of canvas\r\n\r\n        ctx.save();\r\n        ctx.beginPath();\r\n\r\n        // Style\r\n        ctx.strokeStyle = this._data.color;\r\n        ctx.lineWidth = this._data.width;\r\n\r\n        ctx.moveTo(x, y);\r\n        ctx.lineTo(width, y);\r\n        ctx.stroke();\r\n\r\n        ctx.restore();\r\n    }\r\n\r\n    protected hitTestBody(point: Point): boolean {\r\n        if (!this._series || !this._chart) return false;\r\n\r\n        const timeScale = this._chart.timeScale();\r\n        const x = this.getSafeTimeCoordinate(this._data.time);\r\n        const y = this._series.priceToCoordinate(this._data.price);\r\n\r\n        if (x === null || y === null) return false;\r\n\r\n        const tolerance = 6 + (this._data.width / 2);\r\n\r\n        // Ray logic: y must match AND x must be >= startX\r\n        return Math.abs(point.y - y) <= tolerance && point.x >= x;\r\n    }\r\n\r\n    public getSettingsSchema(): import('./InteractiveChartObject').SettingField[] {\r\n        return [\r\n            { id: 'color', label: 'Color', type: 'color', value: this._data.color },\r\n            { id: 'width', label: 'Width', type: 'number', value: this._data.width },\r\n        ];\r\n    }\r\n\r\n    public applySettings(settings: any): void {\r\n        this._data = { ...this._data, ...settings };\r\n        this._requestUpdate?.();\r\n    }\r\n\r\n    public getData() { return this._data; }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAaO,MAAM,4BAA4B,6LAAsB;IACnD,MAA0B;IAElC,YAAY,WAA+B,CAAE;QACzC,KAAK;QACL,IAAI,CAAC,KAAK,GAAG;QACb,IAAI,CAAC,UAAU,GAAG,YAAY,MAAM,EAAE,aAAa;IACvD;IAEO,aAAuB;QAC1B,OAAO;YACH;gBACI,IAAI;gBACJ,MAAM,IAAI,CAAC,KAAK,CAAC,IAAI;gBACrB,OAAO,IAAI,CAAC,KAAK,CAAC,KAAK;gBACvB,UAAU;gBACV,QAAQ;YACZ;SACH;IACL;IAEO,YAAY,QAAgB,EAAE,QAA8D,EAAQ;QACvG,IAAI,aAAa,YAAY,aAAa,QAAQ;YAC9C,IAAI,CAAC,KAAK,CAAC,IAAI,GAAG,SAAS,IAAI;YAC/B,IAAI,CAAC,KAAK,CAAC,KAAK,GAAG,SAAS,KAAK;YACjC,IAAI,CAAC,KAAK,CAAC,MAAM,GAAG,SAAS,MAAM,IAAI;YACvC,IAAI,CAAC,cAAc;QACvB;IACJ;IAEO,UAAU,GAA6B,EAAQ;QAClD,IAAI,CAAC,IAAI,CAAC,MAAM,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE;QAEnC,MAAM,YAAY,IAAI,CAAC,MAAM,CAAC,SAAS;QACvC,MAAM,SAAS,IAAI,CAAC,OAAO;QAE3B,MAAM,IAAI,IAAI,CAAC,qBAAqB,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI;QACpD,MAAM,IAAI,OAAO,iBAAiB,CAAC,IAAI,CAAC,KAAK,CAAC,KAAK;QAEnD,IAAI,MAAM,QAAQ,MAAM,MAAM;QAE9B,MAAM,QAAQ,IAAI,MAAM,CAAC,KAAK,EAAE,wBAAwB;QAExD,IAAI,IAAI;QACR,IAAI,SAAS;QAEb,QAAQ;QACR,IAAI,WAAW,GAAG,IAAI,CAAC,KAAK,CAAC,KAAK;QAClC,IAAI,SAAS,GAAG,IAAI,CAAC,KAAK,CAAC,KAAK;QAEhC,IAAI,MAAM,CAAC,GAAG;QACd,IAAI,MAAM,CAAC,OAAO;QAClB,IAAI,MAAM;QAEV,IAAI,OAAO;IACf;IAEU,YAAY,KAAY,EAAW;QACzC,IAAI,CAAC,IAAI,CAAC,OAAO,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE,OAAO;QAE1C,MAAM,YAAY,IAAI,CAAC,MAAM,CAAC,SAAS;QACvC,MAAM,IAAI,IAAI,CAAC,qBAAqB,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI;QACpD,MAAM,IAAI,IAAI,CAAC,OAAO,CAAC,iBAAiB,CAAC,IAAI,CAAC,KAAK,CAAC,KAAK;QAEzD,IAAI,MAAM,QAAQ,MAAM,MAAM,OAAO;QAErC,MAAM,YAAY,IAAK,IAAI,CAAC,KAAK,CAAC,KAAK,GAAG;QAE1C,kDAAkD;QAClD,OAAO,KAAK,GAAG,CAAC,MAAM,CAAC,GAAG,MAAM,aAAa,MAAM,CAAC,IAAI;IAC5D;IAEO,oBAAuE;QAC1E,OAAO;YACH;gBAAE,IAAI;gBAAS,OAAO;gBAAS,MAAM;gBAAS,OAAO,IAAI,CAAC,KAAK,CAAC,KAAK;YAAC;YACtE;gBAAE,IAAI;gBAAS,OAAO;gBAAS,MAAM;gBAAU,OAAO,IAAI,CAAC,KAAK,CAAC,KAAK;YAAC;SAC1E;IACL;IAEO,cAAc,QAAa,EAAQ;QACtC,IAAI,CAAC,KAAK,GAAG;YAAE,GAAG,IAAI,CAAC,KAAK;YAAE,GAAG,QAAQ;QAAC;QAC1C,IAAI,CAAC,cAAc;IACvB;IAEO,UAAU;QAAE,OAAO,IAAI,CAAC,KAAK;IAAE;AAC1C"}},
    {"offset": {"line": 2294, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Michael/IdeaProjects/MSMTB/src/trading-cockpit/src/components/charts/widgets/adapters/VerticalLineAdapter.ts"],"sourcesContent":["import { IChartShape, TimePoint, EntityId } from '../api';\r\nimport { VerticalLineWidget } from '../VerticalLineWidget';\r\nimport { v4 as uuidv4 } from 'uuid';\r\n\r\nexport class VerticalLineAdapter implements IChartShape {\r\n    public id: EntityId;\r\n    public name: string;\r\n\r\n    private _tool: VerticalLineWidget;\r\n    private _selectionEnabled: boolean = true;\r\n\r\n    constructor(tool: VerticalLineWidget) {\r\n        this.id = uuidv4();\r\n        this.name = 'vertical_line';\r\n        this._tool = tool;\r\n    }\r\n\r\n    public getPoints(): TimePoint[] {\r\n        const data = this._tool.getData();\r\n        return [\r\n            { time: data.time, price: data.price }\r\n        ];\r\n    }\r\n\r\n    public setPoints(points: TimePoint[]): void {\r\n        if (points.length < 1) return;\r\n        this._tool.updatePoint('body', { time: points[0].time as number, price: points[0].price });\r\n        this._tool.setSelected(this._tool.getState() === 'selected');\r\n    }\r\n\r\n    public getProperties(): Record<string, any> {\r\n        const data = this._tool.getData();\r\n        return {\r\n            \"linetoolverticalline.linecolor\": data.color,\r\n            \"linetoolverticalline.linewidth\": data.width,\r\n            \"linetoolverticalline.linestyle\": data.lineStyle,\r\n            \"linetoolverticalline.showLabel\": data.showLabel\r\n        };\r\n    }\r\n\r\n    public setProperties(props: Record<string, any>): void {\r\n        const data = this._tool.getData();\r\n        if (props[\"linetoolverticalline.linecolor\"]) data.color = props[\"linetoolverticalline.linecolor\"];\r\n        if (props[\"linetoolverticalline.linewidth\"]) data.width = props[\"linetoolverticalline.linewidth\"];\r\n        if (typeof props[\"linetoolverticalline.linestyle\"] !== 'undefined') data.lineStyle = props[\"linetoolverticalline.linestyle\"];\r\n        if (typeof props[\"linetoolverticalline.showLabel\"] !== 'undefined') data.showLabel = props[\"linetoolverticalline.showLabel\"];\r\n\r\n        this._tool.setSelected(this._tool.getState() === 'selected');\r\n    }\r\n\r\n    public setSelection(selected: boolean): void {\r\n        this._tool.setSelected(selected);\r\n    }\r\n\r\n    public isSelectionEnabled(): boolean {\r\n        return this._selectionEnabled;\r\n    }\r\n\r\n    public getPrimitive(): any {\r\n        return this._tool;\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;AAEA;;AAEO,MAAM;IACF,GAAa;IACb,KAAa;IAEZ,MAA0B;IAC1B,oBAA6B,KAAK;IAE1C,YAAY,IAAwB,CAAE;QAClC,IAAI,CAAC,EAAE,GAAG,IAAA,4KAAM;QAChB,IAAI,CAAC,IAAI,GAAG;QACZ,IAAI,CAAC,KAAK,GAAG;IACjB;IAEO,YAAyB;QAC5B,MAAM,OAAO,IAAI,CAAC,KAAK,CAAC,OAAO;QAC/B,OAAO;YACH;gBAAE,MAAM,KAAK,IAAI;gBAAE,OAAO,KAAK,KAAK;YAAC;SACxC;IACL;IAEO,UAAU,MAAmB,EAAQ;QACxC,IAAI,OAAO,MAAM,GAAG,GAAG;QACvB,IAAI,CAAC,KAAK,CAAC,WAAW,CAAC,QAAQ;YAAE,MAAM,MAAM,CAAC,EAAE,CAAC,IAAI;YAAY,OAAO,MAAM,CAAC,EAAE,CAAC,KAAK;QAAC;QACxF,IAAI,CAAC,KAAK,CAAC,WAAW,CAAC,IAAI,CAAC,KAAK,CAAC,QAAQ,OAAO;IACrD;IAEO,gBAAqC;QACxC,MAAM,OAAO,IAAI,CAAC,KAAK,CAAC,OAAO;QAC/B,OAAO;YACH,kCAAkC,KAAK,KAAK;YAC5C,kCAAkC,KAAK,KAAK;YAC5C,kCAAkC,KAAK,SAAS;YAChD,kCAAkC,KAAK,SAAS;QACpD;IACJ;IAEO,cAAc,KAA0B,EAAQ;QACnD,MAAM,OAAO,IAAI,CAAC,KAAK,CAAC,OAAO;QAC/B,IAAI,KAAK,CAAC,iCAAiC,EAAE,KAAK,KAAK,GAAG,KAAK,CAAC,iCAAiC;QACjG,IAAI,KAAK,CAAC,iCAAiC,EAAE,KAAK,KAAK,GAAG,KAAK,CAAC,iCAAiC;QACjG,IAAI,OAAO,KAAK,CAAC,iCAAiC,KAAK,aAAa,KAAK,SAAS,GAAG,KAAK,CAAC,iCAAiC;QAC5H,IAAI,OAAO,KAAK,CAAC,iCAAiC,KAAK,aAAa,KAAK,SAAS,GAAG,KAAK,CAAC,iCAAiC;QAE5H,IAAI,CAAC,KAAK,CAAC,WAAW,CAAC,IAAI,CAAC,KAAK,CAAC,QAAQ,OAAO;IACrD;IAEO,aAAa,QAAiB,EAAQ;QACzC,IAAI,CAAC,KAAK,CAAC,WAAW,CAAC;IAC3B;IAEO,qBAA8B;QACjC,OAAO,IAAI,CAAC,iBAAiB;IACjC;IAEO,eAAoB;QACvB,OAAO,IAAI,CAAC,KAAK;IACrB;AACJ"}},
    {"offset": {"line": 2361, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Michael/IdeaProjects/MSMTB/src/trading-cockpit/src/components/charts/widgets/VerticalLineWidget.ts"],"sourcesContent":["import { InteractiveChartObject, Handle } from './InteractiveChartObject';\r\nimport { Point } from './types';\r\nimport { AnchorInfo } from './MagnetService';\r\nimport { Time } from 'lightweight-charts';\r\n\r\nexport interface VerticalLineState {\r\n    time: number;\r\n    price: number; // For handle positioning along the line\r\n    color: string;\r\n    width: number;\r\n    lineStyle: number; // 0=Solid, 1=Dotted, 2=Dashed, etc.\r\n    showLabel: boolean;\r\n    fixed: boolean;\r\n    anchor?: AnchorInfo | null;\r\n}\r\n\r\nexport class VerticalLineWidget extends InteractiveChartObject {\r\n    private _data: VerticalLineState;\r\n\r\n    constructor(initialData: VerticalLineState) {\r\n        super();\r\n        this._data = initialData;\r\n        this._timeframe = initialData.anchor?.timeframe || 'D1';\r\n    }\r\n\r\n    public getHandles(): Handle[] {\r\n        return [\r\n            {\r\n                id: 'drag',\r\n                time: this._data.time,\r\n                price: this._data.price,\r\n                // axisLock: 'horizontal_only', // Ideally we want to lock Y (Price) so handle stays put? \r\n                // But dragging free allows user to position handle where they want on the line.\r\n                axisLock: 'free',\r\n                cursor: 'ew-resize' // East-West resize\r\n            }\r\n        ];\r\n    }\r\n\r\n    public updatePoint(handleId: string, newPoint: { time: number; price: number; anchor?: AnchorInfo }): void {\r\n        if (handleId === 'body' || handleId === 'drag') {\r\n            this._data.time = newPoint.time;\r\n            this._data.price = newPoint.price; // Update handle vertical position too\r\n            this._data.anchor = newPoint.anchor || null;\r\n            this._requestUpdate?.();\r\n        }\r\n    }\r\n\r\n    public drawShape(ctx: CanvasRenderingContext2D): void {\r\n        if (!this._chart || !this._series) return;\r\n\r\n        const timeScale = this._chart.timeScale();\r\n        const x = timeScale.timeToCoordinate(this._data.time as Time);\r\n\r\n        if (x === null) return;\r\n\r\n        const height = ctx.canvas.height; // Screen height\r\n\r\n        ctx.save();\r\n        ctx.beginPath();\r\n\r\n        // Set Styles\r\n        ctx.strokeStyle = this._data.color;\r\n        ctx.lineWidth = this._data.width;\r\n\r\n        // Line Pattern\r\n        if (this._data.lineStyle === 1) ctx.setLineDash([2, 2]);\r\n        else if (this._data.lineStyle === 2) ctx.setLineDash([6, 6]);\r\n        else ctx.setLineDash([]);\r\n\r\n        ctx.moveTo(x, 0);\r\n        ctx.lineTo(x, height);\r\n        ctx.stroke();\r\n\r\n        // Label at bottom or top? Horizontal line has it on right axis.\r\n        // Vertical line logic often has date at bottom.\r\n        // But lightweight-charts handles date axis.\r\n        // Maybe we just draw a small text near the top?\r\n        if (this._data.showLabel) {\r\n            const dateStr = new Date(this._data.time * 1000).toLocaleDateString();\r\n            ctx.font = '11px sans-serif';\r\n            ctx.fillStyle = this._data.color;\r\n            ctx.fillText(dateStr, x + 5, 20); // 20px from top\r\n        }\r\n\r\n        ctx.restore();\r\n    }\r\n\r\n    protected hitTestBody(point: Point): boolean {\r\n        if (!this._chart) return false;\r\n\r\n        const timeScale = this._chart.timeScale();\r\n        const x = timeScale.timeToCoordinate(this._data.time as Time);\r\n\r\n        if (x === null) return false;\r\n\r\n        const tolerance = 6 + (this._data.width / 2);\r\n        return Math.abs(point.x - x) <= tolerance;\r\n    }\r\n\r\n    public getSettingsSchema(): import('./InteractiveChartObject').SettingField[] {\r\n        return [\r\n            { id: 'color', label: 'Color', type: 'color', value: this._data.color },\r\n            { id: 'width', label: 'Width', type: 'number', value: this._data.width },\r\n            { id: 'showLabel', label: 'Show Date Label', type: 'boolean', value: this._data.showLabel },\r\n        ];\r\n    }\r\n\r\n    public applySettings(settings: any): void {\r\n        this._data = { ...this._data, ...settings };\r\n        this._requestUpdate?.();\r\n    }\r\n\r\n    public getData() { return this._data; }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2479, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Michael/IdeaProjects/MSMTB/src/trading-cockpit/src/components/charts/ActivePositionTool.ts"],"sourcesContent":["import { Time, PrimitiveHoveredItem } from 'lightweight-charts';\r\nimport { InteractiveChartObject, Handle } from './widgets/InteractiveChartObject';\r\nimport { Point } from './widgets/types';\r\n\r\nexport interface ActivePositionState {\r\n    id: string; // Trade ID\r\n    symbol: string;\r\n    direction: 'LONG' | 'SHORT';\r\n    entryPrice: number;\r\n    stopLossPrice?: number;\r\n    takeProfitPrice?: number;\r\n    timeIndex?: number;\r\n\r\n    // PnL calc\r\n    volume?: number;     // e.g. 1.0\r\n    contractSize?: number; // e.g. 100000 or 1\r\n    tickValue?: number;  // Optional override\r\n\r\n    // Data\r\n    currentProfit?: number; // For Entry Label\r\n    currency?: string;      // e.g. \"USD\" | \"EUR\"\r\n\r\n    // Visuals\r\n    lineColor?: string;\r\n    stopColor?: string;\r\n    profitColor?: string;\r\n}\r\n\r\nexport class ActivePositionTool extends InteractiveChartObject {\r\n    private _data: ActivePositionState;\r\n    private _width: number = 0; // Infinite width logic handled in adapter usually, or we use explicit width\r\n\r\n    constructor(data: ActivePositionState) {\r\n        super();\r\n        this._data = data;\r\n    }\r\n\r\n    public updatePrice(type: 'entry' | 'sl' | 'tp', price: number) {\r\n        if (type === 'entry') this._data.entryPrice = price;\r\n        if (type === 'sl') this._data.stopLossPrice = price;\r\n        if (type === 'tp') this._data.takeProfitPrice = price;\r\n        this._requestUpdate?.();\r\n    }\r\n\r\n    public updateProfit(profit: number) {\r\n        this._data.currentProfit = profit;\r\n        this._requestUpdate?.();\r\n    }\r\n\r\n    /**\r\n     * Called by ChartWidget when a new tick arrives.\r\n     * Calculates PnL locally for instant feedback.\r\n     */\r\n    public updateMarketPrice(price: number, time: number) {\r\n        // Simple PnL Calculation\r\n        // If we have volume, we can try to estimate.\r\n        // For now, if we don't have volume/contract details, we might just trust the external updateProfit?\r\n        // BUT the user complains about sync.\r\n        // If we assume standard Forex/CFD: (Current - Entry) * Volume * ContractSize\r\n\r\n        if (this._data.entryPrice && this._data.volume) {\r\n            const diff = price - this._data.entryPrice;\r\n            const dirMult = this._data.direction === 'LONG' ? 1 : -1;\r\n\r\n            // Default Contract Size 1 if not set (or 100000?)\r\n            // We need to pass this from the trade data.\r\n            // For now, let's use a simplified multiplier or fallback to just price diff if volume is missing.\r\n\r\n            const multiplier = this._data.contractSize || 1;\r\n            const rawPnL = diff * dirMult * this._data.volume * multiplier;\r\n\r\n            this._data.currentProfit = rawPnL;\r\n            this._requestUpdate?.();\r\n        }\r\n    }\r\n\r\n    public getHandles(): Handle[] {\r\n        // We only want handles on the right edge, but for now we can just return standard handles\r\n        // IF we want them draggable later. For now, visual only as per requirements\r\n        // \"spter aber erst! den level verschieben kann\" -> \"Only later draggable\"\r\n        // So no handles for now? Or just visual handles?\r\n        // User said: \"am rechten rand dann eine griffflche... (spter aber erst! den level verschieben kann)\"\r\n        // So we draw the grip, but maybe don't enable dragging yet?\r\n        // Or we implement handles but return empty here to disable interaction?\r\n        return [];\r\n    }\r\n\r\n    public drawShape(ctx: CanvasRenderingContext2D): void {\r\n        if (!this._chart || !this._series) return;\r\n\r\n        const series = this._series;\r\n        const width = this._chart.timeScale().width();\r\n        const range = this._chart.timeScale().getVisibleRange();\r\n\r\n        // We draw full width, so we need coordinates from 0 to width?\r\n        // Or we use the visible logical range.\r\n        // Canvas is sized to the chart pane. 0 is left, width is right.\r\n\r\n        const drawDashedLine = (price: number | undefined, color: string) => {\r\n            if (price === undefined || price === 0) return;\r\n            const y = series.priceToCoordinate(price);\r\n            if (y === null) return;\r\n\r\n            ctx.beginPath();\r\n            ctx.strokeStyle = color;\r\n            ctx.lineWidth = 1;\r\n            ctx.setLineDash([4, 4]); // Dashed\r\n            ctx.moveTo(0, y);\r\n            ctx.lineTo(width, y);\r\n            ctx.stroke();\r\n            ctx.setLineDash([]); // Reset\r\n        };\r\n\r\n        const drawHandle = (price: number | undefined, color: string, label: string, isEntry: boolean = false) => {\r\n            if (price === undefined || price === 0) return;\r\n            const y = series.priceToCoordinate(price);\r\n            if (y === null) return;\r\n\r\n            // Handle Settings\r\n            const marginRight = 5; // Closer to edge\r\n            const handleWidth = 100;\r\n            const handleHeight = 22;\r\n            const handleX = width - marginRight - handleWidth;\r\n            const handleY = y - (handleHeight / 2);\r\n\r\n            // 1. Clear Line behind Handle (White Background)\r\n            ctx.fillStyle = '#FFFFFF';\r\n            // Note: In Dark Mode this should be dark. We assume White for now or need theme.\r\n            // Ideally we just fill the rect.\r\n\r\n            ctx.beginPath();\r\n            ctx.roundRect(handleX, handleY, handleWidth, handleHeight, 4);\r\n            ctx.fill();\r\n\r\n            // 2. Border\r\n            ctx.strokeStyle = color;\r\n            ctx.lineWidth = 1;\r\n            ctx.stroke();\r\n\r\n            // 3. Text\r\n            // Profit Text smaller to fit 5 digits\r\n            ctx.font = isEntry ? '10px sans-serif' : '11px sans-serif';\r\n            ctx.textAlign = 'center';\r\n            ctx.textBaseline = 'middle';\r\n\r\n            // Profit Color Logic for Entry\r\n            if (isEntry) {\r\n                const p = this._data.currentProfit || 0;\r\n                ctx.fillStyle = p >= 0 ? '#10B981' : '#EF4444'; // Green/Red Text\r\n            } else {\r\n                ctx.fillStyle = color; // Label Color matches Line\r\n            }\r\n\r\n            // Calc Text X (Center of payload area?)\r\n            // Area: [Width - CloseBtn]\r\n            const closeBtnWidth = 20;\r\n            const contentWidth = handleWidth - closeBtnWidth;\r\n            const textX = handleX + (contentWidth / 2);\r\n\r\n            ctx.fillText(label, textX, handleY + (handleHeight / 2) + 1);\r\n\r\n            // 4. Divider (Light)\r\n            ctx.beginPath();\r\n            ctx.strokeStyle = 'rgba(200, 200, 200, 0.5)';\r\n            ctx.moveTo(handleX + contentWidth, handleY);\r\n            ctx.lineTo(handleX + contentWidth, handleY + handleHeight);\r\n            ctx.stroke();\r\n\r\n            // 5. Close \"X\"\r\n            const closeX = handleX + contentWidth + (closeBtnWidth / 2);\r\n            const closeY = handleY + (handleHeight / 2);\r\n\r\n            ctx.fillStyle = '#94a3b8'; // Slate-400\r\n            ctx.font = '12px sans-serif';\r\n            ctx.fillText('', closeX, closeY); // Standard Multiplication Sign or 'x'\r\n        };\r\n\r\n        // Colors\r\n        // Entry: Blue/Black? User said \"Entry: Black\" originally. But TV usually Blue.\r\n        const entryColor = this._data.lineColor || '#000000'; // Fallback\r\n        const slColor = this._data.stopColor || 'rgba(239, 68, 68, 1)';\r\n        const tpColor = this._data.profitColor || 'rgba(16, 185, 129, 1)';\r\n\r\n        // 1. Draw Lines First (Background)\r\n        drawDashedLine(this._data.takeProfitPrice, tpColor);\r\n        drawDashedLine(this._data.stopLossPrice, slColor);\r\n        drawDashedLine(this._data.entryPrice, entryColor);\r\n\r\n        // 2. Draw Handles (Foreground)\r\n        if (this._data.takeProfitPrice) drawHandle(this._data.takeProfitPrice, tpColor, \"Take Profit\");\r\n        if (this._data.stopLossPrice) drawHandle(this._data.stopLossPrice, slColor, \"Stop Loss\");\r\n\r\n        // Entry Label: Profit\r\n        const profitVal = this._data.currentProfit || 0;\r\n        const cur = this._data.currency || 'USD';\r\n        const profitTxt = `${profitVal > 0 ? '+' : ''}${profitVal.toFixed(2)} ${cur}`;\r\n\r\n        drawHandle(this._data.entryPrice, entryColor, profitTxt, true);\r\n    }\r\n\r\n    public hitTest(x: number, y: number): PrimitiveHoveredItem | null {\r\n        // Interaction disabled for now\r\n        return null;\r\n    }\r\n\r\n    public updatePoint(handleId: string, newPoint: { time: number, price: number, anchor?: any }): void {\r\n        // No-op for now as we don't have draggable points yet\r\n    }\r\n\r\n    public getData() { return this._data; }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2645, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Michael/IdeaProjects/MSMTB/src/trading-cockpit/src/components/charts/widgets/adapters/ActivePositionAdapter.ts"],"sourcesContent":["import { IChartShape, TimePoint, EntityId } from '../api';\r\nimport { ActivePositionTool } from '../../ActivePositionTool';\r\nimport { v4 as uuidv4 } from 'uuid';\r\n\r\nexport class ActivePositionAdapter implements IChartShape {\r\n    public id: EntityId;\r\n    public name: string = 'ActivePosition';\r\n\r\n    private _tool: ActivePositionTool;\r\n    private _selectionEnabled: boolean = false; // No selection for now\r\n\r\n    constructor(tool: ActivePositionTool) {\r\n        this.id = tool.getData().id || uuidv4(); // Use Trade ID if possible\r\n        this._tool = tool;\r\n    }\r\n\r\n    public getPoints(): TimePoint[] {\r\n        // Not really point-based in the traditional sense\r\n        const d = this._tool.getData();\r\n        return [{ time: 0, price: d.entryPrice }];\r\n    }\r\n\r\n    public setPoints(points: TimePoint[]): void {\r\n        // No-op\r\n    }\r\n\r\n    public getProperties(): Record<string, any> {\r\n        return this._tool.getData();\r\n    }\r\n\r\n    public setProperties(props: Record<string, any>): void {\r\n        // Update logic if needed\r\n        const d = this._tool.getData();\r\n        if (props.entryPrice !== undefined) d.entryPrice = props.entryPrice;\r\n        if (props.stopLossPrice !== undefined) d.stopLossPrice = props.stopLossPrice;\r\n        if (props.takeProfitPrice !== undefined) d.takeProfitPrice = props.takeProfitPrice;\r\n        if (props.direction !== undefined) d.direction = props.direction;\r\n        if (props.currentProfit !== undefined) d.currentProfit = props.currentProfit;\r\n    }\r\n\r\n    public isSelectionEnabled(): boolean {\r\n        return false;\r\n    }\r\n\r\n    public setSelection(selected: boolean): void {\r\n        // No-op\r\n    }\r\n\r\n    public getTool(): ActivePositionTool {\r\n        return this._tool;\r\n    }\r\n\r\n    public getPrimitive(): any {\r\n        return this._tool;\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;AAEA;;AAEO,MAAM;IACF,GAAa;IACb,OAAe,iBAAiB;IAE/B,MAA0B;IAC1B,oBAA6B,MAAM;IAE3C,YAAY,IAAwB,CAAE;QAClC,IAAI,CAAC,EAAE,GAAG,KAAK,OAAO,GAAG,EAAE,IAAI,IAAA,4KAAM,KAAI,2BAA2B;QACpE,IAAI,CAAC,KAAK,GAAG;IACjB;IAEO,YAAyB;QAC5B,kDAAkD;QAClD,MAAM,IAAI,IAAI,CAAC,KAAK,CAAC,OAAO;QAC5B,OAAO;YAAC;gBAAE,MAAM;gBAAG,OAAO,EAAE,UAAU;YAAC;SAAE;IAC7C;IAEO,UAAU,MAAmB,EAAQ;IACxC,QAAQ;IACZ;IAEO,gBAAqC;QACxC,OAAO,IAAI,CAAC,KAAK,CAAC,OAAO;IAC7B;IAEO,cAAc,KAA0B,EAAQ;QACnD,yBAAyB;QACzB,MAAM,IAAI,IAAI,CAAC,KAAK,CAAC,OAAO;QAC5B,IAAI,MAAM,UAAU,KAAK,WAAW,EAAE,UAAU,GAAG,MAAM,UAAU;QACnE,IAAI,MAAM,aAAa,KAAK,WAAW,EAAE,aAAa,GAAG,MAAM,aAAa;QAC5E,IAAI,MAAM,eAAe,KAAK,WAAW,EAAE,eAAe,GAAG,MAAM,eAAe;QAClF,IAAI,MAAM,SAAS,KAAK,WAAW,EAAE,SAAS,GAAG,MAAM,SAAS;QAChE,IAAI,MAAM,aAAa,KAAK,WAAW,EAAE,aAAa,GAAG,MAAM,aAAa;IAChF;IAEO,qBAA8B;QACjC,OAAO;IACX;IAEO,aAAa,QAAiB,EAAQ;IACzC,QAAQ;IACZ;IAEO,UAA8B;QACjC,OAAO,IAAI,CAAC,KAAK;IACrB;IAEO,eAAoB;QACvB,OAAO,IAAI,CAAC,KAAK;IACrB;AACJ"}},
    {"offset": {"line": 2705, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Michael/IdeaProjects/MSMTB/src/trading-cockpit/src/components/charts/widgets/ChartWidget.ts"],"sourcesContent":["import { IChartWidgetApi, CreateShapeOptions, TimePoint, EntityId, IChartShape } from './api';\r\nimport { ShapeManager } from './ShapeManager';\r\nimport { LongShortPositionAdapter } from './adapters/LongShortPositionAdapter';\r\nimport { TrendLineAdapter } from './adapters/TrendLineAdapter';\r\nimport { HorizontalLineAdapter } from './adapters/HorizontalLineAdapter';\r\nimport { HorizontalRayAdapter } from './adapters/HorizontalRayAdapter';\r\nimport { LongShortPosition, LongShortState } from '../LongShortPosition';\r\nimport { TrendLineTool, TrendLineState } from '../TrendLineTool';\r\nimport { HorizontalLineWidget, HorizontalLineState } from './HorizontalLineWidget';\r\nimport { HorizontalRayWidget, HorizontalRayState } from './HorizontalRayWidget';\r\nimport { VerticalLineAdapter } from './adapters/VerticalLineAdapter';\r\nimport { VerticalLineWidget, VerticalLineState } from './VerticalLineWidget';\r\nimport { ActivePositionTool, ActivePositionState } from '../ActivePositionTool';\r\nimport { ActivePositionAdapter } from './adapters/ActivePositionAdapter';\r\nimport { IChartApi, ISeriesApi, SeriesType } from 'lightweight-charts';\r\n\r\nexport class ChartWidget implements IChartWidgetApi {\r\n    private _chart: IChartApi;\r\n    private _series: ISeriesApi<SeriesType>;\r\n    private _shapeManager: ShapeManager;\r\n    private _symbol: string = 'UNKNOWN';\r\n\r\n    private _data: any[] = [];\r\n    public readonly id: string; // Public for verification\r\n\r\n    constructor(id: string, chart: IChartApi, series: ISeriesApi<SeriesType>) {\r\n        this.id = id;\r\n        this._chart = chart;\r\n        this._series = series;\r\n        this._shapeManager = new ShapeManager();\r\n    }\r\n\r\n    public setSymbol(symbol: string) {\r\n        this._symbol = symbol;\r\n    }\r\n\r\n    private _currentTimeframe: string = 'D1';\r\n\r\n    // --- Factory Method ---\r\n    public async createShape(point: TimePoint, options: CreateShapeOptions & { restoreState?: any }): Promise<EntityId> {\r\n        let shape: IChartShape | null = null;\r\n        let primitive: any = null;\r\n\r\n        if (options.shape === 'Riskrewardlong' || options.shape === 'Riskrewardshort') {\r\n            const isLong = options.shape === 'Riskrewardlong';\r\n\r\n            let initialState: LongShortState;\r\n\r\n            if (options.restoreState) {\r\n                initialState = options.restoreState;\r\n                if (!initialState.symbol) initialState.symbol = this._symbol;\r\n            } else {\r\n                const price = point.price;\r\n                const spread = price * 0.0005;\r\n                initialState = {\r\n                    entryPrice: price,\r\n                    stopLossPrice: isLong ? price - spread : price + spread,\r\n                    takeProfitPrice: isLong ? price + (spread * 2) : price - (spread * 2),\r\n                    timeIndex: point.time as number,\r\n                    riskReward: 2.0,\r\n                    fixedLeg: 'rr',\r\n                    fixedStates: { tp: false, sl: false, entry: false, rr: true },\r\n                    orderType: 'MARKET',\r\n                    symbol: this._symbol\r\n                };\r\n            }\r\n\r\n            // Apply overrides if any (and not restoring or force override)\r\n            if (options.overrides && !options.restoreState) {\r\n                const overrides = options.overrides as Record<string, any>;\r\n                const prefix = isLong ? 'linetoolriskrewardlong' : 'linetoolriskrewardshort';\r\n\r\n                if (typeof overrides[`${prefix}.stopLevel`] === 'number') initialState.stopLossPrice = overrides[`${prefix}.stopLevel`];\r\n                if (typeof overrides[`${prefix}.profitLevel`] === 'number') initialState.takeProfitPrice = overrides[`${prefix}.profitLevel`];\r\n                if (typeof overrides[`${prefix}.entryPrice`] === 'number') initialState.entryPrice = overrides[`${prefix}.entryPrice`];\r\n                if (typeof overrides[`${prefix}.riskReward`] === 'number') initialState.riskReward = overrides[`${prefix}.riskReward`];\r\n                if (typeof overrides[`${prefix}.fixedLeg`] === 'string') initialState.fixedLeg = overrides[`${prefix}.fixedLeg`] as any;\r\n\r\n                if (typeof overrides[`${prefix}.lineColor`] === 'string') initialState.lineColor = overrides[`${prefix}.lineColor`];\r\n                if (typeof overrides[`${prefix}.stopColor`] === 'string') initialState.stopColor = overrides[`${prefix}.stopColor`];\r\n                if (typeof overrides[`${prefix}.profitColor`] === 'string') initialState.profitColor = overrides[`${prefix}.profitColor`];\r\n                if (typeof overrides[`${prefix}.accountSize`] === 'number') initialState.accountSize = overrides[`${prefix}.accountSize`];\r\n                if (typeof overrides[`${prefix}.riskSize`] === 'number') initialState.riskSize = overrides[`${prefix}.riskSize`];\r\n                if (typeof overrides[`${prefix}.riskDisplayMode`] === 'string') initialState.riskDisplayMode = overrides[`${prefix}.riskDisplayMode`] as any;\r\n                if (typeof overrides[`${prefix}.compact`] === 'boolean') initialState.compact = overrides[`${prefix}.compact`];\r\n                if (typeof overrides[`${prefix}.symbol`] === 'string') initialState.symbol = overrides[`${prefix}.symbol`];\r\n            }\r\n\r\n            // Create Tool\r\n            const tool = new LongShortPosition(initialState);\r\n\r\n            // Set Selection if requested\r\n            if (options.disableSelection) {\r\n                // We might need a way to disable selection on the tool\r\n                // tool.setSelectionEnabled(false); // TODO: Add to PositionTool\r\n            }\r\n\r\n            // Create Adapter\r\n            shape = new LongShortPositionAdapter(tool, options.shape);\r\n            primitive = tool;\r\n            tool.setTimeframe(this._currentTimeframe);\r\n\r\n        } else if (options.shape === 'trend_line') {\r\n            // Note: The 'points' array is not directly available in createShape.\r\n            // Assuming 'point' is the first point, and a second point might be added later\r\n            // or this block is intended for createMultipointShape.\r\n            // For now, we'll use 'point' for p1 and a default for p2.\r\n            const p1 = point;\r\n            const p2 = { time: p1.time, price: p1.price }; // Default second point same as first\r\n\r\n            const initialState: TrendLineState = {\r\n                p1: { ...p1, time: p1.time as number },\r\n                p2: { ...p2, time: p2.time as number },\r\n                color: (options.overrides as any)?.[\"linetooltrendline.linecolor\"],\r\n                width: (options.overrides as any)?.[\"linetooltrendline.linewidth\"]\r\n            };\r\n\r\n            const tool = new TrendLineTool(initialState);\r\n            shape = new TrendLineAdapter(tool);\r\n            primitive = tool;\r\n        } else if (options.shape === 'HorizontalLine') {\r\n            const initialState: HorizontalLineState = {\r\n                price: point.price,\r\n                time: point.time as number,\r\n                color: (options.overrides as any)?.[\"linetoolhorizontalline.linecolor\"] || '#2962FF',\r\n                width: (options.overrides as any)?.[\"linetoolhorizontalline.linewidth\"] || 2, // Doubled default width\r\n                lineStyle: 0,\r\n                showLabel: true,\r\n                fixed: false,\r\n                anchor: (options.overrides as any)?.anchor\r\n            };\r\n            const tool = new HorizontalLineWidget(initialState);\r\n            shape = new HorizontalLineAdapter(tool);\r\n            primitive = tool;\r\n        } else if (options.shape === 'HorizontalRay') {\r\n            const initialState: HorizontalRayState = {\r\n                time: point.time as number,\r\n                price: point.price,\r\n                color: (options.overrides as any)?.[\"linetoolhorizontalray.linecolor\"] || '#2962FF',\r\n                width: (options.overrides as any)?.[\"linetoolhorizontalray.linewidth\"] || 2, // Doubled default width\r\n                anchor: (options.overrides as any)?.anchor\r\n            };\r\n            const tool = new HorizontalRayWidget(initialState);\r\n            shape = new HorizontalRayAdapter(tool);\r\n            primitive = tool;\r\n        } else if (options.shape === 'VerticalLine') {\r\n            const initialState: VerticalLineState = {\r\n                time: point.time as number,\r\n                price: point.price,\r\n                color: (options.overrides as any)?.[\"linetoolverticalline.linecolor\"] || '#2962FF',\r\n                width: (options.overrides as any)?.[\"linetoolverticalline.linewidth\"] || 2,\r\n                lineStyle: 0,\r\n                showLabel: false, // Default to false for vertical line as date is on axis usually\r\n                fixed: false,\r\n                anchor: (options.overrides as any)?.anchor\r\n            };\r\n            const tool = new VerticalLineWidget(initialState);\r\n            shape = new VerticalLineAdapter(tool);\r\n            primitive = tool;\r\n        } else if (options.shape === 'ActivePosition') {\r\n            // New Active Position Tool logic\r\n            // Expect overrides to contain the full state\r\n            const overrides = options.overrides as any;\r\n            const initialState: ActivePositionState = {\r\n                id: overrides.id || 'UNKNOWN',\r\n                symbol: overrides.symbol || this._symbol,\r\n                direction: overrides.direction || 'LONG',\r\n                entryPrice: overrides.entryPrice || point.price,\r\n                stopLossPrice: overrides.stopLossPrice,\r\n                takeProfitPrice: overrides.takeProfitPrice,\r\n                // visuals\r\n                lineColor: overrides.lineColor || '#000000',\r\n                stopColor: overrides.stopColor || 'rgba(239, 68, 68, 1)',\r\n                profitColor: overrides.profitColor || 'rgba(16, 185, 129, 1)'\r\n            };\r\n\r\n            const tool = new ActivePositionTool(initialState);\r\n            shape = new ActivePositionAdapter(tool);\r\n            primitive = tool;\r\n        }\r\n\r\n        if (shape && primitive) {\r\n            // Apply Data \r\n            if (this._data.length > 0 && typeof (primitive as any).setSeriesData === 'function') {\r\n                (primitive as any).setSeriesData(this._data);\r\n            }\r\n\r\n            // Register\r\n            this._shapeManager.register(shape);\r\n\r\n            // Attach to Chart\r\n            this._series.attachPrimitive(primitive);\r\n\r\n            // Register execution listener for the UI to pick up\r\n            if (shape instanceof LongShortPositionAdapter) {\r\n                shape.onExecute = (trade) => {\r\n                    this._shapeManager.emit('execute', { trade, id: shape?.id });\r\n                };\r\n            }\r\n\r\n            // Default Selection for new tools (UX Requirement: Visible handles on creation)\r\n            if (shape && typeof shape.setSelection === 'function') {\r\n                if (!options.restoreState) {\r\n                    shape.setSelection(true);\r\n                }\r\n            }\r\n\r\n            // Wire up deletion sync\r\n            if (primitive && (primitive as any).onRemove === undefined) {\r\n                // If not already defined (though we just defined it on the class)\r\n                // We assign it here to control the flow\r\n                (primitive as any).onRemove = () => {\r\n                    if (shape) this.removeEntity(shape.id);\r\n                };\r\n            } else if (primitive) {\r\n                // Force override to ensure it calls OUR removeEntity\r\n                (primitive as any).onRemove = () => {\r\n                    if (shape) this.removeEntity(shape.id);\r\n                };\r\n            }\r\n\r\n            return shape.id;\r\n        }\r\n\r\n        throw new Error(`Unsupported shape type: ${options.shape}`);\r\n    }\r\n\r\n    public setTimeframe(tf: string) {\r\n        this._currentTimeframe = tf;\r\n        // Propagate to existing tools\r\n        const allShapes = this._shapeManager.getAll();\r\n        allShapes.forEach(s => {\r\n            const p = s.getPrimitive();\r\n            if (p && typeof (p as any).setTimeframe === 'function') {\r\n                (p as any).setTimeframe(tf);\r\n            }\r\n        });\r\n    }\r\n\r\n    // --- Multipoint ---\r\n    public async createMultipointShape(points: TimePoint[], options: CreateShapeOptions): Promise<EntityId> {\r\n        let shape: IChartShape | null = null;\r\n        let primitive: any = null;\r\n\r\n        if (options.shape === 'trend_line') {\r\n            const p1 = points[0] || { time: 0, price: 0 };\r\n            const p2 = points[1] || { time: p1.time, price: p1.price };\r\n\r\n            const initialState: TrendLineState = {\r\n                p1: { ...p1, time: p1.time as number },\r\n                p2: { ...p2, time: p2.time as number },\r\n                color: (options.overrides as any)?.[\"linetooltrendline.linecolor\"],\r\n                width: (options.overrides as any)?.[\"linetooltrendline.linewidth\"]\r\n            };\r\n\r\n            const tool = new TrendLineTool(initialState);\r\n            shape = new TrendLineAdapter(tool);\r\n            primitive = tool;\r\n        }\r\n\r\n        if (shape && primitive) {\r\n            // Apply Data \r\n            if (this._data.length > 0 && typeof (primitive as any).setSeriesData === 'function') {\r\n                (primitive as any).setSeriesData(this._data);\r\n            }\r\n\r\n            this._shapeManager.register(shape);\r\n            this._series.attachPrimitive(primitive);\r\n            return shape.id;\r\n        }\r\n\r\n        throw new Error(`Shape type ${options.shape} not supported in createMultipointShape`);\r\n    }\r\n\r\n    // --- Management ---\r\n    public getAllShapes(): IChartShape[] {\r\n        return this._shapeManager.getAll();\r\n    }\r\n\r\n    public getShapeById(id: EntityId): IChartShape | null {\r\n        return this._shapeManager.get(id);\r\n    }\r\n\r\n    /**\r\n     * Hit test for chart widgets.\r\n     * Iterates in reverse order (top-most first) to find the clicked widget.\r\n     */\r\n    public hitTest(x: number, y: number): IChartShape | null {\r\n        const shapes = this._shapeManager.getAll();\r\n        // Iterate in reverse order (last added = drawn on top)\r\n        for (let i = shapes.length - 1; i >= 0; i--) {\r\n            const shape = shapes[i];\r\n            const primitive = shape.getPrimitive();\r\n\r\n            // Check if the primitive has a hitTest method (it should if it inherits from InteractiveChartObject)\r\n            if (primitive && typeof (primitive as any).hitTest === 'function') {\r\n                const hit = (primitive as any).hitTest(x, y);\r\n                if (hit) {\r\n                    return shape;\r\n                }\r\n            }\r\n        }\r\n        return null;\r\n    }\r\n\r\n    public removeEntity(id: EntityId): void {\r\n        const shape = this._shapeManager.get(id);\r\n        if (shape) {\r\n            // Generic Detach\r\n            const primitive = shape.getPrimitive();\r\n            if (primitive && this._series) {\r\n                try {\r\n                    this._series.detachPrimitive(primitive);\r\n                } catch (e) {\r\n                    console.warn(`[ChartWidget:${this.id}] Failed to detach primitive (Series likely disposed):`, e);\r\n                }\r\n            }\r\n\r\n            this._shapeManager.unregister(id);\r\n        }\r\n    }\r\n\r\n    public removeAllShapes(): void {\r\n        this.detachAllPrimitives(); // Visual cleanup\r\n\r\n        // Data cleanup\r\n        const allShapes = this._shapeManager.getAll();\r\n        allShapes.forEach(shape => {\r\n            this._shapeManager.unregister(shape.id);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Detaches all primitives from the series (visual cleanup) but KEEPS them in the registry.\r\n     * This allows saving their state even after the visuals are destroyed.\r\n     */\r\n    public detachAllPrimitives(): void {\r\n        const allShapes = this._shapeManager.getAll();\r\n        allShapes.forEach(shape => {\r\n            const primitive = shape.getPrimitive();\r\n            if (primitive && this._series) {\r\n                try {\r\n                    this._series.detachPrimitive(primitive);\r\n                } catch (e) {\r\n                    console.warn(`[ChartWidget:${this.id}] Failed to detach primitive (Series likely disposed):`, e);\r\n                }\r\n            }\r\n        });\r\n    }\r\n\r\n    public deselectAllShapes(): void {\r\n        const allShapes = this._shapeManager.getAll();\r\n        allShapes.forEach(shape => {\r\n            const primitive = shape.getPrimitive();\r\n            if (primitive && typeof (primitive as any).setSelection === 'function') {\r\n                (primitive as any).setSelection(false);\r\n            }\r\n            // Also handle base widget's setSelected if different\r\n            if (primitive && typeof (primitive as any).setSelected === 'function') {\r\n                (primitive as any).setSelected(false);\r\n            }\r\n        });\r\n    }\r\n\r\n    public setSeriesData(data: any[]): void {\r\n        this._data = data;\r\n        const allShapes = this._shapeManager.getAll();\r\n        allShapes.forEach(shape => {\r\n            const primitive = shape.getPrimitive();\r\n            if (primitive && typeof (primitive as any).setSeriesData === 'function') {\r\n                (primitive as any).setSeriesData(data);\r\n            }\r\n        });\r\n    }\r\n\r\n    public updateLastPrice(price: number, time: number): void {\r\n        const allShapes = this._shapeManager.getAll();\r\n        allShapes.forEach(shape => {\r\n            const primitive = shape.getPrimitive();\r\n            if (primitive && typeof (primitive as any).updateMarketPrice === 'function') {\r\n                (primitive as any).updateMarketPrice(price, time);\r\n            }\r\n        });\r\n    }\r\n\r\n    // --- Events ---\r\n    public subscribe(event: 'drawing', callback: (params: any) => void): void {\r\n        this._shapeManager.subscribe(event, callback);\r\n    }\r\n\r\n    public unsubscribe(event: 'drawing', callback: (params: any) => void): void {\r\n        this._shapeManager.unsubscribe(event, callback);\r\n    }\r\n\r\n    // --- Persistence ---\r\n    public serializeDrawings(): string {\r\n        const shapes = this._shapeManager.getAll();\r\n        const serialized = shapes.map(shape => {\r\n            const primitive = shape.getPrimitive();\r\n            // Use getStorageState if available, fallback to empty or properties\r\n            const state = (primitive as any).getStorageState ? (primitive as any).getStorageState() : {};\r\n            return {\r\n                id: shape.id,\r\n                type: shape.name || (shape as any).type || 'unknown',\r\n                state\r\n            };\r\n        });\r\n        return JSON.stringify(serialized);\r\n    }\r\n\r\n    public hydrateDrawings(json: string): void {\r\n        try {\r\n            const shapes = JSON.parse(json);\r\n            if (Array.isArray(shapes) && shapes.length > 0) {\r\n                // We don't necessarily clear here because this might be additive hydration\r\n                // or the caller manages cleanup.\r\n\r\n                shapes.forEach((s: any) => {\r\n                    // Detect if LongShort\r\n                    if (s.type === 'Riskrewardlong' || s.type === 'Riskrewardshort') {\r\n                        if (s.state) {\r\n                            const point: TimePoint = {\r\n                                time: s.state.timeIndex || 0,\r\n                                price: s.state.entryPrice || 0\r\n                            };\r\n                            this.createShape(point, {\r\n                                shape: s.type,\r\n                                restoreState: s.state,\r\n                                disableSelection: true // restore selection state? maybe\r\n                            });\r\n                        }\r\n                    } else {\r\n                        console.log(`[ChartWidget] Hydration for type ${s.type} not fully implemented yet.`);\r\n                    }\r\n                });\r\n            }\r\n        } catch (e) {\r\n            console.error(\"Failed to hydrate drawings:\", e);\r\n        }\r\n    }\r\n    public dispose(): void {\r\n        this.detachAllPrimitives(); // Only clear visuals, keep data for saving!\r\n        // Nullify references to prevent further usage\r\n        (this._chart as any) = null;\r\n        (this._series as any) = null;\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3149, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Michael/IdeaProjects/MSMTB/src/trading-cockpit/src/components/charts/LoadingOverlay.tsx"],"sourcesContent":["import React from 'react';\r\nimport { Loader2 } from 'lucide-react';\r\n\r\ninterface LoadingOverlayProps {\r\n    isVisible: boolean;\r\n    status?: string;\r\n    error?: string;\r\n}\r\n\r\nexport const LoadingOverlay: React.FC<LoadingOverlayProps> = ({ isVisible, status = \"Initializing Data...\", error }) => {\r\n    if (!isVisible) return null;\r\n\r\n    return (\r\n        <div className=\"absolute inset-0 z-50 flex flex-col items-center justify-center bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm transition-opacity duration-300\">\r\n            {error ? (\r\n                <div className=\"flex flex-col items-center text-red-500 space-y-2 animate-in fade-in zoom-in duration-300\">\r\n                    <div className=\"p-3 rounded-full bg-red-500/10 border border-red-500/20\">\r\n                        <svg width=\"32\" height=\"32\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\r\n                            <circle cx=\"12\" cy=\"12\" r=\"10\" />\r\n                            <line x1=\"12\" y1=\"8\" x2=\"12\" y2=\"12\" />\r\n                            <line x1=\"12\" y1=\"16\" x2=\"12.01\" y2=\"16\" />\r\n                        </svg>\r\n                    </div>\r\n                    <span className=\"font-semibold\">{error}</span>\r\n                </div>\r\n            ) : (\r\n                <div className=\"flex flex-col items-center text-blue-600 dark:text-blue-400 space-y-3 animate-in fade-in zoom-in duration-300\">\r\n                    <Loader2 className=\"w-10 h-10 animate-spin\" />\r\n                    <span className=\"text-sm font-medium tracking-wide text-gray-600 dark:text-gray-300 animate-pulse\">\r\n                        {status}\r\n                    </span>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n"],"names":[],"mappings":";;;;;AACA;;;AAQO,MAAM,iBAAgD,CAAC,EAAE,SAAS,EAAE,SAAS,sBAAsB,EAAE,KAAK,EAAE;IAC/G,IAAI,CAAC,WAAW,OAAO;IAEvB,qBACI,6LAAC;QAAI,WAAU;kBACV,sBACG,6LAAC;YAAI,WAAU;;8BACX,6LAAC;oBAAI,WAAU;8BACX,cAAA,6LAAC;wBAAI,OAAM;wBAAK,QAAO;wBAAK,SAAQ;wBAAY,MAAK;wBAAO,QAAO;wBAAe,aAAY;wBAAI,eAAc;wBAAQ,gBAAe;;0CACnI,6LAAC;gCAAO,IAAG;gCAAK,IAAG;gCAAK,GAAE;;;;;;0CAC1B,6LAAC;gCAAK,IAAG;gCAAK,IAAG;gCAAI,IAAG;gCAAK,IAAG;;;;;;0CAChC,6LAAC;gCAAK,IAAG;gCAAK,IAAG;gCAAK,IAAG;gCAAQ,IAAG;;;;;;;;;;;;;;;;;8BAG5C,6LAAC;oBAAK,WAAU;8BAAiB;;;;;;;;;;;qEAGrC,6LAAC;YAAI,WAAU;;8BACX,6LAAC,+NAAO;oBAAC,WAAU;;;;;;8BACnB,6LAAC;oBAAK,WAAU;8BACX;;;;;;;;;;;;;;;;;AAMzB;KA1Ba"}},
    {"offset": {"line": 3269, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Michael/IdeaProjects/MSMTB/src/trading-cockpit/src/components/charts/contextmenu/ContextMenu.tsx"],"sourcesContent":["import React, { useEffect, useRef } from 'react';\r\n\r\nexport interface ContextMenuItem {\r\n    label: string;\r\n    action: () => void;\r\n    danger?: boolean;\r\n}\r\n\r\nexport interface ContextMenuProps {\r\n    x: number;\r\n    y: number;\r\n    items: ContextMenuItem[];\r\n    onClose: () => void;\r\n}\r\n\r\nexport const ContextMenu: React.FC<ContextMenuProps> = ({ x, y, items, onClose }) => {\r\n    const menuRef = useRef<HTMLDivElement>(null);\r\n\r\n    // Close on click outside\r\n    useEffect(() => {\r\n        const handleClickOutside = (event: MouseEvent) => {\r\n            if (menuRef.current && !menuRef.current.contains(event.target as Node)) {\r\n                onClose();\r\n            }\r\n        };\r\n\r\n        const handleScroll = () => onClose();\r\n\r\n        document.addEventListener('mousedown', handleClickOutside);\r\n        document.addEventListener('scroll', handleScroll, true); // Capture scroll to close menu\r\n\r\n        return () => {\r\n            document.removeEventListener('mousedown', handleClickOutside);\r\n            document.removeEventListener('scroll', handleScroll, true);\r\n        };\r\n    }, [onClose]);\r\n\r\n    // Adjust position if it flows out of viewport\r\n    const style: React.CSSProperties = {\r\n        top: y,\r\n        left: x,\r\n    };\r\n\r\n    return (\r\n        <div\r\n            ref={menuRef}\r\n            className=\"fixed z-50 min-w-[160px] py-1 bg-[#1E222D] border border-[#2A2E39] rounded shadow-lg text-sm text-[#D1D5DB]\"\r\n            style={style}\r\n            onClick={(e) => e.stopPropagation()} // Prevent click from propagating to chart\r\n        >\r\n            <ul className=\"flex flex-col\">\r\n                {items.map((item, index) => (\r\n                    <li key={index}>\r\n                        <button\r\n                            className={`w-full text-left px-4 py-2 hover:bg-[#2A2E39] transition-colors flex items-center gap-2 ${item.danger ? 'text-red-400 hover:text-red-300' : 'text-slate-200'\r\n                                }`}\r\n                            onClick={() => {\r\n                                item.action();\r\n                                onClose();\r\n                            }}\r\n                        >\r\n                            {item.label}\r\n                        </button>\r\n                    </li>\r\n                ))}\r\n            </ul>\r\n        </div>\r\n    );\r\n};\r\n"],"names":[],"mappings":";;;;;AAAA;;;;AAeO,MAAM,cAA0C,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,KAAK,EAAE,OAAO,EAAE;;IAC5E,MAAM,UAAU,IAAA,uKAAM,EAAiB;IAEvC,yBAAyB;IACzB,IAAA,0KAAS;iCAAC;YACN,MAAM;4DAAqB,CAAC;oBACxB,IAAI,QAAQ,OAAO,IAAI,CAAC,QAAQ,OAAO,CAAC,QAAQ,CAAC,MAAM,MAAM,GAAW;wBACpE;oBACJ;gBACJ;;YAEA,MAAM;sDAAe,IAAM;;YAE3B,SAAS,gBAAgB,CAAC,aAAa;YACvC,SAAS,gBAAgB,CAAC,UAAU,cAAc,OAAO,+BAA+B;YAExF;yCAAO;oBACH,SAAS,mBAAmB,CAAC,aAAa;oBAC1C,SAAS,mBAAmB,CAAC,UAAU,cAAc;gBACzD;;QACJ;gCAAG;QAAC;KAAQ;IAEZ,8CAA8C;IAC9C,MAAM,QAA6B;QAC/B,KAAK;QACL,MAAM;IACV;IAEA,qBACI,6LAAC;QACG,KAAK;QACL,WAAU;QACV,OAAO;QACP,SAAS,CAAC,IAAM,EAAE,eAAe;kBAEjC,cAAA,6LAAC;YAAG,WAAU;sBACT,MAAM,GAAG,CAAC,CAAC,MAAM,sBACd,6LAAC;8BACG,cAAA,6LAAC;wBACG,WAAW,CAAC,wFAAwF,EAAE,KAAK,MAAM,GAAG,oCAAoC,kBAClJ;wBACN,SAAS;4BACL,KAAK,MAAM;4BACX;wBACJ;kCAEC,KAAK,KAAK;;;;;;mBATV;;;;;;;;;;;;;;;AAgB7B;GArDa;KAAA"}},
    {"offset": {"line": 3358, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Michael/IdeaProjects/MSMTB/src/trading-cockpit/src/components/charts/settings/SettingsModal.tsx"],"sourcesContent":["import React, { useState, useEffect } from 'react';\r\nimport { SettingField } from '../widgets/InteractiveChartObject';\r\nimport { X } from 'lucide-react';\r\n\r\nexport interface SettingsModalProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n    onSave: (settings: any) => void;\r\n    schema: SettingField[];\r\n    title?: string;\r\n}\r\n\r\nexport const SettingsModal: React.FC<SettingsModalProps> = ({ isOpen, onClose, onSave, schema, title = 'Settings' }) => {\r\n    const [formData, setFormData] = useState<Record<string, any>>({});\r\n\r\n    // Initialize form data from schema values when opened\r\n    useEffect(() => {\r\n        if (isOpen) {\r\n            const initialData: Record<string, any> = {};\r\n            schema.forEach(field => {\r\n                initialData[field.id] = field.value;\r\n            });\r\n            setFormData(initialData);\r\n        }\r\n    }, [isOpen, schema]);\r\n\r\n    if (!isOpen) return null;\r\n\r\n    const handleChange = (id: string, value: any) => {\r\n        setFormData(prev => ({ ...prev, [id]: value }));\r\n    };\r\n\r\n    const handleSave = () => {\r\n        onSave(formData);\r\n        onClose();\r\n    };\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm\" onClick={onClose}>\r\n            <div\r\n                className=\"bg-white dark:bg-[#1E222D] border border-slate-300 dark:border-[#2A2E39] rounded-lg shadow-xl w-full max-w-sm overflow-hidden\"\r\n                onClick={e => e.stopPropagation()}\r\n            >\r\n                {/* Header */}\r\n                <div className=\"px-4 py-3 border-b border-slate-200 dark:border-[#2A2E39] flex justify-between items-center bg-slate-50 dark:bg-[#2A2E39]/30\">\r\n                    <h3 className=\"font-semibold text-slate-900 dark:text-slate-200\">{title}</h3>\r\n                    <button onClick={onClose} className=\"text-slate-400 hover:text-slate-900 dark:hover:text-slate-200 transition-colors\">\r\n                        <X size={18} />\r\n                    </button>\r\n                </div>\r\n\r\n                {/* Body */}\r\n                <div className=\"p-4 space-y-4\">\r\n                    {schema.map((field) => (\r\n                        <div key={field.id} className=\"flex flex-col gap-1.5\">\r\n                            <label className=\"text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wide\">\r\n                                {field.label}\r\n                            </label>\r\n\r\n                            {/* Render Input based on Type */}\r\n                            {field.type === 'color' && (\r\n                                <div className=\"flex items-center gap-2\">\r\n                                    <input\r\n                                        type=\"color\"\r\n                                        value={formData[field.id] || '#000000'}\r\n                                        onChange={(e) => handleChange(field.id, e.target.value)}\r\n                                        className=\"h-8 w-12 rounded cursor-pointer bg-transparent border-none p-0\"\r\n                                    />\r\n                                    <span className=\"text-sm font-mono text-slate-600 dark:text-slate-300 bg-slate-100 dark:bg-[#2A2E39] px-2 py-1 rounded border border-slate-200 dark:border-transparent\">\r\n                                        {formData[field.id]}\r\n                                    </span>\r\n                                </div>\r\n                            )}\r\n\r\n                            {field.type === 'number' && (\r\n                                <input\r\n                                    type=\"number\"\r\n                                    value={formData[field.id] || 0}\r\n                                    onChange={(e) => handleChange(field.id, parseFloat(e.target.value))}\r\n                                    className=\"bg-white dark:bg-[#131722] border border-slate-300 dark:border-[#2A2E39] rounded px-3 py-2 text-sm text-slate-900 dark:text-slate-200 focus:outline-none focus:border-indigo-500 transition-colors w-full\"\r\n                                />\r\n                            )}\r\n\r\n                            {field.type === 'text' && (\r\n                                <input\r\n                                    type=\"text\"\r\n                                    value={formData[field.id] || ''}\r\n                                    onChange={(e) => handleChange(field.id, e.target.value)}\r\n                                    className=\"bg-white dark:bg-[#131722] border border-slate-300 dark:border-[#2A2E39] rounded px-3 py-2 text-sm text-slate-900 dark:text-slate-200 focus:outline-none focus:border-indigo-500 transition-colors w-full\"\r\n                                />\r\n                            )}\r\n\r\n                            {field.type === 'select' && field.options && (\r\n                                <select\r\n                                    value={formData[field.id]}\r\n                                    onChange={(e) => handleChange(field.id, e.target.value)}\r\n                                    className=\"bg-white dark:bg-[#131722] border border-slate-300 dark:border-[#2A2E39] rounded px-3 py-2 text-sm text-slate-900 dark:text-slate-200 focus:outline-none focus:border-indigo-500 transition-colors w-full\"\r\n                                >\r\n                                    {field.options.map(opt => (\r\n                                        <option key={opt} value={opt}>{opt}</option>\r\n                                    ))}\r\n                                </select>\r\n                            )}\r\n\r\n                            {field.type === 'boolean' && (\r\n                                <div className=\"flex items-center gap-2\">\r\n                                    <input\r\n                                        type=\"checkbox\"\r\n                                        checked={!!formData[field.id]}\r\n                                        onChange={(e) => handleChange(field.id, e.target.checked)}\r\n                                        className=\"w-4 h-4 rounded border-slate-300 dark:border-slate-600 bg-white dark:bg-[#131722] text-indigo-500 focus:ring-indigo-500 focus:ring-offset-white dark:focus:ring-offset-slate-900\"\r\n                                    />\r\n                                    <span className=\"text-sm text-slate-700 dark:text-slate-300\">Enabled</span>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    ))}\r\n                </div>\r\n\r\n                {/* Footer */}\r\n                <div className=\"px-4 py-3 bg-slate-50 dark:bg-[#2A2E39]/30 border-t border-slate-200 dark:border-[#2A2E39] flex justify-end gap-2\">\r\n                    <button\r\n                        onClick={onClose}\r\n                        className=\"px-3 py-1.5 text-sm font-medium text-slate-500 hover:text-slate-900 dark:text-slate-400 dark:hover:text-slate-200 transition-colors\"\r\n                    >\r\n                        Cancel\r\n                    </button>\r\n                    <button\r\n                        onClick={handleSave}\r\n                        className=\"px-4 py-1.5 text-sm font-medium bg-indigo-600 hover:bg-indigo-500 text-white rounded shadow-sm transition-colors\"\r\n                    >\r\n                        Save Changes\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3604, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Michael/IdeaProjects/MSMTB/src/trading-cockpit/src/components/charts/indicators/IndicatorRegistry.ts"],"sourcesContent":["\r\nexport interface IndicatorDefinition {\r\n    id: string;\r\n    name: string;\r\n    description?: string;\r\n    defaultSettings: any;\r\n    // We store the Plugin Class constructor or factory\r\n    pluginFactory: (settings: any) => any;\r\n    settingsSchema?: any; // To be defined for generic settings\r\n    dataFetcher?: (params: { symbol: string, timeframe: string, from: number, to: number, settings: any }) => Promise<any>;\r\n    /**\r\n     * Optional function to transform chart data (e.g. for repainting candles).\r\n     * Returns a new array of data items with style overrides.\r\n     */\r\n    dataTransformer?: (data: any[], settings: any) => any[];\r\n}\r\n\r\nclass IndicatorRegistry {\r\n    private definitions: Map<string, IndicatorDefinition> = new Map();\r\n\r\n    register(def: IndicatorDefinition) {\r\n        if (this.definitions.has(def.id)) {\r\n            console.warn(`[IndicatorRegistry] Overwriting indicator: ${def.id}`);\r\n        }\r\n        this.definitions.set(def.id, def);\r\n    }\r\n\r\n    get(id: string): IndicatorDefinition | undefined {\r\n        return this.definitions.get(id);\r\n    }\r\n\r\n    getAll(): IndicatorDefinition[] {\r\n        return Array.from(this.definitions.values());\r\n    }\r\n\r\n    createInstance(id: string, settings: any) {\r\n        const def = this.get(id);\r\n        if (!def) return null;\r\n        // Merge defaults\r\n        const finalSettings = { ...def.defaultSettings, ...settings };\r\n        return def.pluginFactory(finalSettings);\r\n    }\r\n}\r\n\r\nexport const indicatorRegistry = new IndicatorRegistry();\r\n"],"names":[],"mappings":";;;;AAiBA,MAAM;IACM,cAAgD,IAAI,MAAM;IAElE,SAAS,GAAwB,EAAE;QAC/B,IAAI,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,IAAI,EAAE,GAAG;YAC9B,QAAQ,IAAI,CAAC,CAAC,2CAA2C,EAAE,IAAI,EAAE,EAAE;QACvE;QACA,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,IAAI,EAAE,EAAE;IACjC;IAEA,IAAI,EAAU,EAAmC;QAC7C,OAAO,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC;IAChC;IAEA,SAAgC;QAC5B,OAAO,MAAM,IAAI,CAAC,IAAI,CAAC,WAAW,CAAC,MAAM;IAC7C;IAEA,eAAe,EAAU,EAAE,QAAa,EAAE;QACtC,MAAM,MAAM,IAAI,CAAC,GAAG,CAAC;QACrB,IAAI,CAAC,KAAK,OAAO;QACjB,iBAAiB;QACjB,MAAM,gBAAgB;YAAE,GAAG,IAAI,eAAe;YAAE,GAAG,QAAQ;QAAC;QAC5D,OAAO,IAAI,aAAa,CAAC;IAC7B;AACJ;AAEO,MAAM,oBAAoB,IAAI"}},
    {"offset": {"line": 3641, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Michael/IdeaProjects/MSMTB/src/trading-cockpit/src/components/charts/ChartContainer.tsx"],"sourcesContent":["\"use client\";\r\n\r\nimport React, { useEffect, useRef, useState } from 'react';\r\nimport { createChart, ColorType, IChartApi, ISeriesApi, Time, CandlestickSeries, LineSeries, TickMarkType, LogicalRange } from 'lightweight-charts';\r\nimport { getTimeframeSeconds } from '../../utils/chartUtils';\r\nimport { useChartTheme } from '../../context/ChartThemeContext';\r\nimport { LongShortPosition, LongShortState } from './LongShortPosition';\r\nimport { ChartWidget } from './widgets/ChartWidget';\r\nimport { LoadingOverlay } from './LoadingOverlay';\r\nimport { SymbolBrowser } from '../live/SymbolBrowser';\r\nimport { MagnetControl } from './MagnetControl';\r\nimport { MagnetService } from './widgets/MagnetService';\r\nimport { ChevronLeft, ChevronRight, Settings, Clock, ChevronsRight } from 'lucide-react';\r\nimport { useContextMenu } from '../../hooks/useContextMenu';\r\nimport { ContextMenu, ContextMenuItem } from './contextmenu/ContextMenu';\r\nimport { SettingsModal } from './settings/SettingsModal';\r\nimport { indicatorRegistry } from './indicators/IndicatorRegistry';\r\nimport { ICTSessionsPlugin } from './plugins/ICTSessionsPlugin';\r\nimport { useBrokerStore } from '../../stores/useBrokerStore';\r\nimport { TradeDistributionManager, ExecutionBatch } from '../../managers/TradeDistributionManager';\r\nimport { useWorkspaceStore } from '../../stores/useWorkspaceStore';\r\nimport { useTradeMonitor } from '../../hooks/useTradeMonitor';\r\nimport { TradeLogService } from '../../services/TradeLogService';\r\n\r\n\r\n\r\nconst LongIcon = () => (\r\n    <svg width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\">\r\n        <rect x=\"3\" y=\"12\" width=\"18\" height=\"8\" rx=\"1\" fill=\"currentColor\" fillOpacity=\"0.2\" />\r\n        <rect x=\"3\" y=\"4\" width=\"18\" height=\"8\" rx=\"1\" strokeDasharray=\"3 2\" />\r\n        <path d=\"M3 12h18\" strokeWidth=\"2\" />\r\n    </svg>\r\n);\r\n\r\nconst ShortIcon = () => (\r\n    <svg width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\">\r\n        <rect x=\"3\" y=\"4\" width=\"18\" height=\"8\" rx=\"1\" fill=\"currentColor\" fillOpacity=\"0.2\" />\r\n        <rect x=\"3\" y=\"12\" width=\"18\" height=\"8\" rx=\"1\" strokeDasharray=\"3 2\" />\r\n        <path d=\"M3 12h18\" strokeWidth=\"2\" />\r\n    </svg>\r\n);\r\n\r\ninterface ChartContainerProps {\r\n    symbol: string; // Renamed from symbolA\r\n    symbolB?: string; // Kept for optional secondary series/overlay\r\n    dataA: any[];\r\n    dataB: any[];\r\n    timeframe: string;\r\n    isActive?: boolean; // New Prop per v8.5 Spec\r\n    onTimeframeChange?: (tf: string) => void;\r\n    divergences?: any[];\r\n    height?: number | string; // Support flexible height\r\n    onCrosshairMove?: (time: Time | null, priceA: number | undefined, priceB: number | undefined) => void;\r\n    isLoading?: boolean;\r\n    onSettingsClick?: () => void;\r\n    accounts?: any[];\r\n    precision?: number;\r\n    horizonData?: any[]; // New Prop for Future Phantom Bars\r\n    timezone?: string; // External Control\r\n    onTimezoneChange?: (tz: string) => void;\r\n\r\n    // New Props for internal header\r\n    onSymbolChange?: (symbol: string) => void;\r\n    botId?: string;\r\n    onOHLCChange?: (ohlc: { open: number, high: number, low: number, close: number } | null) => void;\r\n    onVisibleRangeChange?: (range: { from: number, to: number }) => void;\r\n    onVisibleLogicalRangeChange?: (range: LogicalRange & { anchorTime?: number, whitespaceOffset?: number }) => void;\r\n    activeIndicators?: any[];\r\n    paneId?: string; // New Prop for Identity Verification\r\n    onChartClick?: () => void; // New Prop for Explicit Activation\r\n    scrollToTimeRequest?: { id: string, time: number }; // Scroll Request from Store\r\n    isChartReady?: boolean;\r\n    syncError?: string;\r\n}\r\n\r\nexport interface ChartContainerHandle {\r\n    updateCandle: (candle: any) => void;\r\n    getLatestCandle: () => any;\r\n    getWidget: () => ChartWidget | null;\r\n    setVisibleRange: (range: { from: number; to: number }) => void;\r\n    setLogicalRange: (range: { from: number; to: number; anchorTime?: number; whitespaceOffset?: number }) => void;\r\n    setCrosshair: (time: number, price?: number) => void;\r\n    closePopups: () => void;\r\n    deselectAll: () => void;\r\n}\r\n\r\nexport const ChartContainer = React.forwardRef<ChartContainerHandle, ChartContainerProps>(({\r\n    symbol,\r\n    symbolB = \"\", // Default to empty if not provided\r\n    dataA,\r\n    dataB,\r\n    timeframe,\r\n    isActive = false,\r\n    onTimeframeChange,\r\n    divergences,\r\n    height = 500,\r\n    isLoading = false,\r\n    onSettingsClick,\r\n\r\n    accounts = [],\r\n    precision = 5,\r\n    horizonData = [], // Restored (Rollback)\r\n    timezone,\r\n    onTimezoneChange,\r\n    onSymbolChange,\r\n    botId,\r\n    onOHLCChange,\r\n    onCrosshairMove, // Destructure new prop\r\n    onVisibleRangeChange, // Destructure new prop\r\n    onVisibleLogicalRangeChange,\r\n    activeIndicators = [],\r\n    paneId, // Destructure paneId\r\n    onChartClick, // Destructure onChartClick\r\n    scrollToTimeRequest, // Destructure scrollToTimeRequest\r\n    isChartReady = true, // Default to true for backward compatibility\r\n    syncError\r\n}, ref) => {\r\n    const mainContainerRef = useRef<HTMLDivElement>(null);\r\n    const containerRefA = useRef<HTMLDivElement>(null);\r\n    const containerRefB = useRef<HTMLDivElement>(null);\r\n\r\n    const { theme } = useChartTheme();\r\n    const { isTestMode } = useWorkspaceStore();\r\n\r\n    const chartARef = useRef<IChartApi | null>(null);\r\n    const chartBRef = useRef<IChartApi | null>(null);\r\n    const seriesARef = useRef<ISeriesApi<\"Candlestick\"> | null>(null);\r\n    const seriesBRef = useRef<ISeriesApi<\"Candlestick\"> | null>(null);\r\n    const hasFittedARef = useRef(false);\r\n    const hasFittedBRef = useRef(false);\r\n\r\n    // DATA REFS for Sync Closure Access\r\n    const dataARef = useRef<any[]>([]);\r\n    const dataBRef = useRef<any[]>([]);\r\n\r\n    // --- SCROLL TO TIME EFFECT ---\r\n    useEffect(() => {\r\n        if (scrollToTimeRequest && chartARef.current && dataARef.current.length > 0) {\r\n            const chart = chartARef.current;\r\n            const data = dataARef.current;\r\n            const targetTime = scrollToTimeRequest.time;\r\n\r\n            // Find index of target time\r\n            // Binary search or find? findIndex is O(N) but safer for now.\r\n            // Using findIndex with assumption of sorted data.\r\n\r\n            // Optimization: If data is sorted, we can binary search.\r\n            // For now, let's use a simple heuristic:\r\n            // Find the closest bar.\r\n\r\n            let closestIndex = -1;\r\n            let minDiff = Infinity;\r\n\r\n            // Simple iteration for robustness (performance impact negligible for <50k bars once)\r\n            for (let i = 0; i < data.length; i++) {\r\n                const diff = Math.abs((data[i].time as number) - targetTime);\r\n                if (diff < minDiff) {\r\n                    minDiff = diff;\r\n                    closestIndex = i;\r\n                }\r\n            }\r\n\r\n            if (closestIndex !== -1) {\r\n                // Calculate visible range width (zoom level)\r\n                const visibleRun = chart.timeScale().getVisibleLogicalRange();\r\n                let width = 100; // Default width\r\n                if (visibleRun) {\r\n                    width = visibleRun.to - visibleRun.from;\r\n                }\r\n\r\n                // Center the view on closestIndex\r\n                const from = closestIndex - (width / 2);\r\n                const to = closestIndex + (width / 2);\r\n\r\n                chart.timeScale().setVisibleLogicalRange({ from, to });\r\n\r\n\r\n\r\n                // Disable Realtime Lock\r\n                setIsAtRealtime(false);\r\n\r\n                // Seed History Focus Ref\r\n                const fromTime = data[Math.max(0, Math.floor(from))]?.time;\r\n                const toTime = data[Math.min(data.length - 1, Math.ceil(to))]?.time;\r\n                if (fromTime && toTime) {\r\n                    historyFocusRef.current = { from: fromTime as number, to: toTime as number };\r\n                }\r\n            } else {\r\n                // If time is outside data range (e.g. far future or past not loaded), \r\n                // we might simply scroll to specific time if it's a timestamp.\r\n                // LWC supports scrollToPosition but that requires index.\r\n                // If we have no data there, we can't easily scroll.\r\n                // Fallback: Notify? Console log?\r\n                console.warn(\"[ChartContainer] Target time not found in loaded data\", targetTime);\r\n            }\r\n        }\r\n    }, [scrollToTimeRequest]);\r\n\r\n\r\n\r\n    // Use a ref to store the previous timeframe to detect changes\r\n    const prevTimeframeRef = useRef(timeframe);\r\n    const seriesHorizonRef = useRef<ISeriesApi<\"Line\"> | null>(null);\r\n    const chartWidgetRef = useRef<ChartWidget | null>(null);\r\n    const currentMousePosRef = useRef<{ x: number, y: number } | null>(null);\r\n\r\n    const indicatorPluginsRef = useRef<Map<string, any>>(new Map());\r\n\r\n    // --- INCREMENTAL UPDATE STATE ---\r\n    const prevDataLengthRef = useRef(0);\r\n    const prevStartTimeRef = useRef(0);\r\n    const prevLastTimeRef = useRef(0);\r\n\r\n    // ROBUSTNESS: Track the last known \"History Focus\" to survive empty data states (The Tunnel)\r\n    const historyFocusRef = useRef<{ from: number, to: number } | null>(null);\r\n\r\n    // LOOP PROTECTION: Flag to suppress event broadcasting during programmatic updates\r\n    const isProgrammaticUpdate = useRef(false);\r\n\r\n    // Active Trades Monitoring\r\n    const { aggregatedTrades } = useTradeMonitor();\r\n    const activePositionIds = useRef<Set<string>>(new Set());\r\n\r\n    // State for Widget Removal\r\n    const [executionSourceId, setExecutionSourceId] = useState<string | null>(null);\r\n\r\n    useEffect(() => {\r\n        // Sync Active Trades to Chart\r\n        if (!chartWidgetRef.current) return;\r\n\r\n        const currentSymbol = symbol; // Use current symbol scope\r\n        const activeForSymbol = aggregatedTrades.filter(t =>\r\n            t.symbol === currentSymbol &&\r\n            t.status === 'RUNNING' // Only running trades\r\n        );\r\n\r\n        const activeIds = new Set<string>();\r\n        const logs = TradeLogService.getLogs();\r\n\r\n        activeForSymbol.forEach(trade => {\r\n            activeIds.add(trade.tradeId);\r\n\r\n            // 1. Get Concrete Levels from Log (Persistence)\r\n            const logEntry = logs.find(l => l.id === trade.tradeId);\r\n\r\n            // 2. Resolve Levels (Log > Current)\r\n            const entryPrice = logEntry?.initialEntry || trade.avgEntry;\r\n            const slPrice = logEntry?.initialSL || trade.avgSl;\r\n            const tpPrice = logEntry?.initialTP || trade.avgTp;\r\n\r\n            // 3. Create/Update Tool\r\n            // We use createShape with ID override. If it exists, it might duplicate or we rely on ChartWidget to handle?\r\n            // ChartWidget.createShape always creates new. We need check if exists.\r\n            const existing = chartWidgetRef.current?.getShapeById(trade.tradeId);\r\n\r\n            if (!existing) {\r\n                // Initial Creation\r\n                chartWidgetRef.current?.createShape(\r\n                    { time: Date.now() / 1000, price: entryPrice },\r\n                    {\r\n                        shape: 'ActivePosition',\r\n                        overrides: {\r\n                            id: trade.tradeId, // Force ID to match Trade ID\r\n                            symbol: trade.symbol,\r\n                            direction: trade.direction === 'BUY' ? 'LONG' : 'SHORT',\r\n                            entryPrice: entryPrice,\r\n                            stopLossPrice: slPrice,\r\n                            takeProfitPrice: tpPrice,\r\n                            lineColor: '#2563EB', // Blue-600 for Entry (TradingView Style)\r\n                            stopColor: 'rgba(239, 68, 68, 1)',\r\n                            profitColor: 'rgba(16, 185, 129, 1)',\r\n                            currentProfit: trade.unrealizedPl,\r\n                            currency: 'USD', // Hardcoded or derive from symbol/account\r\n                            volume: trade.volume || trade.size || 0, // Pass Volume\r\n                            contractSize: 1 // Default to 1 (CFD/Crypto) or need to fetch from broker info\r\n                        }\r\n                    }\r\n                );\r\n            } else {\r\n                // Update existing\r\n                const primitive = existing.getPrimitive();\r\n                if (primitive && typeof (primitive as any).updateProfit === 'function') {\r\n                    // Update State for generic properties\r\n                    existing.setProperties({\r\n                        stopLossPrice: slPrice,\r\n                        takeProfitPrice: tpPrice,\r\n                        // volume: trade.volume // If volume changes?\r\n                    });\r\n\r\n                    // Update Volume if missing in state\r\n                    if ((primitive as any)._data && !(primitive as any)._data.volume) {\r\n                        (primitive as any)._data.volume = trade.volume || trade.size || 0;\r\n                    }\r\n\r\n                    // Direct Profit Update\r\n                    (primitive as any).updateProfit(trade.unrealizedPl);\r\n                }\r\n            }\r\n        });\r\n\r\n        // 4. Cleanup Closed Trades\r\n        activePositionIds.current.forEach(id => {\r\n            if (!activeIds.has(id)) {\r\n                chartWidgetRef.current?.removeEntity(id);\r\n            }\r\n        });\r\n\r\n        activePositionIds.current = activeIds;\r\n\r\n    }, [aggregatedTrades, symbol]); // Re-run when trades change or symbol changes\r\n\r\n    // --- CONTEXT MENU HOOK ---\r\n    const {\r\n        menuState,\r\n        settingsState,\r\n        closeMenu,\r\n        openSettings,\r\n        handleDelete,\r\n        handleRemoveAll,\r\n        closeSettings,\r\n        saveSettings\r\n    } = useContextMenu(mainContainerRef, chartWidgetRef);\r\n\r\n    // --- IMPERATIVE HANDLE FOR FAST UPDATES ---\r\n    React.useImperativeHandle(ref, () => ({\r\n        updateCandle: (candle: any) => {\r\n            if (seriesARef.current) {\r\n                seriesARef.current.update(candle);\r\n                // Also update Widget internal state if needed\r\n                if (chartWidgetRef.current && candle.close !== undefined) {\r\n                    chartWidgetRef.current.updateLastPrice(candle.close, candle.time as number);\r\n                }\r\n\r\n                // --- UPDATE PLUGINS WITH LATEST TIME ---\r\n                indicatorPluginsRef.current.forEach((plugin) => {\r\n                    const p = plugin as any;\r\n                    if (p.updateCurrentTime) {\r\n                        p.updateCurrentTime(candle.time);\r\n                    }\r\n                    if (p.updateCandle) {\r\n                        p.updateCandle(candle);\r\n                    }\r\n                });\r\n            }\r\n        },\r\n        getLatestCandle: () => {\r\n            return null;\r\n        },\r\n        getWidget: () => chartWidgetRef.current,\r\n        setVisibleRange: (range: { from: number; to: number }) => {\r\n            if (chartARef.current) {\r\n                try {\r\n                    isProgrammaticUpdate.current = true;\r\n                    chartARef.current.timeScale().setVisibleRange(range as any);\r\n                    // Reset flag immediately (synchronous) or very short timeout?\r\n                    // LWC triggers subs synchronously usually.\r\n                    isProgrammaticUpdate.current = false;\r\n                } catch (e) {\r\n                    isProgrammaticUpdate.current = false;\r\n                    console.warn(\"[ChartContainer] setVisibleRange failed (chart likely disposing)\", e);\r\n                }\r\n            }\r\n        },\r\n        setLogicalRange: (range: { from: number; to: number, anchorTime?: number, whitespaceOffset?: number }) => {\r\n            if (chartARef.current) {\r\n                // Precise sync: use setVisibleLogicalRange\r\n                try {\r\n                    // LOOP PROTECTION: Lock for 20ms to cover async event dispatch\r\n                    isProgrammaticUpdate.current = true;\r\n                    // TRACE 0162\r\n                    // console.log(`[ChartContainer:${paneId}] setLogicalRange Called. Anchor: ${range.anchorTime}, Offset: ${range.whitespaceOffset}`);\r\n\r\n                    let targetRange = range;\r\n                    const data = dataARef.current;\r\n\r\n                    // TIME-ANCHORED SYNC: Adjust indices based on Anchor Time\r\n                    if (range.anchorTime !== undefined && data.length > 0) {\r\n                        let targetRightIndex = -1;\r\n\r\n                        // Optimization: Check last bar first (Common case: Realtime Sync)\r\n                        if (data[data.length - 1].time <= range.anchorTime) {\r\n                            targetRightIndex = data.length - 1;\r\n                        } else {\r\n                            // Binary Search\r\n                            let low = 0, high = data.length - 1;\r\n                            while (low <= high) {\r\n                                const mid = (low + high) >>> 1;\r\n                                if (data[mid].time < range.anchorTime) low = mid + 1;\r\n                                else high = mid - 1;\r\n                            }\r\n                            targetRightIndex = low > 0 && low >= data.length ? data.length - 1 : low;\r\n                        }\r\n\r\n                        // Sanity Check\r\n                        if (targetRightIndex >= data.length) targetRightIndex = data.length - 1;\r\n\r\n                        // APPLY WHITESPACE OFFSET (Future Scroll Fix)\r\n                        // REMOVED CLAMP: Allow full future scrolling to prevent sync fighting (Task 0162)\r\n                        // TRACE 0162\r\n                        if (range.whitespaceOffset !== undefined && range.whitespaceOffset > 0) {\r\n                            // console.log(`[ChartContainer:${paneId}] SYNC-IN Apply Offset: ${range.whitespaceOffset}. BaseIdx: ${targetRightIndex} -> Target: ${targetRightIndex + range.whitespaceOffset}`);\r\n                            targetRightIndex += range.whitespaceOffset;\r\n                        }\r\n\r\n                        // Apply Width\r\n                        const width = range.to - range.from;\r\n                        const newTo = targetRightIndex;\r\n                        // Maintain Whitespace Offset if source was projected\r\n                        // We can't easily know source whitespace without source length.\r\n                        // But range.to might be > length?\r\n                        // If range.to > range.from, we apply that width.\r\n\r\n                        targetRange = { from: newTo - width, to: newTo } as any;\r\n                    }\r\n\r\n                    chartARef.current.timeScale().setVisibleLogicalRange(targetRange as any);\r\n\r\n                    // Release Lock after short delay\r\n                    setTimeout(() => {\r\n                        isProgrammaticUpdate.current = false;\r\n                    }, 50);\r\n\r\n                } catch (e) {\r\n                    isProgrammaticUpdate.current = false;\r\n                    console.warn(\"[ChartContainer] setLogicalRange failed\", e);\r\n                }\r\n            }\r\n        },\r\n        setCrosshair: (time: number, price?: number) => {\r\n            if (chartARef.current && seriesARef.current) {\r\n                // Defensive: Ensure price and time are strictly not null/undefined\r\n                if (price !== undefined && price !== null && time !== null && time !== undefined) {\r\n                    try {\r\n                        chartARef.current.setCrosshairPosition(price, time as Time, seriesARef.current);\r\n                    } catch (e) {\r\n                        // Silent catch to prevent app crash if LWC internal state disagrees\r\n                    }\r\n                } else {\r\n                    chartARef.current.clearCrosshairPosition();\r\n                }\r\n            }\r\n        },\r\n        closePopups: () => {\r\n            closeMenu();\r\n            closeSettings();\r\n        },\r\n        deselectAll: () => {\r\n            if (chartWidgetRef.current) {\r\n                chartWidgetRef.current.deselectAllShapes();\r\n            }\r\n        }\r\n    }));\r\n\r\n    // --- TIMEFRAME SCROLLER STATE ---\r\n    const tfScrollRef = useRef<HTMLDivElement>(null);\r\n    const [canScrollLeft, setCanScrollLeft] = useState(false);\r\n    const [canScrollRight, setCanScrollRight] = useState(false);\r\n    const [isAutoScale, setIsAutoScale] = useState(true);\r\n    const [pendingTrade, setPendingTrade] = useState<any | null>(null);\r\n    const [isExecutingTrade, setIsExecutingTrade] = useState(false);\r\n    const [executionSummary, setExecutionSummary] = useState<any[] | null>(null);\r\n\r\n    // --- SCROLL TO REALTIME BUTTON STATE ---\r\n    const [isAtRealtime, setIsAtRealtime] = useState(true);\r\n    const [isHoveringScrollTrigger, setIsHoveringScrollTrigger] = useState(false);\r\n    const dataLengthRef = useRef(0);\r\n\r\n    const checkTfScroll = () => {\r\n        if (tfScrollRef.current) {\r\n            const { scrollLeft, scrollWidth, clientWidth } = tfScrollRef.current;\r\n            setCanScrollLeft(scrollLeft > 4); // Added 2px margin for reliability\r\n            // Use Math.ceil for scrollWidth to handle sub-pixel issues in various browsers\r\n            setCanScrollRight(Math.ceil(scrollWidth) > Math.ceil(clientWidth + scrollLeft) + 4);\r\n        }\r\n    };\r\n\r\n    // Hover state for right scale (managed via mouse move to avoid blocking)\r\n    const [isRightHovered, setIsRightHovered] = useState(false);\r\n\r\n    // TIMEZONE STATE\r\n    // If props.timezone is provided, use it. Otherwise default to Browser/UTC.\r\n    // Actually, we should pull from props directly if controlled.\r\n    // But to minimize refactor, let's sync state.\r\n    const [selectedTimezone, setSelectedTimezone] = useState<string>(() => {\r\n        if (timezone) return timezone;\r\n        try { return Intl.DateTimeFormat().resolvedOptions().timeZone; } catch (e) { return 'UTC'; }\r\n    });\r\n\r\n    // --- BROKER DATA FETCHING ---\r\n    const { fetchBrokers, brokers } = useBrokerStore();\r\n\r\n    useEffect(() => {\r\n        fetchBrokers();\r\n    }, []);\r\n\r\n\r\n\r\n\r\n\r\n    useEffect(() => {\r\n        if (timezone) setSelectedTimezone(timezone);\r\n    }, [timezone]);\r\n\r\n    // --- DATA TRANSFORMATION PIPELINE ---\r\n    // Apply indicator-based overrides (e.g. Imbalance opacity/coloring)\r\n    // We memoize this to prevent recalculation on every render unless data or indicators change.\r\n    const processedData = React.useMemo(() => {\r\n        let result = [...dataA];\r\n\r\n        // ROBUSTNESS: Filter out invalid candles (nulls or missing fields)\r\n        // This prevents \"Assertion failed: value of open must be a number\" crashes\r\n        result = result.filter(c =>\r\n            c &&\r\n            typeof c.time === 'number' &&\r\n            typeof c.open === 'number' &&\r\n            typeof c.high === 'number' &&\r\n            typeof c.low === 'number' &&\r\n            typeof c.close === 'number'\r\n        );\r\n\r\n        // Apply transformations from active indicators\r\n        activeIndicators.forEach(ind => {\r\n            const def = indicatorRegistry.get(ind.defId);\r\n            if (def && def.dataTransformer) {\r\n                try {\r\n                    result = def.dataTransformer(result, ind.settings);\r\n                } catch (e) {\r\n                    console.error(`[ChartContainer] Transformer error for ${ind.defId}:`, e);\r\n                }\r\n            }\r\n        });\r\n        return result;\r\n    }, [dataA, activeIndicators]);\r\n\r\n    const [chartReady, setChartReady] = useState(false);\r\n\r\n    // Keep Data Refs Sync'd (Moved here to avoid TDZ)\r\n    useEffect(() => { dataARef.current = processedData; }, [processedData]);\r\n    useEffect(() => { dataBRef.current = dataB; }, [dataB]);\r\n\r\n    // APPLY TIMEZONE FORMATTER\r\n    useEffect(() => {\r\n        const applyTimezone = (chart: IChartApi | null) => {\r\n            if (!chart) return;\r\n            chart.applyOptions({\r\n                timeScale: {\r\n                    tickMarkFormatter: (time: Time, tickMarkType: TickMarkType, locale: string) => {\r\n                        const date = new Date((time as number) * 1000);\r\n                        const opts: Intl.DateTimeFormatOptions = { timeZone: selectedTimezone };\r\n\r\n                        switch (tickMarkType) {\r\n                            case TickMarkType.Year:\r\n                                return date.toLocaleDateString('en-US', { ...opts, year: 'numeric' });\r\n                            case TickMarkType.Month:\r\n                                return date.toLocaleDateString('en-US', { ...opts, month: 'short', year: 'numeric' });\r\n                            case TickMarkType.DayOfMonth:\r\n                                return date.toLocaleDateString('en-US', { ...opts, day: 'numeric', month: 'short' });\r\n                            case TickMarkType.Time:\r\n                                return date.toLocaleTimeString('en-US', { ...opts, hour: '2-digit', minute: '2-digit', hour12: false });\r\n                            case TickMarkType.TimeWithSeconds:\r\n                                return date.toLocaleTimeString('en-US', { ...opts, hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });\r\n                            default:\r\n                                return \"\";\r\n                        }\r\n                    }\r\n                },\r\n                localization: {\r\n                    dateFormat: 'yyyy-MM-dd',\r\n                    timeFormatter: (time: Time) => {\r\n                        const date = new Date((time as number) * 1000);\r\n                        return date.toLocaleString('en-US', {\r\n                            timeZone: selectedTimezone,\r\n                            hour: '2-digit',\r\n                            minute: '2-digit',\r\n                            hour12: false,\r\n                            day: 'numeric',\r\n                            month: 'short'\r\n                        });\r\n                    }\r\n                }\r\n            });\r\n        };\r\n        if (chartReady) {\r\n            console.log(`[ChartContainer] Applying Timezone: ${selectedTimezone}`);\r\n            applyTimezone(chartARef.current);\r\n            applyTimezone(chartBRef.current);\r\n        }\r\n    }, [selectedTimezone, chartReady]);\r\n\r\n    // Sync AutoScale state from chart\r\n    useEffect(() => {\r\n        const checkAutoScale = () => {\r\n            if (chartARef.current) {\r\n                const opts = chartARef.current.priceScale('right').options();\r\n                if (opts.autoScale !== undefined && opts.autoScale !== isAutoScale) {\r\n                    setIsAutoScale(opts.autoScale);\r\n                }\r\n            }\r\n        };\r\n\r\n        const interval = setInterval(checkAutoScale, 250); // Poll every 250ms\r\n        return () => clearInterval(interval);\r\n    }, [isAutoScale]);\r\n\r\n    useEffect(() => {\r\n        const el = tfScrollRef.current;\r\n        if (el) {\r\n\r\n            checkTfScroll();\r\n\r\n            // Listen for scroll events\r\n            el.addEventListener('scroll', checkTfScroll);\r\n\r\n            // Use ResizeObserver for more robust detection of size changes\r\n            const observer = new ResizeObserver(() => checkTfScroll());\r\n            observer.observe(el);\r\n            // Also observe children if they might change size later\r\n            if (el.firstChild) observer.observe(el.firstChild as Element);\r\n\r\n            window.addEventListener('resize', checkTfScroll);\r\n\r\n            return () => {\r\n                el.removeEventListener('scroll', checkTfScroll);\r\n                observer.disconnect();\r\n                window.removeEventListener('resize', checkTfScroll);\r\n            };\r\n        }\r\n    }, []);\r\n\r\n    const scrollTf = (direction: 'left' | 'right') => {\r\n        if (tfScrollRef.current) {\r\n            const amount = direction === 'left' ? -150 : 150;\r\n            tfScrollRef.current.scrollBy({ left: amount, behavior: 'smooth' });\r\n        }\r\n    };\r\n\r\n    // Initialize Charts (Run once on mount or when height changes)\r\n    useEffect(() => {\r\n        // Chart A is mandatory\r\n        if (!containerRefA.current) return;\r\n\r\n        // Default dimensions\r\n        const initialWidth = containerRefA.current.clientWidth;\r\n        const initialHeight = (typeof height === 'number') ? height / 2 : 300;\r\n\r\n        // Helper to normalize background\r\n        const bg = typeof theme.layout.background === 'string'\r\n            ? { type: ColorType.Solid, color: theme.layout.background }\r\n            : { type: ColorType.Solid, color: theme.layout.background.color };\r\n\r\n        const chartOptions = {\r\n            layout: {\r\n                background: bg,\r\n                textColor: theme.layout.textColor,\r\n                fontSize: 11,\r\n            },\r\n            grid: {\r\n                vertLines: {\r\n                    color: theme.grid.vertLines.color,\r\n                    visible: theme.grid.vertLines.visible,\r\n                    style: theme.grid.vertLines.style\r\n                },\r\n                horzLines: {\r\n                    color: theme.grid.horzLines.color,\r\n                    visible: theme.grid.horzLines.visible,\r\n                    style: theme.grid.horzLines.style\r\n                },\r\n            },\r\n            crosshair: {\r\n                mode: 0, // Normal (follows mouse precision)\r\n                vertLine: {\r\n                    color: '#000000',\r\n                    labelBackgroundColor: '#000000',\r\n                },\r\n                horzLine: {\r\n                    color: '#000000',\r\n                    labelBackgroundColor: '#000000',\r\n                },\r\n            },\r\n            timeScale: {\r\n                timeVisible: true,\r\n                secondsVisible: false,\r\n                ticksVisible: true,\r\n                borderColor: theme.timeScale.borderColor,\r\n                rightOffset: 20, // Phantom Bars handle the rest\r\n                barSpacing: 10,\r\n                minBarSpacing: 4,\r\n                shiftVisibleRangeOnNewBar: false,\r\n                fixLeftEdge: false,\r\n                fixRightEdge: false, // Allow scrolling into future\r\n            },\r\n            rightPriceScale: {\r\n                borderColor: theme.priceScale.borderColor,\r\n                autoScale: true,\r\n                minimumWidth: 60, // Fixed width to match overlay\r\n                scaleMargins: {\r\n                    top: 0.1,\r\n                    bottom: 0.1,\r\n                },\r\n            },\r\n            handleScale: {\r\n                mouseWheel: false,\r\n            },\r\n            handleScroll: {\r\n                mouseWheel: true,\r\n                pressedMouseMove: true,\r\n                horzTouchDrag: true,\r\n                vertTouchDrag: true,\r\n            },\r\n        };\r\n\r\n        // --- CHART A (Main) ---\r\n        const chartA = createChart(containerRefA.current, { ...chartOptions, width: initialWidth, height: initialHeight });\r\n        const seriesA = chartA.addSeries(CandlestickSeries, {\r\n            upColor: theme.candles.upColor,\r\n            downColor: theme.candles.downColor,\r\n            borderVisible: true,\r\n            wickVisible: true,\r\n            borderUpColor: theme.candles.borderUpColor,\r\n            borderDownColor: theme.candles.borderDownColor,\r\n            wickUpColor: theme.candles.wickUpColor,\r\n            wickDownColor: theme.candles.wickDownColor,\r\n\r\n            priceFormat: { type: 'price', precision: precision, minMove: 1 / Math.pow(10, precision) },\r\n        });\r\n\r\n        // REACTIVE PRECISION UPDATE\r\n        // When 'precision' prop changes, we must force the series to update.\r\n        // We can't rely on recreating the chart, so we use applyOptions.\r\n        // Ideally we would do this in a separate useEffect, but 'seriesA' is local here.\r\n        // Since we are recreating the chart every time 'height' or 'theme' changes, this might be enough if 'precision' triggers remount.\r\n        // CHECK: dependency array of this useEffect? -> currently only on mount + height + theme. layout has no 'precision' dep.\r\n        // FIX: We need a SEPARATE useEffect to handle precision updates reactively without recreating the chart.\r\n\r\n\r\n        // --- HORIZON SERIES (Phantom Future) ---\r\n        // ROLLBACK: Restored for stability. Used for visual \"Future\" without breaking auto-scale.\r\n        const seriesHorizon = chartA.addSeries(LineSeries, {\r\n            color: 'transparent', // Invisible\r\n            lineWidth: 1,\r\n            crosshairMarkerVisible: false,\r\n            lastValueVisible: false,\r\n            priceLineVisible: false\r\n        });\r\n        seriesHorizonRef.current = seriesHorizon;\r\n\r\n        // Dynamic Scroll Removed in favor of Phantom Bars logic\r\n\r\n\r\n        // Subscribe to Click for Activation\r\n        chartA.subscribeClick(() => {\r\n            if (onChartClick) onChartClick();\r\n        });\r\n\r\n        chartARef.current = chartA;\r\n        seriesARef.current = seriesA;\r\n        // Pass Pane ID for Verification\r\n        const widget = new ChartWidget(paneId || \"unknown\", chartA, seriesA);\r\n        widget.setSymbol(symbol);\r\n        chartWidgetRef.current = widget;\r\n\r\n        // Subscribe to trade execution events\r\n        widget.subscribe('execute' as any, (params: any) => {\r\n            console.log(\"[ChartContainer] Execution event received:\", params.trade);\r\n            setPendingTrade(params.trade);\r\n            if (params.id) {\r\n                setExecutionSourceId(params.id);\r\n            }\r\n        });\r\n\r\n        // --- CHART B (Optional) ---\r\n        let chartB: IChartApi | null = null;\r\n        let seriesB: ISeriesApi<\"Candlestick\"> | null = null;\r\n\r\n        if (containerRefB.current) {\r\n            chartB = createChart(containerRefB.current, { ...chartOptions, width: initialWidth, height: initialHeight });\r\n            seriesB = chartB.addSeries(CandlestickSeries, {\r\n                upColor: theme.candles.upColor,\r\n                downColor: theme.candles.downColor,\r\n                borderVisible: false,\r\n                wickUpColor: theme.candles.wickUpColor,\r\n                wickDownColor: theme.candles.wickDownColor,\r\n\r\n                priceFormat: { type: 'price', precision: precision, minMove: 1 / Math.pow(10, precision) },\r\n            });\r\n            chartBRef.current = chartB;\r\n            seriesBRef.current = seriesB;\r\n        }\r\n\r\n        // --- SYNCHRONIZATION (Only if B exists) ---\r\n        if (chartB) {\r\n            let isSyncing = false;\r\n\r\n            // Helper for safe sync\r\n            const syncRange = (sourceChart: IChartApi, targetChart: IChartApi) => {\r\n                sourceChart.timeScale().subscribeVisibleLogicalRangeChange((range) => {\r\n                    // Internal Loop Protection\r\n                    if (isProgrammaticUpdate.current) return;\r\n\r\n                    if (!range || isSyncing) return;\r\n                    if (range.from === null || range.to === null || range.from === undefined || range.to === undefined) return;\r\n\r\n                    isSyncing = true;\r\n                    try {\r\n                        const ts = targetChart.timeScale && targetChart.timeScale();\r\n                        if (ts) {\r\n                            isProgrammaticUpdate.current = true;\r\n\r\n                            // TIME-ANCHORED FIXED-WIDTH SYNC\r\n                            // 1. Get Width and Right Time\r\n                            const width = (range.to as number) - (range.from as number);\r\n\r\n                            // Use Refs to get latest data without closure staleness\r\n                            const sourceData = sourceChart === chartA ? dataARef.current : dataBRef.current;\r\n                            const targetData = targetChart === chartA ? dataARef.current : dataBRef.current;\r\n\r\n                            if (sourceData && sourceData.length > 0 && targetData && targetData.length > 0) {\r\n\r\n                                const clampedSourceIdx = Math.max(0, Math.min(Math.floor(range.to as number), sourceData.length - 1));\r\n                                const rightTime = sourceData[clampedSourceIdx]?.time;\r\n\r\n                                if (rightTime) {\r\n                                    // Find Time in Target\r\n                                    let targetRightIndex = -1;\r\n\r\n                                    // Optimization: Check last bar first (Common case: Realtime Sync)\r\n                                    if (targetData[targetData.length - 1].time <= rightTime) {\r\n                                        targetRightIndex = targetData.length - 1;\r\n                                    } else {\r\n                                        // Binary Search for precise history sync\r\n                                        let low = 0, high = targetData.length - 1;\r\n                                        while (low <= high) {\r\n                                            const mid = (low + high) >>> 1;\r\n                                            if (targetData[mid].time < rightTime) low = mid + 1;\r\n                                            else high = mid - 1;\r\n                                        }\r\n                                        // 'low' is insertion point (first element >= value)\r\n                                        targetRightIndex = low > 0 && low >= targetData.length ? targetData.length - 1 : low;\r\n                                    }\r\n\r\n                                    // Handle Exact Match Logic vs \"Closest\"\r\n                                    if (targetRightIndex >= targetData.length) targetRightIndex = targetData.length - 1;\r\n\r\n                                    // Correct for whitespace offset if source was in whitespace\r\n                                    const whitespaceOffset = (range.to as number) - clampedSourceIdx;\r\n                                    if (whitespaceOffset > 0) {\r\n                                        targetRightIndex += whitespaceOffset;\r\n                                    }\r\n\r\n                                    const newTo = targetRightIndex;\r\n                                    const newFrom = newTo - width;\r\n\r\n                                    ts.setVisibleLogicalRange({ from: newFrom, to: newTo } as any);\r\n                                }\r\n                            } else {\r\n                                // Fallback if no data or init\r\n                                ts.setVisibleLogicalRange(range as any);\r\n                            }\r\n\r\n                            isProgrammaticUpdate.current = false;\r\n                        }\r\n                    } catch (e) {\r\n                        isProgrammaticUpdate.current = false;\r\n                    }\r\n                    isSyncing = false;\r\n                });\r\n            };\r\n\r\n            syncRange(chartA, chartB);\r\n            syncRange(chartB, chartA);\r\n\r\n            // Crosshair Sync\r\n            const syncCrosshair = (\r\n                sourceChart: IChartApi,\r\n                targetChart: IChartApi,\r\n                targetSeries: ISeriesApi<\"Candlestick\"> | null\r\n            ) => {\r\n                sourceChart.subscribeCrosshairMove((param) => {\r\n                    if (isSyncing || !targetSeries) return;\r\n                    isSyncing = true;\r\n                    try {\r\n                        if (param.time) targetChart.setCrosshairPosition(param.point?.y || 0, param.time, targetSeries);\r\n                        else targetChart.clearCrosshairPosition();\r\n                    } catch (e) { /* Silent */ }\r\n                    isSyncing = false;\r\n                });\r\n            };\r\n\r\n            syncCrosshair(chartA, chartB, seriesB);\r\n            syncCrosshair(chartB, chartA, seriesA); // Chart A always has series\r\n        }\r\n\r\n        // --- Crosshair Move Handler for OHLC Overlay ---\r\n        // --- Crosshair Move Handler for OHLC Overlay & Sync ---\r\n        chartA.subscribeCrosshairMove((param) => {\r\n            // Guard against disposed state\r\n            if (!chartARef.current || !seriesARef.current) return;\r\n\r\n            try {\r\n                // 1. OHLC Overlay\r\n                if (param.time) {\r\n                    const data = param.seriesData.get(seriesA);\r\n                    if (data && typeof data === 'object' && 'open' in data) {\r\n                        onOHLCChange?.(data as { open: number, high: number, low: number, close: number });\r\n                    } else {\r\n                        const candle = dataA.find(d => d.time === param.time);\r\n                        if (candle) {\r\n                            onOHLCChange?.(candle);\r\n                        }\r\n                    }\r\n                } else {\r\n                    onOHLCChange?.(null);\r\n                }\r\n\r\n                // 2. Sync / External Reporting\r\n                if (param.time) {\r\n                    const price = param.seriesData.get(seriesA);\r\n                    // We need the raw price from the coordinate if possible, OR just use the Close of the candle\r\n                    // Param.point.y is the coordinate.\r\n                    let priceVal: number | undefined;\r\n\r\n                    try {\r\n                        priceVal = (price as any)?.close ?? seriesA.coordinateToPrice(param.point?.y || 0);\r\n                    } catch (innerE) {\r\n                        // If coordinateToPrice fails, fallback or ignore\r\n                    }\r\n\r\n                    if (priceVal !== undefined) {\r\n                        onCrosshairMove?.(param.time, priceVal as number, undefined);\r\n                    }\r\n                } else {\r\n                    onCrosshairMove?.(null, undefined, undefined);\r\n                }\r\n            } catch (e) {\r\n                // Silent catch for crosshair errors during disposal\r\n            }\r\n        });\r\n\r\n        // Subscribe to Visible Range Changes for Sync\r\n        chartA.timeScale().subscribeVisibleTimeRangeChange((range) => {\r\n            // LOOP PROTECTION\r\n            if (isProgrammaticUpdate.current) return;\r\n\r\n            try {\r\n                if (range && range.from && range.to) {\r\n                    onVisibleRangeChange?.({ from: range.from as number, to: range.to as number });\r\n                }\r\n\r\n                // HYBRID SYNC: Also emit Logical Range on Time Scroll \r\n                // This ensures we catch scroll events that might bypass the logical observer in some LWC versions\r\n                const logical = chartA.timeScale().getVisibleLogicalRange();\r\n                if (logical) {\r\n                    onVisibleLogicalRangeChange?.(logical);\r\n                }\r\n            } catch (e) {\r\n                // Silent catch for disposal race conditions\r\n            }\r\n        });\r\n\r\n        // Subscribe to Logical Range Changes for Sync (Precise index-based)\r\n        chartA.timeScale().subscribeVisibleLogicalRangeChange((range) => {\r\n            // LOOP PROTECTION\r\n            if (isProgrammaticUpdate.current) {\r\n                // console.log(`[ChartContainer:${paneId}] Skipping emit (programmatic lock active)`);\r\n                return;\r\n            }\r\n\r\n            try {\r\n                let anchorTime: number | undefined;\r\n\r\n                if (range) {\r\n                    const data = dataARef.current;\r\n                    let whitespaceOffset = 0;\r\n\r\n                    if (data && data.length > 0) {\r\n                        // Calculate Anchor Time (Right Edge Time)\r\n                        // Use clamped index to stay within valid data bounds\r\n                        const idx = Math.max(0, Math.min(Math.floor(range.to as number), data.length - 1));\r\n                        anchorTime = data[idx]?.time;\r\n\r\n                        // Calculate Whitespace Offset (Fix for \"Sticky Right Edge\")\r\n                        whitespaceOffset = (range.to as number) - (data.length - 1);\r\n\r\n                        // DEBUG LOGGING\r\n                        // if (whitespaceOffset > 0) {\r\n                        //     console.log(`[Sync Emit] Offset: ${whitespaceOffset.toFixed(2)}, To: ${range.to.toFixed(2)}, LastIdx: ${data.length - 1}`);\r\n                        // }\r\n\r\n                        // TRACE 0162\r\n                        if (Math.abs(whitespaceOffset) > 1 || (range.to as number) > data.length) {\r\n                            console.log(`[ChartContainer:${paneId}] Emit LogicalRange. To: ${(range.to as number).toFixed(2)}, Offset: ${whitespaceOffset.toFixed(2)}, Anchor: ${anchorTime}`);\r\n                        }\r\n\r\n                        // Check if at Realtime Edge\r\n                        const dist = (data.length - 1) - (range.to as number);\r\n                        const isAtEdge = dist < 2;\r\n                        setIsAtRealtime(isAtEdge);\r\n\r\n                        // ROBUSTNESS: While in history, strictly track where we are\r\n                        if (!isAtEdge && data) {\r\n                            const fIdx = Math.max(0, Math.floor(range.from as number));\r\n                            const tIdx = Math.min(data.length - 1, Math.ceil(range.to as number));\r\n                            const fTime = data[fIdx]?.time;\r\n                            const tTime = data[tIdx]?.time;\r\n                            if (fTime && tTime) {\r\n                                historyFocusRef.current = { from: fTime as number, to: tTime as number };\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    onVisibleLogicalRangeChange?.({ ...range, anchorTime, whitespaceOffset } as any);\r\n                }\r\n            } catch (e) {\r\n                // Silent catch\r\n            }\r\n        });\r\n\r\n        setChartReady(true);\r\n\r\n        return () => {\r\n            // 1. Lock the door: Prevent external access immediately\r\n            chartARef.current = null;\r\n            chartBRef.current = null;\r\n            seriesARef.current = null;\r\n            seriesBRef.current = null;\r\n\r\n            // 2. Dispose Widget\r\n            if (chartWidgetRef.current) {\r\n                try {\r\n                    chartWidgetRef.current.dispose();\r\n                } catch (e) {\r\n                    console.warn(\"[ChartContainer] Widget dispose failed:\", e);\r\n                }\r\n                chartWidgetRef.current = null;\r\n            }\r\n\r\n            // 3. Destroy Chart\r\n            try {\r\n                chartA.remove();\r\n                if (chartB) chartB.remove();\r\n            } catch (e) {\r\n                console.warn(\"[ChartContainer] Chart remove error:\", e);\r\n            }\r\n        };\r\n    }, []); // Only run once on mount\r\n\r\n    // Resize Logic\r\n    const isSingleMode = !symbolB;\r\n\r\n    useEffect(() => {\r\n        if (!mainContainerRef.current) return;\r\n\r\n        const resizeObserver = new ResizeObserver((entries) => {\r\n            if (entries.length === 0) return;\r\n            const { width, height: containerHeight } = entries[0].contentRect;\r\n\r\n            // Calculate available height for charts\r\n            // overhead: Header(40) + Footer(42) = 82 if single\r\n            // overhead: HeaderA(40) + Footer(42) + HeaderB(41) = 123 if dual\r\n            const overhead = isSingleMode ? 0 : 41;\r\n            const availableHeight = containerHeight - overhead;\r\n\r\n            if (availableHeight > 0) {\r\n                const heightPerChart = isSingleMode ? availableHeight : (availableHeight / 2);\r\n\r\n                chartARef.current?.applyOptions({ width, height: heightPerChart });\r\n                if (!isSingleMode) {\r\n                    chartBRef.current?.applyOptions({ width, height: heightPerChart });\r\n                }\r\n            }\r\n        });\r\n\r\n        resizeObserver.observe(mainContainerRef.current);\r\n        return () => resizeObserver.disconnect();\r\n    }, [symbolB]); // Re-run when mode changes\r\n\r\n\r\n\r\n    // Handler for Scroll To RealTime\r\n    const handleScrollToRealTime = () => {\r\n        if (!chartARef.current || dataARef.current.length === 0) return;\r\n\r\n        const dataA = dataARef.current;\r\n\r\n        // STRICT REALTIME CLAMP: Ignore future bars in calculation\r\n        const nowSec = Math.floor(Date.now() / 1000) + getTimeframeSeconds(timeframe); // Tolerance 1 bar\r\n        let lastRealIndex = dataA.length - 1;\r\n\r\n        // Scan backward to find last REAL candle\r\n        for (let i = dataA.length - 1; i >= 0; i--) {\r\n            if (dataA[i].time <= nowSec) {\r\n                lastRealIndex = i;\r\n                break;\r\n            }\r\n        }\r\n\r\n        // We use the calculated index. Future logic is explicitly disabled.\r\n        // User Requirement: \"ensure automatic repositioning never jumps beyond current candle\"\r\n        const additionalBars = 0;\r\n\r\n        // Get current width to maintain zoom\r\n        const currentRange = chartARef.current.timeScale().getVisibleLogicalRange();\r\n        const width = currentRange ? (currentRange.to - currentRange.from) : 100;\r\n\r\n        // We typically want a bit of right offset (e.g. 5 bars)\r\n        const rightOffset = 5;\r\n\r\n        // Target: End of Real Data + Future Gap + Offset\r\n        const newTo = lastRealIndex + additionalBars + rightOffset;\r\n        const newFrom = newTo - width;\r\n\r\n        chartARef.current.timeScale().setVisibleLogicalRange({ from: newFrom, to: newTo });\r\n        setIsAtRealtime(true);\r\n    };\r\n\r\n    // Reset fit flags when symbol changes\r\n    useEffect(() => {\r\n        hasFittedARef.current = false;\r\n        if (chartWidgetRef.current) {\r\n            chartWidgetRef.current.setSymbol(symbol);\r\n        }\r\n    }, [symbol]);\r\n\r\n    // --- HORIZON DATA SYNC ---\r\n    // ROLLBACK: Feed the phantom bars to the invisible series\r\n    useEffect(() => {\r\n        if (seriesHorizonRef.current && horizonData.length > 0) {\r\n            seriesHorizonRef.current.setData(horizonData);\r\n        }\r\n    }, [horizonData]);\r\n\r\n    // Dynamic Scroll Logic Removed (Was causing jumps)\r\n\r\n\r\n\r\n\r\n    // State to persist \"Intent\" across renders until data is ready\r\n    const viewStateRef = useRef<{\r\n        type: 'LIVE_EDGE' | 'HISTORY' | 'TIME' | 'NONE';\r\n        savedBarCount: number | null;\r\n        savedRightTime: number | null;\r\n        savedRightOffset: number | null;\r\n        savedRange: any;\r\n    }>({ type: 'NONE', savedBarCount: null, savedRightTime: null, savedRightOffset: null, savedRange: null });\r\n\r\n    // Ref to track stabilization status during switches to prevent premature sync broadcasts\r\n    const isStabilizingRef = useRef(false);\r\n\r\n    // Data Update Effect with One-Time Fit AND Scroll Preservation\r\n    useEffect(() => {\r\n        if (seriesARef.current) {\r\n            // Check if this update coincides with a timeframe switch request\r\n            const isTimeframeSwitchReq = prevTimeframeRef.current !== timeframe;\r\n\r\n            if (isTimeframeSwitchReq) {\r\n                isStabilizingRef.current = true;\r\n            }\r\n\r\n            // 1. Snapshot State BEFORE touching data (if switching)\r\n            // Use processedData length for consistent state management\r\n            dataLengthRef.current = processedData.length;\r\n\r\n            if (isTimeframeSwitchReq && viewStateRef.current.type === 'NONE') {\r\n                if (hasFittedARef.current && chartARef.current) {\r\n                    try {\r\n                        const logicRange = chartARef.current.timeScale().getVisibleLogicalRange();\r\n\r\n                        if (logicRange && logicRange.from !== null && logicRange.to !== null) {\r\n                            const barCount = (logicRange.to as number) - (logicRange.from as number);\r\n                            const lastBarIndex = processedData.length - 1;\r\n                            const distFromEdge = lastBarIndex - (logicRange.to as number); // Positive if looking at history\r\n\r\n                            // THRESHOLD: If we are within 5 bars of the \"Latest Data\" OR in the future (negative), consider it Realtime Mode.\r\n                            // Infinite Scroll Support: Allow arbitrary negative offset (Future).\r\n                            const isAtRealtimeEdge = distFromEdge < 5;\r\n\r\n                            if (isAtRealtimeEdge) {\r\n                                viewStateRef.current = {\r\n                                    type: 'LIVE_EDGE',\r\n                                    savedBarCount: barCount,\r\n                                    savedRightOffset: distFromEdge,\r\n                                    savedRightTime: null,\r\n                                    savedRange: null\r\n                                };\r\n                                // console.log(`[ChartContainer] Capturing LIVE_EDGE Viewport. Offset: ${distFromEdge.toFixed(2)}`);\r\n                            } else {\r\n                                // HISTORY MODE: Capture the TIME of the rightmost visible bar\r\n                                // This ensures that when we switch TF, we find the index corresponding to this TIME.\r\n                                const clampedRightIdx = Math.max(0, Math.min(Math.floor(logicRange.to as number), processedData.length - 1));\r\n                                const rightTime = processedData[clampedRightIdx]?.time;\r\n\r\n                                if (rightTime) {\r\n                                    viewStateRef.current = {\r\n                                        type: 'HISTORY',\r\n                                        savedBarCount: barCount,\r\n                                        savedRightTime: rightTime as number,\r\n                                        savedRightOffset: null,\r\n                                        savedRange: null\r\n                                    };\r\n                                    console.log(`[ChartContainer] Capturing HISTORY Viewport. RightTime: ${rightTime}`);\r\n                                }\r\n                            }\r\n                        }\r\n                    } catch (e) {\r\n                        console.warn(\"[ChartContainer] Failed to capture state for TF switch\", e);\r\n                    }\r\n                }\r\n            } else if (!isTimeframeSwitchReq && viewStateRef.current.type === 'NONE' && hasFittedARef.current && chartARef.current) {\r\n                // Regular streaming/backfill update - Snapshot TIME range\r\n                try {\r\n                    const r = chartARef.current.timeScale().getVisibleRange();\r\n                    if (r) {\r\n                        viewStateRef.current = {\r\n                            type: 'TIME',\r\n                            savedRange: r,\r\n                            savedBarCount: null,\r\n                            savedRightTime: null,\r\n                            savedRightOffset: null\r\n                        };\r\n                    } else if (!isAtRealtime && historyFocusRef.current) {\r\n                        // FALLBACK: If chart returned null range (e.g. was empty/loading), but we know we are in history\r\n                        console.log(\"[ChartContainer] Snapshot failed, using History Fallback\");\r\n                        viewStateRef.current = {\r\n                            type: 'TIME',\r\n                            savedRange: { from: historyFocusRef.current.from, to: historyFocusRef.current.to } as any,\r\n                            savedBarCount: null,\r\n                            savedRightTime: null,\r\n                            savedRightOffset: null\r\n                        };\r\n                    }\r\n                } catch (e) { /* Silent */ }\r\n            }\r\n\r\n            // 2. Analyze Incoming Data for Freshness\r\n            let isDataReady = false;\r\n\r\n            if (processedData.length > 1) {\r\n                const interval = Math.abs(processedData[processedData.length - 1].time - processedData[processedData.length - 2].time);\r\n                const targetInterval = getTimeframeSeconds(timeframe);\r\n\r\n                if (interval >= targetInterval * 0.8 && interval <= targetInterval * 5) {\r\n                    isDataReady = true;\r\n                } else if (processedData.length < 5) {\r\n                    isDataReady = true;\r\n                }\r\n            } else if (processedData.length > 0) {\r\n                isDataReady = true;\r\n            } else {\r\n                isDataReady = true;\r\n            }\r\n\r\n            // If we are strictly switching, enforce data readiness before applying logic or updating ref\r\n            if (isTimeframeSwitchReq && !isDataReady) {\r\n                return;\r\n            }\r\n\r\n            // 3. Apply Data (INCREMENTAL vs FULL)\r\n            // Smart update to prevent Crosshair Reset on Ticks\r\n            const prevLen = dataLengthRef.current; // Captured before snapshot logic for accurate comparison? No, that was processedData.length.\r\n            // Better to use a separate Persistent Ref for comparison, as dataLengthRef meant for \"Before this render logic\"\r\n\r\n            // Logic:\r\n            // If NOT switching timeframe AND data is effectively the same (start time match) AND length is same or +1\r\n            // Then UPDATE instead of SET.\r\n\r\n            let appliedIncremental = false;\r\n\r\n            if (!isTimeframeSwitchReq && processedData.length > 0 && prevDataLengthRef.current > 0) {\r\n                // Check consistency (Start Time match) - crude check for massive history shift\r\n                const prevStart = prevStartTimeRef.current;\r\n                const newStart = processedData[0].time as number;\r\n\r\n                // Allow tiny tolerance or exact match\r\n                if (prevStart === newStart) {\r\n                    const lenDiff = processedData.length - prevDataLengthRef.current;\r\n                    const newLastTime = processedData[processedData.length - 1].time as number;\r\n\r\n                    // Allow strictly 0 (update last) or 1 (new tick)\r\n                    // GUARD: Ensure we never try to update with PAST data (Time Reversion) which crashes LWC\r\n                    if (lenDiff >= 0 && lenDiff <= 2 && newLastTime >= prevLastTimeRef.current) {\r\n                        try {\r\n                            // Apply Updates\r\n                            const lastCandle = processedData[processedData.length - 1];\r\n                            seriesARef.current.update(lastCandle);\r\n\r\n                            // If we added 2 candles (rare), update the one before too?\r\n                            // update() only affects the specific time.\r\n                            if (lenDiff === 2) {\r\n                                const secondLast = processedData[processedData.length - 2];\r\n                                seriesARef.current.update(secondLast); // Update previous just in case\r\n                                seriesARef.current.update(lastCandle); // Then last\r\n                            }\r\n\r\n                            appliedIncremental = true;\r\n                            // console.log(`[ChartContainer:Diagnose] Incremental Tick Applied. Last: ${lastCandle.time}`);\r\n                        } catch (e) {\r\n                            console.warn(\"[ChartContainer] Incremental update failed, falling back to setData\", e);\r\n                            appliedIncremental = false;\r\n                        }\r\n                    } else {\r\n                        // console.log(`[ChartContainer:Diagnose] Incremental skipped. LenDiff: ${lenDiff}, NewLast: ${newLastTime}, PrevLast: ${prevLastTimeRef.current}`);\r\n                    }\r\n                }\r\n            }\r\n\r\n            if (!appliedIncremental) {\r\n                // console.log(`[ChartContainer:Diagnose] FALLBACK TO SETDATA. Len: ${processedData.length}`);\r\n                seriesARef.current.setData(processedData);\r\n            }\r\n\r\n            // Update Tracking Refs for Next Render\r\n            if (processedData.length > 0) {\r\n                prevDataLengthRef.current = processedData.length;\r\n                prevStartTimeRef.current = processedData[0].time as number;\r\n                prevLastTimeRef.current = processedData[processedData.length - 1].time as number;\r\n                // Critical: Update dataARef for other effects (Dynamic Scroll)\r\n                dataARef.current = processedData;\r\n            } else {\r\n                prevDataLengthRef.current = 0;\r\n                prevStartTimeRef.current = 0;\r\n                prevLastTimeRef.current = 0;\r\n                dataARef.current = [];\r\n            }\r\n\r\n            // 4. Restore State\r\n            if (processedData.length > 0 && !appliedIncremental) { // Update logic preserves state, so only restore on setData\r\n                // console.log(`[ChartContainer:Diagnose] Restore State Triggered. Type: ${viewStateRef.current.type}`);\r\n                if (!hasFittedARef.current) {\r\n                    // Start with explicit \"Last 150 Bars\" view instead of fitContent (which zooms out too much/erratically with large offsets)\r\n                    if (chartARef.current && processedData.length > 0) {\r\n                        const lastIdx = processedData.length - 1;\r\n                        const visibleCount = 150; // Standard startup zoom\r\n\r\n                        // Set range to: [End - 150, End + 10]\r\n                        // We add +10 margin. The 1000 bar rightOffset is handled by LWC as margin BEYOND this logical range? \r\n                        // Actually, rightOffset shifts the coordinate system.\r\n                        // Let's just set the logical range indices.\r\n                        chartARef.current.timeScale().setVisibleLogicalRange({\r\n                            from: lastIdx - visibleCount,\r\n                            to: lastIdx + 5 // Small buffer past data end\r\n                        });\r\n                    } else {\r\n                        chartARef.current?.timeScale().fitContent();\r\n                    }\r\n                    hasFittedARef.current = true;\r\n                } else if (chartARef.current) {\r\n                    // Apply captured view state\r\n                    try {\r\n                        const state = viewStateRef.current;\r\n\r\n                        if (state.type === 'TIME' && state.savedRange && state.savedRange.from && state.savedRange.to) {\r\n                            chartARef.current.timeScale().setVisibleRange(state.savedRange);\r\n                        }\r\n                        else if (state.type === 'LIVE_EDGE' && state.savedBarCount != null && state.savedRightOffset != null) {\r\n                            const lastIdx = processedData.length - 1;\r\n                            const newTo = lastIdx - state.savedRightOffset;\r\n                            const newFrom = newTo - state.savedBarCount;\r\n\r\n                            chartARef.current.timeScale().setVisibleLogicalRange({\r\n                                from: newFrom,\r\n                                to: newTo\r\n                            } as any);\r\n                            console.log(`[ChartContainer] Restored LIVE_EDGE. Offset: ${state.savedRightOffset.toFixed(2)} -> To: ${newTo.toFixed(2)}`);\r\n                        }\r\n                        else if (state.type === 'HISTORY' && state.savedBarCount != null && state.savedRightTime != null) {\r\n                            // Find index close to RightTime\r\n                            let low = 0, high = processedData.length - 1;\r\n                            let idx = -1;\r\n\r\n                            while (low <= high) {\r\n                                const mid = (low + high) >>> 1;\r\n                                const midTime = processedData[mid].time;\r\n                                if (midTime < state.savedRightTime) {\r\n                                    low = mid + 1;\r\n                                } else {\r\n                                    high = mid - 1;\r\n                                }\r\n                            }\r\n                            idx = low;\r\n                            // idx is now the insertion point (closest bar >= RightTime) OR the exact bar.\r\n                            if (idx < 0) idx = 0;\r\n                            if (idx >= processedData.length) idx = processedData.length - 1;\r\n\r\n                            const newTo = idx;\r\n                            const newFrom = idx - state.savedBarCount;\r\n\r\n                            chartARef.current.timeScale().setVisibleLogicalRange({\r\n                                from: newFrom,\r\n                                to: newTo\r\n                            } as any);\r\n                            console.log(`[ChartContainer] Restored HISTORY. RightTime: ${state.savedRightTime} -> Idx: ${idx}`);\r\n                        }\r\n                    } catch (e) {\r\n                        console.error(\"[ChartContainer] Error restoring view state:\", e);\r\n                    }\r\n                }\r\n            }\r\n            // 5. Cleanup / Finish Transition\r\n            const isClearing = processedData.length === 0;\r\n\r\n            if (!isClearing && (isDataReady || !isTimeframeSwitchReq)) {\r\n                prevTimeframeRef.current = timeframe;\r\n                // Reset Intent\r\n                viewStateRef.current = { type: 'NONE', savedBarCount: null, savedRightTime: null, savedRightOffset: null, savedRange: null };\r\n                // Mark stabilization complete\r\n                isStabilizingRef.current = false;\r\n            }\r\n        }\r\n    }, [processedData, timeframe]);\r\n\r\n    useEffect(() => {\r\n        if (seriesBRef.current && dataB.length > 0 && !isSingleMode) {\r\n            seriesBRef.current.setData(dataB);\r\n            if (!hasFittedBRef.current) {\r\n                chartBRef.current?.timeScale().fitContent();\r\n                hasFittedBRef.current = true;\r\n            }\r\n        }\r\n    }, [dataB, isSingleMode]);\r\n\r\n    // --- INDICATOR PLUGIN MANAGEMENT ---\r\n    useEffect(() => {\r\n        if (!chartReady || !seriesARef.current || !chartARef.current) return;\r\n\r\n        const plugins = indicatorPluginsRef.current;\r\n        const currentIds = new Set(activeIndicators.map(i => i.instanceId));\r\n\r\n        // 1. Remove Detached Indicators\r\n        for (const [id, plugin] of plugins.entries()) {\r\n            if (!currentIds.has(id)) {\r\n                try {\r\n                    seriesARef.current.detachPrimitive(plugin);\r\n                } catch (e) { /* ignore */ }\r\n                plugins.delete(id);\r\n                console.log(`[ChartContainer] Detached plugin: ${id}`);\r\n            }\r\n        }\r\n\r\n        // 2. Add/Update Indicators\r\n        activeIndicators.forEach(ind => {\r\n            let plugin = plugins.get(ind.instanceId);\r\n\r\n            // A. Create if missing\r\n            if (!plugin) {\r\n                const def = indicatorRegistry.get(ind.defId);\r\n                if (def && def.pluginFactory) {\r\n                    plugin = def.pluginFactory(ind.settings);\r\n                    if (plugin) {\r\n                        seriesARef.current?.attachPrimitive(plugin);\r\n                        plugins.set(ind.instanceId, plugin);\r\n                        // console.log(`[ChartContainer] Attached plugin: ${ind.defId} (${ind.instanceId})`);\r\n                    }\r\n                }\r\n            } else {\r\n                // B. Update Settings\r\n                if (plugin.updateSettings) {\r\n                    plugin.updateSettings(ind.settings);\r\n                }\r\n            }\r\n\r\n            // NEW: Push Common State to Plugin\r\n            const pluginAsAny = plugin as any;\r\n\r\n            // 1. Timeframe\r\n            if (pluginAsAny && pluginAsAny.updateTimeframe) {\r\n                pluginAsAny.updateTimeframe(timeframe);\r\n            }\r\n\r\n            // 2. Latest Time (for precise clamping)\r\n            if (pluginAsAny && pluginAsAny.updateCurrentTime && dataA.length > 0) {\r\n                const latestTime = dataA[dataA.length - 1].time;\r\n                pluginAsAny.updateCurrentTime(latestTime);\r\n            }\r\n            // NEW: Push Full Data to Plugin (for Client-Side Calculation)\r\n            if (pluginAsAny && pluginAsAny.updateData) {\r\n                pluginAsAny.updateData(dataA);\r\n            }\r\n\r\n            // NEW: Push Visibility\r\n            if (pluginAsAny && typeof pluginAsAny.setVisible === 'function') {\r\n                pluginAsAny.setVisible(ind.visible ?? true);\r\n            }\r\n\r\n            // C. Fetch Data Check\r\n            if (plugin && ind.visible) {\r\n                const def = indicatorRegistry.get(ind.defId);\r\n                if (def && def.dataFetcher) {\r\n                    // Fetch Data logic\r\n                    const fromTime = dataA.length > 0 ? dataA[0].time : Math.floor(Date.now() / 1000) - 86400 * 30;\r\n                    const toTime = dataA.length > 0 ? dataA[dataA.length - 1].time : Math.floor(Date.now() / 1000);\r\n\r\n                    def.dataFetcher({\r\n                        symbol: symbol,\r\n                        timeframe: timeframe,\r\n                        from: (fromTime as number) * 1000,\r\n                        to: (toTime as number) * 1000,\r\n                        settings: ind.settings\r\n                    }).then(data => {\r\n                        if (plugin.updateSessions) {\r\n                            plugin.updateSessions(data);\r\n                        }\r\n                    }).catch(e => console.error(\"Indicator Data Fetch Failed\", e));\r\n                }\r\n            }\r\n        });\r\n\r\n    }, [activeIndicators, symbol, timeframe, dataA, chartReady]);\r\n\r\n    // Cleanup Plugins on Unmount\r\n    useEffect(() => {\r\n        return () => {\r\n            const plugins = indicatorPluginsRef.current;\r\n            if (seriesARef.current && plugins.size > 0) {\r\n                plugins.forEach((plugin) => {\r\n                    try {\r\n                        seriesARef.current?.detachPrimitive(plugin);\r\n                    } catch (e) { /* Ignore if already disposed */ }\r\n                });\r\n                plugins.clear();\r\n            }\r\n        };\r\n    }, []);\r\n\r\n    // Apply Theme Changes Dynamically\r\n    useEffect(() => {\r\n        const applyThemeToChart = (chart: IChartApi | null, series: ISeriesApi<\"Candlestick\"> | null) => {\r\n            if (!chart) return;\r\n\r\n            chart.applyOptions({\r\n                layout: {\r\n                    background: { type: ColorType.Solid, color: typeof theme.layout.background === 'string' ? theme.layout.background : theme.layout.background.color },\r\n                    textColor: theme.layout.textColor,\r\n                },\r\n                grid: {\r\n                    vertLines: {\r\n                        color: theme.grid.vertLines.color,\r\n                        visible: theme.grid.vertLines.visible,\r\n                        style: theme.grid.vertLines.style\r\n                    },\r\n                    horzLines: {\r\n                        color: theme.grid.horzLines.color,\r\n                        visible: theme.grid.horzLines.visible,\r\n                        style: theme.grid.horzLines.style\r\n                    },\r\n                },\r\n                timeScale: {\r\n                    borderColor: theme.timeScale.borderColor,\r\n                    timeVisible: true,\r\n                    secondsVisible: false,\r\n                    ticksVisible: true,\r\n                },\r\n                rightPriceScale: {\r\n                    borderColor: theme.priceScale.borderColor,\r\n                },\r\n                crosshair: {\r\n                    vertLine: {\r\n                        color: '#000000',\r\n                        labelBackgroundColor: '#000000',\r\n                    },\r\n                    horzLine: {\r\n                        color: '#000000',\r\n                        labelBackgroundColor: '#000000',\r\n                    },\r\n                },\r\n                localization: {\r\n                    priceFormatter: (p: number) => p.toFixed(precision),\r\n                },\r\n                handleScale: {\r\n                    mouseWheel: false,\r\n                },\r\n                handleScroll: {\r\n                    mouseWheel: true,\r\n                    pressedMouseMove: true,\r\n                    horzTouchDrag: true,\r\n                    vertTouchDrag: true,\r\n                },\r\n            });\r\n\r\n            if (series) {\r\n                series.applyOptions({\r\n                    upColor: theme.candles.upColor,\r\n                    downColor: theme.candles.downColor,\r\n                    wickVisible: true,\r\n                    borderVisible: true,\r\n                    wickUpColor: theme.candles.wickUpColor,\r\n                    wickDownColor: theme.candles.wickDownColor,\r\n                    borderUpColor: theme.candles.borderUpColor,\r\n                    borderDownColor: theme.candles.borderDownColor,\r\n                    // priceFormat: handled in separate effect\r\n                });\r\n            }\r\n        };\r\n\r\n        applyThemeToChart(chartARef.current, seriesARef.current);\r\n        applyThemeToChart(chartBRef.current, seriesBRef.current);\r\n\r\n    }, [theme]);\r\n\r\n    // --- SEPARATE EFFECT: PRECISION ---\r\n    useEffect(() => {\r\n        if (!seriesARef.current) return;\r\n\r\n        const minMove = 1 / Math.pow(10, precision);\r\n        console.log(`[ChartContainer] Applying Precision: ${precision} (minMove: ${minMove})`);\r\n\r\n        seriesARef.current.applyOptions({\r\n            priceFormat: { type: 'price', precision: precision, minMove: minMove },\r\n        });\r\n\r\n        if (seriesBRef.current) {\r\n            seriesBRef.current.applyOptions({\r\n                priceFormat: { type: 'price', precision: precision, minMove: minMove },\r\n            });\r\n        }\r\n    }, [precision, chartReady]); // Depend on chartReady to ensure series exists // Removed precision dependency from here\r\n\r\n    // Tool Toggle Logic\r\n    // --- UPDATE MAGNET DATA ---\r\n    useEffect(() => {\r\n        if (chartWidgetRef.current && dataA.length > 0) {\r\n            chartWidgetRef.current.setSeriesData(dataA);\r\n            // Also update timeframe\r\n            if (timeframe) {\r\n                chartWidgetRef.current.setTimeframe(timeframe);\r\n            }\r\n            // Fix: Ensure widgets (like position tools) get the latest price immediately on data refresh\r\n            const last = dataA[dataA.length - 1];\r\n            if (last) {\r\n                chartWidgetRef.current.updateLastPrice(last.close, last.time as number);\r\n            }\r\n        }\r\n    }, [dataA, timeframe]);\r\n\r\n    const toggleLongShortTool = (direction: 'long' | 'short') => {\r\n        console.log(`[ChartContainer] toggleLongShortTool called: ${direction}`);\r\n        if (!seriesARef.current || !chartARef.current) {\r\n            console.error(\"[ChartContainer] Chart or Series not initialized\", {\r\n                chart: !!chartARef.current,\r\n                series: !!seriesARef.current\r\n            });\r\n            return;\r\n        }\r\n\r\n        if (dataA.length === 0) {\r\n            console.warn(\"[ChartContainer] Cannot create tool: dataA is empty\");\r\n            return;\r\n        }\r\n\r\n        const lastCandle = dataA[dataA.length - 1];\r\n        const currentPrice = lastCandle.close || lastCandle.value;\r\n        console.log(`[ChartContainer] Creating ${direction} tool at ${currentPrice}`);\r\n\r\n        // Calculate tighter defaults (0.05% risk/reward base)\r\n        const spread = currentPrice * 0.0005;\r\n\r\n        let slPrice, tpPrice;\r\n\r\n        if (direction === 'long') {\r\n            slPrice = currentPrice - spread;\r\n            tpPrice = currentPrice + (spread * 2); // 1:2 RR default\r\n        } else {\r\n            slPrice = currentPrice + spread;\r\n            tpPrice = currentPrice - (spread * 2); // 1:2 RR default\r\n        }\r\n\r\n        // Create initial state\r\n        const initialState: LongShortState = {\r\n            entryPrice: currentPrice,\r\n            stopLossPrice: slPrice,\r\n            takeProfitPrice: tpPrice,\r\n            timeIndex: lastCandle.time as number,\r\n            riskReward: 2.0,\r\n            fixedLeg: 'rr',\r\n            fixedStates: {\r\n                tp: false,\r\n                sl: false,\r\n                entry: false,\r\n                rr: true\r\n            },\r\n            orderType: 'MARKET'\r\n        };\r\n\r\n        try {\r\n            if (chartWidgetRef.current) {\r\n                chartWidgetRef.current.createShape(\r\n                    { time: lastCandle.time as number, price: currentPrice },\r\n                    {\r\n                        shape: direction === 'long' ? 'Riskrewardlong' : 'Riskrewardshort',\r\n                        overrides: {\r\n                            [`linetoolriskreward${direction}.stopLevel`]: slPrice,\r\n                            [`linetoolriskreward${direction}.profitLevel`]: tpPrice,\r\n                            [`linetoolriskreward${direction}.entryPrice`]: currentPrice,\r\n                            [`linetoolriskreward${direction}.riskReward`]: 2.0,\r\n                            [`linetoolriskreward${direction}.fixedLeg`]: 'rr',\r\n                            [`linetoolriskreward${direction}.symbol`]: symbol  // Pass usage symbol\r\n                        }\r\n                    }\r\n                );\r\n            }\r\n            console.log(\"Tool created successfully via ChartWidget\");\r\n        } catch (e) {\r\n            console.error(\"Error attaching tool:\", e);\r\n        }\r\n    };\r\n\r\n    const toggleAutoScale = () => {\r\n        const newState = !isAutoScale;\r\n        setIsAutoScale(newState);\r\n        chartARef.current?.priceScale('right').applyOptions({ autoScale: newState });\r\n        if (!isSingleMode) {\r\n            chartBRef.current?.priceScale('right').applyOptions({ autoScale: newState });\r\n        }\r\n    };\r\n\r\n\r\n\r\n    // ... (rest of the file until handleConfirmExecution)\r\n\r\n    const handleConfirmExecution = async () => {\r\n        if (!pendingTrade) return;\r\n\r\n        // 1. IMMEDIATE FEEDBACK: Start Loading & Close Dialog\r\n        setIsExecutingTrade(true);\r\n        setPendingTrade(null);\r\n\r\n        // Remove the Widget immediately (User Request)\r\n        if (executionSourceId && chartWidgetRef.current) {\r\n            try {\r\n                chartWidgetRef.current.removeEntity(executionSourceId);\r\n                setExecutionSourceId(null);\r\n            } catch (e) {\r\n                console.warn(\"Failed to remove execution widget\", e);\r\n            }\r\n        }\r\n\r\n        try {\r\n            console.log(\"[Chart] Preparing Execution for:\", pendingTrade);\r\n\r\n            // 2. Get Distribution Config\r\n            const config = await TradeDistributionManager.getDistributionConfig();\r\n\r\n            // 3. Calculate Batches\r\n            const batches = TradeDistributionManager.distributeTrade(\r\n                pendingTrade,\r\n                accounts,\r\n                brokers,\r\n                config,\r\n                isTestMode\r\n            );\r\n\r\n            console.log(\"--- DEBUG: DISTRIBUTION PLAN ---\");\r\n            console.log(batches);\r\n\r\n            if (batches.length === 0) {\r\n                alert(\"No target accounts found for distribution!\");\r\n                return;\r\n            }\r\n\r\n            // 4. EXECUTE TRADES (Send to Backend)\r\n            const results = await Promise.all(batches.map(async (batch) => {\r\n                try {\r\n                    const res = await fetch('/api/distribution/execute', {\r\n                        method: 'POST',\r\n                        headers: { 'Content-Type': 'application/json' },\r\n                        body: JSON.stringify(batch)\r\n                    });\r\n\r\n                    if (res.ok) {\r\n                        const result = await res.json();\r\n                        console.log(`[ChartContainer] Batch for ${batch.brokerId} executed:`, result);\r\n                        return {\r\n                            status: 'success',\r\n                            brokerId: batch.brokerId,\r\n                            accounts: batch.accounts,\r\n                            details: result\r\n                        };\r\n                    } else {\r\n                        console.error(`[ChartContainer] Batch execution failed for ${batch.brokerId}: ${res.statusText}`);\r\n                        return {\r\n                            status: 'error',\r\n                            brokerId: batch.brokerId,\r\n                            accounts: batch.accounts,\r\n                            error: res.statusText\r\n                        };\r\n                    }\r\n                } catch (e: any) {\r\n                    console.error(`[ChartContainer] Batch Network Error`, e);\r\n                    return {\r\n                        status: 'error',\r\n                        brokerId: batch.brokerId,\r\n                        accounts: batch.accounts,\r\n                        error: e.message || \"Network Error\"\r\n                    };\r\n                }\r\n            }));\r\n\r\n            // 5. SHOW SUMMARY\r\n            setExecutionSummary(results);\r\n\r\n        } catch (e) {\r\n            console.error(\"[ChartContainer] Execution Error\", e);\r\n            alert(\"Failed to prepare or execute trades.\");\r\n        } finally {\r\n            setIsExecutingTrade(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div ref={mainContainerRef} className=\"flex flex-col bg-white dark:bg-slate-950 border border-slate-300 dark:border-slate-800 overflow-hidden w-full relative\" style={{ height: typeof height === 'number' ? height : '100%' }}>\r\n            {/* ... Header and Content ... */}\r\n            {/* Need to ensure we don't overwrite the whole file. Ideally just targeting the button area would be safer but since I need to insert the function... */}\r\n            {/* Actually, I can insert the function before 'return' and then replace the button separately? */}\r\n            {/* But I can do one block if I match context. */}\r\n\r\n            {/* Global Key Listener for Drawing Tools */}\r\n            {React.createElement(\r\n                React.Fragment,\r\n                null,\r\n                (() => {\r\n                    useEffect(() => {\r\n                        const handleKeyDown = (e: KeyboardEvent) => {\r\n                            // Alt + H = Horizontal Line\r\n                            // Alt + J = Horizontal Ray\r\n                            if (!isActive || !e.altKey) return;\r\n\r\n                            const isLine = e.code === 'KeyH';\r\n                            const isRay = e.code === 'KeyJ';\r\n                            const isVert = e.code === 'KeyV';\r\n\r\n                            if ((isLine || isRay || isVert) && currentMousePosRef.current && chartARef.current && seriesARef.current && chartWidgetRef.current) {\r\n                                e.preventDefault();\r\n\r\n                                const { x, y } = currentMousePosRef.current;\r\n                                const timeScale = chartARef.current.timeScale();\r\n                                const series = seriesARef.current;\r\n\r\n                                // Magnet Snap Logic\r\n                                const snapped = MagnetService.snap(\r\n                                    x, y,\r\n                                    series,\r\n                                    dataA, // Using dataA as main source\r\n                                    timeScale,\r\n                                    timeframe\r\n                                );\r\n\r\n                                const finalTime = timeScale.coordinateToTime(snapped.x) as number;\r\n                                const finalPrice = series.coordinateToPrice(snapped.y);\r\n\r\n                                if (finalPrice !== null) {\r\n                                    chartWidgetRef.current.createShape(\r\n                                        { time: finalTime || 0, price: finalPrice },\r\n                                        {\r\n                                            shape: isVert ? 'VerticalLine' : (isLine ? 'HorizontalLine' : 'HorizontalRay'),\r\n                                            overrides: {\r\n                                                anchor: snapped.anchor // Passing anchor info for snapping context\r\n                                            }\r\n                                        }\r\n                                    );\r\n                                }\r\n                            }\r\n                        };\r\n\r\n                        window.addEventListener('keydown', handleKeyDown);\r\n                        return () => window.removeEventListener('keydown', handleKeyDown);\r\n                    }, [dataA, timeframe, isActive]);\r\n                    return null;\r\n                })()\r\n            )}\r\n\r\n            {/* Chart A Header */}\r\n\r\n\r\n            {/* Chart A Header Removed */}\r\n\r\n            {/* Charts Section */}\r\n            {/* Charts Section */}\r\n            <div className=\"flex-1 min-h-0 flex flex-col relative\">\r\n                {!isAtRealtime && (\r\n                    <div\r\n                        // Large Trigger Zone for easy access\r\n                        className=\"absolute bottom-[30px] right-[60px] w-40 h-32 flex items-end justify-end z-[50] pb-[15px] pr-[15px]\"\r\n                        style={{ pointerEvents: 'auto' }}\r\n                        onMouseEnter={() => setIsHoveringScrollTrigger(true)}\r\n                        onMouseLeave={() => setIsHoveringScrollTrigger(false)}\r\n                    >\r\n                        {isHoveringScrollTrigger && (\r\n                            <button\r\n                                onClick={handleScrollToRealTime}\r\n                                // TradingView-like: Small (26px), dark grey bg. Hover: Text becomes white for contrast.\r\n                                className=\"bg-white dark:bg-[#2a2e39] hover:bg-slate-100 dark:hover:bg-[#363a45] text-slate-600 dark:text-[#b2b5be] hover:text-slate-900 dark:hover:text-white rounded w-[26px] h-[26px] flex items-center justify-center shadow-md transition-all border border-slate-300 dark:border-[#2a2e39]\"\r\n                                title=\"Scroll to Realtime\"\r\n                            >\r\n                                <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\r\n                                    {/* Right Arrow (Larger) - Centered at 12 (bbox 6.25-17.75) */}\r\n                                    <path d=\"M10.75 5l7 7-7 7\" strokeWidth=\"2.5\" />\r\n                                    {/* Left Arrow (Smaller & Nested) */}\r\n                                    <path d=\"M6.25 9l3 3-3 3\" strokeWidth=\"2.5\" />\r\n                                </svg>\r\n                            </button>\r\n                        )}\r\n                    </div>\r\n                )}\r\n                {/* Chart A Wrapper */}\r\n                <div\r\n                    className={`w-full relative min-h-0 bg-slate-50 dark:bg-slate-900/10 ${isSingleMode ? 'flex-1' : 'flex-1'}`}\r\n                    onMouseMove={(e) => {\r\n                        const rect = e.currentTarget.getBoundingClientRect();\r\n                        currentMousePosRef.current = {\r\n                            x: e.clientX - rect.left,\r\n                            y: e.clientY - rect.top\r\n                        };\r\n\r\n                        const isRight = (e.clientX - rect.left) > (rect.width - 60);\r\n                        if (isRight !== isRightHovered) {\r\n                            setIsRightHovered(isRight);\r\n                        }\r\n                    }}\r\n                    onMouseLeave={() => setIsRightHovered(false)}\r\n                >\r\n                    <div ref={containerRefA} className=\"absolute inset-0\" />\r\n\r\n\r\n\r\n\r\n\r\n                    {/* Auto Scale Toggle Button (Shows on Hover - Non-blocking) */}\r\n                    <div\r\n                        className={`absolute bottom-[34px] right-2 z-30 transition-all duration-200 pointer-events-auto ${isRightHovered ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-2 pointer-events-none'\r\n                            }`}\r\n                    >\r\n                        <button\r\n                            onClick={(e) => {\r\n                                e.stopPropagation();\r\n                                toggleAutoScale();\r\n                            }}\r\n                            className={`w-6 h-6 rounded border flex items-center justify-center text-[10px] font-bold shadow-sm transition-colors ${isAutoScale\r\n                                ? 'bg-slate-950 dark:bg-slate-950 text-white border-slate-950 dark:border-slate-950 hover:bg-slate-800' // Active: Black button\r\n                                : 'bg-white text-black border-slate-300 hover:bg-slate-100'     // Inactive: White button\r\n                                }`}\r\n                            title=\"Toggle Auto Scale\"\r\n                        >\r\n                            A\r\n                        </button>\r\n                    </div>\r\n\r\n                    {/* --- CORNER GEAR (Permanent) --- */}\r\n                    <div className=\"absolute bottom-0 right-0 w-[60px] h-[30px] z-20 flex items-center justify-center bg-transparent pointer-events-auto\">\r\n                        <button\r\n                            onClick={(e) => {\r\n                                e.stopPropagation();\r\n                                onSettingsClick?.();\r\n                            }}\r\n                            className=\"text-slate-500 hover:text-slate-400 transition-colors p-1\"\r\n                            title=\"Chart Settings\"\r\n                        >\r\n                            <Settings size={14} />\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Chart B Section (Conditional) */}\r\n                {!isSingleMode && (\r\n                    <>\r\n                        <div className=\"h-[1px] bg-slate-200 dark:bg-slate-800 shrink-0 mx-4\" />\r\n                        {/* Chart B Header */}\r\n                        <div className=\"px-4 py-2 bg-slate-50 dark:bg-slate-900 border-b border-t border-slate-200 dark:border-slate-800 flex justify-between items-center h-[40px] shrink-0\">\r\n                            <div className=\"flex items-center gap-2\">\r\n                                <span className=\"w-2 h-2 rounded-full bg-indigo-500 shadow-[0_0_8px_rgba(99,102,241,0.5)]\" />\r\n                                <span className=\"font-bold text-indigo-300 tracking-tight\">{symbolB}</span>\r\n                            </div>\r\n                            <span className=\"text-[10px] font-bold text-indigo-500/50 uppercase tracking-widest\">Correlation</span>\r\n                        </div>\r\n                        {/* Chart B Wrapper */}\r\n                        <div className=\"w-full relative flex-1 min-h-0 bg-slate-50 dark:bg-slate-900/10\">\r\n                            <div ref={containerRefB} className=\"absolute inset-0\" />\r\n                        </div>\r\n                    </>\r\n                )}\r\n\r\n                {/* Loading Overlay */}\r\n                {/* Loading Overlay (Strict Consistency Lock) */}\r\n                {/* Loading Overlay (Modified: Only block if < 100 candles) */}\r\n                <LoadingOverlay isVisible={isLoading} error={syncError} />\r\n            </div>\r\n\r\n\r\n\r\n            {/* Footer Removed */}\r\n\r\n            {/* --- Context Menu & Settings --- */}\r\n            {menuState.visible && (\r\n                <ContextMenu\r\n                    x={menuState.x}\r\n                    y={menuState.y}\r\n                    items={menuState.type === 'widget' ? [\r\n                        { label: 'Settings...', action: openSettings },\r\n                        { label: 'Bring to Front', action: () => { console.log('Bring to front not implemented yet'); } },\r\n                        { label: 'Delete', action: handleDelete, danger: true }\r\n                    ] : [\r\n                        { label: 'Remove All Drawings', action: handleRemoveAll, danger: true }\r\n                    ]}\r\n                    onClose={closeMenu}\r\n                />\r\n            )}\r\n\r\n            <SettingsModal\r\n                isOpen={settingsState.isOpen}\r\n                onClose={closeSettings}\r\n                onSave={saveSettings}\r\n                schema={settingsState.schema}\r\n                title=\"Widget Settings\"\r\n            />\r\n\r\n            {/* --- Trade Confirmation Dialog --- */}\r\n            {pendingTrade && (\r\n                <div className=\"absolute inset-0 z-[100] flex items-center justify-center bg-slate-950/60 backdrop-blur-sm p-4 animate-in fade-in duration-200\">\r\n                    <div className=\"bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in duration-200\">\r\n                        <div className=\"px-6 py-4 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center bg-slate-50 dark:bg-slate-900/50\">\r\n                            <h3 className=\"text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2\">\r\n                                <span className={pendingTrade.direction === 'LONG' ? \"text-emerald-600 dark:text-emerald-500\" : \"text-rose-600 dark:text-rose-500\"}>\r\n                                    {pendingTrade.direction === 'LONG' ? \"Long\" : \"Short\"} Setup\r\n                                </span>\r\n                            </h3>\r\n                            <button onClick={() => setPendingTrade(null)} className=\"text-slate-400 hover:text-slate-600 dark:hover:text-white transition-colors\">\r\n                                <ChevronRight className=\"rotate-90\" size={20} />\r\n                            </button>\r\n                        </div>\r\n\r\n                        <div className=\"p-0 overflow-hidden\">\r\n                            {/* Table Panel for Execution Config */}\r\n                            <div className=\"w-full text-sm text-left\">\r\n                                <div className=\"grid grid-cols-[100px_1fr_80px] border-b border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900/50 text-slate-500 font-bold text-[10px] uppercase tracking-wider\">\r\n                                    <div className=\"px-4 py-2\">Level</div>\r\n                                    <div className=\"px-4 py-2\">Configuration</div>\r\n                                    <div className=\"px-4 py-2 text-right\">Status</div>\r\n                                </div>\r\n\r\n                                {/* Stop Loss */}\r\n                                <div className=\"grid grid-cols-[100px_1fr_80px] border-b border-slate-200 dark:border-slate-800 items-center hover:bg-slate-50 dark:hover:bg-slate-900/30 transition-colors\">\r\n                                    <div className=\"px-4 py-3 font-bold text-rose-600 dark:text-rose-500\">Stop Loss</div>\r\n                                    <div className=\"px-4 py-3 font-mono text-slate-700 dark:text-slate-300\">\r\n                                        {pendingTrade.sl.anchor ? (\r\n                                            <span className=\"flex items-center gap-2\">\r\n                                                <span className=\"bg-slate-200 dark:bg-slate-800 px-1.5 rounded text-[10px] text-slate-600 dark:text-slate-400 border border-slate-300 dark:border-slate-700\">{pendingTrade.sl.anchor.timeframe}</span>\r\n                                                <span className=\"bg-slate-200 dark:bg-slate-800 px-1.5 rounded text-[10px] text-slate-600 dark:text-slate-400 border border-slate-300 dark:border-slate-700 font-bold text-slate-900 dark:text-white\">{pendingTrade.sl.anchor.type.toUpperCase()}</span>\r\n                                                <span>{new Date(pendingTrade.sl.anchor.time * 1000).toISOString().substr(11, 5)}</span>\r\n                                            </span>\r\n                                        ) : (\r\n                                            <span className=\"text-slate-500 dark:text-slate-600 italic\">No Anchor (Price-based)</span>\r\n                                        )}\r\n                                    </div>\r\n                                    <div className=\"px-4 py-3 text-right\">\r\n                                        {pendingTrade.sl.fixed ? (\r\n                                            <span className=\"text-[10px] font-bold text-slate-100 dark:text-slate-950 bg-slate-500 px-1.5 py-0.5 rounded\">FIX</span>\r\n                                        ) : (\r\n                                            <span className=\"text-[10px] text-slate-500 dark:text-slate-600\">Dynamic</span>\r\n                                        )}\r\n                                    </div>\r\n                                </div>\r\n\r\n                                {/* Entry */}\r\n                                <div className=\"grid grid-cols-[100px_1fr_80px] border-b border-slate-200 dark:border-slate-800 items-center hover:bg-slate-50 dark:hover:bg-slate-900/30 transition-colors\">\r\n                                    <div className=\"px-4 py-3 font-bold text-slate-800 dark:text-slate-100\">Entry</div>\r\n                                    <div className=\"px-4 py-3 font-mono text-slate-700 dark:text-slate-300\">\r\n                                        {pendingTrade.entry.type === 'MARKET' ? (\r\n                                            <span className=\"text-amber-600 dark:text-amber-500 font-bold\">MARKET</span>\r\n                                        ) : (\r\n                                            <span>LIMIT</span>\r\n                                        )}\r\n                                    </div>\r\n                                    <div className=\"px-4 py-3 text-right\">\r\n                                        {pendingTrade.entry.fixed ? (\r\n                                            <span className=\"text-[10px] font-bold text-slate-100 dark:text-slate-950 bg-slate-500 px-1.5 py-0.5 rounded\">FIX</span>\r\n                                        ) : (\r\n                                            <span className=\"text-[10px] text-slate-500 dark:text-slate-600\">Dynamic</span>\r\n                                        )}\r\n                                    </div>\r\n                                </div>\r\n\r\n                                {/* Risk Reward */}\r\n                                <div className=\"grid grid-cols-[100px_1fr_80px] border-b border-slate-200 dark:border-slate-800 items-center hover:bg-slate-50 dark:hover:bg-slate-900/30 transition-colors\">\r\n                                    <div className=\"px-4 py-3 font-bold text-slate-800 dark:text-slate-100\">Risk Reward</div>\r\n                                    <div className=\"px-4 py-3 font-mono text-emerald-600 dark:text-emerald-400 font-bold\">\r\n                                        {pendingTrade.riskReward.value.toFixed(2)} R\r\n                                    </div>\r\n                                    <div className=\"px-4 py-3 text-right\">\r\n                                        {pendingTrade.riskReward.fixed ? (\r\n                                            <span className=\"text-[10px] font-bold text-slate-100 dark:text-slate-950 bg-emerald-500 px-1.5 py-0.5 rounded\">FIX</span>\r\n                                        ) : (\r\n                                            <span className=\"text-[10px] text-slate-500 dark:text-slate-600\">Dynamic</span>\r\n                                        )}\r\n                                    </div>\r\n                                </div>\r\n\r\n                                {/* Take Profit */}\r\n                                <div className=\"grid grid-cols-[100px_1fr_80px] items-center hover:bg-slate-50 dark:hover:bg-slate-900/30 transition-colors\">\r\n                                    <div className=\"px-4 py-3 font-bold text-emerald-600 dark:text-emerald-500\">Take Profit</div>\r\n                                    <div className=\"px-4 py-3 font-mono text-slate-700 dark:text-slate-300\">\r\n                                        {pendingTrade.tp.anchor ? (\r\n                                            <span className=\"flex items-center gap-2\">\r\n                                                <span className=\"bg-slate-200 dark:bg-slate-800 px-1.5 rounded text-[10px] text-slate-600 dark:text-slate-400 border border-slate-300 dark:border-slate-700\">{pendingTrade.tp.anchor.timeframe}</span>\r\n                                                <span className=\"bg-slate-200 dark:bg-slate-800 px-1.5 rounded text-[10px] text-slate-600 dark:text-slate-400 border border-slate-300 dark:border-slate-700 font-bold text-slate-900 dark:text-white\">{pendingTrade.tp.anchor.type.toUpperCase()}</span>\r\n                                                <span>{new Date(pendingTrade.tp.anchor.time * 1000).toISOString().substr(11, 5)}</span>\r\n                                            </span>\r\n                                        ) : (\r\n                                            <span className=\"text-slate-500 dark:text-slate-600 italic opacity-50\">&lt; leer &gt;</span>\r\n                                        )}\r\n                                    </div>\r\n                                    <div className=\"px-4 py-3 text-right\">\r\n                                        {pendingTrade.tp.fixed ? (\r\n                                            <span className=\"text-[10px] font-bold text-slate-100 dark:text-slate-950 bg-slate-500 px-1.5 py-0.5 rounded\">FIX</span>\r\n                                        ) : (\r\n                                            <span className=\"text-[10px] text-slate-500 dark:text-slate-600\">Dynamic</span>\r\n                                        )}\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div className=\"p-4 bg-slate-100 dark:bg-slate-950/50 border-t border-slate-200 dark:border-slate-800 font-mono text-[10px] text-slate-500 dark:text-slate-600 whitespace-pre overflow-auto max-h-[200px]\">\r\n                                {JSON.stringify(pendingTrade, null, 2)}\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"px-6 py-4 bg-slate-50 dark:bg-slate-900/80 border-t border-slate-200 dark:border-slate-800 flex gap-3\">\r\n                            <button\r\n                                onClick={() => setPendingTrade(null)}\r\n                                className=\"flex-1 px-4 py-2 bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-700 dark:text-white rounded-lg font-bold transition-colors border border-slate-300 dark:border-slate-700 shadow-sm\"\r\n                            >\r\n                                Cancel\r\n                            </button>\r\n                            <button\r\n                                onClick={handleConfirmExecution}\r\n                                className=\"flex-1 px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-bold transition-colors shadow-lg shadow-emerald-500/20\"\r\n                            >\r\n                                Confirm Execution\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )\r\n            }\r\n            {/* --- Trade Execution Loading Overlay --- */}\r\n            {isExecutingTrade && (\r\n                <div className=\"absolute inset-0 z-[110] flex items-center justify-center bg-white/80 dark:bg-slate-950/80 backdrop-blur-sm animate-in fade-in duration-200\">\r\n                    <div className=\"flex flex-col items-center gap-4 bg-white dark:bg-slate-900/90 p-8 rounded-2xl border border-slate-300 dark:border-slate-700 shadow-2xl\">\r\n                        <div className=\"relative\">\r\n                            <div className=\"w-16 h-16 border-4 border-slate-200 dark:border-slate-800 rounded-full\"></div>\r\n                            <div className=\"absolute top-0 left-0 w-16 h-16 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin\"></div>\r\n                        </div>\r\n                        <div className=\"flex flex-col items-center gap-1\">\r\n                            <span className=\"text-lg font-bold text-slate-900 dark:text-white tracking-widest text-shadow-glow\">EXECUTING TRADES</span>\r\n                            <span className=\"text-xs font-mono text-slate-500 dark:text-slate-400\">Please wait...</span>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {/* --- Execution Summary Dialog --- */}\r\n            {executionSummary && (\r\n                <div className=\"absolute inset-0 z-[120] flex items-center justify-center bg-slate-950/80 backdrop-blur-sm p-4 animate-in fade-in zoom-in duration-200\">\r\n                    <div className=\"bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]\">\r\n                        <div className=\"px-6 py-4 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center bg-slate-50 dark:bg-slate-900/50\">\r\n                            <h3 className=\"text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2\">\r\n                                <span className={executionSummary.some(r => r.status === 'error') ? \"text-amber-600 dark:text-amber-500\" : \"text-emerald-600 dark:text-emerald-500\"}>\r\n                                    Execution Report\r\n                                </span>\r\n                            </h3>\r\n                            <button onClick={() => setExecutionSummary(null)} className=\"text-slate-400 hover:text-slate-600 dark:hover:text-white transition-colors\">\r\n                                <ChevronRight className=\"rotate-90\" size={20} />\r\n                            </button>\r\n                        </div>\r\n\r\n                        <div className=\"flex-1 overflow-y-auto p-0\">\r\n                            <div className=\"grid grid-cols-[120px_1fr_100px] border-b border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900/50 text-slate-500 font-bold text-[10px] uppercase tracking-wider sticky top-0 z-10 backdrop-blur-sm\">\r\n                                <div className=\"px-4 py-2\">Account</div>\r\n                                <div className=\"px-4 py-2\">Details</div>\r\n                                <div className=\"px-4 py-2 text-right\">Status</div>\r\n                            </div>\r\n\r\n                            {executionSummary.flatMap((batch, batchIdx) =>\r\n                                batch.accounts.map((acc: any, accIdx: number) => (\r\n                                    <div key={`${batchIdx}-${accIdx}`} className=\"grid grid-cols-[120px_1fr_100px] border-b border-slate-200 dark:border-slate-800 items-center hover:bg-slate-50 dark:hover:bg-slate-900/30 transition-colors py-2 text-sm\">\r\n                                        <div className=\"px-4 font-mono text-slate-700 dark:text-slate-300 font-bold truncate\" title={acc.login || acc.id}>\r\n                                            {acc.login || acc.id}\r\n                                        </div>\r\n                                        <div className=\"px-4 text-xs text-slate-500 dark:text-slate-400\">\r\n                                            {batch.brokerId}\r\n                                            {batch.details && (\r\n                                                <div className=\"text-[10px] text-slate-600 mt-1 truncate\">\r\n                                                    {JSON.stringify(batch.details.message || batch.details)}\r\n                                                </div>\r\n                                            )}\r\n                                            {batch.error && (\r\n                                                <div className=\"text-[10px] text-rose-500 mt-1 truncate font-bold\">\r\n                                                    {batch.error}\r\n                                                </div>\r\n                                            )}\r\n                                        </div>\r\n                                        <div className=\"px-4 text-right\">\r\n                                            {batch.status === 'success' ? (\r\n                                                <span className=\"bg-emerald-500/10 text-emerald-500 px-2 py-0.5 rounded text-[10px] font-bold border border-emerald-500/20\">SENT</span>\r\n                                            ) : (\r\n                                                <span className=\"bg-rose-500/10 text-rose-500 px-2 py-0.5 rounded text-[10px] font-bold border border-rose-500/20\">FAILED</span>\r\n                                            )}\r\n                                        </div>\r\n                                    </div>\r\n                                ))\r\n                            )}\r\n                        </div>\r\n\r\n                        <div className=\"px-6 py-4 bg-slate-50 dark:bg-slate-900/80 border-t border-slate-200 dark:border-slate-800 flex justify-end\">\r\n                            <button\r\n                                onClick={() => setExecutionSummary(null)}\r\n                                className=\"px-6 py-2 bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-700 dark:text-white rounded-lg font-bold transition-colors border border-slate-300 dark:border-slate-700 shadow-sm\"\r\n                            >\r\n                                Close\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div >\r\n    );\r\n});\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 6510, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Michael/IdeaProjects/MSMTB/src/trading-cockpit/src/components/charts/ChartStatusIndicator.tsx"],"sourcesContent":["import React from 'react';\r\nimport { Wifi, WifiOff, RefreshCw } from 'lucide-react';\r\nimport { useChartTheme } from '../../context/ChartThemeContext';\r\n\r\nexport type SyncStatus = 'OFFLINE' | 'SYNCING' | 'ONLINE';\r\n\r\ninterface ChartStatusIndicatorProps {\r\n    status: SyncStatus;\r\n    className?: string;\r\n}\r\n\r\nexport const ChartStatusIndicator: React.FC<ChartStatusIndicatorProps> = ({ status, className = \"\" }) => {\r\n    const { mode } = useChartTheme();\r\n    const isDark = mode === 'dark';\r\n\r\n    let content = null;\r\n    let containerClass = \"flex items-center gap-1.5 px-2 py-0.5 rounded text-[10px] font-bold tracking-wider border transition-colors select-none\";\r\n\r\n    // Explicit Styles based on Chart Theme Mode (ignoring App Global Theme)\r\n    switch (status) {\r\n        case 'OFFLINE':\r\n            if (isDark) {\r\n                // Dark Mode: Gray BG, Black Text\r\n                containerClass += \" bg-gray-400 text-black border-gray-500\";\r\n            } else {\r\n                // Light Mode: Black BG, White Text\r\n                containerClass += \" bg-black text-white border-black\";\r\n            }\r\n            content = (\r\n                <>\r\n                    <WifiOff size={10} strokeWidth={3} />\r\n                    <span>OFFLINE</span>\r\n                </>\r\n            );\r\n            break;\r\n        case 'SYNCING':\r\n            if (isDark) {\r\n                // Dark Mode: Gray BG, Amber Text\r\n                containerClass += \" bg-gray-400 text-amber-900 border-gray-500\";\r\n            } else {\r\n                // Light Mode: Black BG, Yellow Text\r\n                containerClass += \" bg-black text-yellow-400 border-black\";\r\n            }\r\n            content = (\r\n                <>\r\n                    <RefreshCw size={10} strokeWidth={3} className=\"animate-spin\" />\r\n                    <span>SYNCING</span>\r\n                </>\r\n            );\r\n            break;\r\n        case 'ONLINE':\r\n            // Hidden\r\n            return null;\r\n    }\r\n\r\n    return (\r\n        <div className={`${containerClass} ${className}`}>\r\n            {content}\r\n        </div>\r\n    );\r\n};\r\n"],"names":[],"mappings":";;;;;AACA;AAAA;AACA;;;;;AASO,MAAM,uBAA4D,CAAC,EAAE,MAAM,EAAE,YAAY,EAAE,EAAE;;IAChG,MAAM,EAAE,IAAI,EAAE,GAAG,IAAA,wJAAa;IAC9B,MAAM,SAAS,SAAS;IAExB,IAAI,UAAU;IACd,IAAI,iBAAiB;IAErB,wEAAwE;IACxE,OAAQ;QACJ,KAAK;YACD,IAAI,QAAQ;gBACR,iCAAiC;gBACjC,kBAAkB;YACtB,OAAO;gBACH,mCAAmC;gBACnC,kBAAkB;YACtB;YACA,wBACI;;kCACI,6LAAC,0NAAO;wBAAC,MAAM;wBAAI,aAAa;;;;;;kCAChC,6LAAC;kCAAK;;;;;;;;YAGd;QACJ,KAAK;YACD,IAAI,QAAQ;gBACR,iCAAiC;gBACjC,kBAAkB;YACtB,OAAO;gBACH,oCAAoC;gBACpC,kBAAkB;YACtB;YACA,wBACI;;kCACI,6LAAC,gOAAS;wBAAC,MAAM;wBAAI,aAAa;wBAAG,WAAU;;;;;;kCAC/C,6LAAC;kCAAK;;;;;;;;YAGd;QACJ,KAAK;YACD,SAAS;YACT,OAAO;IACf;IAEA,qBACI,6LAAC;QAAI,WAAW,GAAG,eAAe,CAAC,EAAE,WAAW;kBAC3C;;;;;;AAGb;GAjDa;;QACQ,wJAAa;;;KADrB"}},
    {"offset": {"line": 6615, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Michael/IdeaProjects/MSMTB/src/trading-cockpit/src/components/charts/plugins/ICTSessionsPlugin.ts"],"sourcesContent":["import { BaseWidget, WidgetState } from '../widgets/BaseWidget';\r\nimport { IChartApi, ISeriesApi, Time, Coordinate, MouseEventParams } from 'lightweight-charts';\r\nimport { Point } from '../widgets/types';\r\nimport { getTimeframeSeconds } from '../../../utils/chartUtils';\r\n\r\n// --- Data Interfaces ---\r\nexport interface ICTSession {\r\n    id: number;\r\n    symbol: string;\r\n    session_type: string;\r\n    start_time: number; // Unix Seconds or MS? DB has MS usually.\r\n    end_time: number;\r\n    high: number;\r\n    low: number;\r\n    open: number;\r\n    mitigated_at_high: number | null;\r\n    mitigated_at_low: number | null;\r\n    range_pips: number;\r\n}\r\n\r\nexport interface ICTSessionsSettings {\r\n    // Session Configs\r\n    show_asia: boolean;\r\n    asia_range: string;\r\n    asia_color: string;\r\n\r\n    show_london: boolean;\r\n    london_range: string;\r\n    london_color: string;\r\n\r\n    show_nyam: boolean;\r\n    nyam_range: string;\r\n    nyam_color: string;\r\n\r\n    show_nypm: boolean;\r\n    nypm_range: string;\r\n    nypm_color: string;\r\n\r\n    // Visuals\r\n    box_transparency: number; // 0-1\r\n    linewidth: number;\r\n    high_line_style: 'Solid' | 'Dashed' | 'Dotted';\r\n    low_line_style: 'Solid' | 'Dashed' | 'Dotted';\r\n    show_labels: boolean;\r\n    show_midpoints: boolean;\r\n\r\n    // Logic\r\n    mitigation_enabled: boolean;\r\n    limit_to_next_session: boolean;\r\n    max_timeframe: string;\r\n    history_count: number;\r\n}\r\n\r\nexport interface ICTSessionsState {\r\n    settings: ICTSessionsSettings;\r\n    sessions: ICTSession[];\r\n    lastCandleTime?: number; // Added to track server/chart time for clamping\r\n    timeframe?: string;\r\n}\r\n\r\nexport class ICTSessionsPlugin extends BaseWidget<ICTSessionsState> {\r\n\r\n    constructor(settings: ICTSessionsSettings) {\r\n        // BaseWidget expects initialData\r\n        super({ settings, sessions: [], lastCandleTime: undefined, timeframe: undefined });\r\n    }\r\n\r\n    public updateSessions(sessions: ICTSession[]) {\r\n        if (sessions.length > 0) {\r\n            console.log(`[ICTPlugin] Updated Sessions: ${sessions.length}`, sessions[0]);\r\n        }\r\n        this._data.sessions = sessions;\r\n        this.requestUpdate();\r\n    }\r\n\r\n    /**\r\n     * Updates the plugin with the timestamp (seconds) of the latest known candle.\r\n     * This is crucial to snap active sessions to the data edge, avoiding whitespace extension.\r\n     */\r\n    public updateCurrentTime(time: number) {\r\n        // time is strictly seconds (Unix Timestamp)\r\n        if (this._data.lastCandleTime !== time) {\r\n            this._data.lastCandleTime = time;\r\n            this.requestUpdate();\r\n        }\r\n    }\r\n\r\n    public updateSettings(settings: ICTSessionsSettings) {\r\n        this._data.settings = settings;\r\n        this.requestUpdate();\r\n    }\r\n\r\n    public updateTimeframe(timeframe: string) {\r\n        if (this._data.timeframe !== timeframe) {\r\n            this._data.timeframe = timeframe;\r\n            this.requestUpdate();\r\n        }\r\n    }\r\n\r\n    // --- ISeriesPrimitive Implementation ---\r\n\r\n    public updateGeometry(timeScale: any, series: any): void {\r\n        // No complex geometry caching needed for this simple overlay\r\n    }\r\n\r\n    protected applyDrag(target: string, newPoint: Point): void {\r\n        // No dragging\r\n    }\r\n\r\n    // Override hitTest to disable interaction/dragging for this indicator\r\n    protected hitTestBody(point: any): boolean {\r\n        return false;\r\n    }\r\n\r\n    private getLineDash(style: string): number[] {\r\n        switch (style) {\r\n            case 'Solid': return [];\r\n            case 'Dotted': return [2, 2];\r\n            case 'Dashed': return [5, 5];\r\n            default: return [5, 5];\r\n        }\r\n    }\r\n\r\n    drawBody(ctx: CanvasRenderingContext2D): void {\r\n        const { sessions, settings, lastCandleTime, timeframe } = this._data;\r\n        if (!this._chart || !this._series || sessions.length === 0) return;\r\n\r\n        // Check Max Timeframe\r\n        if (timeframe && settings.max_timeframe) {\r\n            const currentSec = getTimeframeSeconds(timeframe);\r\n            const maxSec = getTimeframeSeconds(settings.max_timeframe);\r\n            if (currentSec > maxSec) return;\r\n        }\r\n\r\n        const timeScale = this._chart.timeScale();\r\n        const nowSeconds = Date.now() / 1000;\r\n\r\n        // Define comparison time: Use lastCandleTime if available, else Date.now()\r\n        // FIX: Ensure strict clamping to lastCandleTime if available to avoid future overflow.\r\n        // If lastCandleTime is missing/invalid, fallback to nowSeconds but treat it cautiously.\r\n        const comparisonTime = (lastCandleTime && lastCandleTime > 0) ? lastCandleTime : nowSeconds;\r\n\r\n        ctx.save();\r\n\r\n        // 1. Boxes & Lines\r\n        // Filter sessions by history_count if set\r\n        let sessionsToDraw = sessions;\r\n        if (settings.history_count && settings.history_count > 0) {\r\n            sessionsToDraw = sessions.slice(-settings.history_count);\r\n        }\r\n\r\n        for (let i = 0; i < sessionsToDraw.length; i++) {\r\n            const session = sessionsToDraw[i];\r\n\r\n            if (!session.start_time) continue;\r\n\r\n            // Find NEXT session of same type for limiting\r\n            let nextSessionStart = Infinity;\r\n            if (settings.limit_to_next_session) {\r\n                // BUG FIX: We must search in the FULL sessions array, not relative to the sliced loop index 'i'\r\n                const realIndex = sessions.indexOf(session);\r\n                if (realIndex !== -1) {\r\n                    for (let j = realIndex + 1; j < sessions.length; j++) {\r\n                        if (sessions[j].session_type === session.session_type) {\r\n                            nextSessionStart = sessions[j].start_time / 1000;\r\n                            break;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            const timeS = session.start_time / 1000;\r\n            const timeE = session.end_time ? session.end_time / 1000 : null;\r\n            const nominalEnd = timeE ? timeE : nowSeconds;\r\n\r\n            // --- CORE LOGIC ---\r\n            // Clamp the drawing end to the 'active' edge of the chart (comparisonTime).\r\n            // If the session is historic (nominalEnd < comparisonTime), we draw to nominalEnd.\r\n            // If the session is active/future (nominalEnd > comparisonTime), we draw ONLY to comparisonTime (Latest Candle).\r\n            let effectiveEnd = Math.min(nominalEnd, comparisonTime);\r\n\r\n            // FIX: Ensure effectiveEnd is never BEFORE start time (prevents backward draw)\r\n            effectiveEnd = Math.max(effectiveEnd, timeS);\r\n\r\n            // Calculate coordinates\r\n            const x1 = timeScale.timeToCoordinate(timeS as Time);\r\n\r\n            // Logic for x2 (End Coordinate)\r\n            // If the session is fully complete (nominalEnd <= comparisonTime), we must treat nominalEnd as EXCLUSIVE.\r\n            // Example: Session ends 03:00. Candle 03:00 exists. We must NOT draw on 03:00. We stop at 02:45.\r\n            let x2 = timeScale.timeToCoordinate(effectiveEnd as Time);\r\n\r\n            const isSessionComplete = (comparisonTime >= nominalEnd);\r\n\r\n            if (isSessionComplete && x2 !== null) {\r\n                // If we mapped strictly to a coordinate, we might be on the \"exclusive\" boundary candle.\r\n                // We need to back off 1 logical index.\r\n                const tsApi = timeScale as any; // Cast to access logical methods if not on interface\r\n                if (tsApi.coordinateToLogical && tsApi.logicalToCoordinate) {\r\n                    const logicIdx = tsApi.coordinateToLogical(x2);\r\n                    if (logicIdx !== null) {\r\n                        // Logic: If effectiveEnd is exactly the session end, exclude it using -1 logical\r\n                        // However, lightweight-charts coordinates are centers. \r\n                        // If we found a valid candle at effectiveEnd, we back off to the previous one.\r\n                        const prevLogicIdx = logicIdx - 1;\r\n                        const prevX = tsApi.logicalToCoordinate(prevLogicIdx);\r\n                        if (prevX !== null) {\r\n                            x2 = prevX;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            // Valid X1\r\n            const validX1 = x1 !== null ? x1 : -100;\r\n\r\n            // Valid X2\r\n            let validX2: number;\r\n            if (x2 !== null) {\r\n                validX2 = x2;\r\n            } else {\r\n                // If effectiveEnd (LatestBar) has no coordinate in LWC, it usually means \r\n                // it is offscreen left or we have a gap.\r\n\r\n                // Fallback check against Visible Range\r\n                const visibleRange = timeScale.getVisibleRange();\r\n                if (!visibleRange) {\r\n                    validX2 = -100;\r\n                } else {\r\n                    // If effectiveEnd is > VisibleFrom, it SHOULD be on screen or right edge\r\n                    if (effectiveEnd >= (visibleRange.from as number)) {\r\n                        // It's conceptually on screen (just map failure?). Snap to Right Edge.\r\n                        // This handles the \"Hot Candle\" case where maybe it hasn't indexed yet?\r\n                        // Or simply use timeScale width as a safe Right Anchor if we know we are 'active'\r\n                        const rightEdgeX = timeScale.timeToCoordinate(visibleRange.to as Time);\r\n                        validX2 = rightEdgeX !== null ? rightEdgeX : timeScale.width();\r\n                    } else {\r\n                        // Truly past\r\n                        validX2 = -100;\r\n                    }\r\n                }\r\n            }\r\n\r\n            // If both offscreen left, skip\r\n            if (validX1 === -100 && validX2 === -100) continue;\r\n\r\n            // Calculate Y coords\r\n            const yHigh = this._series.priceToCoordinate(session.high);\r\n            const yLow = this._series.priceToCoordinate(session.low);\r\n\r\n            if (yHigh === null || yLow === null) continue;\r\n\r\n            const sessionColor = this.getColorForSession(session.session_type, settings);\r\n            const boxColor = this.hexToRgba(sessionColor, settings.box_transparency || 0.1);\r\n\r\n            const width = validX2 - validX1;\r\n            const height = yLow - yHigh; // High price has lower Y value\r\n\r\n            // DRAW BOX\r\n            ctx.fillStyle = boxColor;\r\n            ctx.fillRect(validX1, yHigh, width, height);\r\n\r\n            // DRAW PIVOTS (Hi/Lo)\r\n            ctx.beginPath();\r\n            ctx.strokeStyle = sessionColor;\r\n            ctx.lineWidth = settings.linewidth || 1;\r\n\r\n            // High Pivot\r\n            const highMitigatedWait = settings.mitigation_enabled && session.mitigated_at_high;\r\n\r\n            // Base End: If mitigated, stop there. Else, go to 'Now' (comparisonTime).\r\n            let highEndTs = highMitigatedWait ? (session.mitigated_at_high! / 1000) : comparisonTime;\r\n\r\n            // Limit Rule: Stop at next session start if configured\r\n            highEndTs = Math.min(highEndTs, nextSessionStart);\r\n\r\n            // Global Clamp: Never draw past the 'Latest Candle' (comparisonTime)\r\n            let effectiveHighEnd = Math.min(highEndTs, comparisonTime);\r\n\r\n            // FIX: Ensure it doesn't go backwards\r\n            effectiveHighEnd = Math.max(effectiveHighEnd, timeS);\r\n\r\n            const xLineEndHigh = timeScale.timeToCoordinate(effectiveHighEnd as Time);\r\n            const safeXLineEndHigh = xLineEndHigh !== null ? xLineEndHigh : validX2; // Fallback to box end if line end is null\r\n\r\n            ctx.setLineDash(this.getLineDash(settings.high_line_style || 'Dashed'));\r\n            ctx.moveTo(validX1, yHigh);\r\n            // If safeXLineEndHigh < validX1, we might still draw backwards if coordinate mapping is weird.\r\n            // Force Math.max for coordinates too if needed, but time clamp should suffice.\r\n            const drawnXHigh = Math.max(validX1, safeXLineEndHigh);\r\n            ctx.lineTo(drawnXHigh, yHigh);\r\n            ctx.stroke();\r\n\r\n            // Low Pivot\r\n            const lowMitigatedWait = settings.mitigation_enabled && session.mitigated_at_low;\r\n\r\n            let lowEndTs = lowMitigatedWait ? (session.mitigated_at_low! / 1000) : comparisonTime;\r\n            lowEndTs = Math.min(lowEndTs, nextSessionStart);\r\n\r\n            let effectiveLowEnd = Math.min(lowEndTs, comparisonTime);\r\n            // FIX: Ensure it doesn't go backwards\r\n            effectiveLowEnd = Math.max(effectiveLowEnd, timeS);\r\n\r\n            const xLineEndLow = timeScale.timeToCoordinate(effectiveLowEnd as Time);\r\n            const safeXLineEndLow = xLineEndLow !== null ? xLineEndLow : validX2;\r\n\r\n            ctx.beginPath(); // New path for low\r\n            ctx.setLineDash(this.getLineDash(settings.low_line_style || 'Dashed'));\r\n            ctx.strokeStyle = sessionColor; // Reset stroke just in case\r\n            ctx.moveTo(validX1, yLow);\r\n            const drawnXLow = Math.max(validX1, safeXLineEndLow);\r\n            ctx.lineTo(drawnXLow, yLow);\r\n\r\n            ctx.stroke();\r\n\r\n            // DRAW LABELS\r\n            if (settings.show_labels) {\r\n                const text = session.session_type;\r\n\r\n                const lines = text.split(' ');\r\n\r\n                const margin = 10;\r\n                const safeWidth = Math.abs(width) - margin;\r\n                const safeHeight = Math.abs(height) - margin;\r\n\r\n                if (safeWidth > 10 && safeHeight > 5) {\r\n                    ctx.save();\r\n\r\n                    // Use paler color for text (35% opacity based on session color)\r\n                    ctx.fillStyle = this.hexToRgba(sessionColor, 0.35);\r\n\r\n                    // 1. Measure text at Reference Size\r\n                    const refSize = 20;\r\n                    ctx.font = `bold ${refSize}px Roboto`;\r\n\r\n                    // Measure widest line\r\n                    let maxTextW = 0;\r\n                    for (const line of lines) {\r\n                        const m = ctx.measureText(line);\r\n                        if (m.width > maxTextW) maxTextW = m.width;\r\n                    }\r\n\r\n                    // Calculate scale to fit width\r\n                    let scale = safeWidth / maxTextW;\r\n                    let fontSize = refSize * scale;\r\n\r\n                    // Check height constraint (total height of all lines)\r\n                    // line height approx 1.2 * fontSize\r\n                    const totalLineHeightVal = (fontSize * 1.2) * lines.length;\r\n\r\n                    if (totalLineHeightVal > safeHeight) {\r\n                        // fontSize * 1.2 * lines.length = safeHeight\r\n                        // fontSize = safeHeight / (1.2 * lines.length)\r\n                        fontSize = safeHeight / (1.2 * lines.length);\r\n                    }\r\n\r\n                    const MIN_FONT = 8;\r\n                    const MAX_FONT = 200;\r\n                    fontSize = Math.max(MIN_FONT, Math.min(MAX_FONT, fontSize));\r\n\r\n                    ctx.font = `bold ${fontSize}px Roboto`;\r\n                    ctx.textAlign = 'center';\r\n                    ctx.textBaseline = 'middle';\r\n\r\n                    const centerX = validX1 + width / 2;\r\n                    const centerY = yHigh + height / 2;\r\n                    const lineHeight = fontSize * 1.2;\r\n\r\n                    // Vertical centering offset\r\n                    // If we have N lines, total height is N * lineHeight.\r\n                    // Start Y = CenterY - TotalHeight/2 + LineHeight/2 (since baseline is middle)\r\n                    // Actually, if baseline is middle, the 'middle' of the block is at CenterY.\r\n                    // Line i (0-indexed) offset: (i - (N-1)/2) * lineHeight\r\n\r\n                    if (fontSize >= MIN_FONT) {\r\n                        for (let i = 0; i < lines.length; i++) {\r\n                            const lineOffset = (i - (lines.length - 1) / 2) * lineHeight;\r\n                            ctx.fillText(lines[i], centerX, centerY + lineOffset);\r\n                        }\r\n                    }\r\n\r\n                    ctx.restore();\r\n                }\r\n            }\r\n        }\r\n\r\n        ctx.restore();\r\n    }\r\n\r\n    private getColorForSession(type: string, settings: ICTSessionsSettings): string {\r\n        switch (type) {\r\n            case 'ASIA': return settings.asia_color;\r\n            case 'LONDON': return settings.london_color;\r\n            case 'NYAM': return settings.nyam_color;\r\n            case 'NYPM': return settings.nypm_color;\r\n            default: return '#cccccc';\r\n        }\r\n    }\r\n\r\n    private hexToRgba(hex: string, alpha: number): string {\r\n        // Simple hex to rgba\r\n        let r = 0, g = 0, b = 0;\r\n        if (hex.length === 4) {\r\n            r = parseInt(hex[1] + hex[1], 16);\r\n            g = parseInt(hex[2] + hex[2], 16);\r\n            b = parseInt(hex[3] + hex[3], 16);\r\n        } else if (hex.length === 7) {\r\n            r = parseInt(hex.substring(1, 3), 16);\r\n            g = parseInt(hex.substring(3, 5), 16);\r\n            b = parseInt(hex.substring(5, 7), 16);\r\n        } else if (hex.length === 9) {\r\n            // Hex8 #RRGGBBAA - Ignore alpha from hex, use override\r\n            r = parseInt(hex.substring(1, 3), 16);\r\n            g = parseInt(hex.substring(3, 5), 16);\r\n            b = parseInt(hex.substring(5, 7), 16);\r\n        }\r\n        return `rgba(${r},${g},${b},${alpha})`;\r\n    }\r\n}\r\n\r\n// Re-export Schema\r\nexport const ICTSessionsSchema = [\r\n    {\r\n        group: 'General', id: 'max_timeframe', type: 'select', title: 'Timeframe Limit', def: 'H1',\r\n        options: ['M1', 'M2', 'M3', 'M5', 'M10', 'M15', 'M30', 'H1', 'H2', 'H3', 'H4', 'H6', 'H8', 'H12', 'D1', 'W1', 'MN1']\r\n    },\r\n    { group: 'General', id: 'history_count', type: 'number', title: 'History Count (0=All)', def: 10 },\r\n    { group: 'Asia Session', id: 'show_asia', type: 'bool', title: 'Enable Asia', def: true },\r\n    { group: 'Asia Session', id: 'asia_range', type: 'time_range', title: 'Range (EST)', def: '2000-0000' },\r\n    { group: 'Asia Session', id: 'asia_color', type: 'color', title: 'Color', def: '#3b82f6' }, // Blue\r\n\r\n    { group: 'London Session', id: 'show_london', type: 'bool', title: 'Enable London', def: true },\r\n    { group: 'London Session', id: 'london_range', type: 'time_range', title: 'Range (EST)', def: '0300-0600' },\r\n    { group: 'London Session', id: 'london_color', type: 'color', title: 'Color', def: '#22c55e' }, // Green\r\n\r\n    { group: 'New York AM', id: 'show_nyam', type: 'bool', title: 'Enable NY AM', def: true },\r\n    { group: 'New York AM', id: 'nyam_range', type: 'time_range', title: 'Range (EST)', def: '0930-1100' },\r\n    { group: 'New York AM', id: 'nyam_color', type: 'color', title: 'Color', def: '#ef4444' }, // Red\r\n\r\n    { group: 'New York PM', id: 'show_nypm', type: 'bool', title: 'Enable NY PM', def: true },\r\n    { group: 'New York PM', id: 'nypm_range', type: 'time_range', title: 'Range (EST)', def: '1330-1600' },\r\n    { group: 'New York PM', id: 'nypm_color', type: 'color', title: 'Color', def: '#eab308' }, // Yellow\r\n\r\n    { group: 'Visuals', id: 'box_transparency', type: 'number', title: 'Transparency (0-1)', def: 0.15 },\r\n    { group: 'Visuals', id: 'linewidth', type: 'number', title: 'Line Width', def: 1 },\r\n    { group: 'Visuals', id: 'high_line_style', type: 'select', title: 'High Line Style', def: 'Dashed', options: ['Solid', 'Dashed', 'Dotted'] },\r\n    { group: 'Visuals', id: 'low_line_style', type: 'select', title: 'Low Line Style', def: 'Dashed', options: ['Solid', 'Dashed', 'Dotted'] },\r\n    { group: 'Visuals', id: 'show_labels', type: 'bool', title: 'Show Labels', def: true },\r\n    { group: 'Logic', id: 'mitigation_enabled', type: 'bool', title: 'Visualize Mitigation', def: true },\r\n    { group: 'Logic', id: 'limit_to_next_session', type: 'bool', title: 'Limit to Next Session', def: true },\r\n];\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 7123, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Michael/IdeaProjects/MSMTB/src/trading-cockpit/src/components/charts/plugins/ImbalancePlugin.ts"],"sourcesContent":["import { BaseWidget } from '../widgets/BaseWidget';\r\n\r\ninterface ImbalanceSettings {\r\n    bullishColor: string;\r\n    bearishColor: string;\r\n    showBullish: boolean;\r\n    showBearish: boolean;\r\n}\r\n\r\n/**\r\n * Data Transformer for Imbalance Indicator.\r\n * Instead of drawing on canvas (which overlays), we modify the candle data colors directly\r\n * to achieve true transparency effects on the candle body.\r\n */\r\nexport const applyImbalanceTransformation = (data: any[], settings: ImbalanceSettings): any[] => {\r\n    // Clone data to avoid mutating source\r\n    // We create a shallow copy of the array, but we must also handle item cloning if modify\r\n    const result = [...data];\r\n    if (result.length < 3) return result;\r\n\r\n    const { bullishColor, bearishColor, showBullish, showBearish } = settings;\r\n\r\n    // Iterate through data (excluding first and last to check neighbors)\r\n    // We check pattern: Prev -> Curr -> Next\r\n    // Imbalance is identified on the 'Curr' (middle) candle.\r\n    for (let i = 1; i < result.length - 1; i++) {\r\n        const prev = result[i - 1];\r\n        const curr = result[i];\r\n        const next = result[i + 1];\r\n\r\n        let isBullishImbalance = false;\r\n        let isBearishImbalance = false;\r\n\r\n        // Bullish Imbalance: Middle is Bullish (Close > Open)\r\n        // AND High of Prev < Low of Next\r\n        if (showBullish && curr.close > curr.open) {\r\n            if (prev.high < next.low) {\r\n                isBullishImbalance = true;\r\n            }\r\n        }\r\n\r\n        // Bearish Imbalance: Middle is Bearish (Close < Open)\r\n        // AND Low of Prev > High of Next\r\n        if (showBearish && curr.close < curr.open) {\r\n            if (prev.low > next.high) {\r\n                isBearishImbalance = true;\r\n            }\r\n        }\r\n\r\n        if (isBullishImbalance || isBearishImbalance) {\r\n            const color = isBullishImbalance ? bullishColor : bearishColor;\r\n\r\n            // Apply color overrides to the Middle Candle\r\n            // We create a new object for the modified candle to preserve immutability of the original data source\r\n            result[i] = {\r\n                ...curr,\r\n                color: color,          // Only override Body color\r\n                // wickColor: undefined, // Inherit from series\r\n                // borderColor: undefined // Inherit from series\r\n            };\r\n        }\r\n    }\r\n\r\n    return result;\r\n};\r\n\r\n// We keep the Plugin class for consistency with Registry and potential future use,\r\n// but it strictly does NO rendering now.\r\nexport class ImbalancePlugin extends BaseWidget<any> {\r\n    constructor(settings: any) {\r\n        super({ settings });\r\n    }\r\n\r\n    // No-op drawing\r\n    drawBody(ctx: CanvasRenderingContext2D): void { }\r\n\r\n    // Implement required methods\r\n    public updateGeometry(timeScale: any, series: any): void { }\r\n    public updateData(data: any[]): void { }\r\n    public updateCandle(candle: any): void { }\r\n    public updateSettings(settings: any): void { }\r\n\r\n    // Interaction methods\r\n    public hitTestBody(point: any): boolean { return false; }\r\n    public applyDrag(target: string, newPoint: any): void { }\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;;AAcO,MAAM,+BAA+B,CAAC,MAAa;IACtD,sCAAsC;IACtC,wFAAwF;IACxF,MAAM,SAAS;WAAI;KAAK;IACxB,IAAI,OAAO,MAAM,GAAG,GAAG,OAAO;IAE9B,MAAM,EAAE,YAAY,EAAE,YAAY,EAAE,WAAW,EAAE,WAAW,EAAE,GAAG;IAEjE,qEAAqE;IACrE,yCAAyC;IACzC,yDAAyD;IACzD,IAAK,IAAI,IAAI,GAAG,IAAI,OAAO,MAAM,GAAG,GAAG,IAAK;QACxC,MAAM,OAAO,MAAM,CAAC,IAAI,EAAE;QAC1B,MAAM,OAAO,MAAM,CAAC,EAAE;QACtB,MAAM,OAAO,MAAM,CAAC,IAAI,EAAE;QAE1B,IAAI,qBAAqB;QACzB,IAAI,qBAAqB;QAEzB,sDAAsD;QACtD,iCAAiC;QACjC,IAAI,eAAe,KAAK,KAAK,GAAG,KAAK,IAAI,EAAE;YACvC,IAAI,KAAK,IAAI,GAAG,KAAK,GAAG,EAAE;gBACtB,qBAAqB;YACzB;QACJ;QAEA,sDAAsD;QACtD,iCAAiC;QACjC,IAAI,eAAe,KAAK,KAAK,GAAG,KAAK,IAAI,EAAE;YACvC,IAAI,KAAK,GAAG,GAAG,KAAK,IAAI,EAAE;gBACtB,qBAAqB;YACzB;QACJ;QAEA,IAAI,sBAAsB,oBAAoB;YAC1C,MAAM,QAAQ,qBAAqB,eAAe;YAElD,6CAA6C;YAC7C,sGAAsG;YACtG,MAAM,CAAC,EAAE,GAAG;gBACR,GAAG,IAAI;gBACP,OAAO;YAGX;QACJ;IACJ;IAEA,OAAO;AACX;AAIO,MAAM,wBAAwB,qKAAU;IAC3C,YAAY,QAAa,CAAE;QACvB,KAAK,CAAC;YAAE;QAAS;IACrB;IAEA,gBAAgB;IAChB,SAAS,GAA6B,EAAQ,CAAE;IAEhD,6BAA6B;IACtB,eAAe,SAAc,EAAE,MAAW,EAAQ,CAAE;IACpD,WAAW,IAAW,EAAQ,CAAE;IAChC,aAAa,MAAW,EAAQ,CAAE;IAClC,eAAe,QAAa,EAAQ,CAAE;IAE7C,sBAAsB;IACf,YAAY,KAAU,EAAW;QAAE,OAAO;IAAO;IACjD,UAAU,MAAc,EAAE,QAAa,EAAQ,CAAE;AAC5D"}},
    {"offset": {"line": 7200, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Michael/IdeaProjects/MSMTB/src/trading-cockpit/src/components/charts/plugins/LevelsPlugin.ts"],"sourcesContent":["import { BaseWidget } from '../widgets/BaseWidget';\r\nimport { IChartApi, ISeriesApi, Time, Coordinate } from 'lightweight-charts';\r\nimport { Point } from '../widgets/types';\r\nimport { getTimeframeSeconds } from '../../../utils/chartUtils';\r\n\r\n// --- Interfaces ---\r\n\r\nexport interface LevelsSettings {\r\n    // Daily / Weekly / Monthly (DWM) - Uses Broker Time\r\n    show_d_open: boolean;\r\n    d_open_label: string;\r\n    d_open_color: string;\r\n    show_d_hl: boolean; // Pivots (Prev High/Low)\r\n    show_d_sep: boolean;\r\n    broker_timezone: string; // e.g. \"Europe/Athens\" or \"UTC\"\r\n\r\n    show_w_open: boolean;\r\n    w_open_label: string;\r\n    w_open_color: string;\r\n    show_w_hl: boolean;\r\n    show_w_sep: boolean;\r\n\r\n    show_m_open: boolean;\r\n    m_open_label: string;\r\n    m_open_color: string;\r\n    show_m_hl: boolean;\r\n    show_m_sep: boolean;\r\n\r\n    show_weekday_labels: boolean;\r\n\r\n    // Custom Opens (TDO - NY Midnight)\r\n    show_tdo: boolean;\r\n    tdo_color: string;\r\n\r\n    // Visuals\r\n    linewidth: number;\r\n    linestyle: 'Solid' | 'Dashed' | 'Dotted';\r\n    show_labels: boolean;\r\n}\r\n\r\ninterface LevelItem {\r\n    type: string;\r\n    price: number;\r\n    startTime: number;\r\n    endTime: number;\r\n    color: string;\r\n    label: string;\r\n    style: 'Solid' | 'Dashed' | 'Dotted';\r\n}\r\n\r\ninterface SeparatorItem {\r\n    time: number;\r\n    color: string;\r\n    type: 'D' | 'W' | 'M';\r\n    label?: string; // Weekday label\r\n}\r\n\r\nexport interface LevelsState {\r\n    settings: LevelsSettings;\r\n    levels: LevelItem[];\r\n    separators: SeparatorItem[];\r\n    data: any[];\r\n    timeframe?: string;\r\n    lastCandleTime?: number;\r\n}\r\n\r\nexport class LevelsPlugin extends BaseWidget<LevelsState> {\r\n\r\n    constructor(settings: LevelsSettings) {\r\n        super({ settings, levels: [], separators: [], data: [], timeframe: undefined });\r\n    }\r\n\r\n    public updateSettings(settings: LevelsSettings) {\r\n        this._data.settings = settings;\r\n        this.recalculateLevels();\r\n        this.requestUpdate();\r\n    }\r\n\r\n    public updateTimeframe(timeframe: string) {\r\n        if (this._data.timeframe !== timeframe) {\r\n            this._data.timeframe = timeframe;\r\n            // Recalculate if needed (often levels depend on lower timeframe data aggregation)\r\n            this.recalculateLevels();\r\n            this.requestUpdate();\r\n        }\r\n    }\r\n\r\n    public updateCurrentTime(time: number) {\r\n        this._data.lastCandleTime = time;\r\n        this.requestUpdate();\r\n    }\r\n\r\n    public updateData(data: any[]) {\r\n        this._data.data = data;\r\n        this.recalculateLevels();\r\n        this.requestUpdate();\r\n    }\r\n\r\n    // --- Calculation Logic ---\r\n\r\n    private recalculateLevels() {\r\n        const { data, settings } = this._data;\r\n        if (!data || data.length === 0) return;\r\n\r\n        // Reset\r\n        this._data.levels = [];\r\n        this._data.separators = [];\r\n\r\n        this.calculateSegments(data, settings);\r\n    }\r\n\r\n    private calculateSegments(data: any[], settings: LevelsSettings) {\r\n        if (!data.length) return;\r\n\r\n        const levels: LevelItem[] = [];\r\n        const separators: SeparatorItem[] = [];\r\n\r\n        // Active Lists for Auto-Closing\r\n        let activeDaily: LevelItem[] = [];\r\n        let activeWeekly: LevelItem[] = [];\r\n        let activeMonthly: LevelItem[] = [];\r\n\r\n        const brokerTz = settings.broker_timezone || 'UTC';\r\n        const tdoTz = 'America/New_York'; // HARDCODED as per requirement\r\n\r\n        // Opener State Latch (Index -> Last Day Key)\r\n        const openerState = new Map<number, string>();\r\n\r\n        // 1. Broker Format (for D/W/M)\r\n        const brokerFmt = new Intl.DateTimeFormat('en-US', {\r\n            timeZone: brokerTz,\r\n            year: 'numeric', month: '2-digit', day: '2-digit',\r\n            hour: '2-digit', minute: '2-digit', weekday: 'short', hour12: false\r\n        });\r\n\r\n        // 2. Reference Format (for Custom Opens)\r\n        // 2. Reference Format (for True Day Open - NY)\r\n        const tdoFmt = new Intl.DateTimeFormat('en-US', {\r\n            timeZone: tdoTz,\r\n            year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'short',\r\n            hour: '2-digit', minute: '2-digit', hour12: false\r\n        });\r\n\r\n        let currentDay: string | null = null;\r\n        let currentWeekday: string | null = null;\r\n        let currentWeek: string | null = null;\r\n        let currentMonth: string | null = null;\r\n\r\n        let dayStartIdx = 0;\r\n        let prevDayHigh = NaN, prevDayLow = NaN;\r\n        let prevDayHighTime = NaN, prevDayLowTime = NaN;\r\n\r\n        let weekStartIdx = 0;\r\n        let prevWeekHigh = NaN, prevWeekLow = NaN;\r\n        let prevWeekHighTime = NaN, prevWeekLowTime = NaN;\r\n\r\n        let monthStartIdx = 0;\r\n        let prevMonthHigh = NaN, prevMonthLow = NaN;\r\n        let prevMonthHighTime = NaN, prevMonthLowTime = NaN;\r\n\r\n        // Helpers for Level Creation\r\n        const addLevel = (list: LevelItem[], activeList: LevelItem[], item: LevelItem) => {\r\n            list.push(item);\r\n            activeList.push(item);\r\n        };\r\n\r\n        const closeLevels = (activeList: LevelItem[], time: number) => {\r\n            activeList.forEach(l => l.endTime = time);\r\n            activeList.length = 0; // Clear array\r\n        };\r\n\r\n        // We iterate through data\r\n        for (let i = 0; i < data.length; i++) {\r\n            const candle = data[i];\r\n            const d = new Date(candle.time * 1000);\r\n\r\n            // --- BROKER TIME LOGIC (D/W/M) ---\r\n            const brokerParts = brokerFmt.formatToParts(d);\r\n            const bp: any = {};\r\n            brokerParts.forEach(x => bp[x.type] = x.value);\r\n\r\n            const dayKey = `${bp.year}-${bp.month}-${bp.day}`;\r\n            const monthKey = `${bp.year}-${bp.month}`;\r\n\r\n            // DAY CHANGE\r\n            if (dayKey !== currentDay) {\r\n                // Check if we are transitioning from Sun -> Mon\r\n                const isSunToMon = currentWeekday === 'Sun' && bp.weekday === 'Mon';\r\n\r\n                if (!isSunToMon) {\r\n                    // 1. CLOSE Previous Day Levels\r\n                    if (currentDay !== null) {\r\n                        closeLevels(activeDaily, candle.time);\r\n\r\n                        // Determine Prev Pivot Stats: DAILY\r\n                        let dH = -Infinity, dL = Infinity;\r\n                        let dHT = NaN, dLT = NaN;\r\n                        const prevEnd = i - 1;\r\n                        for (let j = dayStartIdx; j <= prevEnd; j++) {\r\n                            const barHigh = data[j].high;\r\n                            const barLow = data[j].low;\r\n                            const barTime = data[j].time;\r\n\r\n                            if (barHigh > dH) {\r\n                                dH = barHigh;\r\n                                dHT = barTime;\r\n                            }\r\n                            if (barLow < dL) {\r\n                                dL = barLow;\r\n                                dLT = barTime;\r\n                            }\r\n                        }\r\n                        prevDayHigh = dH;\r\n                        prevDayLow = dL;\r\n                        prevDayHighTime = dHT;\r\n                        prevDayLowTime = dLT;\r\n                    }\r\n\r\n                } // End if !isSunToMon\r\n\r\n                currentDay = dayKey;\r\n                currentWeekday = bp.weekday;\r\n\r\n                if (!isSunToMon) {\r\n                    dayStartIdx = i;\r\n\r\n                    // Separator\r\n                    if (settings.show_d_sep) {\r\n                        separators.push({\r\n                            time: candle.time,\r\n                            color: settings.d_open_color,\r\n                            type: 'D',\r\n                            label: settings.show_weekday_labels ? bp.weekday : undefined\r\n                        });\r\n                    }\r\n\r\n                    // Daily Open\r\n                    if (settings.show_d_open) {\r\n                        addLevel(levels, activeDaily, {\r\n                            type: 'D_OPEN',\r\n                            price: candle.open,\r\n                            startTime: candle.time,\r\n                            endTime: Infinity,\r\n                            color: settings.d_open_color,\r\n                            label: settings.d_open_label,\r\n                            style: settings.linestyle\r\n                        });\r\n                    }\r\n\r\n                    // Pivots (D)\r\n                    if (settings.show_d_hl && !isNaN(prevDayHigh)) {\r\n                        addLevel(levels, activeDaily, { type: 'PDH', price: prevDayHigh, startTime: prevDayHighTime, endTime: Infinity, color: settings.d_open_color, label: 'PDH', style: settings.linestyle });\r\n                        addLevel(levels, activeDaily, { type: 'PDL', price: prevDayLow, startTime: prevDayLowTime, endTime: Infinity, color: settings.d_open_color, label: 'PDL', style: settings.linestyle });\r\n                    }\r\n                }\r\n\r\n                // WEEK CHANGE (Mon)\r\n                const isMonday = bp.weekday === 'Mon';\r\n                let isNewWeek = false;\r\n                if (currentWeek === null) isNewWeek = true;\r\n                else if (isMonday && dayKey !== currentWeek) isNewWeek = true;\r\n\r\n                if (isNewWeek) {\r\n                    // WEEK CLOSED\r\n                    if (currentWeek !== null) {\r\n                        closeLevels(activeWeekly, candle.time);\r\n\r\n                        let wH = -Infinity, wL = Infinity;\r\n                        let wHT = NaN, wLT = NaN;\r\n                        const prevEnd = i - 1;\r\n                        for (let j = weekStartIdx; j <= prevEnd; j++) {\r\n                            const barHigh = data[j].high;\r\n                            const barLow = data[j].low;\r\n                            const barTime = data[j].time;\r\n\r\n                            if (barHigh > wH) {\r\n                                wH = barHigh;\r\n                                wHT = barTime;\r\n                            }\r\n                            if (barLow < wL) {\r\n                                wL = barLow;\r\n                                wLT = barTime;\r\n                            }\r\n                        }\r\n                        prevWeekHigh = wH;\r\n                        prevWeekLow = wL;\r\n                        prevWeekHighTime = wHT;\r\n                        prevWeekLowTime = wLT;\r\n                    }\r\n\r\n                    currentWeek = dayKey;\r\n                    weekStartIdx = i;\r\n\r\n                    if (settings.show_w_sep) separators.push({ time: candle.time, color: settings.w_open_color, type: 'W' });\r\n\r\n                    if (settings.show_w_open) {\r\n                        addLevel(levels, activeWeekly, { type: 'W_OPEN', price: candle.open, startTime: candle.time, endTime: Infinity, color: settings.w_open_color, label: settings.w_open_label, style: settings.linestyle });\r\n                    }\r\n\r\n                    // Add WEEKLY PIVOTS\r\n                    if (settings.show_w_hl && !isNaN(prevWeekHigh)) {\r\n                        addLevel(levels, activeWeekly, { type: 'PWH', price: prevWeekHigh, startTime: prevWeekHighTime, endTime: Infinity, color: settings.w_open_color, label: 'PWH', style: settings.linestyle });\r\n                        addLevel(levels, activeWeekly, { type: 'PWL', price: prevWeekLow, startTime: prevWeekLowTime, endTime: Infinity, color: settings.w_open_color, label: 'PWL', style: settings.linestyle });\r\n                    }\r\n                }\r\n\r\n                // MONTH CHANGE\r\n                if (monthKey !== currentMonth) {\r\n                    // MONTH CLOSED\r\n                    if (currentMonth !== null) {\r\n                        closeLevels(activeMonthly, candle.time);\r\n\r\n                        let mH = -Infinity, mL = Infinity;\r\n                        let mHT = NaN, mLT = NaN;\r\n                        const prevEnd = i - 1;\r\n                        for (let j = monthStartIdx; j <= prevEnd; j++) {\r\n                            const barHigh = data[j].high;\r\n                            const barLow = data[j].low;\r\n                            const barTime = data[j].time;\r\n\r\n                            if (barHigh > mH) {\r\n                                mH = barHigh;\r\n                                mHT = barTime;\r\n                            }\r\n                            if (barLow < mL) {\r\n                                mL = barLow;\r\n                                mLT = barTime;\r\n                            }\r\n                        }\r\n                        prevMonthHigh = mH;\r\n                        prevMonthLow = mL;\r\n                        prevMonthHighTime = mHT;\r\n                        prevMonthLowTime = mLT;\r\n                    }\r\n\r\n                    currentMonth = monthKey;\r\n                    monthStartIdx = i;\r\n\r\n                    if (settings.show_m_sep) separators.push({ time: candle.time, color: settings.m_open_color, type: 'M' });\r\n\r\n                    if (settings.show_m_open) {\r\n                        addLevel(levels, activeMonthly, { type: 'M_OPEN', price: candle.open, startTime: candle.time, endTime: Infinity, color: settings.m_open_color, label: settings.m_open_label, style: settings.linestyle });\r\n                    }\r\n\r\n                    // Add MONTHLY PIVOTS\r\n                    if (settings.show_m_hl && !isNaN(prevMonthHigh)) {\r\n                        addLevel(levels, activeMonthly, { type: 'PMH', price: prevMonthHigh, startTime: prevMonthHighTime, endTime: Infinity, color: settings.m_open_color, label: 'PMH', style: settings.linestyle });\r\n                        addLevel(levels, activeMonthly, { type: 'PML', price: prevMonthLow, startTime: prevMonthLowTime, endTime: Infinity, color: settings.m_open_color, label: 'PML', style: settings.linestyle });\r\n                    }\r\n                }\r\n            }\r\n\r\n            // --- TDO LOGIC (New York 00:00) ---\r\n            const tdoParts = tdoFmt.formatToParts(d);\r\n            const tp: any = {};\r\n            tdoParts.forEach(x => tp[x.type] = x.value);\r\n            const tdoTimeStr = `${tp.hour}:${tp.minute}`;\r\n            const tdoDayKey = `${tp.year}-${tp.month}-${tp.day}`;\r\n\r\n            const openers = [\r\n                { en: settings.show_tdo, t: '00:00', l: 'True Day Open', c: settings.tdo_color },\r\n            ];\r\n\r\n            openers.forEach((opt, idx) => {\r\n                if (!opt.en) return;\r\n\r\n                // Exclude Sunday (NY Time) - Market Open (17:00) should not trigger TDO (00:00)\r\n                // This prevents \"Ghost TDO\" at chart start\r\n                if (tp.weekday === 'Sun') return;\r\n\r\n                // Latch Check\r\n                const lastDay = openerState.get(idx);\r\n                if (lastDay === tdoDayKey) return;\r\n\r\n                // Time Check (First candle >= target)\r\n                if (tdoTimeStr >= opt.t) {\r\n                    addLevel(levels, activeDaily, {\r\n                        type: 'CUSTOM_OPEN',\r\n                        price: candle.open,\r\n                        startTime: candle.time,\r\n                        endTime: Infinity,\r\n                        color: opt.c,\r\n                        label: opt.l,\r\n                        style: 'Dotted'\r\n                    });\r\n                    openerState.set(idx, tdoDayKey);\r\n                }\r\n            });\r\n        }\r\n\r\n        this._data.levels = levels;\r\n        this._data.separators = separators;\r\n    }\r\n\r\n    // --- Drawing ---\r\n\r\n    drawBody(ctx: CanvasRenderingContext2D): void {\r\n        const { levels, separators, settings, lastCandleTime } = this._data;\r\n        if (!this._chart || !this._series) return;\r\n\r\n        const timeScale = this._chart.timeScale();\r\n        const visibleRange = timeScale.getVisibleRange();\r\n        if (!visibleRange) return;\r\n\r\n        const rightEdgeTime = lastCandleTime || (Date.now() / 1000);\r\n\r\n        ctx.save();\r\n\r\n        // Draw Separators\r\n        separators.forEach(sep => {\r\n            const x = timeScale.timeToCoordinate(sep.time as Time);\r\n            if (x === null) return;\r\n\r\n            ctx.beginPath();\r\n            ctx.strokeStyle = sep.color;\r\n            ctx.lineWidth = 1;\r\n            ctx.setLineDash([2, 4]);\r\n            ctx.moveTo(x as number, 0);\r\n            ctx.lineTo(x as number, ctx.canvas.height);\r\n            ctx.stroke();\r\n\r\n            // Draw Weekday Label\r\n            if (sep.label) {\r\n                ctx.fillStyle = sep.color; // or generic gray?\r\n                ctx.font = '10px Roboto';\r\n                ctx.textAlign = 'center';\r\n                ctx.globalAlpha = 0.6;\r\n                ctx.fillText(sep.label, x as number, ctx.canvas.height - 10);\r\n                ctx.globalAlpha = 1.0;\r\n                ctx.textAlign = 'left';\r\n            }\r\n        });\r\n\r\n        // Draw Levels\r\n        levels.forEach(lvl => {\r\n            const x1 = timeScale.timeToCoordinate(lvl.startTime as Time);\r\n            const end = (lvl.endTime === Infinity) ? rightEdgeTime : lvl.endTime;\r\n            const x2 = timeScale.timeToCoordinate(end as Time);\r\n\r\n            const y = this._series!.priceToCoordinate(lvl.price);\r\n            if (y === null) return;\r\n\r\n            let drawX1 = x1;\r\n            let drawX2 = x2;\r\n\r\n            if (drawX1 === null) {\r\n                if (lvl.startTime < (visibleRange.from as number)) drawX1 = -10 as Coordinate;\r\n                else return;\r\n            }\r\n            if (drawX2 === null) {\r\n                if (end >= (visibleRange.to as number)) drawX2 = this._chart!.timeScale().width() as Coordinate;\r\n                else return;\r\n            }\r\n\r\n            ctx.beginPath();\r\n            ctx.strokeStyle = lvl.color;\r\n            ctx.lineWidth = settings.linewidth;\r\n            if (lvl.style === 'Dashed') ctx.setLineDash([5, 5]);\r\n            else if (lvl.style === 'Dotted') ctx.setLineDash([2, 2]);\r\n            else ctx.setLineDash([]);\r\n\r\n            ctx.moveTo(drawX1 as number, y);\r\n            ctx.lineTo(drawX2 as number, y);\r\n            ctx.stroke();\r\n\r\n            if (settings.show_labels && lvl.label) {\r\n                ctx.fillStyle = lvl.color;\r\n                ctx.font = '10px Roboto';\r\n                ctx.textAlign = 'right';\r\n                // Always draw label at the end of the line (Right Side)\r\n                ctx.fillText(lvl.label, (drawX2 as number), y - 6);\r\n                ctx.textAlign = 'left'; // reset\r\n            }\r\n        });\r\n\r\n        ctx.restore();\r\n    }\r\n\r\n    // --- Hit Test ---\r\n    protected hitTestBody(point: any): boolean { return false; }\r\n    protected applyDrag(target: string, newPoint: Point): void { }\r\n    public updateGeometry(timeScale: any, series: any): void { }\r\n}\r\n\r\n// --- Schema ---\r\nexport const LevelsSchema = [\r\n    { group: 'Settings', id: 'broker_timezone', type: 'text', title: 'Broker Timezone', def: 'Europe/Berlin' },\r\n\r\n    { group: 'Daily', id: 'show_d_open', type: 'bool', title: 'Show Daily Open', def: true },\r\n    { group: 'Daily', id: 'd_open_color', type: 'color', title: 'Daily Color', def: '#3b82f6' },\r\n    { group: 'Daily', id: 'd_open_label', type: 'text', title: 'Label', def: 'D Open' },\r\n    { group: 'Daily', id: 'show_d_hl', type: 'bool', title: 'Show Prev D High/Low', def: true },\r\n    { group: 'Daily', id: 'show_d_sep', type: 'bool', title: 'Show Separators', def: true },\r\n    { group: 'Daily', id: 'show_weekday_labels', type: 'bool', title: 'Show Weekdays', def: true },\r\n\r\n    { group: 'Weekly', id: 'show_w_open', type: 'bool', title: 'Show Weekly Open', def: false },\r\n    { group: 'Weekly', id: 'w_open_color', type: 'color', title: 'Weekly Color', def: '#10b981' },\r\n    { group: 'Weekly', id: 'w_open_label', type: 'text', title: 'Label', def: 'W Open' },\r\n    { group: 'Weekly', id: 'show_w_hl', type: 'bool', title: 'Show Prev W High/Low', def: false },\r\n    { group: 'Weekly', id: 'show_w_sep', type: 'bool', title: 'Show Separators', def: false },\r\n\r\n    { group: 'Monthly', id: 'show_m_open', type: 'bool', title: 'Show Monthly Open', def: false },\r\n    { group: 'Monthly', id: 'm_open_color', type: 'color', title: 'Monthly Color', def: '#ef4444' },\r\n    { group: 'Monthly', id: 'm_open_label', type: 'text', title: 'Label', def: 'M Open' },\r\n    { group: 'Monthly', id: 'show_m_hl', type: 'bool', title: 'Show Prev M High/Low', def: false },\r\n    { group: 'Monthly', id: 'show_m_sep', type: 'bool', title: 'Show Separators', def: false },\r\n\r\n    // Custom\r\n    { group: 'True Day Open', id: 'show_tdo', type: 'bool', title: 'Show True Day Open', def: true },\r\n    { group: 'True Day Open', id: 'tdo_color', type: 'color', title: 'Color', def: '#808080' },\r\n\r\n    { group: 'Visuals', id: 'linewidth', type: 'number', title: 'Line Width', def: 1 },\r\n    { group: 'Visuals', id: 'linestyle', type: 'select', title: 'Style', def: 'Dashed', options: ['Solid', 'Dashed', 'Dotted'] },\r\n    { group: 'Visuals', id: 'show_labels', type: 'bool', title: 'Show Labels', def: true },\r\n];\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 7824, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Michael/IdeaProjects/MSMTB/src/trading-cockpit/src/components/charts/indicators/index.ts"],"sourcesContent":["import { indicatorRegistry } from './IndicatorRegistry';\r\nimport { ICTSessionsPlugin, ICTSessionsSchema } from '../plugins/ICTSessionsPlugin';\r\nimport { ImbalancePlugin, applyImbalanceTransformation } from '../plugins/ImbalancePlugin';\r\nimport { LevelsPlugin, LevelsSchema } from '../plugins/LevelsPlugin';\r\n\r\n// Register Default Indicators\r\nexport const registerIndicators = () => {\r\n    indicatorRegistry.register({\r\n        id: 'ict_sessions',\r\n        name: 'Sessions & Pivots',\r\n        description: 'Visualizes Asia, London, and NY sessions with dynamic pivot mitigation.',\r\n        defaultSettings: ICTSessionsSchema.reduce((acc: any, item: any) => {\r\n            acc[item.id] = item.def;\r\n            return acc;\r\n        }, {}),\r\n        pluginFactory: (settings) => new ICTSessionsPlugin(settings),\r\n        settingsSchema: ICTSessionsSchema,\r\n        dataFetcher: async ({ symbol, timeframe, from, to, settings }) => {\r\n            // Transform Flat Settings to Engine Config\r\n            const engineSettings = {\r\n                mitigation_enabled: settings.mitigation_enabled,\r\n                sessions: [\r\n                    { type: 'ASIA', enabled: settings.show_asia, range: settings.asia_range, color: settings.asia_color },\r\n                    { type: 'LONDON', enabled: settings.show_london, range: settings.london_range, color: settings.london_color },\r\n                    { type: 'NYAM', enabled: settings.show_nyam, range: settings.nyam_range, color: settings.nyam_color },\r\n                    { type: 'NYPM', enabled: settings.show_nypm, range: settings.nypm_range, color: settings.nypm_color }\r\n                ]\r\n            };\r\n\r\n            const params = new URLSearchParams({\r\n                symbol,\r\n                timeframe,\r\n                from: from.toString(),\r\n                to: to.toString(),\r\n                settings: JSON.stringify(engineSettings)\r\n            });\r\n            const res = await fetch(`http://localhost:3005/indicators/ict-sessions?${params.toString()}`);\r\n            const data = await res.json();\r\n            return data.sessions || [];\r\n        }\r\n    });\r\n\r\n    // Register Imbalance Indicator (Client-Side)\r\n    indicatorRegistry.register({\r\n        id: 'imbalance',\r\n        name: 'Imbalances',\r\n        description: 'Highlights bullish and bearish Fair Value Gaps (Imbalance) by coloring the middle candle body.',\r\n        defaultSettings: {\r\n            bullishColor: '#00BFFF', // Deep Sky Blue\r\n            bearishColor: '#FF8C00', // Dark Orange\r\n            showBullish: true,\r\n            showBearish: true\r\n        },\r\n        pluginFactory: (settings) => new ImbalancePlugin(settings),\r\n        settingsSchema: [\r\n            { group: 'Bullish Imbalance', id: 'showBullish', type: 'bool', title: 'Show Bullish', def: true },\r\n            { group: 'Bullish Imbalance', id: 'bullishColor', type: 'color', title: 'Color', def: '#00BFFF' },\r\n            { group: 'Bearish Imbalance', id: 'showBearish', type: 'bool', title: 'Show Bearish', def: true },\r\n            { group: 'Bearish Imbalance', id: 'bearishColor', type: 'color', title: 'Color', def: '#FF8C00' }\r\n        ],\r\n        dataTransformer: (data, settings) => new ImbalancePlugin(settings).constructor['prototype'] ?\r\n            (require('../plugins/ImbalancePlugin').applyImbalanceTransformation(data, settings)) : data\r\n        // Note: Direct import is cleaner. 'pluginFactory' uses class, 'dataTransformer' uses function.\r\n        // We need to import 'applyImbalanceTransformation' at top level.\r\n    });\r\n\r\n    // Register Levels Indicator (Ported logic)\r\n    indicatorRegistry.register({\r\n        id: 'levels',\r\n        name: 'Levels',\r\n        description: 'Displays Daily, Weekly, Monthly logic and Custom Opening Prices.',\r\n        defaultSettings: LevelsSchema.reduce((acc: any, item: any) => {\r\n            acc[item.id] = item.def;\r\n            return acc;\r\n        }, {}),\r\n        pluginFactory: (settings) => new LevelsPlugin(settings),\r\n        settingsSchema: LevelsSchema,\r\n        // No data fetcher needed, uses client data via updateData\r\n    });\r\n\r\n    console.log(\"[IndicatorRegistry] Registered default indicators.\");\r\n};\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;AAGO,MAAM,qBAAqB;IAC9B,sLAAiB,CAAC,QAAQ,CAAC;QACvB,IAAI;QACJ,MAAM;QACN,aAAa;QACb,iBAAiB,mLAAiB,CAAC,MAAM,CAAC,CAAC,KAAU;YACjD,GAAG,CAAC,KAAK,EAAE,CAAC,GAAG,KAAK,GAAG;YACvB,OAAO;QACX,GAAG,CAAC;QACJ,eAAe,CAAC,WAAa,IAAI,mLAAiB,CAAC;QACnD,gBAAgB,mLAAiB;QACjC,aAAa,OAAO,EAAE,MAAM,EAAE,SAAS,EAAE,IAAI,EAAE,EAAE,EAAE,QAAQ,EAAE;YACzD,2CAA2C;YAC3C,MAAM,iBAAiB;gBACnB,oBAAoB,SAAS,kBAAkB;gBAC/C,UAAU;oBACN;wBAAE,MAAM;wBAAQ,SAAS,SAAS,SAAS;wBAAE,OAAO,SAAS,UAAU;wBAAE,OAAO,SAAS,UAAU;oBAAC;oBACpG;wBAAE,MAAM;wBAAU,SAAS,SAAS,WAAW;wBAAE,OAAO,SAAS,YAAY;wBAAE,OAAO,SAAS,YAAY;oBAAC;oBAC5G;wBAAE,MAAM;wBAAQ,SAAS,SAAS,SAAS;wBAAE,OAAO,SAAS,UAAU;wBAAE,OAAO,SAAS,UAAU;oBAAC;oBACpG;wBAAE,MAAM;wBAAQ,SAAS,SAAS,SAAS;wBAAE,OAAO,SAAS,UAAU;wBAAE,OAAO,SAAS,UAAU;oBAAC;iBACvG;YACL;YAEA,MAAM,SAAS,IAAI,gBAAgB;gBAC/B;gBACA;gBACA,MAAM,KAAK,QAAQ;gBACnB,IAAI,GAAG,QAAQ;gBACf,UAAU,KAAK,SAAS,CAAC;YAC7B;YACA,MAAM,MAAM,MAAM,MAAM,CAAC,8CAA8C,EAAE,OAAO,QAAQ,IAAI;YAC5F,MAAM,OAAO,MAAM,IAAI,IAAI;YAC3B,OAAO,KAAK,QAAQ,IAAI,EAAE;QAC9B;IACJ;IAEA,6CAA6C;IAC7C,sLAAiB,CAAC,QAAQ,CAAC;QACvB,IAAI;QACJ,MAAM;QACN,aAAa;QACb,iBAAiB;YACb,cAAc;YACd,cAAc;YACd,aAAa;YACb,aAAa;QACjB;QACA,eAAe,CAAC,WAAa,IAAI,+KAAe,CAAC;QACjD,gBAAgB;YACZ;gBAAE,OAAO;gBAAqB,IAAI;gBAAe,MAAM;gBAAQ,OAAO;gBAAgB,KAAK;YAAK;YAChG;gBAAE,OAAO;gBAAqB,IAAI;gBAAgB,MAAM;gBAAS,OAAO;gBAAS,KAAK;YAAU;YAChG;gBAAE,OAAO;gBAAqB,IAAI;gBAAe,MAAM;gBAAQ,OAAO;gBAAgB,KAAK;YAAK;YAChG;gBAAE,OAAO;gBAAqB,IAAI;gBAAgB,MAAM;gBAAS,OAAO;gBAAS,KAAK;YAAU;SACnG;QACD,iBAAiB,CAAC,MAAM,WAAa,IAAI,+KAAe,CAAC,UAAU,WAAW,CAAC,YAAY,GACtF,gHAAsC,4BAA4B,CAAC,MAAM,YAAa;IAG/F;IAEA,2CAA2C;IAC3C,sLAAiB,CAAC,QAAQ,CAAC;QACvB,IAAI;QACJ,MAAM;QACN,aAAa;QACb,iBAAiB,yKAAY,CAAC,MAAM,CAAC,CAAC,KAAU;YAC5C,GAAG,CAAC,KAAK,EAAE,CAAC,GAAG,KAAK,GAAG;YACvB,OAAO;QACX,GAAG,CAAC;QACJ,eAAe,CAAC,WAAa,IAAI,yKAAY,CAAC;QAC9C,gBAAgB,yKAAY;IAEhC;IAEA,QAAQ,GAAG,CAAC;AAChB"}},
    {"offset": {"line": 7955, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Michael/IdeaProjects/MSMTB/src/trading-cockpit/src/components/charts/settings/IndicatorSettingsDialog.tsx"],"sourcesContent":["import React, { useState, useEffect, useRef } from 'react';\r\nimport { createPortal } from 'react-dom';\r\nimport { ColorPalettePicker } from '../../ui/ColorPalettePicker';\r\nimport { usePopoverPosition } from '../../../hooks/ui/usePopoverPosition';\r\n\r\nexport interface SettingItem {\r\n    id: string;\r\n    type: 'bool' | 'string' | 'number' | 'color' | 'session' | 'select' | 'time_range';\r\n    title: string;\r\n    def?: any;\r\n    options?: string[]; // For select\r\n    group?: string;\r\n    tooltip?: string;\r\n}\r\n\r\ninterface IndicatorSettingsDialogProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n    onSave: (settings: any) => void;\r\n    definition: {\r\n        name: string;\r\n        settingsSchema: SettingItem[];\r\n    };\r\n    currentSettings: any;\r\n}\r\n\r\nexport const IndicatorSettingsDialog: React.FC<IndicatorSettingsDialogProps> = ({\r\n    isOpen, onClose, onSave, definition, currentSettings\r\n}) => {\r\n    const [settings, setSettings] = useState(currentSettings);\r\n\r\n    // Track previous open state to only reset on OPEN event, not on prop updates while open\r\n    const prevOpenRef = React.useRef(isOpen);\r\n\r\n    useEffect(() => {\r\n        // Did we just open?\r\n        if (isOpen && !prevOpenRef.current) {\r\n            setSettings({\r\n                ...definition.settingsSchema.reduce((acc: any, item: any) => {\r\n                    acc[item.id] = item.def;\r\n                    return acc;\r\n                }, {}), ...currentSettings\r\n            });\r\n        }\r\n        prevOpenRef.current = isOpen;\r\n    }, [isOpen, currentSettings, definition]);\r\n\r\n    const handleChange = (id: string, value: any) => {\r\n        setSettings((prev: any) => ({ ...prev, [id]: value }));\r\n    };\r\n\r\n    if (!isOpen) return null;\r\n\r\n    // Group items\r\n    const groups: { [key: string]: SettingItem[] } = {};\r\n    const ungrouped: SettingItem[] = [];\r\n\r\n    definition.settingsSchema.forEach(item => {\r\n        if (item.group) {\r\n            if (!groups[item.group]) groups[item.group] = [];\r\n            groups[item.group].push(item);\r\n        } else {\r\n            ungrouped.push(item);\r\n        }\r\n    });\r\n\r\n    const renderInput = (item: SettingItem) => {\r\n        const val = settings[item.id];\r\n\r\n        switch (item.type) {\r\n            case 'bool':\r\n                return (\r\n                    <input\r\n                        type=\"checkbox\"\r\n                        checked={!!val}\r\n                        onChange={(e) => handleChange(item.id, e.target.checked)}\r\n                        className=\"w-4 h-4 rounded border-slate-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-blue-500 focus:ring-blue-500 focus:ring-offset-white dark:focus:ring-offset-gray-900\"\r\n                    />\r\n                );\r\n            case 'color':\r\n                return (\r\n                    <ColorInput\r\n                        value={val}\r\n                        onChange={(v) => handleChange(item.id, v)}\r\n                    />\r\n                );\r\n            case 'select':\r\n                return (\r\n                    <select\r\n                        value={val || ''}\r\n                        onChange={(e) => handleChange(item.id, e.target.value)}\r\n                        className=\"bg-white dark:bg-gray-700 border border-slate-300 dark:border-gray-600 rounded px-2 py-1 text-sm text-slate-900 dark:text-gray-200 focus:outline-none focus:border-blue-500\"\r\n                    >\r\n                        {item.options?.map(opt => (\r\n                            <option key={opt} value={opt}>{opt}</option>\r\n                        ))}\r\n                    </select>\r\n                );\r\n            case 'time_range':\r\n                return (\r\n                    <TimeRangePicker\r\n                        value={val || '0930-1600'}\r\n                        onChange={(newVal) => handleChange(item.id, newVal)}\r\n                    />\r\n                );\r\n            default:\r\n                return (\r\n                    <input\r\n                        type={item.type === 'number' ? 'number' : 'text'}\r\n                        value={val || ''}\r\n                        onChange={(e) => handleChange(item.id, item.type === 'number' ? parseFloat(e.target.value) : e.target.value)}\r\n                        className=\"bg-white dark:bg-gray-700 border border-slate-300 dark:border-gray-600 rounded px-2 py-1 text-sm text-slate-900 dark:text-gray-200 focus:outline-none focus:border-blue-500 w-full\"\r\n                    />\r\n                );\r\n        }\r\n    };\r\n\r\n    const renderItem = (item: SettingItem) => (\r\n        <div key={item.id} className=\"flex items-center justify-between py-2 border-b border-slate-200 dark:border-gray-800 last:border-0 hover:bg-slate-50 dark:hover:bg-gray-800/50 px-2 rounded-sm transition-colors\">\r\n            <div className=\"flex flex-col\">\r\n                <span className=\"text-sm text-slate-700 dark:text-gray-300\">{item.title}</span>\r\n                {item.tooltip && <span className=\"text-[10px] text-slate-400 dark:text-gray-500\">{item.tooltip}</span>}\r\n            </div>\r\n            <div className=\"ml-4 w-1/2 flex justify-end\">\r\n                {renderInput(item)}\r\n            </div>\r\n        </div>\r\n    );\r\n\r\n    const content = (\r\n        <div className=\"fixed inset-0 z-[9999] flex items-center justify-center bg-slate-950/50 dark:bg-black/50 backdrop-blur-sm\" onClick={onClose}>\r\n            <div className=\"bg-white dark:bg-[#1e222d] border border-slate-300 dark:border-gray-700 rounded-lg shadow-xl w-[400px] max-h-[85vh] flex flex-col\" onClick={e => e.stopPropagation()}>\r\n                {/* Header */}\r\n                <div className=\"px-4 py-3 border-b border-slate-200 dark:border-gray-700 flex justify-between items-center bg-slate-50 dark:bg-[#2a2e39] rounded-t-lg\">\r\n                    <h3 className=\"text-sm font-semibold text-slate-900 dark:text-gray-200\">{definition.name} Settings</h3>\r\n                    <button onClick={onClose} className=\"text-slate-400 dark:text-gray-400 hover:text-slate-900 dark:hover:text-white transition-colors\">\r\n                        <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\"><path d=\"M18 6L6 18M6 6l12 12\" /></svg>\r\n                    </button>\r\n                </div>\r\n\r\n                {/* Content */}\r\n                <div className=\"flex-1 overflow-y-auto p-4 custom-scrollbar\">\r\n                    {/* Groups */}\r\n                    {Object.keys(groups).map(groupName => (\r\n                        <div key={groupName} className=\"mb-6\">\r\n                            <h4 className=\"text-xs font-bold text-blue-500 dark:text-blue-400 uppercase tracking-wider mb-2 pb-1 border-b border-slate-200 dark:border-gray-700/50\">{groupName}</h4>\r\n                            <div className=\"space-y-0.5\">\r\n                                {groups[groupName].map(renderItem)}\r\n                            </div>\r\n                        </div>\r\n                    ))}\r\n\r\n                    {/* Ungrouped */}\r\n                    {ungrouped.length > 0 && (\r\n                        <div className=\"mb-4 space-y-0.5\">\r\n                            {ungrouped.map(renderItem)}\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                {/* Footer */}\r\n                <div className=\"p-4 border-t border-slate-200 dark:border-gray-700 bg-slate-50 dark:bg-[#2a2e39] rounded-b-lg flex justify-end gap-2\">\r\n                    <button onClick={onClose} className=\"px-3 py-1.5 text-sm text-slate-600 dark:text-gray-300 hover:bg-slate-200 dark:hover:bg-gray-700 rounded transition-colors\">Cancel</button>\r\n                    <button onClick={() => onSave(settings)} className=\"px-3 py-1.5 text-sm bg-blue-600 text-white rounded hover:bg-blue-500 transition-colors font-medium shadow-sm\">Save Changes</button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n\r\n    // Render via Portal to body to escape Z-Index stacking contexts of ChartPane/Splitter\r\n    // Ensure document is defined (client-side only check is handled by next.js normally, but safe guard)\r\n    if (typeof document === 'undefined') return null;\r\n\r\n    return createPortal(content, document.body);\r\n};\r\n\r\n\r\n// --- Time Picker Components (Moved Outside and Improved) ---\r\n\r\nconst TimeRangePicker: React.FC<{ value: string, onChange: (val: string) => void }> = ({ value, onChange }) => {\r\n    // Parse \"HHmm-HHmm\" -> [\"HH:mm\", \"HH:mm\"]\r\n    const parse = (v: string) => {\r\n        if (!v || !v.includes('-')) return { start: '09:30', end: '16:00' };\r\n        const [s, e] = v.split('-');\r\n        const fmt = (t: string) => (t.length === 4 ? `${t.substring(0, 2)}:${t.substring(2, 4)}` : t);\r\n        return { start: fmt(s), end: fmt(e) };\r\n    };\r\n\r\n    const [times, setTimes] = useState(parse(value));\r\n\r\n    // Sync with external value changes ONLY if meaningful difference\r\n    useEffect(() => {\r\n        const current = parse(value);\r\n        setTimes(prev => {\r\n            if (prev.start !== current.start || prev.end !== current.end) {\r\n                return current;\r\n            }\r\n            return prev;\r\n        });\r\n    }, [value]);\r\n\r\n    const update = (type: 'start' | 'end', newVal: string) => {\r\n        const newTimes = { ...times, [type]: newVal };\r\n        setTimes(newTimes);\r\n\r\n        // Convert \"HH:mm\" -> \"HHmm\"\r\n        const clean = (t: string) => t.replace(':', '').padStart(4, '0');\r\n        onChange(`${clean(newTimes.start)}-${clean(newTimes.end)}`);\r\n    };\r\n\r\n    return (\r\n        <div className=\"flex items-center gap-2\">\r\n            <TimeInput value={times.start} onChange={(v) => update('start', v)} />\r\n            <span className=\"text-slate-500 dark:text-gray-500\">-</span>\r\n            <TimeInput value={times.end} onChange={(v) => update('end', v)} />\r\n        </div>\r\n    );\r\n};\r\n\r\nconst TimeInput: React.FC<{ value: string, onChange: (val: string) => void }> = ({ value, onChange }) => {\r\n    const [showDropdown, setShowDropdown] = useState(false);\r\n    const containerRef = React.useRef<HTMLDivElement>(null);\r\n\r\n    // Split value into HH and MM for local consumption\r\n    // Maintain local state to allow 'incomplete' typing before commit\r\n    const parse = (v: string) => {\r\n        const p = (v || '00:00').split(':');\r\n        return { hh: p[0] || '00', mm: p[1] || '00' };\r\n    };\r\n\r\n    const [local, setLocal] = useState(parse(value));\r\n\r\n    // Sync local state when external value changes\r\n    useEffect(() => {\r\n        setLocal(parse(value));\r\n    }, [value]);\r\n\r\n    const commit = () => {\r\n        let hn = parseInt(local.hh) || 0;\r\n        let mn = parseInt(local.mm) || 0;\r\n        hn = Math.min(23, Math.max(0, hn));\r\n        mn = Math.min(59, Math.max(0, mn));\r\n\r\n        const fmt = (n: number) => n.toString().padStart(2, '0');\r\n        const formatted = `${fmt(hn)}:${fmt(mn)}`;\r\n\r\n        onChange(formatted);\r\n        // Force local update to formatted version\r\n        setLocal({ hh: fmt(hn), mm: fmt(mn) });\r\n    };\r\n\r\n    const handleBlur = () => {\r\n        commit();\r\n    };\r\n\r\n    const handleInput = (type: 'hh' | 'mm', val: string) => {\r\n        const num = val.replace(/[^0-9]/g, '');\r\n        if (num.length > 2) return;\r\n        setLocal(prev => ({ ...prev, [type]: num }));\r\n    };\r\n\r\n    const handleKeyDown = (e: React.KeyboardEvent) => {\r\n        if (e.key === 'Enter') {\r\n            setShowDropdown(false);\r\n            commit();\r\n            (e.target as HTMLInputElement).blur();\r\n        }\r\n    };\r\n\r\n    // Close on click outside\r\n    useEffect(() => {\r\n        const handleClick = (e: MouseEvent) => {\r\n            if (containerRef.current && !containerRef.current.contains(e.target as Node)) {\r\n                setShowDropdown(false);\r\n            }\r\n        };\r\n        document.addEventListener('mousedown', handleClick);\r\n        return () => document.removeEventListener('mousedown', handleClick);\r\n    }, []);\r\n\r\n    // Generate 15m intervals\r\n    const times = [];\r\n    for (let h = 0; h < 24; h++) {\r\n        for (let m = 0; m < 60; m += 15) {\r\n            times.push(`${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`);\r\n        }\r\n    }\r\n\r\n    return (\r\n        <div className=\"relative w-20 bg-white dark:bg-gray-700 border border-slate-300 dark:border-gray-600 rounded flex items-center px-1\" ref={containerRef}>\r\n            <input\r\n                type=\"text\"\r\n                value={local.hh}\r\n                onChange={(e) => handleInput('hh', e.target.value)}\r\n                onBlur={handleBlur}\r\n                onFocus={() => setShowDropdown(true)}\r\n                onKeyDown={handleKeyDown}\r\n                maxLength={2}\r\n                className=\"w-7 bg-transparent text-center text-sm text-slate-900 dark:text-gray-200 focus:outline-none placeholder-slate-400 dark:placeholder-gray-500\"\r\n            />\r\n            <span className=\"text-slate-400 dark:text-gray-400 select-none\">:</span>\r\n            <input\r\n                type=\"text\"\r\n                value={local.mm}\r\n                onChange={(e) => handleInput('mm', e.target.value)}\r\n                onBlur={handleBlur}\r\n                onFocus={() => setShowDropdown(true)}\r\n                onKeyDown={handleKeyDown}\r\n                maxLength={2}\r\n                className=\"w-7 bg-transparent text-center text-sm text-slate-900 dark:text-gray-200 focus:outline-none\"\r\n            />\r\n\r\n            {showDropdown && (\r\n                <div className=\"absolute top-full left-0 mt-1 w-24 -ml-2 max-h-48 overflow-y-auto bg-white dark:bg-[#1e222d] border border-slate-300 dark:border-gray-600 rounded shadow-xl z-[99999] custom-scrollbar\">\r\n                    {times.map(t => (\r\n                        <div\r\n                            key={t}\r\n                            className={`px-2 py-1 text-xs cursor-pointer hover:bg-blue-600 hover:text-white ${t === value ? 'bg-blue-600/20 text-blue-600 dark:text-blue-400' : 'text-slate-700 dark:text-gray-300'}`}\r\n                            onMouseDown={(e) => {\r\n                                e.preventDefault();\r\n                                onChange(t);\r\n                                setShowDropdown(false);\r\n                            }}\r\n                        >\r\n                            {t}\r\n                        </div>\r\n                    ))}\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n\r\nconst ColorInput: React.FC<{ value: string, onChange: (val: string) => void }> = ({ value, onChange }) => {\r\n    const [open, setOpen] = useState(false);\r\n    const buttonRef = useRef<HTMLButtonElement>(null);\r\n    const { top, left, contentRef } = usePopoverPosition({\r\n        triggerRef: buttonRef as React.RefObject<HTMLElement>,\r\n        isOpen: open,\r\n        gap: 5,\r\n        contentHeight: 380 // Estimate for initial render\r\n    });\r\n\r\n    // Helpers for Hex8 <-> Hex + Opacity\r\n    const parseColor = (val: string) => {\r\n        const clean = (val || '#000000').replace('#', '');\r\n        if (clean.length === 8) {\r\n            return {\r\n                hex: '#' + clean.substring(0, 6),\r\n                opacity: Math.round((parseInt(clean.substring(6), 16) / 255) * 100)\r\n            };\r\n        }\r\n        return { hex: '#' + clean, opacity: 100 }; // Default 100%\r\n    };\r\n\r\n    const toHex8 = (hex: string, opacity: number) => {\r\n        const alpha = Math.round((opacity / 100) * 255);\r\n        const alphaHex = alpha.toString(16).padStart(2, '0');\r\n        return (hex.substring(0, 7) + alphaHex).toUpperCase();\r\n    };\r\n\r\n    const { hex, opacity } = parseColor(value);\r\n\r\n    // Handler when Picker changes only Color\r\n    const handleColorChange = (newHex: string) => {\r\n        onChange(toHex8(newHex, opacity));\r\n    };\r\n\r\n    // Handler when Picker changes only Opacity\r\n    const handleOpacityChange = (newOpacity: number) => {\r\n        onChange(toHex8(hex, newOpacity));\r\n    };\r\n\r\n    return (\r\n        <>\r\n            <div className=\"flex items-center gap-2\">\r\n                <button\r\n                    ref={buttonRef}\r\n                    onClick={() => setOpen(!open)}\r\n                    className=\"w-8 h-8 rounded-md border border-slate-300 dark:border-gray-600 cursor-pointer hover:border-blue-500 transition-colors shadow-sm relative overflow-hidden\"\r\n                    title=\"Change Color\"\r\n                >\r\n                    {/* Checkerboard for opacity preview */}\r\n                    <div className=\"absolute inset-0 z-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4IiBoZWlnaHQ9IjgiPjxwYXRoIGZpbGw9IiM4MDgwODAiIGQ9Ik0wIDBoNHY0SDB6bTQgNGg0djRINFoiIGZpbGwtb3BhY2l0eT0iMC4yIi8+PC9zdmc+')]\" />\r\n                    <div className=\"absolute inset-0 z-10\" style={{ backgroundColor: value || '#000000' }} />\r\n                </button>\r\n                {/* Optional Text Display */}\r\n                <span className=\"text-xs font-mono text-slate-500 dark:text-gray-500\">{value}</span>\r\n            </div>\r\n\r\n            {open && createPortal(\r\n                <div className=\"fixed inset-0 z-[100000]\" onClick={() => setOpen(false)}>\r\n                    <div\r\n                        ref={contentRef}\r\n                        className=\"absolute\"\r\n                        style={{ top, left }}\r\n                        onClick={(e) => e.stopPropagation()}\r\n                    >\r\n                        <ColorPalettePicker\r\n                            color={hex}\r\n                            opacity={opacity}\r\n                            onChange={handleColorChange}\r\n                            onOpacityChange={handleOpacityChange}\r\n                        />\r\n                    </div>\r\n                </div>,\r\n                document.body\r\n            )}\r\n        </>\r\n    );\r\n};\r\n"],"names":[],"mappings":";;;;;AAAA;AACA;AACA;AACA;;;;;;;AAuBO,MAAM,0BAAkE,CAAC,EAC5E,MAAM,EAAE,OAAO,EAAE,MAAM,EAAE,UAAU,EAAE,eAAe,EACvD;;IACG,MAAM,CAAC,UAAU,YAAY,GAAG,IAAA,yKAAQ,EAAC;IAEzC,wFAAwF;IACxF,MAAM,cAAc,wKAAK,CAAC,MAAM,CAAC;IAEjC,IAAA,0KAAS;6CAAC;YACN,oBAAoB;YACpB,IAAI,UAAU,CAAC,YAAY,OAAO,EAAE;gBAChC,YAAY;oBACR,GAAG,WAAW,cAAc,CAAC,MAAM;6DAAC,CAAC,KAAU;4BAC3C,GAAG,CAAC,KAAK,EAAE,CAAC,GAAG,KAAK,GAAG;4BACvB,OAAO;wBACX;4DAAG,CAAC,EAAE;oBAAE,GAAG,eAAe;gBAC9B;YACJ;YACA,YAAY,OAAO,GAAG;QAC1B;4CAAG;QAAC;QAAQ;QAAiB;KAAW;IAExC,MAAM,eAAe,CAAC,IAAY;QAC9B,YAAY,CAAC,OAAc,CAAC;gBAAE,GAAG,IAAI;gBAAE,CAAC,GAAG,EAAE;YAAM,CAAC;IACxD;IAEA,IAAI,CAAC,QAAQ,OAAO;IAEpB,cAAc;IACd,MAAM,SAA2C,CAAC;IAClD,MAAM,YAA2B,EAAE;IAEnC,WAAW,cAAc,CAAC,OAAO,CAAC,CAAA;QAC9B,IAAI,KAAK,KAAK,EAAE;YACZ,IAAI,CAAC,MAAM,CAAC,KAAK,KAAK,CAAC,EAAE,MAAM,CAAC,KAAK,KAAK,CAAC,GAAG,EAAE;YAChD,MAAM,CAAC,KAAK,KAAK,CAAC,CAAC,IAAI,CAAC;QAC5B,OAAO;YACH,UAAU,IAAI,CAAC;QACnB;IACJ;IAEA,MAAM,cAAc,CAAC;QACjB,MAAM,MAAM,QAAQ,CAAC,KAAK,EAAE,CAAC;QAE7B,OAAQ,KAAK,IAAI;YACb,KAAK;gBACD,qBACI,6LAAC;oBACG,MAAK;oBACL,SAAS,CAAC,CAAC;oBACX,UAAU,CAAC,IAAM,aAAa,KAAK,EAAE,EAAE,EAAE,MAAM,CAAC,OAAO;oBACvD,WAAU;;;;;;YAGtB,KAAK;gBACD,qBACI,6LAAC;oBACG,OAAO;oBACP,UAAU,CAAC,IAAM,aAAa,KAAK,EAAE,EAAE;;;;;;YAGnD,KAAK;gBACD,qBACI,6LAAC;oBACG,OAAO,OAAO;oBACd,UAAU,CAAC,IAAM,aAAa,KAAK,EAAE,EAAE,EAAE,MAAM,CAAC,KAAK;oBACrD,WAAU;8BAET,KAAK,OAAO,EAAE,IAAI,CAAA,oBACf,6LAAC;4BAAiB,OAAO;sCAAM;2BAAlB;;;;;;;;;;YAI7B,KAAK;gBACD,qBACI,6LAAC;oBACG,OAAO,OAAO;oBACd,UAAU,CAAC,SAAW,aAAa,KAAK,EAAE,EAAE;;;;;;YAGxD;gBACI,qBACI,6LAAC;oBACG,MAAM,KAAK,IAAI,KAAK,WAAW,WAAW;oBAC1C,OAAO,OAAO;oBACd,UAAU,CAAC,IAAM,aAAa,KAAK,EAAE,EAAE,KAAK,IAAI,KAAK,WAAW,WAAW,EAAE,MAAM,CAAC,KAAK,IAAI,EAAE,MAAM,CAAC,KAAK;oBAC3G,WAAU;;;;;;QAG1B;IACJ;IAEA,MAAM,aAAa,CAAC,qBAChB,6LAAC;YAAkB,WAAU;;8BACzB,6LAAC;oBAAI,WAAU;;sCACX,6LAAC;4BAAK,WAAU;sCAA6C,KAAK,KAAK;;;;;;wBACtE,KAAK,OAAO,kBAAI,6LAAC;4BAAK,WAAU;sCAAiD,KAAK,OAAO;;;;;;;;;;;;8BAElG,6LAAC;oBAAI,WAAU;8BACV,YAAY;;;;;;;WANX,KAAK,EAAE;;;;;IAWrB,MAAM,wBACF,6LAAC;QAAI,WAAU;QAA4G,SAAS;kBAChI,cAAA,6LAAC;YAAI,WAAU;YAAoI,SAAS,CAAA,IAAK,EAAE,eAAe;;8BAE9K,6LAAC;oBAAI,WAAU;;sCACX,6LAAC;4BAAG,WAAU;;gCAA2D,WAAW,IAAI;gCAAC;;;;;;;sCACzF,6LAAC;4BAAO,SAAS;4BAAS,WAAU;sCAChC,cAAA,6LAAC;gCAAI,OAAM;gCAAK,QAAO;gCAAK,SAAQ;gCAAY,MAAK;gCAAO,QAAO;gCAAe,aAAY;0CAAI,cAAA,6LAAC;oCAAK,GAAE;;;;;;;;;;;;;;;;;;;;;;8BAKlH,6LAAC;oBAAI,WAAU;;wBAEV,OAAO,IAAI,CAAC,QAAQ,GAAG,CAAC,CAAA,0BACrB,6LAAC;gCAAoB,WAAU;;kDAC3B,6LAAC;wCAAG,WAAU;kDAA2I;;;;;;kDACzJ,6LAAC;wCAAI,WAAU;kDACV,MAAM,CAAC,UAAU,CAAC,GAAG,CAAC;;;;;;;+BAHrB;;;;;wBASb,UAAU,MAAM,GAAG,mBAChB,6LAAC;4BAAI,WAAU;sCACV,UAAU,GAAG,CAAC;;;;;;;;;;;;8BAM3B,6LAAC;oBAAI,WAAU;;sCACX,6LAAC;4BAAO,SAAS;4BAAS,WAAU;sCAA4H;;;;;;sCAChK,6LAAC;4BAAO,SAAS,IAAM,OAAO;4BAAW,WAAU;sCAA+G;;;;;;;;;;;;;;;;;;;;;;;IAMlL,sFAAsF;IACtF,qGAAqG;IACrG,IAAI,OAAO,aAAa,aAAa,OAAO;IAE5C,qBAAO,IAAA,oLAAY,EAAC,SAAS,SAAS,IAAI;AAC9C;GApJa;KAAA;AAuJb,8DAA8D;AAE9D,MAAM,kBAAgF,CAAC,EAAE,KAAK,EAAE,QAAQ,EAAE;;IACtG,0CAA0C;IAC1C,MAAM,QAAQ,CAAC;QACX,IAAI,CAAC,KAAK,CAAC,EAAE,QAAQ,CAAC,MAAM,OAAO;YAAE,OAAO;YAAS,KAAK;QAAQ;QAClE,MAAM,CAAC,GAAG,EAAE,GAAG,EAAE,KAAK,CAAC;QACvB,MAAM,MAAM,CAAC,IAAe,EAAE,MAAM,KAAK,IAAI,GAAG,EAAE,SAAS,CAAC,GAAG,GAAG,CAAC,EAAE,EAAE,SAAS,CAAC,GAAG,IAAI,GAAG;QAC3F,OAAO;YAAE,OAAO,IAAI;YAAI,KAAK,IAAI;QAAG;IACxC;IAEA,MAAM,CAAC,OAAO,SAAS,GAAG,IAAA,yKAAQ,EAAC,MAAM;IAEzC,iEAAiE;IACjE,IAAA,0KAAS;qCAAC;YACN,MAAM,UAAU,MAAM;YACtB;6CAAS,CAAA;oBACL,IAAI,KAAK,KAAK,KAAK,QAAQ,KAAK,IAAI,KAAK,GAAG,KAAK,QAAQ,GAAG,EAAE;wBAC1D,OAAO;oBACX;oBACA,OAAO;gBACX;;QACJ;oCAAG;QAAC;KAAM;IAEV,MAAM,SAAS,CAAC,MAAuB;QACnC,MAAM,WAAW;YAAE,GAAG,KAAK;YAAE,CAAC,KAAK,EAAE;QAAO;QAC5C,SAAS;QAET,4BAA4B;QAC5B,MAAM,QAAQ,CAAC,IAAc,EAAE,OAAO,CAAC,KAAK,IAAI,QAAQ,CAAC,GAAG;QAC5D,SAAS,GAAG,MAAM,SAAS,KAAK,EAAE,CAAC,EAAE,MAAM,SAAS,GAAG,GAAG;IAC9D;IAEA,qBACI,6LAAC;QAAI,WAAU;;0BACX,6LAAC;gBAAU,OAAO,MAAM,KAAK;gBAAE,UAAU,CAAC,IAAM,OAAO,SAAS;;;;;;0BAChE,6LAAC;gBAAK,WAAU;0BAAoC;;;;;;0BACpD,6LAAC;gBAAU,OAAO,MAAM,GAAG;gBAAE,UAAU,CAAC,IAAM,OAAO,OAAO;;;;;;;;;;;;AAGxE;IAtCM;MAAA;AAwCN,MAAM,YAA0E,CAAC,EAAE,KAAK,EAAE,QAAQ,EAAE;;IAChG,MAAM,CAAC,cAAc,gBAAgB,GAAG,IAAA,yKAAQ,EAAC;IACjD,MAAM,eAAe,wKAAK,CAAC,MAAM,CAAiB;IAElD,mDAAmD;IACnD,kEAAkE;IAClE,MAAM,QAAQ,CAAC;QACX,MAAM,IAAI,CAAC,KAAK,OAAO,EAAE,KAAK,CAAC;QAC/B,OAAO;YAAE,IAAI,CAAC,CAAC,EAAE,IAAI;YAAM,IAAI,CAAC,CAAC,EAAE,IAAI;QAAK;IAChD;IAEA,MAAM,CAAC,OAAO,SAAS,GAAG,IAAA,yKAAQ,EAAC,MAAM;IAEzC,+CAA+C;IAC/C,IAAA,0KAAS;+BAAC;YACN,SAAS,MAAM;QACnB;8BAAG;QAAC;KAAM;IAEV,MAAM,SAAS;QACX,IAAI,KAAK,SAAS,MAAM,EAAE,KAAK;QAC/B,IAAI,KAAK,SAAS,MAAM,EAAE,KAAK;QAC/B,KAAK,KAAK,GAAG,CAAC,IAAI,KAAK,GAAG,CAAC,GAAG;QAC9B,KAAK,KAAK,GAAG,CAAC,IAAI,KAAK,GAAG,CAAC,GAAG;QAE9B,MAAM,MAAM,CAAC,IAAc,EAAE,QAAQ,GAAG,QAAQ,CAAC,GAAG;QACpD,MAAM,YAAY,GAAG,IAAI,IAAI,CAAC,EAAE,IAAI,KAAK;QAEzC,SAAS;QACT,0CAA0C;QAC1C,SAAS;YAAE,IAAI,IAAI;YAAK,IAAI,IAAI;QAAI;IACxC;IAEA,MAAM,aAAa;QACf;IACJ;IAEA,MAAM,cAAc,CAAC,MAAmB;QACpC,MAAM,MAAM,IAAI,OAAO,CAAC,WAAW;QACnC,IAAI,IAAI,MAAM,GAAG,GAAG;QACpB,SAAS,CAAA,OAAQ,CAAC;gBAAE,GAAG,IAAI;gBAAE,CAAC,KAAK,EAAE;YAAI,CAAC;IAC9C;IAEA,MAAM,gBAAgB,CAAC;QACnB,IAAI,EAAE,GAAG,KAAK,SAAS;YACnB,gBAAgB;YAChB;YACC,EAAE,MAAM,CAAsB,IAAI;QACvC;IACJ;IAEA,yBAAyB;IACzB,IAAA,0KAAS;+BAAC;YACN,MAAM;mDAAc,CAAC;oBACjB,IAAI,aAAa,OAAO,IAAI,CAAC,aAAa,OAAO,CAAC,QAAQ,CAAC,EAAE,MAAM,GAAW;wBAC1E,gBAAgB;oBACpB;gBACJ;;YACA,SAAS,gBAAgB,CAAC,aAAa;YACvC;uCAAO,IAAM,SAAS,mBAAmB,CAAC,aAAa;;QAC3D;8BAAG,EAAE;IAEL,yBAAyB;IACzB,MAAM,QAAQ,EAAE;IAChB,IAAK,IAAI,IAAI,GAAG,IAAI,IAAI,IAAK;QACzB,IAAK,IAAI,IAAI,GAAG,IAAI,IAAI,KAAK,GAAI;YAC7B,MAAM,IAAI,CAAC,GAAG,EAAE,QAAQ,GAAG,QAAQ,CAAC,GAAG,KAAK,CAAC,EAAE,EAAE,QAAQ,GAAG,QAAQ,CAAC,GAAG,MAAM;QAClF;IACJ;IAEA,qBACI,6LAAC;QAAI,WAAU;QAAsH,KAAK;;0BACtI,6LAAC;gBACG,MAAK;gBACL,OAAO,MAAM,EAAE;gBACf,UAAU,CAAC,IAAM,YAAY,MAAM,EAAE,MAAM,CAAC,KAAK;gBACjD,QAAQ;gBACR,SAAS,IAAM,gBAAgB;gBAC/B,WAAW;gBACX,WAAW;gBACX,WAAU;;;;;;0BAEd,6LAAC;gBAAK,WAAU;0BAAgD;;;;;;0BAChE,6LAAC;gBACG,MAAK;gBACL,OAAO,MAAM,EAAE;gBACf,UAAU,CAAC,IAAM,YAAY,MAAM,EAAE,MAAM,CAAC,KAAK;gBACjD,QAAQ;gBACR,SAAS,IAAM,gBAAgB;gBAC/B,WAAW;gBACX,WAAW;gBACX,WAAU;;;;;;YAGb,8BACG,6LAAC;gBAAI,WAAU;0BACV,MAAM,GAAG,CAAC,CAAA,kBACP,6LAAC;wBAEG,WAAW,CAAC,oEAAoE,EAAE,MAAM,QAAQ,oDAAoD,qCAAqC;wBACzL,aAAa,CAAC;4BACV,EAAE,cAAc;4BAChB,SAAS;4BACT,gBAAgB;wBACpB;kCAEC;uBARI;;;;;;;;;;;;;;;;AAejC;IAhHM;MAAA;AAkHN,MAAM,aAA2E,CAAC,EAAE,KAAK,EAAE,QAAQ,EAAE;;IACjG,MAAM,CAAC,MAAM,QAAQ,GAAG,IAAA,yKAAQ,EAAC;IACjC,MAAM,YAAY,IAAA,uKAAM,EAAoB;IAC5C,MAAM,EAAE,GAAG,EAAE,IAAI,EAAE,UAAU,EAAE,GAAG,IAAA,iKAAkB,EAAC;QACjD,YAAY;QACZ,QAAQ;QACR,KAAK;QACL,eAAe,IAAI,8BAA8B;IACrD;IAEA,qCAAqC;IACrC,MAAM,aAAa,CAAC;QAChB,MAAM,QAAQ,CAAC,OAAO,SAAS,EAAE,OAAO,CAAC,KAAK;QAC9C,IAAI,MAAM,MAAM,KAAK,GAAG;YACpB,OAAO;gBACH,KAAK,MAAM,MAAM,SAAS,CAAC,GAAG;gBAC9B,SAAS,KAAK,KAAK,CAAC,AAAC,SAAS,MAAM,SAAS,CAAC,IAAI,MAAM,MAAO;YACnE;QACJ;QACA,OAAO;YAAE,KAAK,MAAM;YAAO,SAAS;QAAI,GAAG,eAAe;IAC9D;IAEA,MAAM,SAAS,CAAC,KAAa;QACzB,MAAM,QAAQ,KAAK,KAAK,CAAC,AAAC,UAAU,MAAO;QAC3C,MAAM,WAAW,MAAM,QAAQ,CAAC,IAAI,QAAQ,CAAC,GAAG;QAChD,OAAO,CAAC,IAAI,SAAS,CAAC,GAAG,KAAK,QAAQ,EAAE,WAAW;IACvD;IAEA,MAAM,EAAE,GAAG,EAAE,OAAO,EAAE,GAAG,WAAW;IAEpC,yCAAyC;IACzC,MAAM,oBAAoB,CAAC;QACvB,SAAS,OAAO,QAAQ;IAC5B;IAEA,2CAA2C;IAC3C,MAAM,sBAAsB,CAAC;QACzB,SAAS,OAAO,KAAK;IACzB;IAEA,qBACI;;0BACI,6LAAC;gBAAI,WAAU;;kCACX,6LAAC;wBACG,KAAK;wBACL,SAAS,IAAM,QAAQ,CAAC;wBACxB,WAAU;wBACV,OAAM;;0CAGN,6LAAC;gCAAI,WAAU;;;;;;0CACf,6LAAC;gCAAI,WAAU;gCAAwB,OAAO;oCAAE,iBAAiB,SAAS;gCAAU;;;;;;;;;;;;kCAGxF,6LAAC;wBAAK,WAAU;kCAAuD;;;;;;;;;;;;YAG1E,sBAAQ,IAAA,oLAAY,gBACjB,6LAAC;gBAAI,WAAU;gBAA2B,SAAS,IAAM,QAAQ;0BAC7D,cAAA,6LAAC;oBACG,KAAK;oBACL,WAAU;oBACV,OAAO;wBAAE;wBAAK;oBAAK;oBACnB,SAAS,CAAC,IAAM,EAAE,eAAe;8BAEjC,cAAA,6LAAC,uKAAkB;wBACf,OAAO;wBACP,SAAS;wBACT,UAAU;wBACV,iBAAiB;;;;;;;;;;;;;;;0DAI7B,SAAS,IAAI;;;AAI7B;IA7EM;;QAGgC,iKAAkB;;;MAHlD"}},
    {"offset": {"line": 8623, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Michael/IdeaProjects/MSMTB/src/trading-cockpit/src/components/charts/MagnetControl.tsx"],"sourcesContent":["\"use client\";\r\n\r\nimport React, { useState, useEffect, useRef } from 'react';\r\nimport { MagnetService, MagnetMode } from './widgets/MagnetService';\r\nimport { ChevronDown, ChevronRight } from 'lucide-react';\r\n\r\n/**\r\n * Magnet icon SVG component.\r\n */\r\n/**\r\n * Magnet icon SVG component.\r\n * \"Frame\" style: Outlined U-shape with pole separators.\r\n */\r\n/**\r\n * Magnet icon SVG component.\r\n * \"Frame\" style: Outlined U-shape with pole separators.\r\n * Wider design: Outer 4-20, Inner 9-15.\r\n */\r\nconst MagnetIcon = ({ active }: { active: boolean }) => (\r\n    <svg width=\"28\" height=\"28\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\">\r\n        {/* Main Body Outline (Wider) */}\r\n        <path d=\"M4 21V10a8 8 0 0 1 16 0v11h-5V10a3 3 0 0 0-6 0v11H4z\" />\r\n        {/* Pole Separators */}\r\n        <path d=\"M4 16h5\" />\r\n        <path d=\"M15 16h5\" />\r\n    </svg>\r\n);\r\n\r\n/**\r\n * Strong Magnet icon with 'sparks'\r\n */\r\nconst StrongMagnetIcon = ({ active }: { active: boolean }) => (\r\n    <svg width=\"28\" height=\"28\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\">\r\n        {/* Main Body (Wider) */}\r\n        <path d=\"M4 21V10a8 8 0 0 1 16 0v11h-5V10a3 3 0 0 0-6 0v11H4z\" />\r\n        {/* Pole Separators */}\r\n        <path d=\"M4 16h5\" />\r\n        <path d=\"M15 16h5\" />\r\n        {/* Sparks/Lightning */}\r\n        <path d=\"M8 3l-3 4\" />\r\n        <path d=\"M16 3l3 4\" />\r\n        <path d=\"M12 2v4\" />\r\n    </svg>\r\n);\r\n\r\nexport const MagnetControl: React.FC<{ side?: 'right' | 'top' }> = ({ side = 'top' }) => {\r\n    const [mode, setMode] = useState<MagnetMode>('OFF');\r\n    const [prevActiveMode, setPrevActiveMode] = useState<MagnetMode>('WEAK');\r\n    const [isMenuOpen, setIsMenuOpen] = useState(false);\r\n    const menuRef = useRef<HTMLDivElement>(null);\r\n\r\n    // Sync with MagnetService\r\n    useEffect(() => {\r\n        setMode(MagnetService.getMode());\r\n        const unsubscribe = MagnetService.subscribe((newMode) => {\r\n            setMode(newMode);\r\n            if (newMode !== 'OFF') {\r\n                setPrevActiveMode(newMode);\r\n            }\r\n        });\r\n        return unsubscribe;\r\n    }, []);\r\n\r\n    // Close menu on click outside\r\n    useEffect(() => {\r\n        const handleClickOutside = (event: MouseEvent) => {\r\n            if (menuRef.current && !menuRef.current.contains(event.target as Node)) {\r\n                setIsMenuOpen(false);\r\n            }\r\n        };\r\n        document.addEventListener('mousedown', handleClickOutside);\r\n        return () => document.removeEventListener('mousedown', handleClickOutside);\r\n    }, []);\r\n\r\n    const handleToggle = () => {\r\n        if (mode === 'OFF') {\r\n            MagnetService.setMode(prevActiveMode);\r\n        } else {\r\n            MagnetService.setMode('OFF');\r\n        }\r\n    };\r\n\r\n    const handleSelectMode = (newMode: 'WEAK' | 'STRONG') => {\r\n        MagnetService.setMode(newMode);\r\n        setIsMenuOpen(false);\r\n    };\r\n\r\n    const isActive = mode !== 'OFF';\r\n\r\n    const menuClasses = side === 'right'\r\n        ? \"absolute left-full top-0 ml-2 w-56 bg-white dark:bg-[#1e222d] border border-slate-200 dark:border-slate-800 rounded shadow-xl z-50 overflow-hidden animate-in fade-in slide-in-from-left-1\"\r\n        : \"absolute bottom-full right-0 mb-2 w-56 bg-white dark:bg-[#1e222d] border border-slate-200 dark:border-slate-800 rounded shadow-xl z-50 overflow-hidden animate-in fade-in slide-in-from-bottom-1\";\r\n\r\n    return (\r\n        <div className=\"relative flex items-center justify-center group\" ref={menuRef}>\r\n            {/* Hover container for triggering arrow visibility */}\r\n            <div className=\"flex items-center gap-0.5\">\r\n\r\n                {/* Main Toggle Button */}\r\n                <button\r\n                    onClick={handleToggle}\r\n                    className={`\r\n                        p-2 rounded transition-all flex items-center justify-center\r\n                        ${isActive\r\n                            ? 'bg-blue-100 dark:bg-blue-500/20 text-blue-600 dark:text-blue-400 hover:bg-blue-200 dark:hover:bg-blue-500/30'\r\n                            : 'text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-slate-100'}\r\n                    `}\r\n                    title={isActive ? `Magnet ON (${mode})` : 'Magnet OFF'}\r\n                >\r\n                    {mode === 'STRONG' ? <StrongMagnetIcon active={isActive} /> : <MagnetIcon active={isActive} />}\r\n                </button>\r\n\r\n                {/* Arrow / Dropdown Button - Hidden by default, visible on group hover */}\r\n                {/* Visual refinement: small gray arrow appearing next to it */}\r\n                <button\r\n                    onClick={(e) => {\r\n                        e.stopPropagation();\r\n                        setIsMenuOpen(!isMenuOpen);\r\n                    }}\r\n                    className={`\r\n                        absolute left-full ml-1 w-3 h-full flex items-center justify-center\r\n                        opacity-0 group-hover:opacity-100 transition-opacity\r\n                        text-slate-500 hover:text-blue-400 group-hover:text-blue-400 cursor-pointer\r\n                    `}\r\n                >\r\n                    <ChevronRight size={12} />\r\n                </button>\r\n            </div>\r\n\r\n            {/* Dropdown Menu */}\r\n            {isMenuOpen && (\r\n                <div className={menuClasses}>\r\n                    <div className=\"py-1\">\r\n                        <button\r\n                            onClick={() => handleSelectMode('WEAK')}\r\n                            className={`w-full text-left px-3 py-2 text-sm flex items-center gap-3 transition-colors ${mode === 'WEAK' ? 'bg-blue-50 dark:bg-blue-600/10 text-blue-600 dark:text-blue-400' : 'text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800'}`}\r\n                        >\r\n                            <span className=\"shrink-0\"><MagnetIcon active={true} /></span>\r\n                            <span>Weak Magnet Mode</span>\r\n                        </button>\r\n                        <button\r\n                            onClick={() => handleSelectMode('STRONG')}\r\n                            className={`w-full text-left px-3 py-2 text-sm flex items-center gap-3 transition-colors ${mode === 'STRONG' ? 'bg-blue-50 dark:bg-blue-600/10 text-blue-600 dark:text-blue-400' : 'text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800'}`}\r\n                        >\r\n                            <span className=\"shrink-0\"><StrongMagnetIcon active={true} /></span>\r\n                            <span>Strong Magnet Mode</span>\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n"],"names":[],"mappings":";;;;;AAEA;AACA;AACA;;;AAJA;;;;AAMA;;CAEC,GACD;;;CAGC,GACD;;;;CAIC,GACD,MAAM,aAAa,CAAC,EAAE,MAAM,EAAuB,iBAC/C,6LAAC;QAAI,OAAM;QAAK,QAAO;QAAK,SAAQ;QAAY,MAAK;QAAO,QAAO;QAAe,aAAY;;0BAE1F,6LAAC;gBAAK,GAAE;;;;;;0BAER,6LAAC;gBAAK,GAAE;;;;;;0BACR,6LAAC;gBAAK,GAAE;;;;;;;;;;;;KANV;AAUN;;CAEC,GACD,MAAM,mBAAmB,CAAC,EAAE,MAAM,EAAuB,iBACrD,6LAAC;QAAI,OAAM;QAAK,QAAO;QAAK,SAAQ;QAAY,MAAK;QAAO,QAAO;QAAe,aAAY;;0BAE1F,6LAAC;gBAAK,GAAE;;;;;;0BAER,6LAAC;gBAAK,GAAE;;;;;;0BACR,6LAAC;gBAAK,GAAE;;;;;;0BAER,6LAAC;gBAAK,GAAE;;;;;;0BACR,6LAAC;gBAAK,GAAE;;;;;;0BACR,6LAAC;gBAAK,GAAE;;;;;;;;;;;;MAVV;AAcC,MAAM,gBAAsD,CAAC,EAAE,OAAO,KAAK,EAAE;;IAChF,MAAM,CAAC,MAAM,QAAQ,GAAG,IAAA,yKAAQ,EAAa;IAC7C,MAAM,CAAC,gBAAgB,kBAAkB,GAAG,IAAA,yKAAQ,EAAa;IACjE,MAAM,CAAC,YAAY,cAAc,GAAG,IAAA,yKAAQ,EAAC;IAC7C,MAAM,UAAU,IAAA,uKAAM,EAAiB;IAEvC,0BAA0B;IAC1B,IAAA,0KAAS;mCAAC;YACN,QAAQ,2KAAa,CAAC,OAAO;YAC7B,MAAM,cAAc,2KAAa,CAAC,SAAS;uDAAC,CAAC;oBACzC,QAAQ;oBACR,IAAI,YAAY,OAAO;wBACnB,kBAAkB;oBACtB;gBACJ;;YACA,OAAO;QACX;kCAAG,EAAE;IAEL,8BAA8B;IAC9B,IAAA,0KAAS;mCAAC;YACN,MAAM;8DAAqB,CAAC;oBACxB,IAAI,QAAQ,OAAO,IAAI,CAAC,QAAQ,OAAO,CAAC,QAAQ,CAAC,MAAM,MAAM,GAAW;wBACpE,cAAc;oBAClB;gBACJ;;YACA,SAAS,gBAAgB,CAAC,aAAa;YACvC;2CAAO,IAAM,SAAS,mBAAmB,CAAC,aAAa;;QAC3D;kCAAG,EAAE;IAEL,MAAM,eAAe;QACjB,IAAI,SAAS,OAAO;YAChB,2KAAa,CAAC,OAAO,CAAC;QAC1B,OAAO;YACH,2KAAa,CAAC,OAAO,CAAC;QAC1B;IACJ;IAEA,MAAM,mBAAmB,CAAC;QACtB,2KAAa,CAAC,OAAO,CAAC;QACtB,cAAc;IAClB;IAEA,MAAM,WAAW,SAAS;IAE1B,MAAM,cAAc,SAAS,UACvB,+LACA;IAEN,qBACI,6LAAC;QAAI,WAAU;QAAkD,KAAK;;0BAElE,6LAAC;gBAAI,WAAU;;kCAGX,6LAAC;wBACG,SAAS;wBACT,WAAW,CAAC;;wBAER,EAAE,WACI,iHACA,+HAA+H;oBACzI,CAAC;wBACD,OAAO,WAAW,CAAC,WAAW,EAAE,KAAK,CAAC,CAAC,GAAG;kCAEzC,SAAS,yBAAW,6LAAC;4BAAiB,QAAQ;;;;;qFAAe,6LAAC;4BAAW,QAAQ;;;;;;;;;;;kCAKtF,6LAAC;wBACG,SAAS,CAAC;4BACN,EAAE,eAAe;4BACjB,cAAc,CAAC;wBACnB;wBACA,WAAW,CAAC;;;;oBAIZ,CAAC;kCAED,cAAA,6LAAC,yOAAY;4BAAC,MAAM;;;;;;;;;;;;;;;;;YAK3B,4BACG,6LAAC;gBAAI,WAAW;0BACZ,cAAA,6LAAC;oBAAI,WAAU;;sCACX,6LAAC;4BACG,SAAS,IAAM,iBAAiB;4BAChC,WAAW,CAAC,6EAA6E,EAAE,SAAS,SAAS,oEAAoE,gFAAgF;;8CAEjQ,6LAAC;oCAAK,WAAU;8CAAW,cAAA,6LAAC;wCAAW,QAAQ;;;;;;;;;;;8CAC/C,6LAAC;8CAAK;;;;;;;;;;;;sCAEV,6LAAC;4BACG,SAAS,IAAM,iBAAiB;4BAChC,WAAW,CAAC,6EAA6E,EAAE,SAAS,WAAW,oEAAoE,gFAAgF;;8CAEnQ,6LAAC;oCAAK,WAAU;8CAAW,cAAA,6LAAC;wCAAiB,QAAQ;;;;;;;;;;;8CACrD,6LAAC;8CAAK;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAOlC;GA3Ga;MAAA"}},
    {"offset": {"line": 8949, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Michael/IdeaProjects/MSMTB/src/trading-cockpit/src/components/charts/modals/GoToDateModal.tsx"],"sourcesContent":["import React, { useState, useEffect } from 'react';\r\nimport { X, Calendar as CalendarIcon, Clock, ChevronLeft, ChevronRight } from 'lucide-react';\r\nimport { useChartTheme } from '../../../context/ChartThemeContext';\r\n\r\ninterface GoToDateModalProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n    onGoTo: (timestamp: number) => void;\r\n}\r\n\r\nexport const GoToDateModal: React.FC<GoToDateModalProps> = ({ isOpen, onClose, onGoTo }) => {\r\n    const { theme } = useChartTheme();\r\n    const [activeTab, setActiveTab] = useState<'date' | 'custom'>('date');\r\n\r\n    // Date State\r\n    const [selectedDate, setSelectedDate] = useState<Date>(new Date());\r\n    const [inputDate, setInputDate] = useState<string>('');\r\n    const [inputTime, setInputTime] = useState<string>('00:00');\r\n\r\n    // Calendar View State\r\n    const [viewDate, setViewDate] = useState<Date>(new Date()); // For navigating months without changing selection\r\n\r\n    useEffect(() => {\r\n        if (isOpen) {\r\n            const now = new Date();\r\n            setSelectedDate(now);\r\n            setViewDate(now);\r\n            setInputDate(now.toISOString().split('T')[0]);\r\n            setInputTime(now.toTimeString().slice(0, 5));\r\n        }\r\n    }, [isOpen]);\r\n\r\n    // Update inputs when calendar selection changes\r\n    useEffect(() => {\r\n        setInputDate(selectedDate.toISOString().split('T')[0]);\r\n    }, [selectedDate]);\r\n\r\n    // Handle Input Changes\r\n    const handleDateInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        setInputDate(e.target.value);\r\n        const d = new Date(e.target.value);\r\n        if (!isNaN(d.getTime())) {\r\n            setSelectedDate(d);\r\n            setViewDate(d);\r\n        }\r\n    };\r\n\r\n    const handleTimeInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        setInputTime(e.target.value);\r\n    };\r\n\r\n    const handleGoTo = () => {\r\n        const [hours, minutes] = inputTime.split(':').map(Number);\r\n        const target = new Date(selectedDate);\r\n        target.setHours(hours, minutes, 0, 0);\r\n        onGoTo(Math.floor(target.getTime() / 1000));\r\n        onClose();\r\n    };\r\n\r\n    // Calendar Helper Functions\r\n    const getDaysInMonth = (year: number, month: number) => new Date(year, month + 1, 0).getDate();\r\n    const getFirstDayOfMonth = (year: number, month: number) => {\r\n        const day = new Date(year, month, 1).getDay();\r\n        return day === 0 ? 6 : day - 1; // Adjust for Monday start (0=Mon, 6=Sun)\r\n    };\r\n\r\n    const generateCalendarDays = () => {\r\n        const year = viewDate.getFullYear();\r\n        const month = viewDate.getMonth();\r\n\r\n        const daysInMonth = getDaysInMonth(year, month);\r\n        const firstDay = getFirstDayOfMonth(year, month);\r\n\r\n        const days: (number | null)[] = [];\r\n\r\n        // Padding for previous month\r\n        for (let i = 0; i < firstDay; i++) {\r\n            days.push(null);\r\n        }\r\n\r\n        // Days of current month\r\n        for (let i = 1; i <= daysInMonth; i++) {\r\n            days.push(i);\r\n        }\r\n\r\n        return days;\r\n    };\r\n\r\n    const changeMonth = (delta: number) => {\r\n        const newDate = new Date(viewDate);\r\n        newDate.setMonth(newDate.getMonth() + delta);\r\n        setViewDate(newDate);\r\n    };\r\n\r\n    if (!isOpen) return null;\r\n\r\n    const days = generateCalendarDays();\r\n    const weekDays = ['Mo.', 'Di.', 'Mi.', 'Do.', 'Fr.', 'Sa.', 'So.'];\r\n\r\n    // Format Helper\r\n    const monthNames = [\r\n        'Januar', 'Februar', 'Mrz', 'April', 'Mai', 'Juni',\r\n        'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'\r\n    ];\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm\" onClick={onClose}>\r\n            <div\r\n                className=\"bg-white dark:bg-[#1E222D] rounded-lg shadow-xl w-[340px] overflow-hidden border border-slate-200 dark:border-[#2A2E39]\"\r\n                onClick={e => e.stopPropagation()}\r\n            >\r\n                {/* Header */}\r\n                <div className=\"flex justify-between items-center p-4 pb-2\">\r\n                    <h2 className=\"text-lg font-bold text-slate-900 dark:text-[#D1D4DC]\">Gehe zu</h2>\r\n                    <button onClick={onClose} className=\"text-slate-500 dark:text-[#787B86] hover:text-slate-900 dark:hover:text-[#D1D4DC] transition-colors\">\r\n                        <X size={20} />\r\n                    </button>\r\n                </div>\r\n\r\n                {/* Tags */}\r\n                <div className=\"flex px-4 border-b border-slate-200 dark:border-[#2A2E39] mb-4\">\r\n                    <button\r\n                        className={`pb-2 text-sm font-medium border-b-2 transition-colors mr-4 ${activeTab === 'date'\r\n                            ? 'text-blue-600 dark:text-[#2962FF] border-blue-600 dark:border-[#2962FF]'\r\n                            : 'text-slate-500 dark:text-[#D1D4DC] border-transparent hover:text-blue-600 dark:hover:text-[#2962FF]'\r\n                            }`}\r\n                        onClick={() => setActiveTab('date')}\r\n                    >\r\n                        Datum\r\n                    </button>\r\n                    {/* Custom range removed per user request */}\r\n                </div>\r\n\r\n                <div className=\"px-4 pb-4\">\r\n                    {/* Inputs Row */}\r\n                    <div className=\"flex gap-3 mb-6\">\r\n                        <div className=\"relative flex-1\">\r\n                            <input\r\n                                type=\"date\"\r\n                                value={inputDate}\r\n                                onChange={handleDateInputChange}\r\n                                className=\"w-full bg-slate-50 dark:bg-[#131722] border border-slate-300 dark:border-[#363A45] rounded px-3 py-1.5 text-sm text-slate-900 dark:text-[#D1D4DC] focus:border-blue-500 dark:focus:border-[#2962FF] focus:outline-none\"\r\n                            />\r\n                            {/* Icon overlay logic excluded for standard date input appearance */}\r\n                        </div>\r\n                        <div className=\"relative w-24\">\r\n                            <input\r\n                                type=\"time\"\r\n                                value={inputTime}\r\n                                onChange={handleTimeInputChange}\r\n                                className=\"w-full bg-slate-50 dark:bg-[#131722] border border-slate-300 dark:border-[#363A45] rounded px-3 py-1.5 text-sm text-slate-900 dark:text-[#D1D4DC] focus:border-blue-500 dark:focus:border-[#2962FF] focus:outline-none\"\r\n                            />\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Calendar Nav */}\r\n                    <div className=\"flex justify-between items-center mb-4 text-slate-900 dark:text-[#D1D4DC]\">\r\n                        <button onClick={() => changeMonth(-1)} className=\"p-1 hover:bg-slate-100 dark:hover:bg-[#2A2E39] rounded text-slate-500 dark:text-[#787B86] hover:text-slate-900 dark:hover:text-[#D1D4DC]\">\r\n                            <ChevronLeft size={20} />\r\n                        </button>\r\n                        <span className=\"font-medium\">\r\n                            {monthNames[viewDate.getMonth()]} {viewDate.getFullYear()}\r\n                        </span>\r\n                        <button onClick={() => changeMonth(1)} className=\"p-1 hover:bg-slate-100 dark:hover:bg-[#2A2E39] rounded text-slate-500 dark:text-[#787B86] hover:text-slate-900 dark:hover:text-[#D1D4DC]\">\r\n                            <ChevronRight size={20} />\r\n                        </button>\r\n                    </div>\r\n\r\n                    {/* Calendar Grid */}\r\n                    <div className=\"grid grid-cols-7 gap-1 text-center mb-2\">\r\n                        {weekDays.map(day => (\r\n                            <div key={day} className=\"text-xs text-slate-500 dark:text-[#787B86] py-1 bg-slate-100 dark:bg-[#2A2E39]/30 rounded-sm\">\r\n                                {day}\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n                    <div className=\"grid grid-cols-7 gap-1 text-center\">\r\n                        {days.map((day, idx) => {\r\n                            if (day === null) return <div key={`empty-${idx}`} />;\r\n\r\n                            const isSelected =\r\n                                day === selectedDate.getDate() &&\r\n                                viewDate.getMonth() === selectedDate.getMonth() &&\r\n                                viewDate.getFullYear() === selectedDate.getFullYear();\r\n\r\n                            const isToday =\r\n                                day === new Date().getDate() &&\r\n                                viewDate.getMonth() === new Date().getMonth() &&\r\n                                viewDate.getFullYear() === new Date().getFullYear();\r\n\r\n                            return (\r\n                                <button\r\n                                    key={day}\r\n                                    onClick={() => {\r\n                                        const newD = new Date(viewDate);\r\n                                        newD.setDate(day);\r\n                                        setSelectedDate(newD);\r\n                                    }}\r\n                                    className={`\r\n                                        text-sm py-1.5 rounded transition-colors\r\n                                        ${isSelected\r\n                                            ? 'bg-blue-600 dark:bg-white text-white dark:text-black font-bold'\r\n                                            : 'text-slate-700 dark:text-[#D1D4DC] hover:bg-slate-100 dark:hover:bg-[#2A2E39]'\r\n                                        }\r\n                                        ${isToday && !isSelected ? 'underline decoration-blue-500 dark:decoration-[#2962FF] underline-offset-4' : ''}\r\n                                    `}\r\n                                >\r\n                                    {day}\r\n                                </button>\r\n                            );\r\n                        })}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Footer Buttons */}\r\n                <div className=\"flex justify-end gap-3 p-4 border-t border-slate-200 dark:border-[#2A2E39]\">\r\n                    <button\r\n                        onClick={onClose}\r\n                        className=\"px-4 py-2 text-sm font-medium text-slate-600 dark:text-[#D1D4DC] border border-slate-300 dark:border-[#363A45] rounded hover:bg-slate-100 dark:hover:bg-[#2A2E39] transition-colors\"\r\n                    >\r\n                        Abbrechen\r\n                    </button>\r\n                    <button\r\n                        onClick={handleGoTo}\r\n                        className=\"px-4 py-2 text-sm font-medium bg-blue-600 dark:bg-white hover:bg-blue-500 dark:hover:bg-slate-200 text-white dark:text-black rounded transition-colors font-bold\"\r\n                    >\r\n                        Gehe zu\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n"],"names":[],"mappings":"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"}}]
}